<!DOCTYPE html>
<html>

<head>
    <style type="text/css">
        body {
            max-width: 100%;
            max-height: 100%;
        }

        body .hidden {
            display: none;
            visibility: hidden;
        }

        body .overlay {
            position: fixed;
            z-index: 9999;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            justify-content: center;
            background-color: #000;
            color: #fff;
            filter: opacity(0.5);
        }
    </style>
</head>

<body>
    <div id="audioctx_unlocker" class="hidden">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
            AudioContext is locked.<br>Click to unlock.
        </div>
    </div>

    <h1>HCA decoder demo</h1>
    <i>Standalone version - you may right-click & save this page for offline use.</i><br>
    <a href="https://github.com/y2361547758/hca.js">GitHub repo</a>
    <hr>
    <button disabled id="startworkerbtn">start background worker</button><br>
    <button disabled id="shutdownbtn">shutdown background worker</button><br>
    <hr>
    <h3>Choose a HCA or AWB file</h3>
    Drag & drop a file here,<br>
    <form id="localfileform">
        Or pick a local file: <input type="file" id="localfile" accept=".hca,application/octet-stream"><br>
        <input type="checkbox" id="hcaonly" checked>
        <label for="hcaonly">pick HCA file only (uncheck if unable to pick)</label><br>
    </form>
    <b><u>Don't forget to</u></b> <button disabled id="loadfilebtn">load picked file</button><br>
    Or download from URL: <input type="text" spellcheck="false" id="urlinput" value="bgm22_battle01_hca.hca"><br>
    <button id="downloadbtn">download</button><br>
    <div id="awbsubsongswitcher"></div>
    <hr>
    <h3>Set keys for decryption/encryption</h3>
    key1=<input type="text" spellcheck="false" id="key1input" value="0x01395C51"><br>
    key2=<input type="text" spellcheck="false" id="key2input" value="0x00000000"><br>
    <i>(optional) </i>subkey=<input type="text" spellcheck="false" id="subkeyinput" value="0x0"><br>
    <i>Note: output waveform will be (almostly all) silence if incorrect keys are given!</i><br>
    <hr>
    <h3>Streaming (<a href="https://developer.mozilla.org/en-US/docs/Web/API/AudioWorklet">AudioWorklet API</a>)</h3>
    <input type="checkbox" checked id="awautoplayondrop">
    <label for="awautoplyondrop">Automatically play drag & dropped HCA file</label><br>
    <b><u>Some browsers like Safari (Apple WebKit) may lock AudioContext initially, which blocks auto-play.<br>
            To unlock AudioContext (so that auto-play will no longer be blocked),<br>
            please click anywhere on this page after drag & drop.</u></b><br>
    Load a HCA file for playing, which has been fully loaded/downloaded above:<br>
    <button id="awloadwholehcabtn">Load</button><br>
    Load directly from the URL above, without fully downloading the whole file:<br>
    <button id="awloadfromurlbtn">Load</button><br>
    Progress control:<br>
    <input type="checkbox" id="awplayinbackground">
    <label for="awplayinbackground">Play in background (may glitch)</label><br>
    <button id="awresumebtn">Play/Resume</button><br>
    <button id="awpausebtn">Pause</button><br>
    <button id="awstopbtn">Stop</button><br>
    <a href="#volumeslider">Volume control</a> (in "decoding parameters" section)<br>
    <hr>
    <h3>Decode the whole file</h3>
    Note:<br>
    (1) <b>Please click "get HCA info" button first.</b><br>
    (2) Setting decoding mode to <b>zero means 32-bit float mode</b>, or <b>8/16/24/32-bit integer mode</b>
    otherwise.<br>
    (3) Loop count is <b>ignored if HCA header doesn't have loop section</b><br>
    (4) Loop count doesn't count the existing part which is originally supposed to be looped.<br>
    &nbsp;&nbsp;&nbsp;&nbsp;<b>In other words, actual loop count will be: the number set here plus one.</b><br>
    (5) When <b>decoding the whole file</b>, setting loop count to <b>zero</b> means: <b>disabling loop</b>.</b><br>
    <fieldset>
        <legend>HCA info</legend>
        <button disabled id="infobtn">get HCA info</button><br>
        <style>
            table {
                border-top: 1px solid #000;
                border-left: 1px solid #000;
                border-spacing: 0;
            }

            tbody td {
                border-bottom: 1px solid #000;
                border-right: 1px solid #000;
                min-width: 8ch;
            }

            thead tr th,
            tfoot tr th {
                background-color: #fff;
                color: #000;
                border-bottom: 1px solid #000;
                border-right: 1px solid #000;
            }
        </style>
        <table id="hcaInfoTable">
            <thead>
                <tr>
                    <th colspan="3">HCA info</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>(Not loaded)</td>
                </tr>
            </tbody>
        </table>
    </fieldset>
    <fieldset>
        <legend>Checksum</legend>
        <button disabled id="fixcsumbtn">fix checksum</button><br>
    </fieldset>
    <fieldset>
        <legend>Cipher</legend>
        <button disabled id="encryptbtn">encrypt</button><br>
        <button disabled id="decryptbtn">decrypt</button><br>
    </fieldset>
    <fieldset>
        <legend>Decoding parameters</legend>
        Decoding mode: <input type="number" step="8" min="0" max="32" placeholder="0-99" id="decodingmodeinput"
            value="16"><br>
        Loop count: <input type="number" step="1" min="0" max="99" placeholder="0-99" id="loopcountinput" value="0"><br>
        Volume: <input type="range" step="1" min="0" max="100" placeholder="0-100" id="volumeslider" value="100">
        <input type="number" step="1" min="0" max="100" placeholder="0-100" id="volumeinput" value="100"><br>
        <i>This volume control affects <a href="#awresumebtn">AudioWorklet</a> and <a
                href="#webaudioplaybtn">WebAudio</a> playing as well.</i><br>
    </fieldset>
    <fieldset>
        <legend>Decode to HTML5 Audio</legend>
        <button disabled id="decodetoh5btn">decode</button><br>
        <audio id="audioElement" controls></audio><br>
    </fieldset>
    <fieldset>
        <legend>Decode to WebAudio AudioBufferSourceNode</legend>
        <b>Playing will seamlessly loop if HCA supports looping.</b><br>
        <button disabled id="decodetowabtn">decode</button><br>
        <input type="checkbox" id="webaudioplayinbackground">
        <label for="webaudioplayinbackground">Play in background (may glitch)</label><br>
        <button disabled id="webaudioplaybtn">Play</button><br>
        <button disabled id="webaudiopausebtn">Pause</button><br>
        <button disabled id="webaudiostopbtn">Stop</button><br>
    </fieldset>
    <!-- <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.8.3/dist/ffmpeg.min.js"></script> -->
    <script>
        var AWBSubsongSelect = null;
    </script>
    <script type="module">
        const hcaJsUrl = new URL("data:text/javascript;base64,Y29uc3QgSENBS25vd25LZXlzID0gWwogICAgLy8gW2xvd2VyIDMyIGJpdHMsIGhpZ2hlciAzMiBiaXRzXQogICAgLy8gZWcuIDY2MTU1MThFOEVDRUQ0NDcgPT4gWzB4OEVDRUQ0NDcsIDB4NjYxNTUxOEVdCiAgICAvLyBzb3VyY2U6IGh0dHBzOi8vZ2l0aHViLmNvbS9UaGVhbGV4YmFybmV5L1ZHQXVkaW8vYmxvYi9tYXN0ZXIvZG9jcy9hdWRpby1mb3JtYXRzL2hjYS9lbmNyeXB0aW9uLWtleXMubWQKICAgIFsweDAwMDAwNEM4LCAweDAwMDAwMDAwXSwKICAgIFsweDAwMDAwOTc4LCAweDAwMDAwMDAwXSwKICAgIFsweDAwMDAyMkNFLCAweDAwMDAwMDAwXSwKICAgIFsweDAwMDAzMDM5LCAweDAwMDAwMDAwXSwKICAgIFsweDAwMUQxNDlBLCAweDAwMDAwMDAwXSwKICAgIFsweDAwOTEzNEZDLCAweDAwMDAwMDAwXSwKICAgIFsweDAxMkM5QTUzLCAweDAwMDAwMDAwXSwKICAgIFsweDAxMkVCQ0NBLCAweDAwMDAwMDAwXSwKICAgIFsweDAxMkZDRkRGLCAweDAwMDAwMDAwXSwKICAgIFsweDAxMzk1QzUxLCAweDAwMDAwMDAwXSwKICAgIFsweDBFNjJCRUYwLCAweDAwMDAwMDAwXSwKICAgIFsweDBFODg0NzNDLCAweDAwMDAwMDAwXSwKICAgIFsweDQ5OTEzNTU2LCAweDAwMDAwMDAwXSwKICAgIFsweDc3RURBMTNBLCAweDAwMDAwMDAwXSwKICAgIFsweDc3RURGMjFDLCAweDAwMDAwMDAwXSwKICAgIFsweDcyMzVDQjI5LCAweDAwMDAwMDBCXSwKICAgIFsweDIyMkFBQTg0LCAweDAwMDAwNDk3XSwKICAgIFsweEE2QUQ2MTI1LCAweDAwMDAxQjg1XSwKICAgIFsweEYyN0UzQjIyLCAweDAwMDAzNjU3XSwKICAgIFsweDk3OTc4QTk2LCAweDAwMDA5NjhBXSwKICAgIFsweDk1MzU2QzcyLCAweDAwMDIzNTRFXSwKICAgIFsweEJDNzMxQTg1LCAweDAwMDJCODc1XSwKICAgIFsweDBEQzU3RjQ4LCAweDAwMTFEQ0REXSwKICAgIFsweDEwMjRBREU5LCAweDAwMTg5REZCXSwKICAgIFsweDYzNEI1RjA3LCAweDAwMjA1NUM4XSwKICAgIFsweEExMUNDRkIwLCAweDAwNjg4ODg0XSwKICAgIFsweDhEMEMxMEZELCAweDAwQTA2QTBCXSwKICAgIFsweENDNTU0NjM5LCAweDAwREJFMUFCXSwKICAgIFsweDU5OTBGQjVFLCAweDAyMDUxQUYyXSwKICAgIFsweEY1ODE2QTJBLCAweDI5QUZFOTExXSwKICAgIFsweDgzNjUzNjk5LCAweDQzOEJGMUY4XSwKICAgIFsweEI4RTZDNkQyLCAweDQzRTRFQTYyXSwKICAgIFsweEMzMDkxMzY2LCAweDdDRUM4MUY3XSwKICAgIFsweDkyRUJGNDY0LCAweDdFODk2MzE4XSwKICAgIFsweDMwREJFMUFCLCAweENDNTU0NjM5XSwKICAgIFsweEUwNzQ4OTc4LCAweENGMjIyRjFGXSwKICAgIFsweDM0M0QwMDAwLCAweERCNUI2MUI4XSwKICAgIFsweEFCNDE0QkExLCAweEZEQUU1MzFBXSwKICAgIFsweEZGRkZGRkZGLCAweEZGRkZGRkZGXSwKICAgIC8vIHNvdXJjZTogaHR0cHM6Ly9naXRodWIuY29tL3ZnbXN0cmVhbS92Z21zdHJlYW0vYmxvYi8zNmY0ZGZlYWI0MWFkZjhmOGZmMDg0NzdkYzA2MmY4Yzc2YjAwM2Q4L3NyYy9tZXRhL2hjYV9rZXlzLmgjTDEwNTkKICAgIFsweDhFQ0VENDQ3LCAweDY2MTU1MThFXSwgLy8gSGVhdmVuIEJ1cm5zIFJlZCAoQW5kcm9pZCkKXTsKY2xhc3MgSENBQ2lwaGVyIHsKICAgIGNvbnN0cnVjdG9yKGtleTEsIGtleTIpIHsKICAgICAgICB0aGlzLmNpcGhlclR5cGUgPSAwOwogICAgICAgIHRoaXMuZW5jcnlwdCA9IGZhbHNlOwogICAgICAgIHRoaXMua2V5MWJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcig0KTsKICAgICAgICB0aGlzLmtleTJidWYgPSBuZXcgQXJyYXlCdWZmZXIoNCk7CiAgICAgICAgdGhpcy5fdGFibGUgPSBuZXcgVWludDhBcnJheSgyNTYpOwogICAgICAgIHRoaXMuZHYxID0gbmV3IERhdGFWaWV3KHRoaXMua2V5MWJ1Zik7CiAgICAgICAgdGhpcy5kdjIgPSBuZXcgRGF0YVZpZXcodGhpcy5rZXkyYnVmKTsKICAgICAgICBpZiAoa2V5MSA9PSBudWxsKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIm5vIGtleXMgZ2l2ZW4uIHVzZSBcImRlZmF1bHRrZXlcIiBpZiB5b3Ugd2FudCB0byB1c2UgdGhlIGRlZmF1bHQga2V5Iik7CiAgICAgICAgc3dpdGNoIChrZXkxKSB7CiAgICAgICAgICAgIGNhc2UgIm5vbmUiOgogICAgICAgICAgICBjYXNlICJub2tleSI6CiAgICAgICAgICAgIGNhc2UgIm5vS2V5IjoKICAgICAgICAgICAgY2FzZSAibm8ga2V5IjoKICAgICAgICAgICAgY2FzZSAibm9fS2V5IjoKICAgICAgICAgICAgICAgIHRoaXMuc2V0VG9Ob0tleSgpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImRlZmF1bHRrZXkiOgogICAgICAgICAgICBjYXNlICJkZWZhdWx0S2V5IjoKICAgICAgICAgICAgY2FzZSAiZGVmYXVsdCBrZXkiOgogICAgICAgICAgICBjYXNlICJkZWZhdWx0X2tleSI6CiAgICAgICAgICAgICAgICB0aGlzLnNldFRvRGVmS2V5cygpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICBrZXkxID0gSENBQ2lwaGVyLnBhcnNlS2V5KGtleTEpOwogICAgICAgICAgICAgICAgaWYgKGtleTIgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGtleTIgPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAga2V5MiA9IEhDQUNpcGhlci5wYXJzZUtleShrZXkyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuc2V0S2V5cyhrZXkxLCBrZXkyKTsKICAgICAgICB9CiAgICB9CiAgICBpbml0MSgpIHsKICAgICAgICBmb3IgKGxldCBpID0gMSwgdiA9IDA7IGkgPCAweEZGOyBpKyspIHsKICAgICAgICAgICAgdiA9ICh2ICogMTMgKyAxMSkgJiAweEZGOwogICAgICAgICAgICBpZiAodiA9PSAwIHx8IHYgPT0gMHhGRikKICAgICAgICAgICAgICAgIHYgPSAodiAqIDEzICsgMTEpICYgMHhGRjsKICAgICAgICAgICAgdGhpcy5fdGFibGVbaV0gPSB2OwogICAgICAgIH0KICAgICAgICB0aGlzLl90YWJsZVswXSA9IDA7CiAgICAgICAgdGhpcy5fdGFibGVbMHhGRl0gPSAweEZGOwogICAgfQogICAgaW5pdDU2KCkgewogICAgICAgIGxldCBrZXkxID0gdGhpcy5kdjEuZ2V0VWludDMyKDAsIHRydWUpOwogICAgICAgIGxldCBrZXkyID0gdGhpcy5kdjIuZ2V0VWludDMyKDAsIHRydWUpOwogICAgICAgIGlmICgha2V5MSkKICAgICAgICAgICAga2V5Mi0tOwogICAgICAgIGtleTEtLTsKICAgICAgICB0aGlzLmR2MS5zZXRVaW50MzIoMCwga2V5MSwgdHJ1ZSk7CiAgICAgICAgdGhpcy5kdjIuc2V0VWludDMyKDAsIGtleTIsIHRydWUpOwogICAgICAgIGxldCB0MSA9IHRoaXMuZ2V0Qnl0ZXNPZlR3b0tleXMoKTsKICAgICAgICBsZXQgdDIgPSBuZXcgVWludDhBcnJheShbCiAgICAgICAgICAgIHQxWzFdLCB0MVsxXSBeIHQxWzZdLCB0MVsyXSBeIHQxWzNdLAogICAgICAgICAgICB0MVsyXSwgdDFbMl0gXiB0MVsxXSwgdDFbM10gXiB0MVs0XSwKICAgICAgICAgICAgdDFbM10sIHQxWzNdIF4gdDFbMl0sIHQxWzRdIF4gdDFbNV0sCiAgICAgICAgICAgIHQxWzRdLCB0MVs0XSBeIHQxWzNdLCB0MVs1XSBeIHQxWzZdLAogICAgICAgICAgICB0MVs1XSwgdDFbNV0gXiB0MVs0XSwgdDFbNl0gXiB0MVsxXSwKICAgICAgICAgICAgdDFbNl0KICAgICAgICBdKTsKICAgICAgICBsZXQgdDMgPSBuZXcgVWludDhBcnJheSgweDEwMCk7CiAgICAgICAgbGV0IHQzMSA9IG5ldyBVaW50OEFycmF5KDB4MTApOwogICAgICAgIGxldCB0MzIgPSBuZXcgVWludDhBcnJheSgweDEwKTsKICAgICAgICB0aGlzLmNyZWF0ZVRhYmxlKHQzMSwgdDFbMF0pOwogICAgICAgIGZvciAobGV0IGkgPSAwLCB0ID0gMDsgaSA8IDB4MTA7IGkrKykgewogICAgICAgICAgICB0aGlzLmNyZWF0ZVRhYmxlKHQzMiwgdDJbaV0pOwogICAgICAgICAgICBsZXQgdiA9IHQzMVtpXSA8PCA0OwogICAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IDB4MTA7IGorKykgewogICAgICAgICAgICAgICAgdDNbdCsrXSA9IHYgfCB0MzJbal07CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDAsIHYgPSAwLCB0ID0gMTsgaSA8IDB4MTAwOyBpKyspIHsKICAgICAgICAgICAgdiA9ICh2ICsgMHgxMSkgJiAweEZGOwogICAgICAgICAgICBsZXQgYSA9IHQzW3ZdOwogICAgICAgICAgICBpZiAoYSAhPSAwICYmIGEgIT0gMHhGRikKICAgICAgICAgICAgICAgIHRoaXMuX3RhYmxlW3QrK10gPSBhOwogICAgICAgIH0KICAgICAgICB0aGlzLl90YWJsZVswXSA9IDA7CiAgICAgICAgdGhpcy5fdGFibGVbMHhGRl0gPSAweEZGOwogICAgfQogICAgY3JlYXRlVGFibGUociwga2V5KSB7CiAgICAgICAgbGV0IG11bCA9ICgoa2V5ICYgMSkgPDwgMykgfCA1OwogICAgICAgIGxldCBhZGQgPSAoa2V5ICYgMHhFKSB8IDE7CiAgICAgICAgbGV0IHQgPSAwOwogICAgICAgIGtleSA+Pj0gNDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDB4MTA7IGkrKykgewogICAgICAgICAgICBrZXkgPSAoa2V5ICogbXVsICsgYWRkKSAmIDB4RjsKICAgICAgICAgICAgclt0KytdID0ga2V5OwogICAgICAgIH0KICAgIH0KICAgIGludmVydFRhYmxlKCkgewogICAgICAgIC8vIGFjdHVhbGx5LCB0aGlzIG1ldGhvZCBzd2l0Y2ggdGhlIG1vZGUgYmV0d2VlbiBlbmNyeXB0L2RlY3J5cHQKICAgICAgICB0aGlzLmVuY3J5cHQgPSAhdGhpcy5lbmNyeXB0OwogICAgICAgIGxldCBfb2xkX3RhYmxlID0gdGhpcy5fdGFibGUuc2xpY2UoMCk7CiAgICAgICAgbGV0IGJpdE1hcCA9IG5ldyBVaW50MTZBcnJheSgxNik7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCAyNTY7IGkrKykgewogICAgICAgICAgICAvLyBpbnZlcnQga2V5IGFuZCB2YWx1ZQogICAgICAgICAgICBsZXQga2V5ID0gX29sZF90YWJsZVtpXTsKICAgICAgICAgICAgbGV0IHZhbCA9IGk7CiAgICAgICAgICAgIC8vIGNoZWNrIGZvciBpbmNvbnNpc3RlbmN5CiAgICAgICAgICAgIGxldCBoaWdoZXI0ID0ga2V5ID4+IDQgJiAweDBGOwogICAgICAgICAgICBsZXQgbG93ZXI0ID0ga2V5ICYgMHgwRjsKICAgICAgICAgICAgbGV0IGZsYWcgPSAweDAxIDw8IGxvd2VyNDsKICAgICAgICAgICAgaWYgKGJpdE1hcFtoaWdoZXI0XSAmIGZsYWcpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIl90YWJsZSBpcyBub3QgYmlqZWN0aXZlIik7CiAgICAgICAgICAgIC8vIHVwZGF0ZSB0YWJsZQogICAgICAgICAgICB0aGlzLl90YWJsZVtrZXldID0gdmFsOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIGdldFR5cGUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY2lwaGVyVHlwZTsKICAgIH0KICAgIGdldEVuY3J5cHQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZW5jcnlwdDsKICAgIH0KICAgIGdldEJ5dGVzT2ZUd29LZXlzKCkgewogICAgICAgIGxldCBidWYgPSBuZXcgVWludDhBcnJheSg4KTsKICAgICAgICBidWYuc2V0KG5ldyBVaW50OEFycmF5KHRoaXMua2V5MWJ1ZiksIDApOwogICAgICAgIGJ1Zi5zZXQobmV3IFVpbnQ4QXJyYXkodGhpcy5rZXkyYnVmKSwgNCk7CiAgICAgICAgcmV0dXJuIGJ1ZjsKICAgIH0KICAgIHN0YXRpYyBiaWdVaW50TXVsdGlwbHlMRShkdiwgZmFjdG9yKSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IERhdGFWaWV3KG5ldyBBcnJheUJ1ZmZlcihkdi5ieXRlTGVuZ3RoICsgNCkpOwogICAgICAgIGZhY3RvciA9IE1hdGgudHJ1bmMoZmFjdG9yKTsKICAgICAgICBBcnJheS5mcm9tKHsgbGVuZ3RoOiBkdi5ieXRlTGVuZ3RoIH0sIChfLCBpKSA9PiBmYWN0b3IgKiBkdi5nZXRVaW50OChpKSkKICAgICAgICAgICAgLmZvckVhY2goKHYsIGkpID0+IHsKICAgICAgICAgICAgdiArPSByZXN1bHQuZ2V0VWludDMyKGksIHRydWUpOwogICAgICAgICAgICByZXN1bHQuc2V0VWludDMyKGksIHYsIHRydWUpOwogICAgICAgICAgICB2IC09IHJlc3VsdC5nZXRVaW50MzIoaSwgdHJ1ZSk7CiAgICAgICAgICAgIGlmICh2ID4gMCkgewogICAgICAgICAgICAgICAgdiAvPSAweDEwMDAwMDAwMDsKICAgICAgICAgICAgICAgIGZvciAobGV0IGogPSBpICsgNDsgaiA8IHJlc3VsdC5ieXRlTGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgICAgICAgICB2ICs9IHJlc3VsdC5nZXRVaW50OChqKTsKICAgICAgICAgICAgICAgICAgICByZXN1bHQuc2V0VWludDgoaiwgdik7CiAgICAgICAgICAgICAgICAgICAgdiAtPSByZXN1bHQuZ2V0VWludDgoaik7CiAgICAgICAgICAgICAgICAgICAgaWYgKHYgPiAwKQogICAgICAgICAgICAgICAgICAgICAgICB2IC89IDB4MTAwOwogICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgc3RhdGljIG1peFdpdGhTdWJrZXkoa2V5MSwga2V5Miwgc3Via2V5KSB7CiAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL3ZnbXN0cmVhbS92Z21zdHJlYW0vYmxvYi84NGNmZWFmOTkzOTgyYjQyNDVjZTc1OTNkY2JiNjgxNmM1YWVlOGJjL3NyYy9jb2RpbmcvaGNhX2RlY29kZXIuYyNMMzEzCiAgICAgICAgLyoKICAgICAgICAgICAgaWYgKHN1YmtleSkgewogICAgICAgICAgICAgICAga2V5Y29kZSA9IGtleWNvZGUgKiAoICgodWludDY0X3Qpc3Via2V5IDw8IDE2dSkgfCAoKHVpbnQxNl90KX5zdWJrZXkgKyAydSkgKTsKICAgICAgICAgICAgfQogICAgICAgICovCiAgICAgICAgaWYgKHN1YmtleSA9PSBudWxsKQogICAgICAgICAgICByZXR1cm4geyBrZXkxOiBrZXkxLCBrZXkyOiBrZXkyIH07CiAgICAgICAga2V5MSA9IEhDQUNpcGhlci5wYXJzZUtleShrZXkxKTsKICAgICAgICBrZXkyID0gSENBQ2lwaGVyLnBhcnNlS2V5KGtleTIpOwogICAgICAgIHN1YmtleSA9IEhDQUNpcGhlci5wYXJzZUtleShzdWJrZXkpOwogICAgICAgIGNvbnN0IGtleWR2ID0gbmV3IERhdGFWaWV3KG5ldyBBcnJheUJ1ZmZlcig4KSk7CiAgICAgICAga2V5ZHYuc2V0VWludDMyKDAsIGtleTEsIHRydWUpOwogICAgICAgIGtleWR2LnNldFVpbnQzMig0LCBrZXkyLCB0cnVlKTsKICAgICAgICBjb25zdCBzdWJrZXlkdiA9IG5ldyBEYXRhVmlldyhuZXcgQXJyYXlCdWZmZXIoNCkpOwogICAgICAgIHN1YmtleWR2LnNldFVpbnQxNigyLCBzdWJrZXksIHRydWUpOwogICAgICAgIGlmIChzdWJrZXlkdi5nZXRVaW50MTYoMikgPT0gMCkKICAgICAgICAgICAgcmV0dXJuIHsga2V5MToga2V5MSwga2V5Mjoga2V5MiB9OyAvL3VuY2hhbmdlZAogICAgICAgIHN1YmtleWR2LnNldFVpbnQxNigwLCB+c3Via2V5ZHYuZ2V0VWludDE2KDIsIHRydWUpICsgMiwgdHJ1ZSk7CiAgICAgICAgc3Via2V5ID0gc3Via2V5ZHYuZ2V0VWludDMyKDAsIHRydWUpOwogICAgICAgIGNvbnN0IG1peGVka2V5ZHYgPSB0aGlzLmJpZ1VpbnRNdWx0aXBseUxFKGtleWR2LCBzdWJrZXkpOwogICAgICAgIGtleTEgPSBtaXhlZGtleWR2LmdldFVpbnQzMigwLCB0cnVlKTsKICAgICAgICBrZXkyID0gbWl4ZWRrZXlkdi5nZXRVaW50MzIoNCwgdHJ1ZSk7CiAgICAgICAgcmV0dXJuIHsga2V5MToga2V5MSwga2V5Mjoga2V5MiB9OwogICAgfQogICAgc2V0S2V5cyhrZXkxLCBrZXkyKSB7CiAgICAgICAgdGhpcy5kdjEuc2V0VWludDMyKDAsIGtleTEsIHRydWUpOwogICAgICAgIHRoaXMuZHYyLnNldFVpbnQzMigwLCBrZXkyLCB0cnVlKTsKICAgICAgICB0aGlzLmluaXQ1NigpOwogICAgICAgIHRoaXMuY2lwaGVyVHlwZSA9IDB4Mzg7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICBzZXRUb0RlZktleXMoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc2V0S2V5cyhIQ0FDaXBoZXIuZGVmS2V5MSwgSENBQ2lwaGVyLmRlZktleTIpOwogICAgfQogICAgc2V0VG9Ob0tleSgpIHsKICAgICAgICB0aGlzLmluaXQxKCk7CiAgICAgICAgdGhpcy5jaXBoZXJUeXBlID0gMHgwMTsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIG1hc2soYmxvY2ssIG9mZnNldCwgc2l6ZSkgewogICAgICAgIC8vIGVuY3J5cHQgb3IgZGVjcnlwdCBibG9jayBkYXRhCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzaXplOyBpKyspCiAgICAgICAgICAgIGJsb2NrW29mZnNldCArIGldID0gdGhpcy5fdGFibGVbYmxvY2tbb2Zmc2V0ICsgaV1dOwogICAgfQogICAgc3RhdGljIGlzSENBSGVhZGVyTWFza2VkKGhjYSkgewogICAgICAgIC8vIGZhc3QgJiBkaXJ0eSB3YXkgdG8gZGV0ZXJtaW5lIHdoZXRoZXIgZW5jcnlwdGVkLCBub3QgcmVjb21tZW5kZWQKICAgICAgICBpZiAoaGNhWzBdICYgMHg4MCB8fCBoY2FbMV0gJiAweDgwIHx8IGhjYVsyXSAmIDB4ODApCiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIGVsc2UKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgc3RhdGljIHBhcnNlS2V5KGtleSkgewogICAgICAgIHN3aXRjaCAodHlwZW9mIGtleSkgewogICAgICAgICAgICBjYXNlICJudW1iZXIiOgogICAgICAgICAgICAgICAgcmV0dXJuIGtleTsKICAgICAgICAgICAgY2FzZSAic3RyaW5nIjoKICAgICAgICAgICAgICAgIC8vIGF2b2lkIGFtYmlndWl0eTogYWx3YXlzIHRyZWF0IGFzIGhleAogICAgICAgICAgICAgICAgaWYgKCFrZXkubWF0Y2goL14weC8pKQogICAgICAgICAgICAgICAgICAgIGtleSA9ICIweCIgKyBrZXk7CiAgICAgICAgICAgICAgICBrZXkgPSBwYXJzZUludChrZXkpOwogICAgICAgICAgICAgICAgaWYgKGlzTmFOKGtleSkpCiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJjYW5ub3QgcGFyc2UgYXMgaW50ZWdlciIpOwogICAgICAgICAgICAgICAgcmV0dXJuIGtleTsKICAgICAgICAgICAgY2FzZSAib2JqZWN0IjoKICAgICAgICAgICAgICAgIC8vIGF2b2lkIGVuZGlhbm5lc3MgYW1iaWd1aXR5OiBvbmx5IGFjY2VwdGluZyBVaW50OEFycmF5LCB0aGVuIHJlYWQgYXMgbGl0dGxlIGVuZGlhbgogICAgICAgICAgICAgICAgaWYgKGtleSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkgJiYga2V5LmJ5dGVMZW5ndGggPT0gNCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgRGF0YVZpZXcoa2V5LmJ1ZmZlciwga2V5LmJ5dGVPZmZzZXQsIGtleS5ieXRlTGVuZ3RoKS5nZXRVaW50MzIoMCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImNhbiBvbmx5IGFjY2VwdCBudW1iZXIvaGV4IHN0cmluZy9VaW50OEFycmF5WzRdIik7CiAgICAgICAgfQogICAgfQp9CkhDQUNpcGhlci5kZWZLZXkxID0gMHgwMTM5NUM1MTsKSENBQ2lwaGVyLmRlZktleTIgPSAweDAwMDAwMDAwOwoKY29uc3QgU3ViZnJhbWVzUGVyRnJhbWUgPSA4Owpjb25zdCBTdWJGcmFtZVNhbXBsZXNCaXRzID0gNzsKY29uc3QgU2FtcGxlc1BlclN1YkZyYW1lID0gMSA8PCBTdWJGcmFtZVNhbXBsZXNCaXRzOwpjb25zdCBTYW1wbGVzUGVyRnJhbWUgPSBTdWJmcmFtZXNQZXJGcmFtZSAqCiAgICBTYW1wbGVzUGVyU3ViRnJhbWU7CgpmdW5jdGlvbiBEaXZpZGVCeVJvdW5kVXAodmFsdWUsIGRpdmlzb3IpIHsKICAgIHJldHVybiBNYXRoLmNlaWwodmFsdWUgLyBkaXZpc29yKTsKfQpmdW5jdGlvbiBHZXRIaWdoTmliYmxlKHZhbHVlKSB7CiAgICBpZiAodmFsdWUgPiAweGZmKQogICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgaWYgKHZhbHVlIDwgLTB4ODApCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICByZXR1cm4gKHZhbHVlID4+PiA0KSAmIDB4RjsKfQpmdW5jdGlvbiBHZXRMb3dOaWJibGUodmFsdWUpIHsKICAgIGlmICh2YWx1ZSA+IDB4ZmYpCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICBpZiAodmFsdWUgPCAtMHg4MCkKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgIHJldHVybiB2YWx1ZSAmIDB4RjsKfQpmdW5jdGlvbiBHZXROZXh0TXVsdGlwbGUodmFsdWUsIG11bHRpcGxlKSB7CiAgICBpZiAobXVsdGlwbGUgPD0gMCkgewogICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KICAgIGlmICh2YWx1ZSAlIG11bHRpcGxlID09IDApIHsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgICByZXR1cm4gdmFsdWUgKyBtdWx0aXBsZSAtIHZhbHVlICUgbXVsdGlwbGU7Cn0KZnVuY3Rpb24gU2lnbmVkQml0UmV2ZXJzZTMyKHZhbHVlKSB7CiAgICBpZiAodmFsdWUgPiAweGZmZmZmZmZmKQogICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgaWYgKHZhbHVlIDwgLTB4ODAwMDAwMDApCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICB2YWx1ZSA9ICgodmFsdWUgJiAweGFhYWFhYWFhKSA+Pj4gMSkgfCAoKHZhbHVlICYgMHg1NTU1NTU1NSkgPDwgMSk7CiAgICB2YWx1ZSA9ICgodmFsdWUgJiAweGNjY2NjY2NjKSA+Pj4gMikgfCAoKHZhbHVlICYgMHgzMzMzMzMzMykgPDwgMik7CiAgICB2YWx1ZSA9ICgodmFsdWUgJiAweGYwZjBmMGYwKSA+Pj4gNCkgfCAoKHZhbHVlICYgMHgwZjBmMGYwZikgPDwgNCk7CiAgICB2YWx1ZSA9ICgodmFsdWUgJiAweGZmMDBmZjAwKSA+Pj4gOCkgfCAoKHZhbHVlICYgMHgwMGZmMDBmZikgPDwgOCk7CiAgICByZXR1cm4gKCh2YWx1ZSAmIDB4ZmZmZjAwMDApID4+PiAxNikgfCAoKHZhbHVlICYgMHgwMDAwZmZmZikgPDwgMTYpOwp9CmZ1bmN0aW9uIFVuc2lnbmVkQml0UmV2ZXJzZTMyKHZhbHVlKSB7CiAgICByZXR1cm4gU2lnbmVkQml0UmV2ZXJzZTMyKHZhbHVlKSA+Pj4gMDsKfQpmdW5jdGlvbiBVbnNpZ25lZEJpdFJldmVyc2UzMlRydW5jKHZhbHVlLCBiaXRDb3VudCkgewogICAgcmV0dXJuIFVuc2lnbmVkQml0UmV2ZXJzZTMyKHZhbHVlKSA+Pj4gKDMyIC0gYml0Q291bnQpOwp9CmZ1bmN0aW9uIFNpZ25lZEJpdFJldmVyc2UzMlRydW5jKHZhbHVlLCBiaXRDb3VudCkgewogICAgcmV0dXJuIFVuc2lnbmVkQml0UmV2ZXJzZTMyVHJ1bmModmFsdWUgPj4+IDAsIGJpdENvdW50KTsKfQpmdW5jdGlvbiBDbGFtcCh2YWx1ZSwgbWluLCBtYXgpIHsKICAgIGlmICh2YWx1ZSA8IG1pbikgewogICAgICAgIHJldHVybiBtaW47CiAgICB9CiAgICBpZiAodmFsdWUgPiBtYXgpIHsKICAgICAgICByZXR1cm4gbWF4OwogICAgfQogICAgcmV0dXJuIHZhbHVlOwp9CmZ1bmN0aW9uIERlYnVnQXNzZXJ0KGNvbmRpdGlvbikgewogICAgaWYgKCFjb25kaXRpb24pCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJEZWJ1Z0Fzc2VydCBmYWlsZWQiKTsKfQpjb25zdCBzdXNwZW5kQXVkaW9DdHhJZlVubG9ja2VkID0gYXN5bmMgKGF1ZGlvQ3R4KSA9PiB7CiAgICAvLyBzdXNwZW5kIGF1ZGlvIGNvbnRleHQgZm9yIG5vdwogICAgLy8gaW4gYXBwbGUgd2Via2l0IGl0J3MgYWxyZWFkeSBzdXNwZW5kZWQgJiBjYWxsaW5nIHN1c3BlbmQgeWV0IGFnYWluIHdpbGwgYmxvY2sKICAgIHN3aXRjaCAoYXVkaW9DdHguc3RhdGUpIHsKICAgICAgICBjYXNlICJydW5uaW5nIjoKICAgICAgICAgICAgYXdhaXQgYXVkaW9DdHguc3VzcGVuZCgpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICBjYXNlICJzdXNwZW5kZWQiOgogICAgICAgICAgICBjb25zb2xlLndhcm4oYGF1ZGlvIGNvbnRleHQgZm9yIHNhbXBsZVJhdGU9JHthdWRpb0N0eC5zYW1wbGVSYXRlfSBpcyBzdXNwZW5kZWQvbG9ja2VkLGAKICAgICAgICAgICAgICAgICsgYCB3aGljaCBjYW4gb25seSBiZSByZXN1bWVkL3VubG9ja2VkIGJ5IFVJIGV2ZW50LmApOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBhdWRpbyBjb250ZXh0IGlzIG5laXRoZXIgcnVubmluZyBub3Igc3VzcGVuZGVkYCk7CiAgICB9Cn07CgpjbGFzcyBCaXRSZWFkZXIgewogICAgY29uc3RydWN0b3IoYnVmZmVyKSB7CiAgICAgICAgdGhpcy5CdWZmZXIgPSBidWZmZXI7CiAgICAgICAgdGhpcy5kdiA9IG5ldyBEYXRhVmlldyhidWZmZXIuYnVmZmVyLCBidWZmZXIuYnl0ZU9mZnNldCwgYnVmZmVyLmJ5dGVMZW5ndGgpOwogICAgICAgIHRoaXMuTGVuZ3RoQml0cyA9IGJ1ZmZlci5sZW5ndGggKiA4OwogICAgICAgIHRoaXMuUG9zaXRpb24gPSAwOwogICAgfQogICAgZ2V0IFJlbWFpbmluZygpIHsKICAgICAgICByZXR1cm4gdGhpcy5MZW5ndGhCaXRzIC0gdGhpcy5Qb3NpdGlvbjsKICAgIH0KICAgIFJlYWRJbnQoYml0Q291bnQpIHsKICAgICAgICBsZXQgdmFsdWUgPSB0aGlzLlBlZWtJbnQoYml0Q291bnQpOwogICAgICAgIHRoaXMuUG9zaXRpb24gKz0gYml0Q291bnQ7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQogICAgUmVhZEJvb2woKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuUmVhZEludCgxKSA9PSAxOwogICAgfQogICAgUmVhZE9mZnNldEJpbmFyeShiaXRDb3VudCwgYmlhcykgewogICAgICAgIGxldCBvZmZzZXQgPSAoMSA8PCAoYml0Q291bnQgLSAxKSkgLSBiaWFzOwogICAgICAgIGxldCB2YWx1ZSA9IHRoaXMuUGVla0ludChiaXRDb3VudCkgLSBvZmZzZXQ7CiAgICAgICAgdGhpcy5Qb3NpdGlvbiArPSBiaXRDb3VudDsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgICBBbGlnblBvc2l0aW9uKG11bHRpcGxlKSB7CiAgICAgICAgdGhpcy5Qb3NpdGlvbiA9IEdldE5leHRNdWx0aXBsZSh0aGlzLlBvc2l0aW9uLCBtdWx0aXBsZSk7CiAgICB9CiAgICBQZWVrSW50KGJpdENvdW50KSB7CiAgICAgICAgRGVidWdBc3NlcnQoYml0Q291bnQgPj0gMCAmJiBiaXRDb3VudCA8PSAzMik7CiAgICAgICAgaWYgKGJpdENvdW50ID4gdGhpcy5SZW1haW5pbmcpIHsKICAgICAgICAgICAgaWYgKHRoaXMuUG9zaXRpb24gPj0gdGhpcy5MZW5ndGhCaXRzKQogICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgIGxldCBleHRyYUJpdHMgPSBiaXRDb3VudCAtIHRoaXMuUmVtYWluaW5nOwogICAgICAgICAgICByZXR1cm4gdGhpcy5QZWVrSW50RmFsbGJhY2sodGhpcy5SZW1haW5pbmcpIDw8IGV4dHJhQml0czsKICAgICAgICB9CiAgICAgICAgbGV0IGJ5dGVJbmRleCA9IHRoaXMuUG9zaXRpb24gLyA4OwogICAgICAgIGxldCBiaXRJbmRleCA9IHRoaXMuUG9zaXRpb24gJSA4OwogICAgICAgIGlmIChiaXRDb3VudCA8PSA5ICYmIHRoaXMuUmVtYWluaW5nID49IDE2KSB7CiAgICAgICAgICAgIGxldCB2YWx1ZSA9IHRoaXMuZHYuZ2V0VWludDE2KGJ5dGVJbmRleCk7CiAgICAgICAgICAgIHZhbHVlICY9IDB4RkZGRiA+PiBiaXRJbmRleDsKICAgICAgICAgICAgdmFsdWUgPj49IDE2IC0gYml0Q291bnQgLSBiaXRJbmRleDsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgICAgICBpZiAoYml0Q291bnQgPD0gMTcgJiYgdGhpcy5SZW1haW5pbmcgPj0gMjQpIHsKICAgICAgICAgICAgbGV0IHZhbHVlID0gdGhpcy5kdi5nZXRVaW50MTYoYnl0ZUluZGV4KSA8PCA4IHwKICAgICAgICAgICAgICAgIHRoaXMuZHYuZ2V0VWludDgoYnl0ZUluZGV4ICsgMik7CiAgICAgICAgICAgIHZhbHVlICY9IDB4RkZGRkZGID4+IGJpdEluZGV4OwogICAgICAgICAgICB2YWx1ZSA+Pj0gMjQgLSBiaXRDb3VudCAtIGJpdEluZGV4OwogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfQogICAgICAgIGlmIChiaXRDb3VudCA8PSAyNSAmJiB0aGlzLlJlbWFpbmluZyA+PSAzMikgewogICAgICAgICAgICBsZXQgdmFsdWUgPSB0aGlzLmR2LmdldFVpbnQzMihieXRlSW5kZXgpOwogICAgICAgICAgICB2YWx1ZSAmPSAweEZGRkZGRkZGID4+PiBiaXRJbmRleDsKICAgICAgICAgICAgdmFsdWUgPj49IDMyIC0gYml0Q291bnQgLSBiaXRJbmRleDsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5QZWVrSW50RmFsbGJhY2soYml0Q291bnQpOwogICAgfQogICAgUGVla0ludEZhbGxiYWNrKGJpdENvdW50KSB7CiAgICAgICAgbGV0IHZhbHVlID0gMDsKICAgICAgICBsZXQgYnl0ZUluZGV4ID0gdGhpcy5Qb3NpdGlvbiAvIDg7CiAgICAgICAgbGV0IGJpdEluZGV4ID0gdGhpcy5Qb3NpdGlvbiAlIDg7CiAgICAgICAgd2hpbGUgKGJpdENvdW50ID4gMCkgewogICAgICAgICAgICBpZiAoYml0SW5kZXggPj0gOCkgewogICAgICAgICAgICAgICAgYml0SW5kZXggPSAwOwogICAgICAgICAgICAgICAgYnl0ZUluZGV4Kys7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGV0IGJpdHNUb1JlYWQgPSBNYXRoLm1pbihiaXRDb3VudCwgOCAtIGJpdEluZGV4KTsKICAgICAgICAgICAgbGV0IG1hc2sgPSAweEZGID4+IGJpdEluZGV4OwogICAgICAgICAgICBsZXQgY3VycmVudEJ5dGUgPSAobWFzayAmIHRoaXMuZHYuZ2V0VWludDgoYnl0ZUluZGV4KSkgPj4KICAgICAgICAgICAgICAgICg4IC0gYml0SW5kZXggLSBiaXRzVG9SZWFkKTsKICAgICAgICAgICAgdmFsdWUgPSAodmFsdWUgPDwgYml0c1RvUmVhZCkgfCBjdXJyZW50Qnl0ZTsKICAgICAgICAgICAgYml0SW5kZXggKz0gYml0c1RvUmVhZDsKICAgICAgICAgICAgYml0Q291bnQgLT0gYml0c1RvUmVhZDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQp9CihmdW5jdGlvbiAoQml0UmVhZGVyKSB7CiAgICAoZnVuY3Rpb24gKE9mZnNldEJpYXMpIHsKICAgICAgICBPZmZzZXRCaWFzW09mZnNldEJpYXNbIlBvc2l0aXZlIl0gPSAxXSA9ICJQb3NpdGl2ZSI7CiAgICAgICAgT2Zmc2V0Qmlhc1tPZmZzZXRCaWFzWyJOZWdhdGl2ZSJdID0gMF0gPSAiTmVnYXRpdmUiOwogICAgfSkoQml0UmVhZGVyLk9mZnNldEJpYXMgfHwgKEJpdFJlYWRlci5PZmZzZXRCaWFzID0ge30pKTsKfSkoQml0UmVhZGVyIHx8IChCaXRSZWFkZXIgPSB7fSkpOwp2YXIgSENBQml0UmVhZGVyID0gQml0UmVhZGVyOwoKdmFyIEhDQUNoYW5uZWxUeXBlOwooZnVuY3Rpb24gKEhDQUNoYW5uZWxUeXBlKSB7CiAgICBIQ0FDaGFubmVsVHlwZVtIQ0FDaGFubmVsVHlwZVsiRGlzY3JldGUiXSA9IDBdID0gIkRpc2NyZXRlIjsKICAgIEhDQUNoYW5uZWxUeXBlW0hDQUNoYW5uZWxUeXBlWyJTdGVyZW9QcmltYXJ5Il0gPSAxXSA9ICJTdGVyZW9QcmltYXJ5IjsKICAgIEhDQUNoYW5uZWxUeXBlW0hDQUNoYW5uZWxUeXBlWyJTdGVyZW9TZWNvbmRhcnkiXSA9IDJdID0gIlN0ZXJlb1NlY29uZGFyeSI7Cn0pKEhDQUNoYW5uZWxUeXBlIHx8IChIQ0FDaGFubmVsVHlwZSA9IHt9KSk7CnZhciBIQ0FDaGFubmVsVHlwZSQxID0gSENBQ2hhbm5lbFR5cGU7CgpjbGFzcyBCaXRXcml0ZXIgewogICAgY29uc3RydWN0b3IoYnVmZmVyKSB7CiAgICAgICAgdGhpcy5Qb3NpdGlvbiA9IDA7CiAgICAgICAgdGhpcy5CdWZmZXIgPSBidWZmZXI7CiAgICAgICAgdGhpcy5kdiA9IG5ldyBEYXRhVmlldyhidWZmZXIuYnVmZmVyLCBidWZmZXIuYnl0ZU9mZnNldCwgYnVmZmVyLmJ5dGVMZW5ndGgpOwogICAgICAgIHRoaXMuTGVuZ3RoQml0cyA9IGJ1ZmZlci5sZW5ndGggKiA4OwogICAgfQogICAgZ2V0IFJlbWFpbmluZygpIHsKICAgICAgICByZXR1cm4gdGhpcy5MZW5ndGhCaXRzIC0gdGhpcy5Qb3NpdGlvbjsKICAgIH0KICAgIEFsaWduUG9zaXRpb24obXVsdGlwbGUpIHsKICAgICAgICBsZXQgbmV3UG9zaXRpb24gPSBHZXROZXh0TXVsdGlwbGUodGhpcy5Qb3NpdGlvbiwgbXVsdGlwbGUpOwogICAgICAgIGxldCBiaXRzID0gbmV3UG9zaXRpb24gLSB0aGlzLlBvc2l0aW9uOwogICAgICAgIHRoaXMuV3JpdGUoMCwgYml0cyk7CiAgICB9CiAgICBXcml0ZSh2YWx1ZSwgYml0Q291bnQpIHsKICAgICAgICBEZWJ1Z0Fzc2VydChiaXRDb3VudCA+PSAwICYmIGJpdENvdW50IDw9IDMyKTsKICAgICAgICBpZiAoYml0Q291bnQgPiB0aGlzLlJlbWFpbmluZykgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk5vdCBlbm91Z2ggYml0cyBsZWZ0IGluIG91dHB1dCBidWZmZXIiKTsKICAgICAgICB9CiAgICAgICAgbGV0IGJ5dGVJbmRleCA9IHRoaXMuUG9zaXRpb24gLyA4OwogICAgICAgIGxldCBiaXRJbmRleCA9IHRoaXMuUG9zaXRpb24gJSA4OwogICAgICAgIGlmIChiaXRDb3VudCA8PSA5ICYmIHRoaXMuUmVtYWluaW5nID49IDE2KSB7CiAgICAgICAgICAgIGxldCBvdXRWYWx1ZSA9ICgodmFsdWUgPDwgKDE2IC0gYml0Q291bnQpKSAmIDB4RkZGRikgPj4gYml0SW5kZXg7CiAgICAgICAgICAgIG91dFZhbHVlIHw9IHRoaXMuZHYuZ2V0VWludDE2KGJ5dGVJbmRleCk7CiAgICAgICAgICAgIHRoaXMuZHYuc2V0VWludDE2KGJ5dGVJbmRleCwgb3V0VmFsdWUpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChiaXRDb3VudCA8PSAxNyAmJiB0aGlzLlJlbWFpbmluZyA+PSAyNCkgewogICAgICAgICAgICBsZXQgb3V0VmFsdWUgPSAoKHZhbHVlIDw8ICgyNCAtIGJpdENvdW50KSkgJiAweEZGRkZGRikgPj4gYml0SW5kZXg7CiAgICAgICAgICAgIG91dFZhbHVlIHw9IHRoaXMuZHYuZ2V0VWludDE2KGJ5dGVJbmRleCkgPDwgOCB8CiAgICAgICAgICAgICAgICB0aGlzLmR2LmdldFVpbnQ4KGJ5dGVJbmRleCArIDIpOwogICAgICAgICAgICB0aGlzLmR2LnNldFVpbnQxNihieXRlSW5kZXgsIG91dFZhbHVlID4+PiA4KTsKICAgICAgICAgICAgdGhpcy5kdi5zZXRVaW50OChieXRlSW5kZXggKyAyLCBvdXRWYWx1ZSAmIDB4RkYpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChiaXRDb3VudCA8PSAyNSAmJiB0aGlzLlJlbWFpbmluZyA+PSAzMikgewogICAgICAgICAgICBsZXQgb3V0VmFsdWUgPSAoKCh2YWx1ZSA8PCAoMzIgLSBiaXRDb3VudCkpICYgMHhGRkZGRkZGRikgPj4+IGJpdEluZGV4KTsKICAgICAgICAgICAgb3V0VmFsdWUgfD0gdGhpcy5kdi5nZXRVaW50MzIoYnl0ZUluZGV4KTsKICAgICAgICAgICAgdGhpcy5kdi5zZXRVaW50MzIoYnl0ZUluZGV4LCBvdXRWYWx1ZSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICB0aGlzLldyaXRlRmFsbGJhY2sodmFsdWUsIGJpdENvdW50KTsKICAgICAgICB9CiAgICAgICAgdGhpcy5Qb3NpdGlvbiArPSBiaXRDb3VudDsKICAgIH0KICAgIFdyaXRlRmFsbGJhY2sodmFsdWUsIGJpdENvdW50KSB7CiAgICAgICAgbGV0IGJ5dGVJbmRleCA9IHRoaXMuUG9zaXRpb24gLyA4OwogICAgICAgIGxldCBiaXRJbmRleCA9IHRoaXMuUG9zaXRpb24gJSA4OwogICAgICAgIHdoaWxlIChiaXRDb3VudCA+IDApIHsKICAgICAgICAgICAgaWYgKGJpdEluZGV4ID49IDgpIHsKICAgICAgICAgICAgICAgIGJpdEluZGV4ID0gMDsKICAgICAgICAgICAgICAgIGJ5dGVJbmRleCsrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxldCB0b1NoaWZ0ID0gOCAtIGJpdEluZGV4IC0gYml0Q291bnQ7CiAgICAgICAgICAgIGxldCBzaGlmdGVkID0gdG9TaGlmdCA8IDAgPyB2YWx1ZSA+Pj4gLXRvU2hpZnQgOiB2YWx1ZSA8PCB0b1NoaWZ0OwogICAgICAgICAgICBsZXQgYml0c1RvV3JpdGUgPSBNYXRoLm1pbihiaXRDb3VudCwgOCAtIGJpdEluZGV4KTsKICAgICAgICAgICAgbGV0IG1hc2sgPSAoKDEgPDwgYml0c1RvV3JpdGUpIC0gMSkgPDwgOCAtIGJpdEluZGV4IC0gYml0c1RvV3JpdGU7CiAgICAgICAgICAgIGxldCBvdXRCeXRlID0gdGhpcy5kdi5nZXRVaW50OChieXRlSW5kZXgpICYgfm1hc2s7CiAgICAgICAgICAgIG91dEJ5dGUgfD0gc2hpZnRlZCAmIG1hc2s7CiAgICAgICAgICAgIHRoaXMuZHYuc2V0VWludDgoYnl0ZUluZGV4LCBvdXRCeXRlKTsKICAgICAgICAgICAgYml0SW5kZXggKz0gYml0c1RvV3JpdGU7CiAgICAgICAgICAgIGJpdENvdW50IC09IGJpdHNUb1dyaXRlOwogICAgICAgIH0KICAgIH0KfQoKY2xhc3MgQ3JjMTYgewogICAgc3RhdGljIGNhbGMoZGF0YSwgc2l6ZSkgewogICAgICAgIGlmIChzaXplID4gZGF0YS5ieXRlTGVuZ3RoKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICBpZiAoc2l6ZSA8IDApCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgIGxldCBzdW0gPSAwOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2l6ZTsgaSsrKSB7CiAgICAgICAgICAgIHN1bSA9ICgoc3VtIDw8IDgpIF4gdGhpcy5fdlsoc3VtID4+IDgpIF4gZGF0YVtpXV0pICYgMHgwMDAwZmZmZjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN1bSAmIDB4MDAwMGZmZmY7CiAgICB9CiAgICBzdGF0aWMgdmVyaWZ5KGRhdGEsIHNpemUsIGV4cGVjdGVkLCBkb05vdFRocm93ID0gZmFsc2UpIHsKICAgICAgICBpZiAoZXhwZWN0ZWQgPT0gbnVsbCkgewogICAgICAgICAgICBleHBlY3RlZCA9IG5ldyBEYXRhVmlldyhkYXRhLmJ1ZmZlciwgZGF0YS5ieXRlT2Zmc2V0LCBkYXRhLmJ5dGVMZW5ndGgpCiAgICAgICAgICAgICAgICAuZ2V0VWludDE2KHNpemUpOwogICAgICAgIH0KICAgICAgICBsZXQgYWN0dWFsID0gdGhpcy5jYWxjKGRhdGEsIHNpemUpOwogICAgICAgIGxldCByZXN1bHQgPSBleHBlY3RlZCA9PSBhY3R1YWw7CiAgICAgICAgaWYgKCFyZXN1bHQpIHsKICAgICAgICAgICAgZnVuY3Rpb24gdG9IZXgobnVtKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwYWRkaW5nID0gIjAwMDAiOwogICAgICAgICAgICAgICAgbGV0IGhleCA9IHBhZGRpbmcgKyBudW0udG9TdHJpbmcocGFkZGluZy5sZW5ndGggKiA0KS50b1VwcGVyQ2FzZSgpOwogICAgICAgICAgICAgICAgcmV0dXJuICIweCIgKyBoZXguc3Vic3RyaW5nKGhleC5sZW5ndGggLSBwYWRkaW5nLmxlbmd0aCwgaGV4Lmxlbmd0aCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGV0IG1zZyA9IGBjaGVja3N1bSBtaXNtYXRjaCAoZXhwZWN0ZWQ9JHt0b0hleChleHBlY3RlZCl9IGFjdHVhbD0ke3RvSGV4KGFjdHVhbCl9KWA7CiAgICAgICAgICAgIGlmIChkb05vdFRocm93KQogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihtc2cpOwogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IobXNnKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIHN0YXRpYyBmaXgoZGF0YSwgc2l6ZSkgewogICAgICAgIGxldCBuZXdDcmMxNiA9IHRoaXMuY2FsYyhkYXRhLCBzaXplKTsKICAgICAgICBuZXcgRGF0YVZpZXcoZGF0YS5idWZmZXIsIGRhdGEuYnl0ZU9mZnNldCwgZGF0YS5ieXRlTGVuZ3RoKS5zZXRVaW50MTYoc2l6ZSwgbmV3Q3JjMTYpOwogICAgICAgIHJldHVybiBkYXRhOwogICAgfQp9CkNyYzE2Ll92ID0gbmV3IFVpbnQxNkFycmF5KFsKICAgIDB4MDAwMCwgMHg4MDA1LCAweDgwMEYsIDB4MDAwQSwgMHg4MDFCLCAweDAwMUUsIDB4MDAxNCwgMHg4MDExLCAweDgwMzMsIDB4MDAzNiwgMHgwMDNDLCAweDgwMzksIDB4MDAyOCwgMHg4MDJELCAweDgwMjcsIDB4MDAyMiwKICAgIDB4ODA2MywgMHgwMDY2LCAweDAwNkMsIDB4ODA2OSwgMHgwMDc4LCAweDgwN0QsIDB4ODA3NywgMHgwMDcyLCAweDAwNTAsIDB4ODA1NSwgMHg4MDVGLCAweDAwNUEsIDB4ODA0QiwgMHgwMDRFLCAweDAwNDQsIDB4ODA0MSwKICAgIDB4ODBDMywgMHgwMEM2LCAweDAwQ0MsIDB4ODBDOSwgMHgwMEQ4LCAweDgwREQsIDB4ODBENywgMHgwMEQyLCAweDAwRjAsIDB4ODBGNSwgMHg4MEZGLCAweDAwRkEsIDB4ODBFQiwgMHgwMEVFLCAweDAwRTQsIDB4ODBFMSwKICAgIDB4MDBBMCwgMHg4MEE1LCAweDgwQUYsIDB4MDBBQSwgMHg4MEJCLCAweDAwQkUsIDB4MDBCNCwgMHg4MEIxLCAweDgwOTMsIDB4MDA5NiwgMHgwMDlDLCAweDgwOTksIDB4MDA4OCwgMHg4MDhELCAweDgwODcsIDB4MDA4MiwKICAgIDB4ODE4MywgMHgwMTg2LCAweDAxOEMsIDB4ODE4OSwgMHgwMTk4LCAweDgxOUQsIDB4ODE5NywgMHgwMTkyLCAweDAxQjAsIDB4ODFCNSwgMHg4MUJGLCAweDAxQkEsIDB4ODFBQiwgMHgwMUFFLCAweDAxQTQsIDB4ODFBMSwKICAgIDB4MDFFMCwgMHg4MUU1LCAweDgxRUYsIDB4MDFFQSwgMHg4MUZCLCAweDAxRkUsIDB4MDFGNCwgMHg4MUYxLCAweDgxRDMsIDB4MDFENiwgMHgwMURDLCAweDgxRDksIDB4MDFDOCwgMHg4MUNELCAweDgxQzcsIDB4MDFDMiwKICAgIDB4MDE0MCwgMHg4MTQ1LCAweDgxNEYsIDB4MDE0QSwgMHg4MTVCLCAweDAxNUUsIDB4MDE1NCwgMHg4MTUxLCAweDgxNzMsIDB4MDE3NiwgMHgwMTdDLCAweDgxNzksIDB4MDE2OCwgMHg4MTZELCAweDgxNjcsIDB4MDE2MiwKICAgIDB4ODEyMywgMHgwMTI2LCAweDAxMkMsIDB4ODEyOSwgMHgwMTM4LCAweDgxM0QsIDB4ODEzNywgMHgwMTMyLCAweDAxMTAsIDB4ODExNSwgMHg4MTFGLCAweDAxMUEsIDB4ODEwQiwgMHgwMTBFLCAweDAxMDQsIDB4ODEwMSwKICAgIDB4ODMwMywgMHgwMzA2LCAweDAzMEMsIDB4ODMwOSwgMHgwMzE4LCAweDgzMUQsIDB4ODMxNywgMHgwMzEyLCAweDAzMzAsIDB4ODMzNSwgMHg4MzNGLCAweDAzM0EsIDB4ODMyQiwgMHgwMzJFLCAweDAzMjQsIDB4ODMyMSwKICAgIDB4MDM2MCwgMHg4MzY1LCAweDgzNkYsIDB4MDM2QSwgMHg4MzdCLCAweDAzN0UsIDB4MDM3NCwgMHg4MzcxLCAweDgzNTMsIDB4MDM1NiwgMHgwMzVDLCAweDgzNTksIDB4MDM0OCwgMHg4MzRELCAweDgzNDcsIDB4MDM0MiwKICAgIDB4MDNDMCwgMHg4M0M1LCAweDgzQ0YsIDB4MDNDQSwgMHg4M0RCLCAweDAzREUsIDB4MDNENCwgMHg4M0QxLCAweDgzRjMsIDB4MDNGNiwgMHgwM0ZDLCAweDgzRjksIDB4MDNFOCwgMHg4M0VELCAweDgzRTcsIDB4MDNFMiwKICAgIDB4ODNBMywgMHgwM0E2LCAweDAzQUMsIDB4ODNBOSwgMHgwM0I4LCAweDgzQkQsIDB4ODNCNywgMHgwM0IyLCAweDAzOTAsIDB4ODM5NSwgMHg4MzlGLCAweDAzOUEsIDB4ODM4QiwgMHgwMzhFLCAweDAzODQsIDB4ODM4MSwKICAgIDB4MDI4MCwgMHg4Mjg1LCAweDgyOEYsIDB4MDI4QSwgMHg4MjlCLCAweDAyOUUsIDB4MDI5NCwgMHg4MjkxLCAweDgyQjMsIDB4MDJCNiwgMHgwMkJDLCAweDgyQjksIDB4MDJBOCwgMHg4MkFELCAweDgyQTcsIDB4MDJBMiwKICAgIDB4ODJFMywgMHgwMkU2LCAweDAyRUMsIDB4ODJFOSwgMHgwMkY4LCAweDgyRkQsIDB4ODJGNywgMHgwMkYyLCAweDAyRDAsIDB4ODJENSwgMHg4MkRGLCAweDAyREEsIDB4ODJDQiwgMHgwMkNFLCAweDAyQzQsIDB4ODJDMSwKICAgIDB4ODI0MywgMHgwMjQ2LCAweDAyNEMsIDB4ODI0OSwgMHgwMjU4LCAweDgyNUQsIDB4ODI1NywgMHgwMjUyLCAweDAyNzAsIDB4ODI3NSwgMHg4MjdGLCAweDAyN0EsIDB4ODI2QiwgMHgwMjZFLCAweDAyNjQsIDB4ODI2MSwKICAgIDB4MDIyMCwgMHg4MjI1LCAweDgyMkYsIDB4MDIyQSwgMHg4MjNCLCAweDAyM0UsIDB4MDIzNCwgMHg4MjMxLCAweDgyMTMsIDB4MDIxNiwgMHgwMjFDLCAweDgyMTksIDB4MDIwOCwgMHg4MjBELCAweDgyMDcsIDB4MDIwMgpdKTsKCmNsYXNzIE1kY3QgewogICAgY29uc3RydWN0b3IobWRjdEJpdHMsIHdpbmRvdywgc2NhbGUgPSAxKSB7CiAgICAgICAgTWRjdC5TZXRUYWJsZXMobWRjdEJpdHMpOwogICAgICAgIHRoaXMuTWRjdEJpdHMgPSBtZGN0Qml0czsKICAgICAgICB0aGlzLk1kY3RTaXplID0gMSA8PCBtZGN0Qml0czsKICAgICAgICB0aGlzLlNjYWxlID0gc2NhbGU7CiAgICAgICAgaWYgKHdpbmRvdy5sZW5ndGggPCB0aGlzLk1kY3RTaXplKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiV2luZG93IG11c3QgYmUgYXMgbG9uZyBhcyB0aGUgTURDVCBzaXplLiIpOwogICAgICAgIH0KICAgICAgICB0aGlzLl9tZGN0UHJldmlvdXMgPSBuZXcgRmxvYXQ2NEFycmF5KHRoaXMuTWRjdFNpemUpOwogICAgICAgIHRoaXMuX2ltZGN0UHJldmlvdXMgPSBuZXcgRmxvYXQ2NEFycmF5KHRoaXMuTWRjdFNpemUpOwogICAgICAgIHRoaXMuX3NjcmF0Y2hNZGN0ID0gbmV3IEZsb2F0NjRBcnJheSh0aGlzLk1kY3RTaXplKTsKICAgICAgICB0aGlzLl9zY3JhdGNoRGN0ID0gbmV3IEZsb2F0NjRBcnJheSh0aGlzLk1kY3RTaXplKTsKICAgICAgICB0aGlzLl9pbWRjdFdpbmRvdyA9IHdpbmRvdzsKICAgIH0KICAgIHN0YXRpYyBTZXRUYWJsZXMobWF4Qml0cykgewogICAgICAgIGlmIChtYXhCaXRzID4gdGhpcy5fdGFibGVCaXRzKSB7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSB0aGlzLl90YWJsZUJpdHMgKyAxOyBpIDw9IG1heEJpdHM7IGkrKykgewogICAgICAgICAgICAgICAgbGV0IG91dCA9IHRoaXMuR2VuZXJhdGVUcmlnVGFibGVzKGkpOwogICAgICAgICAgICAgICAgdGhpcy5TaW5UYWJsZXMucHVzaChvdXQuc2luKTsKICAgICAgICAgICAgICAgIHRoaXMuQ29zVGFibGVzLnB1c2gob3V0LmNvcyk7CiAgICAgICAgICAgICAgICB0aGlzLlNodWZmbGVUYWJsZXMucHVzaCh0aGlzLkdlbmVyYXRlU2h1ZmZsZVRhYmxlKGkpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl90YWJsZUJpdHMgPSBtYXhCaXRzOwogICAgICAgIH0KICAgIH0KICAgIFJ1bk1kY3QoaW5wdXQsIG91dHB1dCkgewogICAgICAgIGlmIChpbnB1dC5sZW5ndGggPCB0aGlzLk1kY3RTaXplKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiSW5wdXQgbXVzdCBiZSBhcyBsb25nIGFzIHRoZSBNRENUIHNpemUuIik7CiAgICAgICAgfQogICAgICAgIGlmIChvdXRwdXQubGVuZ3RoIDwgdGhpcy5NZGN0U2l6ZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk91dHB1dCBtdXN0IGJlIGFzIGxvbmcgYXMgdGhlIE1EQ1Qgc2l6ZS4iKTsKICAgICAgICB9CiAgICAgICAgbGV0IHNpemUgPSB0aGlzLk1kY3RTaXplOwogICAgICAgIGxldCBoYWxmID0gKHNpemUgPj4gMSk7CiAgICAgICAgbGV0IGRjdEluID0gdGhpcy5fc2NyYXRjaE1kY3Q7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBoYWxmOyBpKyspIHsKICAgICAgICAgICAgbGV0IGEgPSB0aGlzLl9pbWRjdFdpbmRvd1toYWxmIC0gaSAtIDFdICogLWlucHV0W2hhbGYgKyBpXTsKICAgICAgICAgICAgbGV0IGIgPSB0aGlzLl9pbWRjdFdpbmRvd1toYWxmICsgaV0gKiBpbnB1dFtoYWxmIC0gaSAtIDFdOwogICAgICAgICAgICBsZXQgYyA9IHRoaXMuX2ltZGN0V2luZG93W2ldICogdGhpcy5fbWRjdFByZXZpb3VzW2ldOwogICAgICAgICAgICBsZXQgZCA9IHRoaXMuX2ltZGN0V2luZG93W3NpemUgLSBpIC0gMV0gKgogICAgICAgICAgICAgICAgdGhpcy5fbWRjdFByZXZpb3VzW3NpemUgLSBpIC0gMV07CiAgICAgICAgICAgIGRjdEluW2ldID0gYSAtIGI7CiAgICAgICAgICAgIGRjdEluW2hhbGYgKyBpXSA9IGMgLSBkOwogICAgICAgIH0KICAgICAgICB0aGlzLkRjdDQoZGN0SW4sIG91dHB1dCk7CiAgICAgICAgdGhpcy5fbWRjdFByZXZpb3VzLnNldChpbnB1dCwgaW5wdXQubGVuZ3RoKTsKICAgIH0KICAgIFJ1bkltZGN0KGlucHV0LCBvdXRwdXQpIHsKICAgICAgICBpZiAoaW5wdXQubGVuZ3RoIDwgdGhpcy5NZGN0U2l6ZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIklucHV0IG11c3QgYmUgYXMgbG9uZyBhcyB0aGUgTURDVCBzaXplLiIpOwogICAgICAgIH0KICAgICAgICBpZiAob3V0cHV0Lmxlbmd0aCA8IHRoaXMuTWRjdFNpemUpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJPdXRwdXQgbXVzdCBiZSBhcyBsb25nIGFzIHRoZSBNRENUIHNpemUuIik7CiAgICAgICAgfQogICAgICAgIGxldCBzaXplID0gdGhpcy5NZGN0U2l6ZTsKICAgICAgICBsZXQgaGFsZiA9IChzaXplID4+IDEpOwogICAgICAgIGxldCBkY3RPdXQgPSB0aGlzLl9zY3JhdGNoTWRjdDsKICAgICAgICB0aGlzLkRjdDQoaW5wdXQsIGRjdE91dCk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBoYWxmOyBpKyspIHsKICAgICAgICAgICAgb3V0cHV0W2ldID0gdGhpcy5faW1kY3RXaW5kb3dbaV0gKiBkY3RPdXRbaSArIGhhbGZdICsKICAgICAgICAgICAgICAgIHRoaXMuX2ltZGN0UHJldmlvdXNbaV07CiAgICAgICAgICAgIG91dHB1dFtpICsgaGFsZl0gPSB0aGlzLl9pbWRjdFdpbmRvd1tpICsgaGFsZl0gKiAtZGN0T3V0W3NpemUgLSAxIC0gaV0gLQogICAgICAgICAgICAgICAgdGhpcy5faW1kY3RQcmV2aW91c1tpICsgaGFsZl07CiAgICAgICAgICAgIHRoaXMuX2ltZGN0UHJldmlvdXNbaV0gPSB0aGlzLl9pbWRjdFdpbmRvd1tzaXplIC0gMSAtIGldICoKICAgICAgICAgICAgICAgIC1kY3RPdXRbaGFsZiAtIGkgLSAxXTsKICAgICAgICAgICAgdGhpcy5faW1kY3RQcmV2aW91c1tpICsgaGFsZl0gPSB0aGlzLl9pbWRjdFdpbmRvd1toYWxmIC0gaSAtIDFdICoKICAgICAgICAgICAgICAgIGRjdE91dFtpXTsKICAgICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIERvZXMgYSBUeXBlLTQgRENULgogICAgICoKICAgICAqIEBwYXJhbSBpbnB1dCBUaGUgaW5wdXQgYXJyYXkgY29udGFpbmluZyB0aGUgdGltZSBvciBmcmVxdWVuY3ktZG9tYWluIHNhbXBsZXMKICAgICAqIEBwYXJhbSBvdXRwdXQgVGhlIG91dHB1dCBhcnJheSB0aGF0IHdpbGwgY29udGFpbiB0aGUgdHJhbnNmb3JtZWQgdGltZSBvciBmcmVxdWVuY3ktZG9tYWluIHNhbXBsZXMKICAgICAqLwogICAgRGN0NChpbnB1dCwgb3V0cHV0KSB7CiAgICAgICAgbGV0IHNodWZmbGVUYWJsZSA9IE1kY3QuU2h1ZmZsZVRhYmxlc1t0aGlzLk1kY3RCaXRzXTsKICAgICAgICBsZXQgc2luVGFibGUgPSBNZGN0LlNpblRhYmxlc1t0aGlzLk1kY3RCaXRzXTsKICAgICAgICBsZXQgY29zVGFibGUgPSBNZGN0LkNvc1RhYmxlc1t0aGlzLk1kY3RCaXRzXTsKICAgICAgICBsZXQgZGN0VGVtcCA9IHRoaXMuX3NjcmF0Y2hEY3Q7CiAgICAgICAgbGV0IHNpemUgPSB0aGlzLk1kY3RTaXplOwogICAgICAgIGxldCBsYXN0SW5kZXggPSBzaXplIC0gMTsKICAgICAgICBsZXQgaGFsZlNpemUgPSAoc2l6ZSA+PiAxKTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGhhbGZTaXplOyBpKyspIHsKICAgICAgICAgICAgbGV0IGkyID0gaSAqIDI7CiAgICAgICAgICAgIGxldCBhID0gaW5wdXRbaTJdOwogICAgICAgICAgICBsZXQgYiA9IGlucHV0W2xhc3RJbmRleCAtIGkyXTsKICAgICAgICAgICAgbGV0IHNpbiA9IHNpblRhYmxlW2ldOwogICAgICAgICAgICBsZXQgY29zID0gY29zVGFibGVbaV07CiAgICAgICAgICAgIGRjdFRlbXBbaTJdID0gYSAqIGNvcyArIGIgKiBzaW47CiAgICAgICAgICAgIGRjdFRlbXBbaTIgKyAxXSA9IGEgKiBzaW4gLSBiICogY29zOwogICAgICAgIH0KICAgICAgICBsZXQgc3RhZ2VDb3VudCA9IHRoaXMuTWRjdEJpdHMgLSAxOwogICAgICAgIGZvciAobGV0IHN0YWdlID0gMDsgc3RhZ2UgPCBzdGFnZUNvdW50OyBzdGFnZSsrKSB7CiAgICAgICAgICAgIGxldCBibG9ja0NvdW50ID0gMSA8PCBzdGFnZTsKICAgICAgICAgICAgbGV0IGJsb2NrU2l6ZUJpdHMgPSBzdGFnZUNvdW50IC0gc3RhZ2U7CiAgICAgICAgICAgIGxldCBibG9ja0hhbGZTaXplQml0cyA9IGJsb2NrU2l6ZUJpdHMgLSAxOwogICAgICAgICAgICBsZXQgYmxvY2tTaXplID0gMSA8PCBibG9ja1NpemVCaXRzOwogICAgICAgICAgICBsZXQgYmxvY2tIYWxmU2l6ZSA9IDEgPDwgYmxvY2tIYWxmU2l6ZUJpdHM7CiAgICAgICAgICAgIHNpblRhYmxlID0gTWRjdC5TaW5UYWJsZXNbYmxvY2tIYWxmU2l6ZUJpdHNdOwogICAgICAgICAgICBjb3NUYWJsZSA9IE1kY3QuQ29zVGFibGVzW2Jsb2NrSGFsZlNpemVCaXRzXTsKICAgICAgICAgICAgZm9yIChsZXQgYmxvY2sgPSAwOyBibG9jayA8IGJsb2NrQ291bnQ7IGJsb2NrKyspIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYmxvY2tIYWxmU2l6ZTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IGZyb250UG9zID0gKGJsb2NrICogYmxvY2tTaXplICsgaSkgKiAyOwogICAgICAgICAgICAgICAgICAgIGxldCBiYWNrUG9zID0gZnJvbnRQb3MgKyBibG9ja1NpemU7CiAgICAgICAgICAgICAgICAgICAgbGV0IGEgPSBkY3RUZW1wW2Zyb250UG9zXSAtIGRjdFRlbXBbYmFja1Bvc107CiAgICAgICAgICAgICAgICAgICAgbGV0IGIgPSBkY3RUZW1wW2Zyb250UG9zICsgMV0gLSBkY3RUZW1wW2JhY2tQb3MgKyAxXTsKICAgICAgICAgICAgICAgICAgICBsZXQgc2luID0gc2luVGFibGVbaV07CiAgICAgICAgICAgICAgICAgICAgbGV0IGNvcyA9IGNvc1RhYmxlW2ldOwogICAgICAgICAgICAgICAgICAgIGRjdFRlbXBbZnJvbnRQb3NdICs9IGRjdFRlbXBbYmFja1Bvc107CiAgICAgICAgICAgICAgICAgICAgZGN0VGVtcFtmcm9udFBvcyArIDFdICs9IGRjdFRlbXBbYmFja1BvcyArIDFdOwogICAgICAgICAgICAgICAgICAgIGRjdFRlbXBbYmFja1Bvc10gPSBhICogY29zICsgYiAqIHNpbjsKICAgICAgICAgICAgICAgICAgICBkY3RUZW1wW2JhY2tQb3MgKyAxXSA9IGEgKiBzaW4gLSBiICogY29zOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5NZGN0U2l6ZTsgaSsrKSB7CiAgICAgICAgICAgIG91dHB1dFtpXSA9IGRjdFRlbXBbc2h1ZmZsZVRhYmxlW2ldXSAqIHRoaXMuU2NhbGU7CiAgICAgICAgfQogICAgfQogICAgc3RhdGljIEdlbmVyYXRlVHJpZ1RhYmxlcyhzaXplQml0cykgewogICAgICAgIGxldCBzaXplID0gMSA8PCBzaXplQml0czsKICAgICAgICBsZXQgb3V0ID0gewogICAgICAgICAgICBzaW46IG5ldyBGbG9hdDY0QXJyYXkoc2l6ZSksCiAgICAgICAgICAgIGNvczogbmV3IEZsb2F0NjRBcnJheShzaXplKSwKICAgICAgICB9OwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2l6ZTsgaSsrKSB7CiAgICAgICAgICAgIGxldCB2YWx1ZSA9IE1hdGguUEkgKiAoNCAqIGkgKyAxKSAvICg0ICogc2l6ZSk7CiAgICAgICAgICAgIG91dC5zaW5baV0gPSBNYXRoLnNpbih2YWx1ZSk7CiAgICAgICAgICAgIG91dC5jb3NbaV0gPSBNYXRoLmNvcyh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBvdXQ7CiAgICB9CiAgICBzdGF0aWMgR2VuZXJhdGVTaHVmZmxlVGFibGUoc2l6ZUJpdHMpIHsKICAgICAgICBsZXQgc2l6ZSA9IDEgPDwgc2l6ZUJpdHM7CiAgICAgICAgdmFyIHRhYmxlID0gbmV3IEludDMyQXJyYXkoc2l6ZSk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzaXplOyBpKyspIHsKICAgICAgICAgICAgdGFibGVbaV0gPSBTaWduZWRCaXRSZXZlcnNlMzJUcnVuYyhpIF4gKGkgPj4gMSksIHNpemVCaXRzKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRhYmxlOwogICAgfQogICAgLy8gUmVTaGFycGVyIGRpc2FibGUgb25jZSBVbnVzZWRNZW1iZXIuTG9jYWwKICAgIC8qKgogICAgICogRG9lcyBhIFR5cGUtNCBEQ1QuIEludGVuZGVkIGZvciByZWZlcmVuY2UuCiAgICAgKgogICAgICogQHBhcmFtIGlucHV0IFRoZSBpbnB1dCBhcnJheSBjb250YWluaW5nIHRoZSB0aW1lIG9yIGZyZXF1ZW5jeS1kb21haW4gc2FtcGxlcwogICAgICogQHBhcmFtIG91dHB1dCBUaGUgb3V0cHV0IGFycmF5IHRoYXQgd2lsbCBjb250YWluIHRoZSB0cmFuc2Zvcm1lZCB0aW1lIG9yIGZyZXF1ZW5jeS1kb21haW4gc2FtcGxlcwogICAgICovCiAgICBEY3Q0U2xvdyhpbnB1dCwgb3V0cHV0KSB7CiAgICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCB0aGlzLk1kY3RTaXplOyBrKyspIHsKICAgICAgICAgICAgbGV0IHNhbXBsZSA9IDA7CiAgICAgICAgICAgIGZvciAobGV0IG4gPSAwOyBuIDwgdGhpcy5NZGN0U2l6ZTsgbisrKSB7CiAgICAgICAgICAgICAgICBsZXQgYW5nbGUgPSBNYXRoLlBJIC8gdGhpcy5NZGN0U2l6ZSAqIChrICsgMC41KSAqIChuICsgMC41KTsKICAgICAgICAgICAgICAgIHNhbXBsZSArPSBNYXRoLmNvcyhhbmdsZSkgKiBpbnB1dFtuXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBvdXRwdXRba10gPSBzYW1wbGUgKiB0aGlzLlNjYWxlOwogICAgICAgIH0KICAgIH0KfQpNZGN0Ll90YWJsZUJpdHMgPSAtMTsKTWRjdC5TaW5UYWJsZXMgPSBbXTsKTWRjdC5Db3NUYWJsZXMgPSBbXTsKTWRjdC5TaHVmZmxlVGFibGVzID0gW107Cgp2YXIgX2EkMTsKY2xhc3MgSENBVGFibGVzIHsKICAgIHN0YXRpYyBpc0xpdHRsZUVuZGlhbigpIHsKICAgICAgICBsZXQgdGVzdCA9IG5ldyBGbG9hdDY0QXJyYXkoWzEuMF0pOwogICAgICAgIGxldCBkdiA9IG5ldyBEYXRhVmlldyh0ZXN0LmJ1ZmZlcik7CiAgICAgICAgaWYgKGR2LmdldFVpbnQzMigwKSAhPSAwKQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBzdGF0aWMgYWRhcHRFbmRpYW5uZXNzNjQzMihhKSB7CiAgICAgICAgaWYgKGEuYnl0ZUxlbmd0aCAlIDggIT0gMCkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgaWYgKCF0aGlzLmlzTGl0dGxlRW5kaWFuKCkpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhLmxlbmd0aDsgaSArPSAyKSB7CiAgICAgICAgICAgICAgICBsZXQgdGVtcCA9IGFbaV07CiAgICAgICAgICAgICAgICBhW2ldID0gYVtpICsgMV07CiAgICAgICAgICAgICAgICBhW2kgKyAxXSA9IHRlbXA7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGE7CiAgICB9Cn0KX2EkMSA9IEhDQVRhYmxlczsKSENBVGFibGVzLlF1YW50aXplU3BlY3RydW1CaXRzID0gWwogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDIsIDB4MDEsIDB4MDIsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDMsIDB4MDIsIDB4MDIsIDB4MDIsIDB4MDMsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDIsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDQsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDQsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDMsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQKICAgIF0pLApdOwpIQ0FUYWJsZXMuUXVhbnRpemVTcGVjdHJ1bVZhbHVlID0gWwogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDMsIDB4MDAsIDB4MDIsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDcsIDB4MDIsIDB4MDAsIDB4MDEsIDB4MDYsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDcsIDB4MDUsIDB4MDMsIDB4MDAsIDB4MDIsIDB4MDQsIDB4MDYsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MEYsIDB4MDYsIDB4MDQsIDB4MDIsIDB4MDAsIDB4MDEsIDB4MDMsIDB4MDUsIDB4MEUsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MEYsIDB4MEQsIDB4MEIsIDB4MDQsIDB4MDIsIDB4MDAsIDB4MDEsIDB4MDMsIDB4MEEsIDB4MEMsIDB4MEUsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MEYsIDB4MEQsIDB4MEIsIDB4MDksIDB4MDcsIDB4MDIsIDB4MDAsIDB4MDEsIDB4MDYsIDB4MDgsIDB4MEEsIDB4MEMsIDB4MEUsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MEYsIDB4MEQsIDB4MEIsIDB4MDksIDB4MDcsIDB4MDUsIDB4MDMsIDB4MDAsIDB4MDIsIDB4MDQsIDB4MDYsIDB4MDgsIDB4MEEsIDB4MEMsIDB4MEUKICAgIF0pLApdOwpIQ0FUYWJsZXMuUXVhbnRpemVkU3BlY3RydW1CaXRzID0gWwogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDEsIDB4MDEsIDB4MDIsIDB4MDIsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDIsIDB4MDIsIDB4MDIsIDB4MDIsIDB4MDIsIDB4MDIsIDB4MDMsIDB4MDMsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDIsIDB4MDIsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDQsIDB4MDQKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDMsIDB4MDMsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQKICAgIF0pLApdOwpIQ0FUYWJsZXMuUXVhbnRpemVkU3BlY3RydW1NYXhCaXRzID0gbmV3IFVpbnQ4QXJyYXkoWwogICAgMHgwMCwgMHgwMiwgMHgwMywgMHgwMywgMHgwNCwgMHgwNCwgMHgwNCwgMHgwNCwgMHgwNSwgMHgwNiwgMHgwNywgMHgwOCwgMHgwOSwgMHgwQSwgMHgwQiwgMHgwQwpdKTsKSENBVGFibGVzLlF1YW50aXplZFNwZWN0cnVtVmFsdWUgPSBbCiAgICBuZXcgSW50OEFycmF5KFsKICAgICAgICAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwCiAgICBdKSwKICAgIG5ldyBJbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDEsIDB4RkYsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IEludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMSwgMHgwMSwgMHhGRiwgMHhGRiwgMHgwMiwgMHhGRSwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgSW50OEFycmF5KFsKICAgICAgICAweDAwLCAweDAwLCAweDAxLCAweEZGLCAweDAyLCAweEZFLCAweDAzLCAweEZELCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwCiAgICBdKSwKICAgIG5ldyBJbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDEsIDB4MDEsIDB4RkYsIDB4RkYsIDB4MDIsIDB4MDIsIDB4RkUsIDB4RkUsIDB4MDMsIDB4MDMsIDB4RkQsIDB4RkQsIDB4MDQsIDB4RkMKICAgIF0pLAogICAgbmV3IEludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMSwgMHgwMSwgMHhGRiwgMHhGRiwgMHgwMiwgMHgwMiwgMHhGRSwgMHhGRSwgMHgwMywgMHhGRCwgMHgwNCwgMHhGQywgMHgwNSwgMHhGQgogICAgXSksCiAgICBuZXcgSW50OEFycmF5KFsKICAgICAgICAweDAwLCAweDAwLCAweDAxLCAweDAxLCAweEZGLCAweEZGLCAweDAyLCAweEZFLCAweDAzLCAweEZELCAweDA0LCAweEZDLCAweDA1LCAweEZCLCAweDA2LCAweEZBCiAgICBdKSwKICAgIG5ldyBJbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDEsIDB4RkYsIDB4MDIsIDB4RkUsIDB4MDMsIDB4RkQsIDB4MDQsIDB4RkMsIDB4MDUsIDB4RkIsIDB4MDYsIDB4RkEsIDB4MDcsIDB4RjkKICAgIF0pLApdOwpIQ0FUYWJsZXMuU2NhbGVUb1Jlc29sdXRpb25DdXJ2ZSA9IG5ldyBVaW50OEFycmF5KFsKICAgIDB4MEYsIDB4MEUsIDB4MEUsIDB4MEUsIDB4MEUsIDB4MEUsIDB4MEUsIDB4MEQsIDB4MEQsIDB4MEQsIDB4MEQsIDB4MEQsIDB4MEQsIDB4MEMsIDB4MEMsIDB4MEMsCiAgICAweDBDLCAweDBDLCAweDBDLCAweDBCLCAweDBCLCAweDBCLCAweDBCLCAweDBCLCAweDBCLCAweDBBLCAweDBBLCAweDBBLCAweDBBLCAweDBBLCAweDBBLCAweDBBLAogICAgMHgwOSwgMHgwOSwgMHgwOSwgMHgwOSwgMHgwOSwgMHgwOSwgMHgwOCwgMHgwOCwgMHgwOCwgMHgwOCwgMHgwOCwgMHgwOCwgMHgwNywgMHgwNiwgMHgwNiwgMHgwNSwKICAgIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDIsIDB4MDIsIDB4MDIsIDB4MDIsIDB4MDEsIDB4MDEsIDB4MDEsIDB4MDEsIDB4MDEsIDB4MDEsCiAgICAweDAxLCAweDAxLCAweDAxLCAweDAwCl0pOwpIQ0FUYWJsZXMuQXRoQ3VydmUgPSBuZXcgVWludDhBcnJheShbCiAgICAweDc4LCAweDVGLCAweDU2LCAweDUxLCAweDRFLCAweDRDLCAweDRCLCAweDQ5LCAweDQ4LCAweDQ4LCAweDQ3LCAweDQ2LCAweDQ2LCAweDQ1LCAweDQ1LCAweDQ1LAogICAgMHg0NCwgMHg0NCwgMHg0NCwgMHg0NCwgMHg0MywgMHg0MywgMHg0MywgMHg0MywgMHg0MywgMHg0MywgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwKICAgIDB4NDIsIDB4NDIsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDAsIDB4NDAsIDB4NDAsIDB4NDAsCiAgICAweDQwLCAweDQwLCAweDQwLCAweDQwLCAweDQwLCAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDNGLAogICAgMHgzRiwgMHgzRiwgMHgzRiwgMHgzRSwgMHgzRSwgMHgzRSwgMHgzRSwgMHgzRSwgMHgzRSwgMHgzRCwgMHgzRCwgMHgzRCwgMHgzRCwgMHgzRCwgMHgzRCwgMHgzRCwKICAgIDB4M0MsIDB4M0MsIDB4M0MsIDB4M0MsIDB4M0MsIDB4M0MsIDB4M0MsIDB4M0MsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsCiAgICAweDNCLCAweDNCLCAweDNCLCAweDNCLCAweDNCLCAweDNCLCAweDNCLCAweDNCLCAweDNCLCAweDNCLCAweDNCLCAweDNCLCAweDNCLCAweDNCLCAweDNCLCAweDNCLAogICAgMHgzQiwgMHgzQiwgMHgzQiwgMHgzQiwgMHgzQiwgMHgzQiwgMHgzQiwgMHgzQiwgMHgzQywgMHgzQywgMHgzQywgMHgzQywgMHgzQywgMHgzQywgMHgzQywgMHgzQywKICAgIDB4M0QsIDB4M0QsIDB4M0QsIDB4M0QsIDB4M0QsIDB4M0QsIDB4M0QsIDB4M0QsIDB4M0UsIDB4M0UsIDB4M0UsIDB4M0UsIDB4M0UsIDB4M0UsIDB4M0UsIDB4M0YsCiAgICAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDNGLAogICAgMHgzRiwgMHgzRiwgMHgzRiwgMHgzRiwgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MCwKICAgIDB4NDAsIDB4NDAsIDB4NDAsIDB4NDAsIDB4NDAsIDB4NDAsIDB4NDAsIDB4NDAsIDB4NDAsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsCiAgICAweDQxLCAweDQxLCAweDQxLCAweDQxLCAweDQxLCAweDQxLCAweDQxLCAweDQxLCAweDQxLCAweDQxLCAweDQxLCAweDQxLCAweDQxLCAweDQxLCAweDQxLCAweDQxLAogICAgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwKICAgIDB4NDIsIDB4NDIsIDB4NDIsIDB4NDIsIDB4NDIsIDB4NDIsIDB4NDIsIDB4NDIsIDB4NDIsIDB4NDIsIDB4NDIsIDB4NDIsIDB4NDIsIDB4NDMsIDB4NDMsIDB4NDMsCiAgICAweDQzLCAweDQzLCAweDQzLCAweDQzLCAweDQzLCAweDQzLCAweDQzLCAweDQzLCAweDQzLCAweDQzLCAweDQzLCAweDQzLCAweDQzLCAweDQzLCAweDQ0LCAweDQ0LAogICAgMHg0NCwgMHg0NCwgMHg0NCwgMHg0NCwgMHg0NCwgMHg0NCwgMHg0NCwgMHg0NCwgMHg0NCwgMHg0NCwgMHg0NCwgMHg0NCwgMHg0NSwgMHg0NSwgMHg0NSwgMHg0NSwKICAgIDB4NDUsIDB4NDUsIDB4NDUsIDB4NDUsIDB4NDUsIDB4NDUsIDB4NDUsIDB4NDUsIDB4NDYsIDB4NDYsIDB4NDYsIDB4NDYsIDB4NDYsIDB4NDYsIDB4NDYsIDB4NDYsCiAgICAweDQ2LCAweDQ2LCAweDQ3LCAweDQ3LCAweDQ3LCAweDQ3LCAweDQ3LCAweDQ3LCAweDQ3LCAweDQ3LCAweDQ3LCAweDQ3LCAweDQ4LCAweDQ4LCAweDQ4LCAweDQ4LAogICAgMHg0OCwgMHg0OCwgMHg0OCwgMHg0OCwgMHg0OSwgMHg0OSwgMHg0OSwgMHg0OSwgMHg0OSwgMHg0OSwgMHg0OSwgMHg0OSwgMHg0QSwgMHg0QSwgMHg0QSwgMHg0QSwKICAgIDB4NEEsIDB4NEEsIDB4NEEsIDB4NEEsIDB4NEIsIDB4NEIsIDB4NEIsIDB4NEIsIDB4NEIsIDB4NEIsIDB4NEIsIDB4NEMsIDB4NEMsIDB4NEMsIDB4NEMsIDB4NEMsCiAgICAweDRDLCAweDRELCAweDRELCAweDRELCAweDRELCAweDRELCAweDRELCAweDRFLCAweDRFLCAweDRFLCAweDRFLCAweDRFLCAweDRFLCAweDRGLCAweDRGLCAweDRGLAogICAgMHg0RiwgMHg0RiwgMHg0RiwgMHg1MCwgMHg1MCwgMHg1MCwgMHg1MCwgMHg1MCwgMHg1MSwgMHg1MSwgMHg1MSwgMHg1MSwgMHg1MSwgMHg1MiwgMHg1MiwgMHg1MiwKICAgIDB4NTIsIDB4NTIsIDB4NTMsIDB4NTMsIDB4NTMsIDB4NTMsIDB4NTQsIDB4NTQsIDB4NTQsIDB4NTQsIDB4NTQsIDB4NTUsIDB4NTUsIDB4NTUsIDB4NTUsIDB4NTYsCiAgICAweDU2LCAweDU2LCAweDU2LCAweDU3LCAweDU3LCAweDU3LCAweDU3LCAweDU3LCAweDU4LCAweDU4LCAweDU4LCAweDU5LCAweDU5LCAweDU5LCAweDU5LCAweDVBLAogICAgMHg1QSwgMHg1QSwgMHg1QSwgMHg1QiwgMHg1QiwgMHg1QiwgMHg1QiwgMHg1QywgMHg1QywgMHg1QywgMHg1RCwgMHg1RCwgMHg1RCwgMHg1RCwgMHg1RSwgMHg1RSwKICAgIDB4NUUsIDB4NUYsIDB4NUYsIDB4NUYsIDB4NjAsIDB4NjAsIDB4NjAsIDB4NjEsIDB4NjEsIDB4NjEsIDB4NjEsIDB4NjIsIDB4NjIsIDB4NjIsIDB4NjMsIDB4NjMsCiAgICAweDYzLCAweDY0LCAweDY0LCAweDY0LCAweDY1LCAweDY1LCAweDY2LCAweDY2LCAweDY2LCAweDY3LCAweDY3LCAweDY3LCAweDY4LCAweDY4LCAweDY4LCAweDY5LAogICAgMHg2OSwgMHg2QSwgMHg2QSwgMHg2QSwgMHg2QiwgMHg2QiwgMHg2QiwgMHg2QywgMHg2QywgMHg2RCwgMHg2RCwgMHg2RCwgMHg2RSwgMHg2RSwgMHg2RiwgMHg2RiwKICAgIDB4NzAsIDB4NzAsIDB4NzAsIDB4NzEsIDB4NzEsIDB4NzIsIDB4NzIsIDB4NzMsIDB4NzMsIDB4NzMsIDB4NzQsIDB4NzQsIDB4NzUsIDB4NzUsIDB4NzYsIDB4NzYsCiAgICAweDc3LCAweDc3LCAweDc4LCAweDc4LCAweDc4LCAweDc5LCAweDc5LCAweDdBLCAweDdBLCAweDdCLCAweDdCLCAweDdDLCAweDdDLCAweDdELCAweDdELCAweDdFLAogICAgMHg3RSwgMHg3RiwgMHg3RiwgMHg4MCwgMHg4MCwgMHg4MSwgMHg4MSwgMHg4MiwgMHg4MywgMHg4MywgMHg4NCwgMHg4NCwgMHg4NSwgMHg4NSwgMHg4NiwgMHg4NiwKICAgIDB4ODcsIDB4ODgsIDB4ODgsIDB4ODksIDB4ODksIDB4OEEsIDB4OEEsIDB4OEIsIDB4OEMsIDB4OEMsIDB4OEQsIDB4OEQsIDB4OEUsIDB4OEYsIDB4OEYsIDB4OTAsCiAgICAweDkwLCAweDkxLCAweDkyLCAweDkyLCAweDkzLCAweDk0LCAweDk0LCAweDk1LCAweDk1LCAweDk2LCAweDk3LCAweDk3LCAweDk4LCAweDk5LCAweDk5LCAweDlBLAogICAgMHg5QiwgMHg5QiwgMHg5QywgMHg5RCwgMHg5RCwgMHg5RSwgMHg5RiwgMHhBMCwgMHhBMCwgMHhBMSwgMHhBMiwgMHhBMiwgMHhBMywgMHhBNCwgMHhBNSwgMHhBNSwKICAgIDB4QTYsIDB4QTcsIDB4QTcsIDB4QTgsIDB4QTksIDB4QUEsIDB4QUEsIDB4QUIsIDB4QUMsIDB4QUQsIDB4QUUsIDB4QUUsIDB4QUYsIDB4QjAsIDB4QjEsIDB4QjEsCiAgICAweEIyLCAweEIzLCAweEI0LCAweEI1LCAweEI2LCAweEI2LCAweEI3LCAweEI4LCAweEI5LCAweEJBLCAweEJBLCAweEJCLCAweEJDLCAweEJELCAweEJFLCAweEJGLAogICAgMHhDMCwgMHhDMSwgMHhDMSwgMHhDMiwgMHhDMywgMHhDNCwgMHhDNSwgMHhDNiwgMHhDNywgMHhDOCwgMHhDOSwgMHhDOSwgMHhDQSwgMHhDQiwgMHhDQywgMHhDRCwKICAgIDB4Q0UsIDB4Q0YsIDB4RDAsIDB4RDEsIDB4RDIsIDB4RDMsIDB4RDQsIDB4RDUsIDB4RDYsIDB4RDcsIDB4RDgsIDB4RDksIDB4REEsIDB4REIsIDB4REMsIDB4REQsCiAgICAweERFLCAweERGLCAweEUwLCAweEUxLCAweEUyLCAweEUzLCAweEU0LCAweEU1LCAweEU2LCAweEU3LCAweEU4LCAweEU5LCAweEVBLCAweEVCLCAweEVELCAweEVFLAogICAgMHhFRiwgMHhGMCwgMHhGMSwgMHhGMiwgMHhGMywgMHhGNCwgMHhGNSwgMHhGNywgMHhGOCwgMHhGOSwgMHhGQSwgMHhGQiwgMHhGQywgMHhGRApdKTsKSENBVGFibGVzLk1kY3RXaW5kb3cgPSBuZXcgRmxvYXQ2NEFycmF5KF9hJDEuYWRhcHRFbmRpYW5uZXNzNjQzMihuZXcgVWludDMyQXJyYXkoWwogICAgMHgwMDAwMDAwMCwgMHgzRjQ2QTA5RSwgMHgwMDAwMDAwMCwgMHgzRjYwMzA3NywgMHgwMDAwMDAwMCwgMHgzRjZFMThBNywgMHgwMDAwMDAwMCwgMHgzRjc3NzI0RCwKICAgIDB4MjAwMDAwMDAsIDB4M0Y4MDk1MDEsIDB4MDAwMDAwMDAsIDB4M0Y4NjEwNDAsIDB4ODAwMDAwMDAsIDB4M0Y4QzI1MDksIDB4RTAwMDAwMDAsIDB4M0Y5MTY3RTIsCiAgICAweDQwMDAwMDAwLCAweDNGOTUwNzMyLCAweEEwMDAwMDAwLCAweDNGOThFRkY3LCAweDAwMDAwMDAwLCAweDNGOUQyMjIyLCAweEEwMDAwMDAwLCAweDNGQTBDRUY5LAogICAgMHg4MDAwMDAwMCwgMHgzRkEzMzFGOCwgMHg4MDAwMDAwMCwgMHgzRkE1QkE2QiwgMHg2MDAwMDAwMCwgMHgzRkE4NjhDOCwgMHgyMDAwMDAwMCwgMHgzRkFCM0Q5OCwKICAgIDB4MDAwMDAwMDAsIDB4M0ZBRTM5NzUsIDB4QzAwMDAwMDAsIDB4M0ZCMEFFODMsIDB4NjAwMDAwMDAsIDB4M0ZCMjU0ODIsIDB4ODAwMDAwMDAsIDB4M0ZCNDBGMTYsCiAgICAweDQwMDAwMDAwLCAweDNGQjVERUE0LCAweEMwMDAwMDAwLCAweDNGQjdDMzkzLCAweDYwMDAwMDAwLCAweDNGQjlCRTRGLCAweEEwMDAwMDAwLCAweDNGQkJDRjQzLAogICAgMHhBMDAwMDAwMCwgMHgzRkJERjZERCwgMHg2MDAwMDAwMCwgMHgzRkMwMUFDNSwgMHg0MDAwMDAwMCwgMHgzRkMxNDVEQiwgMHg0MDAwMDAwMCwgMHgzRkMyN0NFNSwKICAgIDB4MjAwMDAwMDAsIDB4M0ZDM0MwMTYsIDB4NDAwMDAwMDAsIDB4M0ZDNTBGOUUsIDB4QTAwMDAwMDAsIDB4M0ZDNjZCQUEsIDB4MjAwMDAwMDAsIDB4M0ZDN0Q0NjQsCiAgICAweEEwMDAwMDAwLCAweDNGQzk0OUVFLCAweEUwMDAwMDAwLCAweDNGQ0FDQzY3LCAweEUwMDAwMDAwLCAweDNGQ0M1QkU2LCAweDIwMDAwMDAwLCAweDNGQ0RGODdBLAogICAgMHgwMDAwMDAwMCwgMHgzRkNGQTIyNywgMHg0MDAwMDAwMCwgMHgzRkQwQUM3NCwgMHhFMDAwMDAwMCwgMHgzRkQxOEU1NiwgMHgyMDAwMDAwMCwgMHgzRkQyNzZBQywKICAgIDB4RTAwMDAwMDAsIDB4M0ZEMzY1NUQsIDB4RTAwMDAwMDAsIDB4M0ZENDVBNEQsIDB4NjAwMDAwMDAsIDB4M0ZENTU1NTUsIDB4NDAwMDAwMDAsIDB4M0ZENjU2NDQsCiAgICAweEMwMDAwMDAwLCAweDNGRDc1Q0UwLCAweEUwMDAwMDAwLCAweDNGRDg2OEU2LCAweEEwMDAwMDAwLCAweDNGRDk3QTA3LCAweEMwMDAwMDAwLCAweDNGREE4RkU4LAogICAgMHgwMDAwMDAwMCwgMHgzRkRCQUEyNSwgMHg4MDAwMDAwMCwgMHgzRkRDQzg0QiwgMHhFMDAwMDAwMCwgMHgzRkRERTlERiwgMHhFMDAwMDAwMCwgMHgzRkRGMEU1QSwKICAgIDB4MjAwMDAwMDAsIDB4M0ZFMDFBOTUsIDB4NDAwMDAwMDAsIDB4M0ZFMEFFRDksIDB4NjAwMDAwMDAsIDB4M0ZFMTQzQTcsIDB4MDAwMDAwMDAsIDB4M0ZFMUQ4QTksCiAgICAweEEwMDAwMDAwLCAweDNGRTI2RDg0LCAweDQwMDAwMDAwLCAweDNGRTMwMURFLCAweDQwMDAwMDAwLCAweDNGRTM5NTU4LCAweDQwMDAwMDAwLCAweDNGRTQyNzk0LAogICAgMHhBMDAwMDAwMCwgMHgzRkU0QjgzNCwgMHhFMDAwMDAwMCwgMHgzRkU1NDZEQywgMHgwMDAwMDAwMCwgMHgzRkU1RDMzMywgMHhBMDAwMDAwMCwgMHgzRkU2NUNFMCwKICAgIDB4QzAwMDAwMDAsIDB4M0ZFNkUzOTMsIDB4QzAwMDAwMDAsIDB4M0ZFNzY2RkYsIDB4NDAwMDAwMDAsIDB4M0ZFN0U2REUsIDB4MDAwMDAwMDAsIDB4M0ZFODYyRjAsCiAgICAweEMwMDAwMDAwLCAweDNGRThEQUZDLCAweDgwMDAwMDAwLCAweDNGRTk0RUQ0LCAweDgwMDAwMDAwLCAweDNGRTlCRTRGLCAweEUwMDAwMDAwLCAweDNGRUEyOTRELAogICAgMHhBMDAwMDAwMCwgMHgzRkVBOEZCOCwgMHg2MDAwMDAwMCwgMHgzRkVBRjE4MCwgMHhDMDAwMDAwMCwgMHgzRkVCNEU5RCwgMHhFMDAwMDAwMCwgMHgzRkVCQTcxMCwKICAgIDB4RTAwMDAwMDAsIDB4M0ZFQkZBRTAsIDB4NDAwMDAwMDAsIDB4M0ZFQzRBMUIsIDB4MjAwMDAwMDAsIDB4M0ZFQzk0RDMsIDB4MDAwMDAwMDAsIDB4M0ZFQ0RCMjEsCiAgICAweEMwMDAwMDAwLCAweDNGRUQxRDIxLCAweDIwMDAwMDAwLCAweDNGRUQ1QUY2LCAweDIwMDAwMDAwLCAweDNGRUQ5NEMyLCAweDQwMDAwMDAwLCAweDNGRURDQUFDLAogICAgMHhFMDAwMDAwMCwgMHgzRkVERkNEQywgMHhFMDAwMDAwMCwgMHgzRkVFMkI3RCwgMHgyMDAwMDAwMCwgMHgzRkVFNTZCQSwgMHhDMDAwMDAwMCwgMHgzRkVFN0VCQywKICAgIDB4MjAwMDAwMDAsIDB4M0ZFRUEzQjEsIDB4NjAwMDAwMDAsIDB4M0ZFRUM1QzIsIDB4RTAwMDAwMDAsIDB4M0ZFRUU1MUEsIDB4MDAwMDAwMDAsIDB4M0ZFRjAxRTQsCiAgICAweDgwMDAwMDAwLCAweDNGRUYxQzQ2LCAweDgwMDAwMDAwLCAweDNGRUYzNDY5LCAweEUwMDAwMDAwLCAweDNGRUY0QTcyLCAweDIwMDAwMDAwLCAweDNGRUY1RTg3LAogICAgMHgwMDAwMDAwMCwgMHgzRkVGNzBDOSwgMHhDMDAwMDAwMCwgMHgzRkVGODE1OSwgMHgwMDAwMDAwMCwgMHgzRkVGOTA1OSwgMHhDMDAwMDAwMCwgMHgzRkVGOURFNCwKICAgIDB4NjAwMDAwMDAsIDB4M0ZFRkFBMTksIDB4QzAwMDAwMDAsIDB4M0ZFRkI1MTEsIDB4RTAwMDAwMDAsIDB4M0ZFRkJFRTYsIDB4QzAwMDAwMDAsIDB4M0ZFRkM3QjAsCiAgICAweDQwMDAwMDAwLCAweDNGRUZDRjg1LCAweDgwMDAwMDAwLCAweDNGRUZENjc5LCAweEUwMDAwMDAwLCAweDNGRUZEQ0EwLCAweDgwMDAwMDAwLCAweDNGRUZFMjBELAogICAgMHg2MDAwMDAwMCwgMHgzRkVGRTZEMCwgMHg0MDAwMDAwMCwgMHgzRkVGRUFGOSwgMHhDMDAwMDAwMCwgMHgzRkVGRUU5NiwgMHhDMDAwMDAwMCwgMHgzRkVGRjFCNiwKICAgIDB4QzAwMDAwMDAsIDB4M0ZFRkY0NjUsIDB4NjAwMDAwMDAsIDB4M0ZFRkY2QUYsIDB4QzAwMDAwMDAsIDB4M0ZFRkY4OUUsIDB4QTAwMDAwMDAsIDB4M0ZFRkZBM0QsCiAgICAweEEwMDAwMDAwLCAweDNGRUZGQjk1LCAweDIwMDAwMDAwLCAweDNGRUZGQ0FGLCAweDAwMDAwMDAwLCAweDNGRUZGRDkyLCAweEMwMDAwMDAwLCAweDNGRUZGRTQ1LAogICAgMHgwMDAwMDAwMCwgMHgzRkVGRkVEMSwgMHgwMDAwMDAwMCwgMHgzRkVGRkYzQSwgMHg0MDAwMDAwMCwgMHgzRkVGRkY4NiwgMHg0MDAwMDAwMCwgMHgzRkVGRkZCQiwKICAgIDB4QTAwMDAwMDAsIDB4M0ZFRkZGREQsIDB4RTAwMDAwMDAsIDB4M0ZFRkZGRjEsIDB4RTAwMDAwMDAsIDB4M0ZFRkZGRkIsIDB4ODAwMDAwMDAsIDB4M0ZFRkZGRkYKXSkpLmJ1ZmZlcik7CkhDQVRhYmxlcy5EZWZhdWx0Q2hhbm5lbE1hcHBpbmcgPSBuZXcgVWludDhBcnJheShbCiAgICAweDAwLCAweDAxLCAweDAwLCAweDA0LCAweDAwLCAweDAxLCAweDAzLCAweDA3LCAweDAzCl0pOwpIQ0FUYWJsZXMuVmFsaWRDaGFubmVsTWFwcGluZ3MgPSBbCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMSwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMSwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMSwgMHgwMSwgMHgwMCwgMHgwMSwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMSwgMHgwMCwgMHgwMCwgMHgwMSwgMHgwMCwgMHgwMSwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMSwgMHgwMSwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMQogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMSwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMQogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMSwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCl07CkhDQVRhYmxlcy5EZXF1YW50aXplclNjYWxpbmdUYWJsZSA9IG5ldyBGbG9hdDY0QXJyYXkoX2EkMS5hZGFwdEVuZGlhbm5lc3M2NDMyKG5ldyBVaW50MzJBcnJheShbCiAgICAweENBNUQ5MjAxLCAweDNFODU1MUE0LCAweDJFNTdEMTM5LCAweDNFOEM2N0YxLCAweEE5M0UyRjRBLCAweDNFOTJFQ0FGLCAweEIwQ0RDNUQ1LCAweDNFOTkzNzM3LAogICAgMHgyQjcyNDdFRCwgMHgzRUEwQ0M5MiwgMHg4MjU1MjIxNywgMHgzRUE2NjIzOCwgMHhGMzAxQjQ0RiwgMHgzRUFERDMyMSwgMHg0QzEyMzQxNiwgMHgzRUIzREVBNiwKICAgIDB4MTMzMEIzNDksIDB4M0VCQTc5OUUsIDB4RUI2RkNCNkMsIDB4M0VDMUEzNUIsIDB4NEZERTVEMzMsIDB4M0VDNzgwNjksIDB4NUI2RTQ1MkYsIDB4M0VDRjUwNzYsCiAgICAweDk5RkRERDAzLCAweDNFRDREQ0IyLCAweDkwNEJDMUMzLCAweDNFREJDQzFFLCAweEUxRjU2Mzc4LCAweDNFRTI4NERGLCAweDQyMkFBMENGLCAweDNFRThBQ0U1LAogICAgMHgyOURERjZENiwgMHgzRUYwNzA2QiwgMHgxNUFEMjEzRSwgMHgzRUY1RTc2RiwgMHgwODBEODlFMywgMHgzRUZEMkY4NywgMHgzNzNBQTlDMiwgMHgzRjAzNzFBNywKICAgIDB4MTlFMzIzMTgsIDB4M0YwOUU4NjMsIDB4QUVBOTJERDgsIDB4M0YxMTQyOUEsIDB4Rjk1MTk0N0IsIDB4M0YxNkZGN0QsIDB4QTJBNDkwQ0QsIDB4M0YxRUE0QUYsCiAgICAweEVEMUQwMDUwLCAweDNGMjQ2QTQxLCAweEI4NEYxNUYwLCAweDNGMkIzM0EyLCAweDkxN0REQzkwLCAweDNGMzIxRjQ5LCAweDk5NENDRTBBLCAweDNGMzgyNTg5LAogICAgMHhBOUZCMzMyRiwgMHgzRjQwMTYzRCwgMHgzNkI1MjdEMywgMHgzRjQ1NkY0NywgMHg5NDA2RTdBQywgMHgzRjRDOEY2RCwgMHgwQTMxQjcwRiwgMHgzRjUzMDZGRSwKICAgIDB4Q0JDODUyMDcsIDB4M0Y1OTVBNDQsIDB4MzJEM0QxOUQsIDB4M0Y2MEUzRUMsIDB4RDQ0Q0E5NkMsIDB4M0Y2NjgxNTUsIDB4MzM3QjlCNTYsIDB4M0Y2REZDOTcsCiAgICAweDA0QUM4MDE2LCAweDNGNzNGQTQ1LCAweDU1NzlGREI4LCAweDNGN0E5RTZCLCAweDg0MDQ1Q0NGLCAweDNGODFCQkUwLCAweDczRUIwMTgxLCAweDNGODdBMTE0LAogICAgMHhBRDlDQkUwQywgMHgzRjhGN0JGRCwgMHg3NjlEMkNBMiwgMHgzRjk0RjlCMiwgMHg1QkQ3MUUwMywgMHgzRjlCRjJDMiwgMHhGNTFGREVERSwgMHgzRkEyOUU5RCwKICAgIDB4MTZCNTQ0ODcsIDB4M0ZBOENGMzIsIDB4MTg3NTlCQzUsIDB4M0ZCMDg3NDUsIDB4Qjk3NkRDMDUsIDB4M0ZCNjA1RTEsIDB4RENGQkE0ODMsIDB4M0ZCRDU4MTgsCiAgICAweDZEMDVEODYzLCAweDNGQzM4Q0FFLCAweDdCNURFNTYxLCAweDNGQ0EwQzY2LCAweEM4QTU4RTRGLCAweDNGRDE1QTk4LCAweEU4RUM1RjcxLCAweDNGRDcxRjc1LAogICAgMHgyRDhFNjdFRCwgMHgzRkRFQ0Y0OCwgMHhCNUMxM0NDRSwgMHgzRkU0ODZBMiwgMHg4REU1NTkzOCwgMHgzRkVCNTk3MiwgMHg2RTc1NjIzNywgMHgzRkYyMzg3QSwKICAgIDB4NDYyM0M3QUMsIDB4M0ZGODQ3MUEsIDB4M0U3NzgwNjAsIDB4NDAwMDJDOUEsIDB4RDQ5N0M3RkQsIDB4NDAwNThEMTIsIDB4RENFRjkwNjgsIDB4NDAwQ0I3MjAsCiAgICAweEZDNENEODMxLCAweDQwMTMyMTcwLCAweDlGREU0RTUwLCAweDQwMTk3RDgyLCAweEFGRkVEMzFCLCAweDQwMjBGQjY2LCAweDY2N0YzQkNELCAweDQwMjZBMDlFCl0pKS5idWZmZXIpOwpIQ0FUYWJsZXMuUXVhbnRpemVyU3RlcFNpemUgPSBuZXcgRmxvYXQ2NEFycmF5KF9hJDEuYWRhcHRFbmRpYW5uZXNzNjQzMihuZXcgVWludDMyQXJyYXkoWwogICAgMHgwMDAwMDAwMCwgMHgwMDAwMDAwMCwgMHg1NTU1NTU1NSwgMHgzRkU1NTU1NSwgMHg5OTk5OTk5QSwgMHgzRkQ5OTk5OSwgMHg5MjQ5MjQ5MiwgMHgzRkQyNDkyNCwKICAgIDB4MUM3MUM3MUMsIDB4M0ZDQzcxQzcsIDB4NzQ1RDE3NDYsIDB4M0ZDNzQ1RDEsIDB4MTNCMTNCMTQsIDB4M0ZDM0IxM0IsIDB4MTExMTExMTEsIDB4M0ZDMTExMTEsCiAgICAweDA4NDIxMDg0LCAweDNGQjA4NDIxLCAweDEwNDEwNDEwLCAweDNGQTA0MTA0LCAweDgxMDIwNDA4LCAweDNGOTAyMDQwLCAweDEwMTAxMDEwLCAweDNGODAxMDEwLAogICAgMHgwMjAxMDA4MCwgMHgzRjcwMDgwNCwgMHgwMDQwMTAwNCwgMHgzRjYwMDQwMSwgMHg0MDA4MDEwMCwgMHgzRjUwMDIwMCwgMHgxMDAxMDAxMCwgMHgzRjQwMDEwMApdKSkuYnVmZmVyKTsKSENBVGFibGVzLlF1YW50aXplckRlYWRab25lID0gbmV3IEZsb2F0NjRBcnJheShfYSQxLmFkYXB0RW5kaWFubmVzczY0MzIobmV3IFVpbnQzMkFycmF5KFsKICAgIDB4RkZGRkZGRkYsIDB4RkZGRkZGRkYsIDB4NTU1NTU1NTMsIDB4M0ZENTU1NTUsIDB4OTk5OTk5OTcsIDB4M0ZDOTk5OTksIDB4OTI0OTI0OEUsIDB4M0ZDMjQ5MjQsCiAgICAweDFDNzFDNzE3LCAweDNGQkM3MUM3LCAweDc0NUQxNzQwLCAweDNGQjc0NUQxLCAweDEzQjEzQjBELCAweDNGQjNCMTNCLCAweDExMTExMTA5LCAweDNGQjExMTExLAogICAgMHgwODQyMTA3NCwgMHgzRkEwODQyMSwgMHgxMDQxMDNGMCwgMHgzRjkwNDEwNCwgMHg4MTAyMDNDOCwgMHgzRjgwMjA0MCwgMHgxMDEwMEY5MCwgMHgzRjcwMTAxMCwKICAgIDB4MDIwMEZGODAsIDB4M0Y2MDA4MDQsIDB4MDA0MDBFMDQsIDB4M0Y1MDA0MDEsIDB4NDAwN0ZEMDAsIDB4M0Y0MDAyMDAsIDB4MTAwMEY4MTAsIDB4M0YzMDAxMDAKXSkpLmJ1ZmZlcik7CkhDQVRhYmxlcy5RdWFudGl6ZXJTY2FsaW5nVGFibGUgPSBuZXcgRmxvYXQ2NEFycmF5KF9hJDEuYWRhcHRFbmRpYW5uZXNzNjQzMihuZXcgVWludDMyQXJyYXkoWwogICAgMHg1NDNFMUEyMSwgMHg0MTU4MDQyNywgMHg4ODYyOENFMiwgMHg0MTUyMDYzQiwgMHgyOThEQjY3NywgMHg0MTRCMEUwNywgMHg2MDYxODkzQSwgMHg0MTQ0NEUwOCwKICAgIDB4RkJDNzRDOTYsIDB4NDEzRTdBNTEsIDB4M0M2NTFBM0QsIDB4NDEzNkRGQjIsIDB4QzA2QzMxRDYsIDB4NDEzMTJBQkQsIDB4ODJBM0YwQTAsIDB4NDEyOUM0OTEsCiAgICAweDVGOTI5RkZDLCAweDQxMjM1NkM1LCAweDRBMDc4OThCLCAweDQxMUQwNzJELCAweDhBNTk0NkMyLCAweDQxMTVDOTI2LCAweEQzMTU4NTdELCAweDQxMTA1OUIwLAogICAgMHhEOThBNjZBNiwgMHg0MTA4OEFDNywgMHg2NUUyN0NFNywgMHg0MTAyNkI0NSwgMHgzMEExMDY1NiwgMHg0MEZCQTVCMCwgMHhENTM2MkEzMiwgMHg0MEY0QkZEQSwKICAgIDB4Mzc2QkJBQTYsIDB4NDBFRjI1MkIsIDB4NTY0MjY3RDQsIDB4NDBFNzVGRUIsIDB4Mzg4QzhERjIsIDB4NDBFMThBRjksIDB4QjIzRTI1NjgsIDB4NDBEQTU1MDMsCiAgICAweEMzMTNBOEVELCAweDQwRDNDMzJELCAweDAzREIzMjkzLCAweDQwQ0RBOUU2LCAweDM0Q0NDMzI4LCAweDQwQzY0MzQ2LCAweDZDRjk4OTE2LCAweDQwQzBCNTU4LAogICAgMHgwQjkxRkZDRiwgMHg0MEI5MTQ1QiwgMHhBNkU0MDMxMywgMHg0MEIyRDI4NSwgMHg1RkZGRDA4NCwgMHg0MEFDNDBBQiwgMHg1NjlENEY4OSwgMHg0MEE1MzQyQiwKICAgIDB4MkI4RjcxRkUsIDB4NDA5RkQzQzIsIDB4MzZDRjRFNkEsIDB4NDA5N0UyRjMsIDB4MjJGQ0Q5MjIsIDB4NDA5MUVENTAsIDB4OTk1QUQzQjYsIDB4NDA4QUU4OUYsCiAgICAweEQ5NTBBODlELCAweDQwODQzMUY1LCAweEU3OEIzRkZGLCAweDQwN0U1MDJFLCAweDc1MEJEQUM2LCAweDQwNzZDMDEyLCAweEQwMTI1QjU2LCAweDQwNzExMzAxLAogICAgMHg3MENBMDdDMSwgMHg0MDY5QTBGMSwgMHhCMjY0MTcwNSwgMHg0MDYzM0MwOCwgMHg1NTVEQzQwMSwgMHg0MDVDREYwQiwgMHhERDQ4NTQyRiwgMHg0MDU1QUIwNywKICAgIDB4RTg2RTdGODksIDB4NDA1MDQzMTUsIDB4OUI0NDkyRjIsIDB4NDA0ODY4RDksIDB4NEZCMkE2NDMsIDB4NDA0MjUxQ0UsIDB4RjJGQjVFNEMsIDB4NDAzQjdGNzYsCiAgICAweEYwRDdEM0UzLCAweDQwMzRBMzJBLCAweEVFNjE1QTJELCAweDQwMkVGQTFCLCAweDQ4QTU4MTc4LCAweDQwMjczRjlBLCAweDNDN0Q1MTdELCAweDQwMjE3MkI4LAogICAgMHhFQzRBMkQzNywgMHg0MDFBMzA5QiwgMHgzNEU1OUZGQSwgMHg0MDEzQTdEQiwgMHgxNkM5ODM5QiwgMHg0MDBEODBFMywgMHhCMDNBNTU4NywgMHg0MDA2MjQ3RSwKICAgIDB4Q0FDNkYzODUsIDB4NDAwMDlFM0UsIDB4OTkxNTc3MzksIDB4M0ZGOEYxQUUsIDB4RDBEQUQ5OTEsIDB4M0ZGMkI4N0YsIDB4REQ4NTUyOUUsIDB4M0ZFQzE5OUIsCiAgICAweEEyQ0Y2NjQyLCAweDNGRTUxNkRBLCAweDgxOUU5MERBLCAweDNGREZBN0MxLCAweDAxMzBDMTMzLCAweDNGRDdDMUVELCAweDMxNjhCOUFCLCAweDNGRDFENDg3LAogICAgMHhCRkQzRjM3QSwgMHgzRkNBQzM2QiwgMHgyMUY3MkUyQSwgMHgzRkM0MTYwQSwgMHgxNEY1QTEyOSwgMHgzRkJFMjY0NiwgMHg2NjdGM0JDQywgMHgzRkI2QTA5RQpdKSkuYnVmZmVyKTsKSENBVGFibGVzLlF1YW50aXplckludmVyc2VTdGVwU2l6ZSA9IG5ldyBGbG9hdDY0QXJyYXkoX2EkMS5hZGFwdEVuZGlhbm5lc3M2NDMyKG5ldyBVaW50MzJBcnJheShbCiAgICAweDAwMDAwMDAwLCAweDNGRTAwMDAwLCAweDAwMDAwMDAwLCAweDNGRjgwMDAwLCAweDAwMDAwMDAwLCAweDQwMDQwMDAwLCAweDAwMDAwMDAwLCAweDQwMEMwMDAwLAogICAgMHgwMDAwMDAwMCwgMHg0MDEyMDAwMCwgMHgwMDAwMDAwMCwgMHg0MDE2MDAwMCwgMHgwMDAwMDAwMCwgMHg0MDFBMDAwMCwgMHgwMDAwMDAwMCwgMHg0MDFFMDAwMCwKICAgIDB4MDAwMDAwMDAsIDB4NDAyRjAwMDAsIDB4MDAwMDAwMDAsIDB4NDAzRjgwMDAsIDB4MDAwMDAwMDAsIDB4NDA0RkMwMDAsIDB4MDAwMDAwMDAsIDB4NDA1RkUwMDAsCiAgICAweDAwMDAwMDAwLCAweDQwNkZGMDAwLCAweDAwMDAwMDAwLCAweDQwN0ZGODAwLCAweDAwMDAwMDAwLCAweDQwOEZGQzAwLCAweDAwMDAwMDAwLCAweDQwOUZGRTAwCl0pKS5idWZmZXIpOwpIQ0FUYWJsZXMuUmVzb2x1dGlvbk1heFZhbHVlcyA9IG5ldyBJbnQzMkFycmF5KFsKICAgIDB4MDAwMDAwMDAsIDB4MDAwMDAwMDEsIDB4MDAwMDAwMDIsIDB4MDAwMDAwMDMsIDB4MDAwMDAwMDQsIDB4MDAwMDAwMDUsIDB4MDAwMDAwMDYsIDB4MDAwMDAwMDcsCiAgICAweDAwMDAwMDBGLCAweDAwMDAwMDFGLCAweDAwMDAwMDNGLCAweDAwMDAwMDdGLCAweDAwMDAwMEZGLCAweDAwMDAwMUZGLCAweDAwMDAwM0ZGLCAweDAwMDAwN0ZGCl0pOwpIQ0FUYWJsZXMuSW50ZW5zaXR5UmF0aW9UYWJsZSA9IG5ldyBGbG9hdDY0QXJyYXkoX2EkMS5hZGFwdEVuZGlhbm5lc3M2NDMyKG5ldyBVaW50MzJBcnJheShbCiAgICAweDAwMDAwMDAwLCAweDQwMDAwMDAwLCAweDZEQjZEQjZFLCAweDNGRkRCNkRCLCAweERCNkRCNkRCLCAweDNGRkI2REI2LCAweDQ5MjQ5MjQ5LCAweDNGRjkyNDkyLAogICAgMHhCNkRCNkRCNywgMHgzRkY2REI2RCwgMHgyNDkyNDkyNSwgMHgzRkY0OTI0OSwgMHg5MjQ5MjQ5MiwgMHgzRkYyNDkyNCwgMHgwMDAwMDAwMCwgMHgzRkYwMDAwMCwKICAgIDB4REI2REI2REIsIDB4M0ZFQjZEQjYsIDB4QjZEQjZEQjcsIDB4M0ZFNkRCNkQsIDB4OTI0OTI0OTIsIDB4M0ZFMjQ5MjQsIDB4REI2REI2REIsIDB4M0ZEQjZEQjYsCiAgICAweDkyNDkyNDkyLCAweDNGRDI0OTI0LCAweDkyNDkyNDkyLCAweDNGQzI0OTI0LCAweDAwMDAwMDAwLCAweDAwMDAwMDAwCl0pKS5idWZmZXIpOwpIQ0FUYWJsZXMuSW50ZW5zaXR5UmF0aW9Cb3VuZHNUYWJsZSA9IG5ldyBGbG9hdDY0QXJyYXkoX2EkMS5hZGFwdEVuZGlhbm5lc3M2NDMyKG5ldyBVaW50MzJBcnJheShbCiAgICAweEI2REI2REI3LCAweDNGRkVEQjZELCAweDI0OTI0OTI1LCAweDNGRkM5MjQ5LCAweDkyNDkyNDkyLCAweDNGRkE0OTI0LCAweDAwMDAwMDAwLCAweDNGRjgwMDAwLAogICAgMHg2REI2REI2RSwgMHgzRkY1QjZEQiwgMHhEQjZEQjZEQiwgMHgzRkYzNkRCNiwgMHg0OTI0OTI0OSwgMHgzRkYxMjQ5MiwgMHg2REI2REI2RSwgMHgzRkVEQjZEQiwKICAgIDB4NDkyNDkyNDksIDB4M0ZFOTI0OTIsIDB4MjQ5MjQ5MjUsIDB4M0ZFNDkyNDksIDB4MDAwMDAwMDAsIDB4M0ZFMDAwMDAsIDB4QjZEQjZEQjcsIDB4M0ZENkRCNkQsCiAgICAweERCNkRCNkRCLCAweDNGQ0I2REI2LCAweDkyNDkyNDkyLCAweDNGQjI0OTI0Cl0pKS5idWZmZXIpOwpIQ0FUYWJsZXMuU2NhbGVDb252ZXJzaW9uVGFibGUgPSBuZXcgRmxvYXQ2NEFycmF5KF9hJDEuYWRhcHRFbmRpYW5uZXNzNjQzMihuZXcgVWludDMyQXJyYXkoWwogICAgMHgwMDAwMDAwMCwgMHgwMDAwMDAwMCwgMHgwMDAwMDAwMCwgMHgwMDAwMDAwMCwgMHgyMUY3MkUxRCwgMHgzRTU0MTYwQSwgMHhCRkQzRjM2OCwgMHgzRTVBQzM2QiwKICAgIDB4MzE2OEI5OUYsIDB4M0U2MUQ0ODcsIDB4MDEzMEMxMjMsIDB4M0U2N0MxRUQsIDB4ODE5RTkwQzQsIDB4M0U2RkE3QzEsIDB4QTJDRjY2MzUsIDB4M0U3NTE2REEsCiAgICAweEREODU1MjhCLCAweDNFN0MxOTlCLCAweEQwREFEOTg1LCAweDNFODJCODdGLCAweDk5MTU3NzI4LCAweDNFODhGMUFFLCAweENBQzZGMzdBLCAweDNFOTA5RTNFLAogICAgMHhCMDNBNTU3OCwgMHgzRTk2MjQ3RSwgMHgxNkM5ODM4OCwgMHgzRTlEODBFMywgMHgzNEU1OUZFQywgMHgzRUEzQTdEQiwgMHhFQzRBMkQyNiwgMHgzRUFBMzA5QiwKICAgIDB4M0M3RDUxNzIsIDB4M0VCMTcyQjgsIDB4NDhBNTgxNjgsIDB4M0VCNzNGOUEsIDB4RUU2MTVBMTgsIDB4M0VCRUZBMUIsIDB4RjBEN0QzRDQsIDB4M0VDNEEzMkEsCiAgICAweEYyRkI1RTNBLCAweDNFQ0I3Rjc2LCAweDRGQjJBNjM3LCAweDNFRDI1MUNFLCAweDlCNDQ5MkUxLCAweDNFRDg2OEQ5LCAweEU4NkU3RjdFLCAweDNFRTA0MzE1LAogICAgMHhERDQ4NTQyMCwgMHgzRUU1QUIwNywgMHg1NTVEQzNFRSwgMHgzRUVDREYwQiwgMHhCMjY0MTZGNywgMHgzRUYzM0MwOCwgMHg3MENBMDdCMCwgMHgzRUY5QTBGMSwKICAgIDB4RDAxMjVCNEEsIDB4M0YwMTEzMDEsIDB4NzUwQkRBQjYsIDB4M0YwNkMwMTIsIDB4RTc4QjNGRUIsIDB4M0YwRTUwMkUsIDB4RDk1MEE4OTAsIDB4M0YxNDMxRjUsCiAgICAweDk5NUFEM0E0LCAweDNGMUFFODlGLCAweDIyRkNEOTE3LCAweDNGMjFFRDUwLCAweDM2Q0Y0RTVBLCAweDNGMjdFMkYzLCAweDJCOEY3MUU3LCAweDNGMkZEM0MyLAogICAgMHg1NjlENEY3QiwgMHgzRjM1MzQyQiwgMHg1RkZGRDA3MiwgMHgzRjNDNDBBQiwgMHhBNkU0MDMwNiwgMHgzRjQyRDI4NSwgMHgwQjkxRkZCRiwgMHgzRjQ5MTQ1QiwKICAgIDB4NkNGOTg5MEIsIDB4M0Y1MEI1NTgsIDB4MzRDQ0MzMUEsIDB4M0Y1NjQzNDYsIDB4MDNEQjMyN0UsIDB4M0Y1REE5RTYsIDB4QzMxM0E4RTAsIDB4M0Y2M0MzMkQsCiAgICAweEIyM0UyNTU3LCAweDNGNkE1NTAzLCAweDM4OEM4REU2LCAweDNGNzE4QUY5LCAweDU2NDI2N0M0LCAweDNGNzc1RkVCLCAweDM3NkJCQTkyLCAweDNGN0YyNTJCLAogICAgMHhENTM2MkEyNCwgMHgzRjg0QkZEQSwgMHgzMEExMDY0NSwgMHgzRjhCQTVCMCwgMHg2NUUyN0NEQSwgMHgzRjkyNkI0NSwgMHhEOThBNjY5NiwgMHgzRjk4OEFDNywKICAgIDB4RDMxNTg1NzIsIDB4M0ZBMDU5QjAsIDB4OEE1OTQ2QjQsIDB4M0ZBNUM5MjYsIDB4NEEwNzg5NzgsIDB4M0ZBRDA3MkQsIDB4NUY5MjlGRUYsIDB4M0ZCMzU2QzUsCiAgICAweDgyQTNGMDhFLCAweDNGQjlDNDkxLCAweEMwNkMzMUNCLCAweDNGQzEyQUJELCAweDNDNjUxQTJELCAweDNGQzZERkIyLCAweEZCQzc0QzgyLCAweDNGQ0U3QTUxLAogICAgMHg2MDYxODkyQywgMHgzRkQ0NEUwOCwgMHgyOThEQjY2NSwgMHgzRkRCMEUwNywgMHg4ODYyOENENiwgMHgzRkUyMDYzQiwgMHg1NDNFMUExMSwgMHgzRkU4MDQyNywKICAgIDB4MDAwMDAwMDAsIDB4M0ZGMDAwMDAsIDB4Q0E1RDkyMEYsIDB4M0ZGNTUxQTQsIDB4MkU1N0QxNEMsIDB4M0ZGQzY3RjEsIDB4QTkzRTJGNTcsIDB4NDAwMkVDQUYsCiAgICAweEIwQ0RDNUU2LCAweDQwMDkzNzM3LCAweDJCNzI0N0Y4LCAweDQwMTBDQzkyLCAweDgyNTUyMjI2LCAweDQwMTY2MjM4LCAweEYzMDFCNDYzLCAweDQwMUREMzIxLAogICAgMHg0QzEyMzQyNCwgMHg0MDIzREVBNiwgMHgxMzMwQjM1QiwgMHg0MDJBNzk5RSwgMHhFQjZGQ0I3NywgMHg0MDMxQTM1QiwgMHg0RkRFNUQ0MiwgMHg0MDM3ODA2OSwKICAgIDB4NUI2RTQ1NDQsIDB4NDAzRjUwNzYsIDB4OTlGREREMTAsIDB4NDA0NERDQjIsIDB4OTA0QkMxRDYsIDB4NDA0QkNDMUUsIDB4RTFGNTYzODQsIDB4NDA1Mjg0REYsCiAgICAweDQyMkFBMEUwLCAweDQwNThBQ0U1LCAweDI5RERGNkUxLCAweDQwNjA3MDZCLCAweDE1QUQyMTRELCAweDQwNjVFNzZGLCAweDA4MEQ4OUY4LCAweDQwNkQyRjg3LAogICAgMHgzNzNBQTlDRiwgMHg0MDczNzFBNywgMHgxOUUzMjMyOSwgMHg0MDc5RTg2MywgMHhBRUE5MkRFNCwgMHg0MDgxNDI5QSwgMHhGOTUxOTQ4QSwgMHg0MDg2RkY3RCwKICAgIDB4QTJBNDkwRTEsIDB4NDA4RUE0QUYsIDB4RUQxRDAwNUQsIDB4NDA5NDZBNDEsIDB4Qjg0RjE2MDMsIDB4NDA5QjMzQTIsIDB4OTE3RERDOUIsIDB4NDBBMjFGNDksCiAgICAweDk5NENDRTFBLCAweDQwQTgyNTg5LCAweEE5RkIzMzNBLCAweDQwQjAxNjNELCAweDM2QjUyN0UxLCAweDQwQjU2RjQ3LCAweDk0MDZFN0JGLCAweDQwQkM4RjZELAogICAgMHgwQTMxQjcxQywgMHg0MEMzMDZGRSwgMHhDQkM4NTIxOCwgMHg0MEM5NUE0NCwgMHgzMkQzRDFBOCwgMHg0MEQwRTNFQywgMHhENDRDQTk3QywgMHg0MEQ2ODE1NSwKICAgIDB4MzM3QjlCNkEsIDB4NDBEREZDOTcsIDB4MDRBQzgwMjQsIDB4NDBFM0ZBNDUsIDB4NTU3OUZEQ0EsIDB4NDBFQTlFNkIsIDB4ODQwNDVDREIsIDB4NDBGMUJCRTAsCiAgICAweDczRUIwMTkxLCAweDQwRjdBMTE0LCAweEFEOUNCRTIxLCAweDQwRkY3QkZELCAweDc2OUQyQ0IwLCAweDQxMDRGOUIyLCAweDVCRDcxRTE1LCAweDQxMEJGMkMyLAogICAgMHhGNTFGREVFQSwgMHg0MTEyOUU5RCwgMHgxNkI1NDQ5OCwgMHg0MTE4Q0YzMiwgMHgxODc1OUJEMCwgMHg0MTIwODc0NSwgMHhCOTc2REMxNCwgMHg0MTI2MDVFMSwKICAgIDB4RENGQkE0OTYsIDB4NDEyRDU4MTgsIDB4NkQwNUQ4NzAsIDB4NDEzMzhDQUUsIDB4N0I1REU1NzMsIDB4NDEzQTBDNjYsIDB4QzhBNThFNUIsIDB4NDE0MTVBOTgsCiAgICAweEU4RUM1RjgxLCAweDQxNDcxRjc1LCAweDJEOEU2ODAyLCAweDQxNEVDRjQ4LCAweEI1QzEzQ0RDLCAweDQxNTQ4NkEyLCAweDhERTU1OTRBLCAweDQxNUI1OTcyLAogICAgMHg2RTc1NjI0MywgMHg0MTYyMzg3QSwgMHg0NjIzQzdCQywgMHg0MTY4NDcxQSwgMHgzRTc3ODA2QiwgMHg0MTcwMkM5QSwgMHhENDk3QzgwQiwgMHg0MTc1OEQxMiwKICAgIDB4RENFRjkwN0MsIDB4NDE3Q0I3MjAsIDB4RkM0Q0Q4M0UsIDB4NDE4MzIxNzAsIDB4OUZERTRFNjEsIDB4NDE4OTdEODIsIDB4MDAwMDAwMDAsIDB4MDAwMDAwMDAKXSkpLmJ1ZmZlcik7CgpjbGFzcyBIQ0FDaGFubmVsIHsKICAgIGNvbnN0cnVjdG9yKHZhbHVlcykgewogICAgICAgIHRoaXMuVHlwZSA9IDA7CiAgICAgICAgdGhpcy5Db2RlZFNjYWxlRmFjdG9yQ291bnQgPSAwOwogICAgICAgIHRoaXMuUGNtRmxvYXQgPSBBcnJheS5mcm9tKHsgbGVuZ3RoOiBTdWJmcmFtZXNQZXJGcmFtZSB9LCAoKSA9PiBuZXcgRmxvYXQ2NEFycmF5KFNhbXBsZXNQZXJTdWJGcmFtZSkpOwogICAgICAgIHRoaXMuU3BlY3RyYSA9IEFycmF5LmZyb20oeyBsZW5ndGg6IFN1YmZyYW1lc1BlckZyYW1lIH0sICgpID0+IG5ldyBGbG9hdDY0QXJyYXkoU2FtcGxlc1BlclN1YkZyYW1lKSk7CiAgICAgICAgdGhpcy5TY2FsZWRTcGVjdHJhID0gQXJyYXkuZnJvbSh7CiAgICAgICAgICAgIGxlbmd0aDogU2FtcGxlc1BlclN1YkZyYW1lLAogICAgICAgIH0sICgpID0+IG5ldyBGbG9hdDY0QXJyYXkoU3ViZnJhbWVzUGVyRnJhbWUpKTsKICAgICAgICB0aGlzLlF1YW50aXplZFNwZWN0cmEgPSBBcnJheS5mcm9tKHsKICAgICAgICAgICAgbGVuZ3RoOiBTdWJmcmFtZXNQZXJGcmFtZSwKICAgICAgICB9LCAoKSA9PiBuZXcgSW50MzJBcnJheShTYW1wbGVzUGVyU3ViRnJhbWUpKTsKICAgICAgICB0aGlzLkdhaW4gPSBuZXcgRmxvYXQ2NEFycmF5KFNhbXBsZXNQZXJTdWJGcmFtZSk7CiAgICAgICAgdGhpcy5JbnRlbnNpdHkgPSBuZXcgSW50MzJBcnJheShTdWJmcmFtZXNQZXJGcmFtZSk7CiAgICAgICAgdGhpcy5IZnJTY2FsZXMgPSBuZXcgSW50MzJBcnJheSg4KTsKICAgICAgICB0aGlzLkhmckdyb3VwQXZlcmFnZVNwZWN0cmEgPSBuZXcgRmxvYXQ2NEFycmF5KDgpOwogICAgICAgIHRoaXMuTWRjdCA9IG5ldyBNZGN0KFN1YkZyYW1lU2FtcGxlc0JpdHMsIEhDQVRhYmxlcy5NZGN0V2luZG93LCBNYXRoLnNxcnQoMi4wIC8gU2FtcGxlc1BlclN1YkZyYW1lKSk7CiAgICAgICAgdGhpcy5TY2FsZUZhY3RvcnMgPSBuZXcgSW50MzJBcnJheShTYW1wbGVzUGVyU3ViRnJhbWUpOwogICAgICAgIHRoaXMuUmVzb2x1dGlvbiA9IG5ldyBJbnQzMkFycmF5KFNhbXBsZXNQZXJTdWJGcmFtZSk7CiAgICAgICAgdGhpcy5IZWFkZXJMZW5ndGhCaXRzID0gMDsKICAgICAgICB0aGlzLlNjYWxlRmFjdG9yRGVsdGFCaXRzID0gMDsKICAgICAgICBsZXQgdCA9IHRoaXM7CiAgICAgICAgZm9yIChsZXQga2V5IGluIHZhbHVlcykgewogICAgICAgICAgICB0W2tleV0gPSB2YWx1ZXNba2V5XTsKICAgICAgICB9CiAgICB9Cn0KCnZhciBfYTsKY2xhc3MgSENBRnJhbWUgewogICAgY29uc3RydWN0b3IoaGNhKSB7CiAgICAgICAgdGhpcy5BY2NlcHRhYmxlTm9pc2VMZXZlbCA9IDA7CiAgICAgICAgdGhpcy5FdmFsdWF0aW9uQm91bmRhcnkgPSAwOwogICAgICAgIHRoaXMuSGNhID0gaGNhOwogICAgICAgIGxldCBjaGFubmVsVHlwZXMgPSBIQ0FGcmFtZS5HZXRDaGFubmVsVHlwZXMoaGNhKTsKICAgICAgICB0aGlzLkNoYW5uZWxzID0gW107CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBoY2EuZm9ybWF0LmNoYW5uZWxDb3VudDsgaSsrKSB7CiAgICAgICAgICAgIHRoaXMuQ2hhbm5lbHMucHVzaChuZXcgSENBQ2hhbm5lbCh7CiAgICAgICAgICAgICAgICBUeXBlOiBjaGFubmVsVHlwZXNbaV0sCiAgICAgICAgICAgICAgICBDb2RlZFNjYWxlRmFjdG9yQ291bnQ6IGNoYW5uZWxUeXBlc1tpXSA9PSBIQ0FDaGFubmVsVHlwZSQxLlN0ZXJlb1NlY29uZGFyeQogICAgICAgICAgICAgICAgICAgID8gaGNhLmNvbXBEZWMuQmFzZUJhbmRDb3VudAogICAgICAgICAgICAgICAgICAgIDogaGNhLmNvbXBEZWMuQmFzZUJhbmRDb3VudCArIGhjYS5jb21wRGVjLlN0ZXJlb0JhbmRDb3VudCwKICAgICAgICAgICAgfSkpOwogICAgICAgIH0KICAgICAgICB0aGlzLkF0aEN1cnZlID0gaGNhLlVzZUF0aEN1cnZlCiAgICAgICAgICAgID8gSENBRnJhbWUuU2NhbGVBdGhDdXJ2ZShoY2EuZm9ybWF0LnNhbXBsaW5nUmF0ZSkKICAgICAgICAgICAgOiBuZXcgVWludDhBcnJheShTYW1wbGVzUGVyU3ViRnJhbWUpOwogICAgfQogICAgc3RhdGljIEdldENoYW5uZWxUeXBlcyhoY2EpIHsKICAgICAgICBsZXQgY2hhbm5lbHNQZXJUcmFjayA9IGhjYS5mb3JtYXQuY2hhbm5lbENvdW50IC8gaGNhLmNvbXBEZWMuVHJhY2tDb3VudDsKICAgICAgICBpZiAoaGNhLmNvbXBEZWMuU3RlcmVvQmFuZENvdW50ID09IDAgfHwgY2hhbm5lbHNQZXJUcmFjayA9PSAxKSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgQXJyYXkoOCkuZmlsbChIQ0FDaGFubmVsVHlwZSQxKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgRGlzY3JldGUgPSBIQ0FDaGFubmVsVHlwZSQxLkRpc2NyZXRlOwogICAgICAgIGNvbnN0IFN0ZXJlb1ByaW1hcnkgPSBIQ0FDaGFubmVsVHlwZSQxLlN0ZXJlb1ByaW1hcnk7CiAgICAgICAgY29uc3QgU3RlcmVvU2Vjb25kYXJ5ID0gSENBQ2hhbm5lbFR5cGUkMS5TdGVyZW9TZWNvbmRhcnk7CiAgICAgICAgc3dpdGNoIChjaGFubmVsc1BlclRyYWNrKSB7CiAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgIHJldHVybiBbU3RlcmVvUHJpbWFyeSwgU3RlcmVvU2Vjb25kYXJ5XTsKICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgICAgcmV0dXJuIFtTdGVyZW9QcmltYXJ5LCBTdGVyZW9TZWNvbmRhcnksIERpc2NyZXRlXTsKICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgICAgaWYgKGhjYS5jb21wRGVjLkNoYW5uZWxDb25maWcgIT0gMCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBbU3RlcmVvUHJpbWFyeSwgU3RlcmVvU2Vjb25kYXJ5LCBEaXNjcmV0ZSwgRGlzY3JldGVdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgICAgICAgICAgU3RlcmVvUHJpbWFyeSwKICAgICAgICAgICAgICAgICAgICAgICAgU3RlcmVvU2Vjb25kYXJ5LAogICAgICAgICAgICAgICAgICAgICAgICBTdGVyZW9QcmltYXJ5LAogICAgICAgICAgICAgICAgICAgICAgICBTdGVyZW9TZWNvbmRhcnksCiAgICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSA1OgogICAgICAgICAgICAgICAgaWYgKGhjYS5jb21wRGVjLkNoYW5uZWxDb25maWcgPiAyKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFtTdGVyZW9QcmltYXJ5LCBTdGVyZW9TZWNvbmRhcnksIERpc2NyZXRlLCBEaXNjcmV0ZSwgRGlzY3JldGVdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgICAgICAgICAgU3RlcmVvUHJpbWFyeSwKICAgICAgICAgICAgICAgICAgICAgICAgU3RlcmVvU2Vjb25kYXJ5LAogICAgICAgICAgICAgICAgICAgICAgICBEaXNjcmV0ZSwKICAgICAgICAgICAgICAgICAgICAgICAgU3RlcmVvUHJpbWFyeSwKICAgICAgICAgICAgICAgICAgICAgICAgU3RlcmVvU2Vjb25kYXJ5LAogICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgNjoKICAgICAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgICAgICAgU3RlcmVvUHJpbWFyeSwKICAgICAgICAgICAgICAgICAgICBTdGVyZW9TZWNvbmRhcnksCiAgICAgICAgICAgICAgICAgICAgRGlzY3JldGUsCiAgICAgICAgICAgICAgICAgICAgRGlzY3JldGUsCiAgICAgICAgICAgICAgICAgICAgU3RlcmVvUHJpbWFyeSwKICAgICAgICAgICAgICAgICAgICBTdGVyZW9TZWNvbmRhcnksCiAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICBjYXNlIDc6CiAgICAgICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgICAgIFN0ZXJlb1ByaW1hcnksCiAgICAgICAgICAgICAgICAgICAgU3RlcmVvU2Vjb25kYXJ5LAogICAgICAgICAgICAgICAgICAgIERpc2NyZXRlLAogICAgICAgICAgICAgICAgICAgIERpc2NyZXRlLAogICAgICAgICAgICAgICAgICAgIFN0ZXJlb1ByaW1hcnksCiAgICAgICAgICAgICAgICAgICAgU3RlcmVvU2Vjb25kYXJ5LAogICAgICAgICAgICAgICAgICAgIERpc2NyZXRlLAogICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgICAgICBTdGVyZW9QcmltYXJ5LAogICAgICAgICAgICAgICAgICAgIFN0ZXJlb1NlY29uZGFyeSwKICAgICAgICAgICAgICAgICAgICBEaXNjcmV0ZSwKICAgICAgICAgICAgICAgICAgICBEaXNjcmV0ZSwKICAgICAgICAgICAgICAgICAgICBTdGVyZW9QcmltYXJ5LAogICAgICAgICAgICAgICAgICAgIFN0ZXJlb1NlY29uZGFyeSwKICAgICAgICAgICAgICAgICAgICBTdGVyZW9QcmltYXJ5LAogICAgICAgICAgICAgICAgICAgIFN0ZXJlb1NlY29uZGFyeSwKICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IEFycmF5KGNoYW5uZWxzUGVyVHJhY2spLmZpbGwoSENBQ2hhbm5lbFR5cGUkMSk7CiAgICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBTY2FsZXMgYW4gQVRIIGN1cnZlIHRvIHRoZSBzcGVjaWZpZWQgZnJlcXVlbmN5LgogICAgICoKICAgICAqIFRoZSBvcmlnaW5hbCBBVEggY3VydmUgaXMgZm9yIGEgZnJlcXVlbmN5IG9mIDQxODU2IEh6LgogICAgICogQHBhcmFtIGZyZXF1ZW5jeSBUaGUgZnJlcXVlbmN5IHRvIHNjYWxlIHRoZSBjdXJ2ZSB0by4KICAgICAqIEByZXR1cm5zIFRoZSBzY2FsZWQgQVRIIGN1cnZlCiAgICAgKi8KICAgIHN0YXRpYyBTY2FsZUF0aEN1cnZlKGZyZXF1ZW5jeSkgewogICAgICAgIHZhciBhdGggPSBuZXcgVWludDhBcnJheShTYW1wbGVzUGVyU3ViRnJhbWUpOwogICAgICAgIGxldCBhY2MgPSAwOwogICAgICAgIGxldCBpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBhdGgubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgYWNjICs9IGZyZXF1ZW5jeTsKICAgICAgICAgICAgbGV0IGluZGV4ID0gYWNjID4+IDEzOwogICAgICAgICAgICBpZiAoaW5kZXggPj0gSENBVGFibGVzLkF0aEN1cnZlLmxlbmd0aCkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYXRoW2ldID0gSENBVGFibGVzLkF0aEN1cnZlW2luZGV4XTsKICAgICAgICB9CiAgICAgICAgZm9yICg7IGkgPCBhdGgubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgYXRoW2ldID0gMHhmZjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGF0aDsKICAgIH0KfQpfYSA9IEhDQUZyYW1lOwpIQ0FGcmFtZS5TdWJmcmFtZXNQZXJGcmFtZSA9IDg7CkhDQUZyYW1lLlN1YkZyYW1lU2FtcGxlc0JpdHMgPSA3OwpIQ0FGcmFtZS5TYW1wbGVzUGVyU3ViRnJhbWUgPSAxIDw8IF9hLlN1YkZyYW1lU2FtcGxlc0JpdHM7CkhDQUZyYW1lLlNhbXBsZXNQZXJGcmFtZSA9IF9hLlN1YmZyYW1lc1BlckZyYW1lICogX2EuU2FtcGxlc1BlclN1YkZyYW1lOwoKY2xhc3MgSENBUGFja2luZyB7CiAgICBzdGF0aWMgVW5wYWNrRnJhbWUoZnJhbWUsIHJlYWRlcikgewogICAgICAgIGlmICghdGhpcy5VbnBhY2tGcmFtZUhlYWRlcihmcmFtZSwgcmVhZGVyKSkKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIHRoaXMuUmVhZFNwZWN0cmFsQ29lZmZpY2llbnRzKGZyYW1lLCByZWFkZXIpOwogICAgICAgIHJldHVybiB0aGlzLlVucGFja2luZ1dhc1N1Y2Nlc3NmdWwoZnJhbWUsIHJlYWRlcik7CiAgICB9CiAgICBzdGF0aWMgUGFja0ZyYW1lKGZyYW1lLCBvdXRCdWZmZXIpIHsKICAgICAgICB2YXIgd3JpdGVyID0gbmV3IEJpdFdyaXRlcihvdXRCdWZmZXIpOwogICAgICAgIHdyaXRlci5Xcml0ZSgweGZmZmYsIDE2KTsKICAgICAgICB3cml0ZXIuV3JpdGUoZnJhbWUuQWNjZXB0YWJsZU5vaXNlTGV2ZWwsIDkpOwogICAgICAgIHdyaXRlci5Xcml0ZShmcmFtZS5FdmFsdWF0aW9uQm91bmRhcnksIDcpOwogICAgICAgIGZvciAobGV0IGNoYW5uZWwgb2YgZnJhbWUuQ2hhbm5lbHMpIHsKICAgICAgICAgICAgdGhpcy5Xcml0ZVNjYWxlRmFjdG9ycyh3cml0ZXIsIGNoYW5uZWwpOwogICAgICAgICAgICBpZiAoY2hhbm5lbC5UeXBlID09IEhDQUNoYW5uZWxUeXBlJDEuU3RlcmVvU2Vjb25kYXJ5KSB7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IFN1YmZyYW1lc1BlckZyYW1lOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB3cml0ZXIuV3JpdGUoY2hhbm5lbC5JbnRlbnNpdHlbaV0sIDQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKGZyYW1lLkhjYS5IZnJHcm91cENvdW50ID4gMCkgewogICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmcmFtZS5IY2EuSGZyR3JvdXBDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgd3JpdGVyLldyaXRlKGNoYW5uZWwuSGZyU2NhbGVzW2ldLCA2KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBzZiA9IDA7IHNmIDwgU3ViZnJhbWVzUGVyRnJhbWU7IHNmKyspIHsKICAgICAgICAgICAgZm9yIChsZXQgY2hhbm5lbCBvZiBmcmFtZS5DaGFubmVscykgewogICAgICAgICAgICAgICAgdGhpcy5Xcml0ZVNwZWN0cmEod3JpdGVyLCBjaGFubmVsLCBzZik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgd3JpdGVyLkFsaWduUG9zaXRpb24oOCk7CiAgICAgICAgZm9yIChsZXQgaSA9IHdyaXRlci5Qb3NpdGlvbiAvIDg7IGkgPCBmcmFtZS5IY2EuYmxvY2tTaXplIC0gMjsgaSsrKSB7CiAgICAgICAgICAgIHdyaXRlci5kdi5zZXRVaW50OChpLCAwKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5Xcml0ZUNoZWNrc3VtKHdyaXRlciwgb3V0QnVmZmVyKTsKICAgIH0KICAgIHN0YXRpYyBDYWxjdWxhdGVSZXNvbHV0aW9uKHNjYWxlRmFjdG9yLCBub2lzZUxldmVsLCB2ZXJzaW9uTWFqb3IpIHsKICAgICAgICBpZiAoc2NhbGVGYWN0b3IgPT0gMCkgewogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CiAgICAgICAgbGV0IGN1cnZlUG9zaXRpb24gPSBub2lzZUxldmVsIC0gKDUgKiBzY2FsZUZhY3RvciA+PiAxKSArIDI7CiAgICAgICAgLy9odHRwczovL2dpdGh1Yi5jb20vdmdtc3RyZWFtL3ZnbXN0cmVhbS9ibG9iLzRlZWNkYWRhOWEwM2E3M2FmMGM3YzE3ZjVjZDZlMDg1MThmZDdlM2Yvc3JjL2NvZGluZy9oY2FfZGVjb2Rlcl9jbGhjYS5jI0wxNDUwCiAgICAgICAgLy9GSVhNRSBoY2EyLjAgZGVjb2RpbmcgYnJlYWtzIGlmIGNvbmRpdGlvbmFsICh0ZXJuYXJ5KSBvcGVyYXRvciBpcyByZW1vdmVkCiAgICAgICAgLy9jdXJ2ZVBvc2l0aW9uID0gSENBVXRpbEZ1bmMuQ2xhbXAoY3VydmVQb3NpdGlvbiwgMCwgNjcpOwogICAgICAgIGN1cnZlUG9zaXRpb24gPSBDbGFtcChjdXJ2ZVBvc2l0aW9uLCAwLCB2ZXJzaW9uTWFqb3IgPD0gMiA/IDU4IDogNjcpOwogICAgICAgIHJldHVybiBIQ0FUYWJsZXMuU2NhbGVUb1Jlc29sdXRpb25DdXJ2ZVtjdXJ2ZVBvc2l0aW9uXTsKICAgIH0KICAgIHN0YXRpYyBVbnBhY2tGcmFtZUhlYWRlcihmcmFtZSwgcmVhZGVyKSB7CiAgICAgICAgbGV0IGhjYSA9IGZyYW1lLkhjYTsKICAgICAgICBsZXQgc3luY1dvcmQgPSByZWFkZXIuUmVhZEludCgxNik7CiAgICAgICAgaWYgKHN5bmNXb3JkICE9IDB4ZmZmZikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgZnJhbWUgaGVhZGVyIik7CiAgICAgICAgfQogICAgICAgIGxldCBhdGhDdXJ2ZSA9IGZyYW1lLkF0aEN1cnZlOwogICAgICAgIGZyYW1lLkFjY2VwdGFibGVOb2lzZUxldmVsID0gcmVhZGVyLlJlYWRJbnQoOSk7CiAgICAgICAgZnJhbWUuRXZhbHVhdGlvbkJvdW5kYXJ5ID0gcmVhZGVyLlJlYWRJbnQoNyk7CiAgICAgICAgZm9yIChsZXQgY2hhbm5lbCBvZiBmcmFtZS5DaGFubmVscykgewogICAgICAgICAgICBpZiAoIXRoaXMuUmVhZFNjYWxlRmFjdG9ycyhjaGFubmVsLCByZWFkZXIsIGhjYS5IZnJHcm91cENvdW50LCBoY2EudmVyc2lvbk1ham9yKSkKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgLy8gYWRkZWQgY2xhbXAKICAgICAgICAgICAgLy9odHRwczovL2dpdGh1Yi5jb20vdmdtc3RyZWFtL3ZnbXN0cmVhbS9ibG9iLzRlZWNkYWRhOWEwM2E3M2FmMGM3YzE3ZjVjZDZlMDg1MThmZDdlM2Yvc3JjL2NvZGluZy9oY2FfZGVjb2Rlcl9jbGhjYS5jI0wxNDYyCiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZnJhbWUuRXZhbHVhdGlvbkJvdW5kYXJ5OyBpKyspIHsKICAgICAgICAgICAgICAgIGxldCBuZXdSZXNvbHV0aW9uID0gdGhpcy5DYWxjdWxhdGVSZXNvbHV0aW9uKGNoYW5uZWwuU2NhbGVGYWN0b3JzW2ldLCBhdGhDdXJ2ZVtpXSArIGZyYW1lLkFjY2VwdGFibGVOb2lzZUxldmVsIC0gMSwgaGNhLnZlcnNpb25NYWpvcik7CiAgICAgICAgICAgICAgICBpZiAoaGNhLnZlcnNpb25NYWpvciA+IDIpCiAgICAgICAgICAgICAgICAgICAgbmV3UmVzb2x1dGlvbiA9IENsYW1wKG5ld1Jlc29sdXRpb24sIGhjYS5jb21wRGVjLk1pblJlc29sdXRpb24sIGhjYS5jb21wRGVjLk1heFJlc29sdXRpb24pOwogICAgICAgICAgICAgICAgY2hhbm5lbC5SZXNvbHV0aW9uW2ldID0gbmV3UmVzb2x1dGlvbjsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKGxldCBpID0gZnJhbWUuRXZhbHVhdGlvbkJvdW5kYXJ5OyBpIDwgY2hhbm5lbC5Db2RlZFNjYWxlRmFjdG9yQ291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgbGV0IG5ld1Jlc29sdXRpb24gPSB0aGlzLkNhbGN1bGF0ZVJlc29sdXRpb24oY2hhbm5lbC5TY2FsZUZhY3RvcnNbaV0sIGF0aEN1cnZlW2ldICsgZnJhbWUuQWNjZXB0YWJsZU5vaXNlTGV2ZWwsIGhjYS52ZXJzaW9uTWFqb3IpOwogICAgICAgICAgICAgICAgaWYgKGhjYS52ZXJzaW9uTWFqb3IgPiAyKQogICAgICAgICAgICAgICAgICAgIG5ld1Jlc29sdXRpb24gPSBDbGFtcChuZXdSZXNvbHV0aW9uLCBoY2EuY29tcERlYy5NaW5SZXNvbHV0aW9uLCBoY2EuY29tcERlYy5NYXhSZXNvbHV0aW9uKTsKICAgICAgICAgICAgICAgIGNoYW5uZWwuUmVzb2x1dGlvbltpXSA9IG5ld1Jlc29sdXRpb247CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNoYW5uZWwuVHlwZSA9PSBIQ0FDaGFubmVsVHlwZSQxLlN0ZXJlb1NlY29uZGFyeSkgewogICAgICAgICAgICAgICAgdGhpcy5SZWFkSW50ZW5zaXR5KHJlYWRlciwgY2hhbm5lbC5JbnRlbnNpdHksIGhjYS52ZXJzaW9uTWFqb3IpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKGZyYW1lLkhjYS5IZnJHcm91cENvdW50ID4gMCkgewogICAgICAgICAgICAgICAgaWYgKGhjYS52ZXJzaW9uTWFqb3IgPD0gMikKICAgICAgICAgICAgICAgICAgICB0aGlzLlJlYWRIZnJTY2FsZUZhY3RvcnMocmVhZGVyLCBmcmFtZS5IY2EuSGZyR3JvdXBDb3VudCwgY2hhbm5lbC5IZnJTY2FsZXMpOwogICAgICAgICAgICAgICAgLy8gdjMuMCB1c2VzIHZhbHVlcyBkZXJpdmVkIGluIFJlYWRTY2FsZUZhY3RvcnMKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHN0YXRpYyBSZWFkU2NhbGVGYWN0b3JzKGNoYW5uZWwsIHJlYWRlciwgaGZyR3JvdXBDb3VudCwgdmVyc2lvbk1ham9yKSB7CiAgICAgICAgY2hhbm5lbC5TY2FsZUZhY3RvckRlbHRhQml0cyA9IHJlYWRlci5SZWFkSW50KDMpOwogICAgICAgIGlmIChjaGFubmVsLlNjYWxlRmFjdG9yRGVsdGFCaXRzID09IDApIHsKICAgICAgICAgICAgY2hhbm5lbC5TY2FsZUZhY3RvcnMuZmlsbCgwLCAwLCBjaGFubmVsLlNjYWxlRmFjdG9ycy5sZW5ndGgpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgLy8gYWRkZWQgaW4gdjMuMAogICAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS92Z21zdHJlYW0vdmdtc3RyZWFtL2Jsb2IvNGVlY2RhZGE5YTAzYTczYWYwYzdjMTdmNWNkNmUwODUxOGZkN2UzZi9zcmMvY29kaW5nL2hjYV9kZWNvZGVyX2NsaGNhLmMjTDEyODcKICAgICAgICBsZXQgZXh0cmFDb2RlZFNjYWxlRmFjdG9yQ291bnQ7CiAgICAgICAgbGV0IGNvZGVkU2NhbGVGYWN0b3JDb3VudDsKICAgICAgICBpZiAoY2hhbm5lbC5UeXBlID09IEhDQUNoYW5uZWxUeXBlJDEuU3RlcmVvU2Vjb25kYXJ5IHx8IGhmckdyb3VwQ291bnQgPD0gMCB8fCB2ZXJzaW9uTWFqb3IgPD0gMikgewogICAgICAgICAgICBleHRyYUNvZGVkU2NhbGVGYWN0b3JDb3VudCA9IDA7CiAgICAgICAgICAgIGNvZGVkU2NhbGVGYWN0b3JDb3VudCA9IGNoYW5uZWwuQ29kZWRTY2FsZUZhY3RvckNvdW50OwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgZXh0cmFDb2RlZFNjYWxlRmFjdG9yQ291bnQgPSBoZnJHcm91cENvdW50OwogICAgICAgICAgICBjb2RlZFNjYWxlRmFjdG9yQ291bnQgPSBjaGFubmVsLkNvZGVkU2NhbGVGYWN0b3JDb3VudCArIGV4dHJhQ29kZWRTY2FsZUZhY3RvckNvdW50OwogICAgICAgICAgICAvLyBqdXN0IGluIGNhc2UKICAgICAgICAgICAgaWYgKGNvZGVkU2NhbGVGYWN0b3JDb3VudCA+IEhDQUZyYW1lLlNhbXBsZXNQZXJTdWJGcmFtZSkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgY29kZWRTY2FsZUZhY3RvckNvdW50ID4gSENBRnJhbWUuU2FtcGxlc1BlclN1YkZyYW1lYCk7CiAgICAgICAgfQogICAgICAgIGlmIChjaGFubmVsLlNjYWxlRmFjdG9yRGVsdGFCaXRzID49IDYpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb2RlZFNjYWxlRmFjdG9yQ291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgY2hhbm5lbC5TY2FsZUZhY3RvcnNbaV0gPSByZWFkZXIuUmVhZEludCg2KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgbGV0IHJlc3VsdCA9IHRoaXMuRGVsdGFEZWNvZGUocmVhZGVyLCBjaGFubmVsLlNjYWxlRmFjdG9yRGVsdGFCaXRzLCA2LCBjb2RlZFNjYWxlRmFjdG9yQ291bnQsIGNoYW5uZWwuU2NhbGVGYWN0b3JzKTsKICAgICAgICBpZiAoIXJlc3VsdCkKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAvLyBzZXQgZGVyaXZlZCBIRlIgc2NhbGVzIGZvciB2My4wCiAgICAgICAgLy9GSVhNRSBVTlRFU1RFRAogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZXh0cmFDb2RlZFNjYWxlRmFjdG9yQ291bnQ7IGkrKykgewogICAgICAgICAgICBjaGFubmVsLkhmclNjYWxlc1tjb2RlZFNjYWxlRmFjdG9yQ291bnQgLSAxIC0gaV0gPSBjaGFubmVsLlNjYWxlRmFjdG9yc1tjb2RlZFNjYWxlRmFjdG9yQ291bnQgLSBpXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIHN0YXRpYyBSZWFkSW50ZW5zaXR5KHJlYWRlciwgaW50ZW5zaXR5LCB2ZXJzaW9uTWFqb3IpIHsKICAgICAgICBpZiAodmVyc2lvbk1ham9yIDw9IDIpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBIQ0FGcmFtZS5TdWJmcmFtZXNQZXJGcmFtZTsgaSsrKSB7CiAgICAgICAgICAgICAgICBpbnRlbnNpdHlbaV0gPSByZWFkZXIuUmVhZEludCg0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgLy9odHRwczovL2dpdGh1Yi5jb20vdmdtc3RyZWFtL3ZnbXN0cmVhbS9ibG9iLzRlZWNkYWRhOWEwM2E3M2FmMGM3YzE3ZjVjZDZlMDg1MThmZDdlM2Yvc3JjL2NvZGluZy9oY2FfZGVjb2Rlcl9jbGhjYS5jI0wxMzc0CiAgICAgICAgICAgIGxldCB2YWx1ZSA9IHJlYWRlci5SZWFkSW50KDQpOwogICAgICAgICAgICBsZXQgZGVsdGFfYml0czsKICAgICAgICAgICAgaWYgKHZhbHVlIDwgMTUpIHsKICAgICAgICAgICAgICAgIGRlbHRhX2JpdHMgPSByZWFkZXIuUmVhZEludCgyKTsgLyogKzEgKi8KICAgICAgICAgICAgICAgIGludGVuc2l0eVswXSA9IHZhbHVlOwogICAgICAgICAgICAgICAgaWYgKGRlbHRhX2JpdHMgPT0gMykgeyAvKiAzKzEgPSA0YiAqLwogICAgICAgICAgICAgICAgICAgIC8qIGZpeGVkIGludGVuc2l0aWVzICovCiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBIQ0FGcmFtZS5TdWJmcmFtZXNQZXJGcmFtZTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGludGVuc2l0eVtpXSA9IHJlYWRlci5SZWFkSW50KDQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8qIGRlbHRhIGludGVuc2l0aWVzICovCiAgICAgICAgICAgICAgICAgICAgbGV0IGJtYXggPSAoMiA8PCBkZWx0YV9iaXRzKSAtIDE7CiAgICAgICAgICAgICAgICAgICAgbGV0IGJpdHMgPSBkZWx0YV9iaXRzICsgMTsKICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8IEhDQUZyYW1lLlN1YmZyYW1lc1BlckZyYW1lOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGRlbHRhID0gcmVhZGVyLlJlYWRJbnQoYml0cyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkZWx0YSA9PSBibWF4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHJlYWRlci5SZWFkSW50KDQpOyAvKiBlbmNvZGVkICovCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHZhbHVlIC0gKGJtYXggPj4gMSkgKyBkZWx0YTsgLyogZGlmZmVyZW50aWFsICovCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUgPiAxNSkgLy90b2RvIGNoZWNrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGB2YWx1ZSA+IDE1YCk7IC8qIG5vdCBkb25lIGluIGxpYiAqLwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGludGVuc2l0eVtpXSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgSENBRnJhbWUuU3ViZnJhbWVzUGVyRnJhbWU7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGludGVuc2l0eVtpXSA9IDc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBzdGF0aWMgUmVhZEhmclNjYWxlRmFjdG9ycyhyZWFkZXIsIGdyb3VwQ291bnQsIGhmclNjYWxlKSB7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBncm91cENvdW50OyBpKyspIHsKICAgICAgICAgICAgaGZyU2NhbGVbaV0gPSByZWFkZXIuUmVhZEludCg2KTsKICAgICAgICB9CiAgICB9CiAgICBzdGF0aWMgUmVhZFNwZWN0cmFsQ29lZmZpY2llbnRzKGZyYW1lLCByZWFkZXIpIHsKICAgICAgICBmb3IgKGxldCBzZiA9IDA7IHNmIDwgU3ViZnJhbWVzUGVyRnJhbWU7IHNmKyspIHsKICAgICAgICAgICAgZm9yIChsZXQgY2hhbm5lbCBvZiBmcmFtZS5DaGFubmVscykgewogICAgICAgICAgICAgICAgZm9yIChsZXQgcyA9IDA7IHMgPCBjaGFubmVsLkNvZGVkU2NhbGVGYWN0b3JDb3VudDsgcysrKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IHJlc29sdXRpb24gPSBjaGFubmVsLlJlc29sdXRpb25bc107CiAgICAgICAgICAgICAgICAgICAgbGV0IGJpdHMgPSBIQ0FUYWJsZXMuUXVhbnRpemVkU3BlY3RydW1NYXhCaXRzW3Jlc29sdXRpb25dOwogICAgICAgICAgICAgICAgICAgIGxldCBjb2RlID0gcmVhZGVyLlBlZWtJbnQoYml0cyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlc29sdXRpb24gPCA4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJpdHMgPSBIQ0FUYWJsZXMuUXVhbnRpemVkU3BlY3RydW1CaXRzW3Jlc29sdXRpb25dW2NvZGVdOwogICAgICAgICAgICAgICAgICAgICAgICBjaGFubmVsLlF1YW50aXplZFNwZWN0cmFbc2ZdW3NdID0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIEhDQVRhYmxlcy5RdWFudGl6ZWRTcGVjdHJ1bVZhbHVlW3Jlc29sdXRpb25dW2NvZGVdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmVhZCB0aGUgc2lnbi1tYWduaXR1ZGUgdmFsdWUuIFRoZSBsb3cgYml0IGlzIHRoZSBzaWduCiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBxdWFudGl6ZWRDb2VmZmljaWVudCA9IChjb2RlID4+IDEpICogKDEgLSAoY29kZSAlIDIgKiAyKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChxdWFudGl6ZWRDb2VmZmljaWVudCA9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaXRzLS07CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgY2hhbm5lbC5RdWFudGl6ZWRTcGVjdHJhW3NmXVtzXSA9IHF1YW50aXplZENvZWZmaWNpZW50OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZWFkZXIuUG9zaXRpb24gKz0gYml0czsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNoYW5uZWwuU3BlY3RyYVtzZl0uZmlsbCgwLCBjaGFubmVsLkNvZGVkU2NhbGVGYWN0b3JDb3VudCwgY2hhbm5lbC5Db2RlZFNjYWxlRmFjdG9yQ291bnQgKyAweDgwIC0gY2hhbm5lbC5Db2RlZFNjYWxlRmFjdG9yQ291bnQpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgc3RhdGljIERlbHRhRGVjb2RlKHJlYWRlciwgZGVsdGFCaXRzLCBkYXRhQml0cywgY291bnQsIG91dHB1dCkgewogICAgICAgIG91dHB1dFswXSA9IHJlYWRlci5SZWFkSW50KGRhdGFCaXRzKTsKICAgICAgICBsZXQgbWF4RGVsdGEgPSAxIDw8IChkZWx0YUJpdHMgLSAxKTsKICAgICAgICBsZXQgbWF4VmFsdWUgPSAoMSA8PCBkYXRhQml0cykgLSAxOwogICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgY291bnQ7IGkrKykgewogICAgICAgICAgICBsZXQgZGVsdGEgPSByZWFkZXIuUmVhZE9mZnNldEJpbmFyeShkZWx0YUJpdHMsIEhDQUJpdFJlYWRlci5PZmZzZXRCaWFzLlBvc2l0aXZlKTsKICAgICAgICAgICAgaWYgKGRlbHRhIDwgbWF4RGVsdGEpIHsKICAgICAgICAgICAgICAgIGxldCB2YWx1ZSA9IG91dHB1dFtpIC0gMV0gKyBkZWx0YTsKICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA8IDAgfHwgdmFsdWUgPiBtYXhWYWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS92Z21zdHJlYW0vdmdtc3RyZWFtL2Jsb2IvNGVlY2RhZGE5YTAzYTczYWYwYzdjMTdmNWNkNmUwODUxOGZkN2UzZi9zcmMvY29kaW5nL2hjYV9kZWNvZGVyX2NsaGNhLmMjTDEzMjcKICAgICAgICAgICAgICAgIC8vdmFsdWUgJj0gMHgzRjsgLy8gdjMuMCBsaWIKICAgICAgICAgICAgICAgIG91dHB1dFtpXSA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgb3V0cHV0W2ldID0gcmVhZGVyLlJlYWRJbnQoZGF0YUJpdHMpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgc3RhdGljIFVucGFja2luZ1dhc1N1Y2Nlc3NmdWwoZnJhbWUsIHJlYWRlcikgewogICAgICAgIC8vIDEyOCBsZWZ0b3ZlciBiaXRzIGFmdGVyIHVucGFja2luZyBzaG91bGQgYmUgaGlnaCBlbm91Z2ggdG8gZ2V0IHJpZCBvZiBmYWxzZSBuZWdhdGl2ZXMsCiAgICAgICAgLy8gYW5kIGxvdyBlbm91Z2ggdGhhdCBmYWxzZSBwb3NpdGl2ZXMgd2lsbCBiZSB1bmNvbW1vbi4KICAgICAgICByZXR1cm4gcmVhZGVyLlJlbWFpbmluZyA+PSAxNiAmJiByZWFkZXIuUmVtYWluaW5nIDw9IDEyOCB8fAogICAgICAgICAgICB0aGlzLkZyYW1lRW1wdHkoZnJhbWUpIHx8CiAgICAgICAgICAgIGZyYW1lLkFjY2VwdGFibGVOb2lzZUxldmVsID09IDAgJiYgcmVhZGVyLlJlbWFpbmluZyA+PSAxNjsKICAgIH0KICAgIHN0YXRpYyBGcmFtZUVtcHR5KGZyYW1lKSB7CiAgICAgICAgaWYgKGZyYW1lLkFjY2VwdGFibGVOb2lzZUxldmVsID4gMCkKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIC8vIElmIGFsbCB0aGUgc2NhbGUgZmFjdG9ycyBhcmUgMCwgdGhlIGZyYW1lIGlzIGVtcHR5CiAgICAgICAgZm9yIChsZXQgY2hhbm5lbCBvZiBmcmFtZS5DaGFubmVscykgewogICAgICAgICAgICBpZiAoY2hhbm5lbC5TY2FsZUZhY3RvckRlbHRhQml0cyA+IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHN0YXRpYyBXcml0ZUNoZWNrc3VtKHdyaXRlciwgaGNhQnVmZmVyKSB7CiAgICAgICAgd3JpdGVyLlBvc2l0aW9uID0gd3JpdGVyLkxlbmd0aEJpdHMgLSAxNjsKICAgICAgICBsZXQgY3JjMTYgPSBDcmMxNi5jYWxjKGhjYUJ1ZmZlciwgaGNhQnVmZmVyLmxlbmd0aCAtIDIpOwogICAgICAgIHdyaXRlci5Xcml0ZShjcmMxNiwgMTYpOwogICAgfQogICAgc3RhdGljIFdyaXRlU3BlY3RyYSh3cml0ZXIsIGNoYW5uZWwsIHN1YkZyYW1lKSB7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGFubmVsLkNvZGVkU2NhbGVGYWN0b3JDb3VudDsgaSsrKSB7CiAgICAgICAgICAgIGxldCByZXNvbHV0aW9uID0gY2hhbm5lbC5SZXNvbHV0aW9uW2ldOwogICAgICAgICAgICBsZXQgcXVhbnRpemVkU3BlY3RyYSA9IGNoYW5uZWwuUXVhbnRpemVkU3BlY3RyYVtzdWJGcmFtZV1baV07CiAgICAgICAgICAgIGlmIChyZXNvbHV0aW9uID09IDApCiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgaWYgKHJlc29sdXRpb24gPCA4KSB7CiAgICAgICAgICAgICAgICBsZXQgYml0cyA9IEhDQVRhYmxlcy5RdWFudGl6ZVNwZWN0cnVtQml0c1tyZXNvbHV0aW9uXVtxdWFudGl6ZWRTcGVjdHJhICsgOF07CiAgICAgICAgICAgICAgICB3cml0ZXIuV3JpdGUoSENBVGFibGVzLlF1YW50aXplU3BlY3RydW1WYWx1ZVtyZXNvbHV0aW9uXVtxdWFudGl6ZWRTcGVjdHJhICsgOF0sIGJpdHMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKHJlc29sdXRpb24gPCAxNikgewogICAgICAgICAgICAgICAgbGV0IGJpdHMgPSBIQ0FUYWJsZXMuUXVhbnRpemVkU3BlY3RydW1NYXhCaXRzW3Jlc29sdXRpb25dIC0gMTsKICAgICAgICAgICAgICAgIHdyaXRlci5Xcml0ZShNYXRoLmFicyhxdWFudGl6ZWRTcGVjdHJhKSwgYml0cyk7CiAgICAgICAgICAgICAgICBpZiAocXVhbnRpemVkU3BlY3RyYSAhPSAwKSB7CiAgICAgICAgICAgICAgICAgICAgd3JpdGVyLldyaXRlKHF1YW50aXplZFNwZWN0cmEgPiAwID8gMCA6IDEsIDEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgc3RhdGljIFdyaXRlU2NhbGVGYWN0b3JzKHdyaXRlciwgY2hhbm5lbCkgewogICAgICAgIGxldCBkZWx0YUJpdHMgPSBjaGFubmVsLlNjYWxlRmFjdG9yRGVsdGFCaXRzOwogICAgICAgIGxldCBzY2FsZXMgPSBjaGFubmVsLlNjYWxlRmFjdG9yczsKICAgICAgICB3cml0ZXIuV3JpdGUoZGVsdGFCaXRzLCAzKTsKICAgICAgICBpZiAoZGVsdGFCaXRzID09IDApCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICBpZiAoZGVsdGFCaXRzID09IDYpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGFubmVsLkNvZGVkU2NhbGVGYWN0b3JDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICB3cml0ZXIuV3JpdGUoc2NhbGVzW2ldLCA2KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHdyaXRlci5Xcml0ZShzY2FsZXNbMF0sIDYpOwogICAgICAgIGxldCBtYXhEZWx0YSA9ICgxIDw8IChkZWx0YUJpdHMgLSAxKSkgLSAxOwogICAgICAgIGxldCBlc2NhcGVWYWx1ZSA9ICgxIDw8IGRlbHRhQml0cykgLSAxOwogICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgY2hhbm5lbC5Db2RlZFNjYWxlRmFjdG9yQ291bnQ7IGkrKykgewogICAgICAgICAgICBsZXQgZGVsdGEgPSBzY2FsZXNbaV0gLSBzY2FsZXNbaSAtIDFdOwogICAgICAgICAgICBpZiAoTWF0aC5hYnMoZGVsdGEpID4gbWF4RGVsdGEpIHsKICAgICAgICAgICAgICAgIHdyaXRlci5Xcml0ZShlc2NhcGVWYWx1ZSwgZGVsdGFCaXRzKTsKICAgICAgICAgICAgICAgIHdyaXRlci5Xcml0ZShzY2FsZXNbaV0sIDYpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgd3JpdGVyLldyaXRlKG1heERlbHRhICsgZGVsdGEsIGRlbHRhQml0cyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0KCmNsYXNzIEhDQURlY29kZXIgewogICAgc3RhdGljIERlY29kZUZyYW1lKGF1ZGlvLCBmcmFtZSkgewogICAgICAgIGxldCByZWFkZXIgPSBuZXcgSENBQml0UmVhZGVyKGF1ZGlvKTsKICAgICAgICBpZiAoIUhDQVBhY2tpbmcuVW5wYWNrRnJhbWUoZnJhbWUsIHJlYWRlcikpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5wYWNrRnJhbWUgZmFpbGVkYCk7CiAgICAgICAgdGhpcy5EZXF1YW50aXplRnJhbWUoZnJhbWUpOwogICAgICAgIHRoaXMuUmVzdG9yZU1pc3NpbmdCYW5kcyhmcmFtZSk7CiAgICAgICAgdGhpcy5SdW5JbWRjdChmcmFtZSk7CiAgICB9CiAgICBzdGF0aWMgRGVxdWFudGl6ZUZyYW1lKGZyYW1lKSB7CiAgICAgICAgZm9yIChsZXQgY2hhbm5lbCBvZiBmcmFtZS5DaGFubmVscykgewogICAgICAgICAgICB0aGlzLkNhbGN1bGF0ZUdhaW4oY2hhbm5lbCk7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IHNmID0gMDsgc2YgPCBTdWJmcmFtZXNQZXJGcmFtZTsgc2YrKykgewogICAgICAgICAgICBmb3IgKGxldCBjaGFubmVsIG9mIGZyYW1lLkNoYW5uZWxzKSB7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBzID0gMDsgcyA8IGNoYW5uZWwuQ29kZWRTY2FsZUZhY3RvckNvdW50OyBzKyspIHsKICAgICAgICAgICAgICAgICAgICBjaGFubmVsLlNwZWN0cmFbc2ZdW3NdID0gY2hhbm5lbC5RdWFudGl6ZWRTcGVjdHJhW3NmXVtzXSAqCiAgICAgICAgICAgICAgICAgICAgICAgIGNoYW5uZWwuR2FpbltzXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHN0YXRpYyBSZXN0b3JlTWlzc2luZ0JhbmRzKGZyYW1lKSB7CiAgICAgICAgdGhpcy5SZWNvbnN0cnVjdEhpZ2hGcmVxdWVuY3koZnJhbWUpOwogICAgICAgIHRoaXMuQXBwbHlJbnRlbnNpdHlTdGVyZW8oZnJhbWUpOwogICAgfQogICAgc3RhdGljIENhbGN1bGF0ZUdhaW4oY2hhbm5lbCkgewogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2hhbm5lbC5Db2RlZFNjYWxlRmFjdG9yQ291bnQ7IGkrKykgewogICAgICAgICAgICBjaGFubmVsLkdhaW5baV0gPQogICAgICAgICAgICAgICAgSENBVGFibGVzLkRlcXVhbnRpemVyU2NhbGluZ1RhYmxlW2NoYW5uZWwuU2NhbGVGYWN0b3JzW2ldXSAqCiAgICAgICAgICAgICAgICAgICAgSENBVGFibGVzLlF1YW50aXplclN0ZXBTaXplW2NoYW5uZWwuUmVzb2x1dGlvbltpXV07CiAgICAgICAgfQogICAgfQogICAgc3RhdGljIFJlY29uc3RydWN0SGlnaEZyZXF1ZW5jeShmcmFtZSkgewogICAgICAgIGxldCBoY2EgPSBmcmFtZS5IY2E7CiAgICAgICAgaWYgKGhjYS5IZnJHcm91cENvdW50ID09IDApCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAvLyBUaGUgbGFzdCBzcGVjdHJhbCBjb2VmZmljaWVudCBzaG91bGQgYWx3YXlzIGJlIDA7CiAgICAgICAgbGV0IHRvdGFsQmFuZENvdW50ID0gTWF0aC5taW4oaGNhLmNvbXBEZWMuVG90YWxCYW5kQ291bnQsIDEyNyk7CiAgICAgICAgbGV0IGhmclN0YXJ0QmFuZCA9IGhjYS5jb21wRGVjLkJhc2VCYW5kQ291bnQgKyBoY2EuY29tcERlYy5TdGVyZW9CYW5kQ291bnQ7CiAgICAgICAgbGV0IGhmckJhbmRDb3VudCA9IE1hdGgubWluKGhjYS5jb21wRGVjLkhmckJhbmRDb3VudCwgdG90YWxCYW5kQ291bnQgLSBoY2EuY29tcERlYy5IZnJCYW5kQ291bnQpOwogICAgICAgIGZvciAobGV0IGNoYW5uZWwgb2YgZnJhbWUuQ2hhbm5lbHMpIHsKICAgICAgICAgICAgaWYgKGNoYW5uZWwuVHlwZSA9PSBIQ0FDaGFubmVsVHlwZSQxLlN0ZXJlb1NlY29uZGFyeSkKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICBmb3IgKGxldCBncm91cCA9IDAsIGJhbmQgPSAwOyBncm91cCA8IGhjYS5IZnJHcm91cENvdW50OyBncm91cCsrKSB7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGhjYS5jb21wRGVjLkJhbmRzUGVySGZyR3JvdXAgJiYgYmFuZCA8IGhmckJhbmRDb3VudDsgYmFuZCsrLCBpKyspIHsKICAgICAgICAgICAgICAgICAgICBsZXQgaGlnaEJhbmQgPSBoZnJTdGFydEJhbmQgKyBiYW5kOwogICAgICAgICAgICAgICAgICAgIGxldCBsb3dCYW5kID0gaGZyU3RhcnRCYW5kIC0gYmFuZCAtIDE7CiAgICAgICAgICAgICAgICAgICAgbGV0IGluZGV4ID0gY2hhbm5lbC5IZnJTY2FsZXNbZ3JvdXBdIC0gY2hhbm5lbC5TY2FsZUZhY3RvcnNbbG93QmFuZF0gKwogICAgICAgICAgICAgICAgICAgICAgICA2NDsKICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBzZiA9IDA7IHNmIDwgU3ViZnJhbWVzUGVyRnJhbWU7IHNmKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2hhbm5lbC5TcGVjdHJhW3NmXVtoaWdoQmFuZF0gPQogICAgICAgICAgICAgICAgICAgICAgICAgICAgSENBVGFibGVzLlNjYWxlQ29udmVyc2lvblRhYmxlW2luZGV4XSAqCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhbm5lbC5TcGVjdHJhW3NmXVtsb3dCYW5kXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBzdGF0aWMgQXBwbHlJbnRlbnNpdHlTdGVyZW8oZnJhbWUpIHsKICAgICAgICBpZiAoZnJhbWUuSGNhLmNvbXBEZWMuU3RlcmVvQmFuZENvdW50IDw9IDApCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICBmb3IgKGxldCBjID0gMDsgYyA8IGZyYW1lLkNoYW5uZWxzLmxlbmd0aDsgYysrKSB7CiAgICAgICAgICAgIGlmIChmcmFtZS5DaGFubmVsc1tjXS5UeXBlICE9IEhDQUNoYW5uZWxUeXBlJDEuU3RlcmVvUHJpbWFyeSkKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICBmb3IgKGxldCBzZiA9IDA7IHNmIDwgU3ViZnJhbWVzUGVyRnJhbWU7IHNmKyspIHsKICAgICAgICAgICAgICAgIGxldCBsID0gZnJhbWUuQ2hhbm5lbHNbY10uU3BlY3RyYVtzZl07CiAgICAgICAgICAgICAgICBsZXQgciA9IGZyYW1lLkNoYW5uZWxzW2MgKyAxXS5TcGVjdHJhW3NmXTsKICAgICAgICAgICAgICAgIGxldCByYXRpb0wgPSBIQ0FUYWJsZXMuSW50ZW5zaXR5UmF0aW9UYWJsZVtmcmFtZS5DaGFubmVsc1tjICsgMV0uSW50ZW5zaXR5W3NmXV07CiAgICAgICAgICAgICAgICBsZXQgcmF0aW9SID0gcmF0aW9MIC0gMi4wOwogICAgICAgICAgICAgICAgZm9yIChsZXQgYiA9IGZyYW1lLkhjYS5jb21wRGVjLkJhc2VCYW5kQ291bnQ7IGIgPCBmcmFtZS5IY2EuY29tcERlYy5Ub3RhbEJhbmRDb3VudDsgYisrKSB7CiAgICAgICAgICAgICAgICAgICAgcltiXSA9IGxbYl0gKiByYXRpb1I7CiAgICAgICAgICAgICAgICAgICAgbFtiXSAqPSByYXRpb0w7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBzdGF0aWMgUnVuSW1kY3QoZnJhbWUpIHsKICAgICAgICBmb3IgKGxldCBzZiA9IDA7IHNmIDwgU3ViZnJhbWVzUGVyRnJhbWU7IHNmKyspIHsKICAgICAgICAgICAgZm9yIChsZXQgY2hhbm5lbCBvZiBmcmFtZS5DaGFubmVscykgewogICAgICAgICAgICAgICAgY2hhbm5lbC5NZGN0LlJ1bkltZGN0KGNoYW5uZWwuU3BlY3RyYVtzZl0sIGNoYW5uZWwuUGNtRmxvYXRbc2ZdKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQoKY2xhc3MgSENBSW5mbyB7CiAgICBjb25zdHJ1Y3RvcihoY2EsIGNoYW5nZU1hc2sgPSBmYWxzZSwgZW5jcnlwdCA9IGZhbHNlKSB7CiAgICAgICAgdGhpcy52ZXJzaW9uID0gIiI7CiAgICAgICAgdGhpcy52ZXJzaW9uTWFqb3IgPSAyOwogICAgICAgIHRoaXMudmVyc2lvbk1pbm9yID0gMDsKICAgICAgICB0aGlzLmRhdGFPZmZzZXQgPSAwOwogICAgICAgIHRoaXMuZm9ybWF0ID0gewogICAgICAgICAgICBjaGFubmVsQ291bnQ6IDAsCiAgICAgICAgICAgIHNhbXBsaW5nUmF0ZTogMCwKICAgICAgICAgICAgYmxvY2tDb3VudDogMCwKICAgICAgICAgICAgZHJvcHBlZEhlYWRlcjogMCwKICAgICAgICAgICAgZHJvcHBlZEZvb3RlcjogMCwKICAgICAgICB9OwogICAgICAgIHRoaXMuYmxvY2tTaXplID0gMDsKICAgICAgICB0aGlzLmhhc0hlYWRlciA9IHt9OwogICAgICAgIHRoaXMuaGVhZGVyT2Zmc2V0ID0ge307IC8vIFtzdGFydCAoaW5jbHVzaXZlKSwgZW5kIChleGNsdXNpdmUpXQogICAgICAgIHRoaXMua2JwcyA9IDA7CiAgICAgICAgdGhpcy5jb21wRGVjID0gewogICAgICAgICAgICBNaW5SZXNvbHV0aW9uOiAwLAogICAgICAgICAgICBNYXhSZXNvbHV0aW9uOiAwLAogICAgICAgICAgICBUcmFja0NvdW50OiAwLAogICAgICAgICAgICBDaGFubmVsQ29uZmlnOiAwLAogICAgICAgICAgICBUb3RhbEJhbmRDb3VudDogMCwKICAgICAgICAgICAgQmFzZUJhbmRDb3VudDogMCwKICAgICAgICAgICAgU3RlcmVvQmFuZENvdW50OiAwLAogICAgICAgICAgICBIZnJCYW5kQ291bnQ6IDAsCiAgICAgICAgICAgIEJhbmRzUGVySGZyR3JvdXA6IDAsCiAgICAgICAgICAgIFJlc2VydmVkMTogMCwKICAgICAgICAgICAgUmVzZXJ2ZWQyOiAwLAogICAgICAgIH07CiAgICAgICAgdGhpcy5kZWMgPSB7CiAgICAgICAgICAgIERlY1N0ZXJlb1R5cGU6IDAsCiAgICAgICAgfTsKICAgICAgICB0aGlzLmxvb3AgPSB7CiAgICAgICAgICAgIHN0YXJ0OiAwLAogICAgICAgICAgICBlbmQ6IDAsCiAgICAgICAgICAgIC8vIGNvdW50OiAwLCAvLyBOeWFnYW1vbidzIGludGVycHJldGF0aW9uCiAgICAgICAgICAgIC8vIHIwMTogMCwKICAgICAgICAgICAgZHJvcHBlZEhlYWRlcjogMCwKICAgICAgICAgICAgZHJvcHBlZEZvb3RlcjogMCwKICAgICAgICB9OwogICAgICAgIHRoaXMudmJyID0gewogICAgICAgICAgICBNYXhCbG9ja1NpemU6IDAsCiAgICAgICAgICAgIE5vaXNlTGV2ZWw6IDAsCiAgICAgICAgfTsKICAgICAgICB0aGlzLlVzZUF0aEN1cnZlID0gZmFsc2U7CiAgICAgICAgdGhpcy5jaXBoZXIgPSAwOwogICAgICAgIHRoaXMucnZhID0gMC4wOwogICAgICAgIHRoaXMuY29tbWVudCA9ICIiOwogICAgICAgIC8vIGNvbXB1dGVkIHNhbXBsZSBjb3VudC9vZmZzZXRzCiAgICAgICAgdGhpcy5IZnJHcm91cENvdW50ID0gMDsKICAgICAgICB0aGlzLmZ1bGxTYW1wbGVDb3VudCA9IDA7CiAgICAgICAgdGhpcy5zdGFydEF0U2FtcGxlID0gMDsKICAgICAgICB0aGlzLmZ1bGxFbmRBdFNhbXBsZSA9IDA7CiAgICAgICAgdGhpcy5sb29wU3RhcnRBdFNhbXBsZSA9IDA7CiAgICAgICAgdGhpcy5sb29wRW5kQXRTYW1wbGUgPSAwOwogICAgICAgIHRoaXMubG9vcFNhbXBsZUNvdW50ID0gMDsKICAgICAgICB0aGlzLmxvb3BTdGFydFRpbWUgPSAwOyAvLyBpbiBzZWNvbmRzCiAgICAgICAgdGhpcy5sb29wRW5kVGltZSA9IDA7IC8vIGluIHNlY29uZHMKICAgICAgICB0aGlzLmxvb3BEdXJhdGlvbiA9IDA7IC8vIGluIHNlY29uZHMKICAgICAgICB0aGlzLmVuZEF0U2FtcGxlID0gMDsKICAgICAgICB0aGlzLnNhbXBsZUNvdW50ID0gMDsKICAgICAgICB0aGlzLmR1cmF0aW9uID0gMDsgLy8gaW4gc2Vjb25kcwogICAgICAgIC8vIGZ1bGwgZmlsZSBzaXplIC8gZGF0YSBwYXJ0IChleGNsdWRpbmcgaGVhZGVyLCBqdXN0IGJsb2Nrcy9mcmFtZXMpIHNpemUKICAgICAgICB0aGlzLmZ1bGxTaXplID0gMDsKICAgICAgICB0aGlzLmRhdGFTaXplID0gMDsKICAgICAgICAvLyBpZiBjaGFuZ2VNYXNrID09IHRydWUsICh1biltYXNrIHRoZSBoZWFkZXIgc2lncyBpbi1wbGFjZQogICAgICAgIHRoaXMucmF3SGVhZGVyID0gdGhpcy5wYXJzZUhlYWRlcihoY2EsIGNoYW5nZU1hc2ssIGVuY3J5cHQsIHt9KTsKICAgIH0KICAgIHN0YXRpYyBnZXRTaWduKHJhdywgb2Zmc2V0ID0gMCwgY2hhbmdlTWFzaywgZW5jcnlwdCkgewogICAgICAgIGxldCBtYWdpYyA9IHJhdy5nZXRVaW50MzIob2Zmc2V0LCB0cnVlKTsKICAgICAgICBsZXQgc3RyTGVuID0gNDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDQ7IGkrKykgewogICAgICAgICAgICBpZiAocmF3LmdldFVpbnQ4KG9mZnNldCArIGkpID09IDApIHsKICAgICAgICAgICAgICAgIHN0ckxlbiA9IGk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoc3RyTGVuID4gMCkgewogICAgICAgICAgICBsZXQgbWFzayA9IDB4ODA4MDgwODAgPj4+IDggKiAoNCAtIHN0ckxlbik7CiAgICAgICAgICAgIG1hZ2ljICY9IDB4N2Y3ZjdmN2Y7CiAgICAgICAgICAgIGlmIChjaGFuZ2VNYXNrKSB7CiAgICAgICAgICAgICAgICByYXcuc2V0VWludDMyKG9mZnNldCwgZW5jcnlwdCA/IG1hZ2ljIHwgbWFzayA6IG1hZ2ljLCB0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBsZXQgaGV4ID0gWwogICAgICAgICAgICBtYWdpYyAmIDB4ZmYsCiAgICAgICAgICAgIG1hZ2ljID4+IDggJiAweGZmLAogICAgICAgICAgICBtYWdpYyA+PiAxNiAmIDB4ZmYsCiAgICAgICAgICAgIG1hZ2ljID4+IDI0ICYgMHhmZiwKICAgICAgICBdOwogICAgICAgIGhleCA9IGhleC5zbGljZSgwLCBzdHJMZW4pOwogICAgICAgIHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KFN0cmluZywgaGV4KTsKICAgIH0KICAgIGNsb25lKCkgewogICAgICAgIHJldHVybiBuZXcgSENBSW5mbyh0aGlzLnJhd0hlYWRlcik7CiAgICB9CiAgICBwYXJzZUhlYWRlcihoY2EsIGNoYW5nZU1hc2ssIGVuY3J5cHQsIG1vZExpc3QpIHsKICAgICAgICBsZXQgcCA9IG5ldyBEYXRhVmlldyhoY2EuYnVmZmVyLCBoY2EuYnl0ZU9mZnNldCwgOCk7CiAgICAgICAgbGV0IGhlYWQgPSBIQ0FJbmZvLmdldFNpZ24ocCwgMCwgZmFsc2UsIGVuY3J5cHQpOyAvLyBkbyBub3Qgb3ZlcndyaXRlIGZvciBub3csIHVudGlsIGNoZWNrc3VtIHZlcmlmaWVkCiAgICAgICAgaWYgKGhlYWQgIT09ICJIQ0EiKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiTm90IGEgSENBIGZpbGUiKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdmVyc2lvbiA9IHsKICAgICAgICAgICAgbWFpbjogcC5nZXRVaW50OCg0KSwKICAgICAgICAgICAgc3ViOiBwLmdldFVpbnQ4KDUpLAogICAgICAgIH07CiAgICAgICAgdGhpcy52ZXJzaW9uID0gdmVyc2lvbi5tYWluICsgIi4iICsgdmVyc2lvbi5zdWI7CiAgICAgICAgdGhpcy52ZXJzaW9uTWFqb3IgPSB2ZXJzaW9uLm1haW47CiAgICAgICAgdGhpcy52ZXJzaW9uTWlub3IgPSB2ZXJzaW9uLnN1YjsKICAgICAgICB0aGlzLmRhdGFPZmZzZXQgPSBwLmdldFVpbnQxNig2KTsKICAgICAgICAvLyB2ZXJpZnkgY2hlY2tzdW0KICAgICAgICBDcmMxNi52ZXJpZnkoaGNhLCB0aGlzLmRhdGFPZmZzZXQgLSAyKTsKICAgICAgICBsZXQgaGFzTW9kRG9uZSA9IGZhbHNlOwogICAgICAgIC8vIGNoZWNrc3VtIHZlcmlmaWVkLCBub3cgd2UgY2FuIG92ZXJ3cml0ZSBpdAogICAgICAgIGlmIChjaGFuZ2VNYXNrKQogICAgICAgICAgICBIQ0FJbmZvLmdldFNpZ24ocCwgMCwgY2hhbmdlTWFzaywgZW5jcnlwdCk7CiAgICAgICAgLy8gcGFyc2UgdGhlIGhlYWRlcgogICAgICAgIHAgPSBuZXcgRGF0YVZpZXcoaGNhLmJ1ZmZlciwgaGNhLmJ5dGVPZmZzZXQsIHRoaXMuZGF0YU9mZnNldCk7CiAgICAgICAgbGV0IGZ0ZWxsID0gODsKICAgICAgICB3aGlsZSAoZnRlbGwgPCB0aGlzLmRhdGFPZmZzZXQgLSAyKSB7CiAgICAgICAgICAgIGxldCBsYXN0RnRlbGwgPSBmdGVsbDsKICAgICAgICAgICAgLy8gZ2V0IHRoZSBzaWcKICAgICAgICAgICAgbGV0IHNpZ24gPSBIQ0FJbmZvLmdldFNpZ24ocCwgZnRlbGwsIGNoYW5nZU1hc2ssIGVuY3J5cHQpOwogICAgICAgICAgICAvLyByZWNvcmQgaGFzSGVhZGVyCiAgICAgICAgICAgIHRoaXMuaGFzSGVhZGVyW3NpZ25dID0gdHJ1ZTsKICAgICAgICAgICAgLy8gcGFkZGluZyBzaG91bGQgYmUgdGhlIGxhc3Qgb25lCiAgICAgICAgICAgIGlmIChzaWduID09ICJwYWQiKSB7CiAgICAgICAgICAgICAgICB0aGlzLmhlYWRlck9mZnNldFtzaWduXSA9IFtmdGVsbCwgdGhpcy5kYXRhT2Zmc2V0IC0gMl07CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBwYXJzZSBkYXRhIGFjY29yZGluZ2x5CiAgICAgICAgICAgIHN3aXRjaCAoc2lnbikgewogICAgICAgICAgICAgICAgY2FzZSAiZm10IjoKICAgICAgICAgICAgICAgICAgICB0aGlzLmZvcm1hdC5jaGFubmVsQ291bnQgPSBwLmdldFVpbnQ4KGZ0ZWxsICsgNCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5mb3JtYXQuc2FtcGxpbmdSYXRlID0gcC5nZXRVaW50MzIoZnRlbGwgKyA0KSAmIDB4MDBmZmZmZmY7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5mb3JtYXQuYmxvY2tDb3VudCA9IHAuZ2V0VWludDMyKGZ0ZWxsICsgOCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5mb3JtYXQuZHJvcHBlZEhlYWRlciA9IHAuZ2V0VWludDE2KGZ0ZWxsICsgMTIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZm9ybWF0LmRyb3BwZWRGb290ZXIgPSBwLmdldFVpbnQxNihmdGVsbCArIDE0KTsKICAgICAgICAgICAgICAgICAgICBmdGVsbCArPSAxNjsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgImNvbXAiOgogICAgICAgICAgICAgICAgICAgIHRoaXMuYmxvY2tTaXplID0gcC5nZXRVaW50MTYoZnRlbGwgKyA0KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmticHMgPSB0aGlzLmZvcm1hdC5zYW1wbGluZ1JhdGUgKiB0aGlzLmJsb2NrU2l6ZSAvIDEyODAwMC4wOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY29tcERlYy5NaW5SZXNvbHV0aW9uID0gcC5nZXRVaW50OChmdGVsbCArIDYpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY29tcERlYy5NYXhSZXNvbHV0aW9uID0gcC5nZXRVaW50OChmdGVsbCArIDcpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY29tcERlYy5UcmFja0NvdW50ID0gcC5nZXRVaW50OChmdGVsbCArIDgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY29tcERlYy5DaGFubmVsQ29uZmlnID0gcC5nZXRVaW50OChmdGVsbCArIDkpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY29tcERlYy5Ub3RhbEJhbmRDb3VudCA9IHAuZ2V0VWludDgoZnRlbGwgKyAxMCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21wRGVjLkJhc2VCYW5kQ291bnQgPSBwLmdldFVpbnQ4KGZ0ZWxsICsgMTEpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY29tcERlYy5TdGVyZW9CYW5kQ291bnQgPSBwLmdldFVpbnQ4KGZ0ZWxsICsgMTIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY29tcERlYy5CYW5kc1Blckhmckdyb3VwID0gcC5nZXRVaW50OChmdGVsbCArIDEzKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbXBEZWMuUmVzZXJ2ZWQxID0gcC5nZXRVaW50OChmdGVsbCArIDE0KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbXBEZWMuUmVzZXJ2ZWQyID0gcC5nZXRVaW50OChmdGVsbCArIDE1KTsKICAgICAgICAgICAgICAgICAgICBmdGVsbCArPSAxNjsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgImRlYyI6CiAgICAgICAgICAgICAgICAgICAgdGhpcy5ibG9ja1NpemUgPSBwLmdldFVpbnQxNihmdGVsbCArIDQpOwogICAgICAgICAgICAgICAgICAgIHRoaXMua2JwcyA9IHRoaXMuZm9ybWF0LnNhbXBsaW5nUmF0ZSAqIHRoaXMuYmxvY2tTaXplIC8gMTI4MDAwLjA7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21wRGVjLk1pblJlc29sdXRpb24gPSBwLmdldFVpbnQ4KGZ0ZWxsICsgNik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21wRGVjLk1heFJlc29sdXRpb24gPSBwLmdldFVpbnQ4KGZ0ZWxsICsgNyk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21wRGVjLlRvdGFsQmFuZENvdW50ID0gcC5nZXRVaW50OChmdGVsbCArIDgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY29tcERlYy5CYXNlQmFuZENvdW50ID0gcC5nZXRVaW50OChmdGVsbCArIDkpOwogICAgICAgICAgICAgICAgICAgIGxldCBhID0gcC5nZXRVaW50OChmdGVsbCArIDEwKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbXBEZWMuVHJhY2tDb3VudCA9IEdldEhpZ2hOaWJibGUoYSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21wRGVjLkNoYW5uZWxDb25maWcgPSBHZXRMb3dOaWJibGUoYSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kZWMuRGVjU3RlcmVvVHlwZSA9IHAuZ2V0VWludDgoZnRlbGwgKyAxMSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVjLkRlY1N0ZXJlb1R5cGUgPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbXBEZWMuQmFzZUJhbmRDb3VudCA9IHRoaXMuY29tcERlYy5Ub3RhbEJhbmRDb3VudDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY29tcERlYy5TdGVyZW9CYW5kQ291bnQgPSB0aGlzLmNvbXBEZWMuVG90YWxCYW5kQ291bnQgLQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21wRGVjLkJhc2VCYW5kQ291bnQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGZ0ZWxsICs9IDEyOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAidmJyIjoKICAgICAgICAgICAgICAgICAgICBmdGVsbCArPSA4OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAiYXRoIjoKICAgICAgICAgICAgICAgICAgICB0aGlzLlVzZUF0aEN1cnZlID0gcC5nZXRVaW50MTYoZnRlbGwgKyA0KSA9PSAxOwogICAgICAgICAgICAgICAgICAgIGZ0ZWxsICs9IDY7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJsb29wIjoKICAgICAgICAgICAgICAgICAgICB0aGlzLmxvb3Auc3RhcnQgPSBwLmdldFVpbnQzMihmdGVsbCArIDQpOwogICAgICAgICAgICAgICAgICAgIHRoaXMubG9vcC5lbmQgPSBwLmdldFVpbnQzMihmdGVsbCArIDgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMubG9vcC5kcm9wcGVkSGVhZGVyID0gcC5nZXRVaW50MTYoZnRlbGwgKyAxMik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb29wLmRyb3BwZWRGb290ZXIgPSBwLmdldFVpbnQxNihmdGVsbCArIDE0KTsKICAgICAgICAgICAgICAgICAgICBmdGVsbCArPSAxNjsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgImNpcGgiOgogICAgICAgICAgICAgICAgICAgIHRoaXMuY2lwaGVyID0gcC5nZXRVaW50MTYoZnRlbGwgKyA0KTsKICAgICAgICAgICAgICAgICAgICBmdGVsbCArPSA2OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAicnZhIjoKICAgICAgICAgICAgICAgICAgICB0aGlzLnJ2YSA9IHAuZ2V0RmxvYXQzMihmdGVsbCArIDQpOwogICAgICAgICAgICAgICAgICAgIGZ0ZWxsICs9IDg7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJ2YnIiOgogICAgICAgICAgICAgICAgICAgIHRoaXMudmJyLk1heEJsb2NrU2l6ZSA9IHAuZ2V0VWludDE2KGZ0ZWxsICsgNCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52YnIuTm9pc2VMZXZlbCA9IHAuZ2V0SW50MTYoZnRlbGwgKyA2KTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgImNvbW0iOgogICAgICAgICAgICAgICAgICAgIGxldCBsZW4gPSBwLmdldFVpbnQ4KGZ0ZWxsICsgNCk7CiAgICAgICAgICAgICAgICAgICAgbGV0IGppc2RlY29kZXIgPSBuZXcgVGV4dERlY29kZXIoInNoaWZ0LWppcyIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY29tbWVudCA9IGppc2RlY29kZXIuZGVjb2RlKGhjYS5zbGljZShmdGVsbCArIDUsIGZ0ZWxsICsgNSArIGxlbikpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInVua25vd24gaGVhZGVyIHNpZyIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIHJlY29yZCBoZWFkZXJPZmZzZXQKICAgICAgICAgICAgdGhpcy5oZWFkZXJPZmZzZXRbc2lnbl0gPSBbbGFzdEZ0ZWxsLCBmdGVsbF07CiAgICAgICAgICAgIC8vIGRvIG1vZGlmaWNhdGlvbiBpZiBuZWVkZWQKICAgICAgICAgICAgbGV0IHNlY3Rpb25EYXRhTGVuID0gZnRlbGwgLSBsYXN0RnRlbGwgLSA0OwogICAgICAgICAgICBsZXQgbmV3RGF0YSA9IG1vZExpc3Rbc2lnbl07CiAgICAgICAgICAgIGlmIChuZXdEYXRhICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChuZXdEYXRhLmJ5dGVMZW5ndGggPiBzZWN0aW9uRGF0YUxlbikKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICAgICAgICAgIGhjYS5zZXQobmV3RGF0YSwgbGFzdEZ0ZWxsICsgNCk7CiAgICAgICAgICAgICAgICBoYXNNb2REb25lID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvKgogICAgICAgICAgLy8gKHBvcnRlZCBmcm9tKSBOeWFnYW1vbidzIG9yaWdpbmFsIGNvZGUsIHNob3VsZCBiZSAoYWxtb3N0KSBlcXVpdmFsZW50IHRvIENhbGN1bGF0ZUhmclZhbHVlcwogICAgICAgICAgdGhpcy5jb21wUGFyYW1bMl0gPSB0aGlzLmNvbXBQYXJhbVsyXSB8fCAxOwogICAgICAgICAgbGV0IF9hID0gdGhpcy5jb21wUGFyYW1bNF0gLSB0aGlzLmNvbXBQYXJhbVs1XSAtIHRoaXMuY29tcFBhcmFtWzZdOwogICAgICAgICAgbGV0IF9iID0gdGhpcy5jb21wUGFyYW1bN107CiAgICAgICAgICB0aGlzLmNvbXBEZWMuUmVzZXJ2ZWQxID0gX2IgPiAwID8gX2EgLyBfYiArIChfYSAlIF9iID8gMSA6IDApIDogMDsKICAgICAgICAgIC8vIFRyYW5zbGF0aW5nIHRoZSBhYm92ZSBjb2RlIHdpdGggbWVhbmluZ2Z1bCB2YXJpYWJsZSBuYW1lczoKICAgICAgICAgIHRoaXMuY29tcERlYy5UcmFja0NvdW50ID0gdGhpcy5jb21wRGVjLlRyYWNrQ291bnQgfHwgMTsKICAgICAgICAgIHRoaXMuY29tcERlYy5IZnJCYW5kQ291bnQgPSB0aGlzLmNvbXBEZWMuVG90YWxCYW5kQ291bnQgLSB0aGlzLmNvbXBEZWMuQmFzZUJhbmRDb3VudCAtIHRoaXMuY29tcERlYy5TdGVyZW9CYW5kQ291bnQ7CiAgICAgICAgICB0aGlzLkhmckdyb3VwQ291bnQgPSB0aGlzLmNvbXBEZWMuQmFuZHNQZXJIZnJHcm91cDsKICAgICAgICAgIHRoaXMuY29tcERlYy5SZXNlcnZlZDEgPSB0aGlzLkhmckdyb3VwQ291bnQgPiAwID8gdGhpcy5jb21wRGVjLkhmckJhbmRDb3VudCAvIHRoaXMuSGZyR3JvdXBDb3VudCArICh0aGlzLmNvbXBEZWMuSGZyQmFuZENvdW50ICUgdGhpcy5IZnJHcm91cENvdW50ID8gMSA6IDApIDogMDsKICAgICAgICAgICovCiAgICAgICAgLy8gQ2FsY3VsYXRlSGZyVmFsdWVzLCBwb3J0ZWQgZnJvbSBWR0F1ZGlvCiAgICAgICAgaWYgKHRoaXMuY29tcERlYy5CYW5kc1Blckhmckdyb3VwID4gMCkgewogICAgICAgICAgICB0aGlzLmNvbXBEZWMuSGZyQmFuZENvdW50ID0gdGhpcy5jb21wRGVjLlRvdGFsQmFuZENvdW50IC0KICAgICAgICAgICAgICAgIHRoaXMuY29tcERlYy5CYXNlQmFuZENvdW50IC0gdGhpcy5jb21wRGVjLlN0ZXJlb0JhbmRDb3VudDsKICAgICAgICAgICAgdGhpcy5IZnJHcm91cENvdW50ID0gRGl2aWRlQnlSb3VuZFVwKHRoaXMuY29tcERlYy5IZnJCYW5kQ291bnQsIHRoaXMuY29tcERlYy5CYW5kc1Blckhmckdyb3VwKTsKICAgICAgICB9CiAgICAgICAgLy8gY2FsY3VsYXRlIHNhbXBsZSBjb3VudC9vZmZzZXRzCiAgICAgICAgdGhpcy5mdWxsU2FtcGxlQ291bnQgPSB0aGlzLmZvcm1hdC5ibG9ja0NvdW50ICogU2FtcGxlc1BlckZyYW1lOwogICAgICAgIHRoaXMuc3RhcnRBdFNhbXBsZSA9IHRoaXMuZm9ybWF0LmRyb3BwZWRIZWFkZXI7CiAgICAgICAgdGhpcy5mdWxsRW5kQXRTYW1wbGUgPSB0aGlzLmZ1bGxTYW1wbGVDb3VudCAtIHRoaXMuZm9ybWF0LmRyb3BwZWRGb290ZXI7CiAgICAgICAgaWYgKHRoaXMuaGFzSGVhZGVyWyJsb29wIl0pIHsKICAgICAgICAgICAgdGhpcy5sb29wU3RhcnRBdFNhbXBsZSA9IHRoaXMubG9vcC5zdGFydCAqIEhDQUZyYW1lLlNhbXBsZXNQZXJGcmFtZSArIHRoaXMubG9vcC5kcm9wcGVkSGVhZGVyOwogICAgICAgICAgICB0aGlzLmxvb3BFbmRBdFNhbXBsZSA9ICh0aGlzLmxvb3AuZW5kICsgMSkgKiBIQ0FGcmFtZS5TYW1wbGVzUGVyRnJhbWUgLSB0aGlzLmxvb3AuZHJvcHBlZEZvb3RlcjsKICAgICAgICAgICAgdGhpcy5sb29wU2FtcGxlQ291bnQgPSB0aGlzLmxvb3BFbmRBdFNhbXBsZSAtIHRoaXMubG9vcFN0YXJ0QXRTYW1wbGU7CiAgICAgICAgICAgIHRoaXMubG9vcFN0YXJ0VGltZSA9ICh0aGlzLmxvb3BTdGFydEF0U2FtcGxlIC0gdGhpcy5zdGFydEF0U2FtcGxlKSAvIHRoaXMuZm9ybWF0LnNhbXBsaW5nUmF0ZTsKICAgICAgICAgICAgdGhpcy5sb29wRHVyYXRpb24gPSB0aGlzLmxvb3BTYW1wbGVDb3VudCAvIHRoaXMuZm9ybWF0LnNhbXBsaW5nUmF0ZTsKICAgICAgICAgICAgdGhpcy5sb29wRW5kVGltZSA9IHRoaXMubG9vcFN0YXJ0VGltZSArIHRoaXMubG9vcER1cmF0aW9uOwogICAgICAgIH0KICAgICAgICB0aGlzLmVuZEF0U2FtcGxlID0gdGhpcy5oYXNIZWFkZXJbImxvb3AiXQogICAgICAgICAgICA/IHRoaXMubG9vcEVuZEF0U2FtcGxlCiAgICAgICAgICAgIDogdGhpcy5mdWxsRW5kQXRTYW1wbGU7CiAgICAgICAgdGhpcy5zYW1wbGVDb3VudCA9IHRoaXMuZW5kQXRTYW1wbGUgLSB0aGlzLnN0YXJ0QXRTYW1wbGU7CiAgICAgICAgdGhpcy5kdXJhdGlvbiA9IHRoaXMuc2FtcGxlQ291bnQgLyB0aGlzLmZvcm1hdC5zYW1wbGluZ1JhdGU7CiAgICAgICAgLy8gY2FsY3VsYXRlIGZpbGUvZGF0YSBzaXplCiAgICAgICAgdGhpcy5kYXRhU2l6ZSA9IHRoaXMuYmxvY2tTaXplICogdGhpcy5mb3JtYXQuYmxvY2tDb3VudDsKICAgICAgICB0aGlzLmZ1bGxTaXplID0gdGhpcy5kYXRhT2Zmc2V0ICsgdGhpcy5kYXRhU2l6ZTsKICAgICAgICBpZiAoY2hhbmdlTWFzayB8fCBoYXNNb2REb25lKSB7CiAgICAgICAgICAgIC8vIGZpeCBjaGVja3N1bSBpZiByZXF1ZXN0ZWQKICAgICAgICAgICAgQ3JjMTYuZml4KGhjYSwgdGhpcy5kYXRhT2Zmc2V0IC0gMik7CiAgICAgICAgfQogICAgICAgIGxldCByYXdIZWFkZXIgPSBoY2Euc2xpY2UoMCwgdGhpcy5kYXRhT2Zmc2V0KTsKICAgICAgICAvLyBjaGVjayB2YWxpZGl0eSBvZiBwYXJzZWQgdmFsdWVzCiAgICAgICAgdGhpcy5jaGVja1ZhbGlkaXR5KCk7CiAgICAgICAgcmV0dXJuIHJhd0hlYWRlcjsKICAgIH0KICAgIGNoZWNrVmFsaWRpdHkoKSB7CiAgICAgICAgY29uc3QgcmVzdWx0cyA9IFsKICAgICAgICAgICAgdGhpcy5ibG9ja1NpemUgPiAwLAogICAgICAgICAgICAwIDwgdGhpcy5mb3JtYXQuYmxvY2tDb3VudCwKICAgICAgICAgICAgMCA8PSB0aGlzLnN0YXJ0QXRTYW1wbGUsCiAgICAgICAgICAgIHRoaXMuc3RhcnRBdFNhbXBsZSA8IHRoaXMuZnVsbEVuZEF0U2FtcGxlLAogICAgICAgICAgICB0aGlzLmZ1bGxFbmRBdFNhbXBsZSA8PSB0aGlzLmZ1bGxTYW1wbGVDb3VudCwKICAgICAgICAgICAgdGhpcy5kdXJhdGlvbiA+IDAsCiAgICAgICAgXTsKICAgICAgICByZXN1bHRzLmZpbmQoKHJlc3VsdCwgaW5kZXgpID0+IHsKICAgICAgICAgICAgaWYgKCFyZXN1bHQpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgZGlkIG5vdCBwYXNzIG5vcm1hbCBjaGVjayBvbiBydWxlICR7aW5kZXh9YCk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBpZiAodGhpcy5oYXNIZWFkZXJbImxvb3AiXSkgewogICAgICAgICAgICBjb25zdCBsb29wQ2hlY2tzID0gWwogICAgICAgICAgICAgICAgdGhpcy5zdGFydEF0U2FtcGxlIDw9IHRoaXMubG9vcFN0YXJ0QXRTYW1wbGUsCiAgICAgICAgICAgICAgICB0aGlzLmxvb3BTdGFydEF0U2FtcGxlIDwgdGhpcy5sb29wRW5kQXRTYW1wbGUsCiAgICAgICAgICAgICAgICB0aGlzLmxvb3BFbmRBdFNhbXBsZSA8PSB0aGlzLmZ1bGxFbmRBdFNhbXBsZSwKICAgICAgICAgICAgICAgIDAgPD0gdGhpcy5sb29wU3RhcnRUaW1lLAogICAgICAgICAgICAgICAgdGhpcy5sb29wU3RhcnRUaW1lIDwgdGhpcy5sb29wRW5kVGltZSwKICAgICAgICAgICAgICAgIHRoaXMubG9vcEVuZFRpbWUgPD0gdGhpcy5kdXJhdGlvbiArIDEuMCAvIHRoaXMuZm9ybWF0LnNhbXBsaW5nUmF0ZSwKICAgICAgICAgICAgXTsKICAgICAgICAgICAgbG9vcENoZWNrcy5maW5kKChyZXN1bHQsIGluZGV4KSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIXJlc3VsdCkgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgZGlkIG5vdCBwYXNzIGxvb3AgY2hlY2sgb24gcnVsZSAke2luZGV4fWApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CiAgICBnZXRSYXdIZWFkZXIoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucmF3SGVhZGVyLnNsaWNlKDApOwogICAgfQogICAgaXNIZWFkZXJDaGFuZ2VkKGhjYSkgewogICAgICAgIGlmIChoY2EubGVuZ3RoID49IHRoaXMucmF3SGVhZGVyLmxlbmd0aCkgewogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMucmF3SGVhZGVyLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAoaGNhW2ldICE9IHRoaXMucmF3SGVhZGVyW2ldKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBtb2RpZnkoaGNhLCBzaWcsIG5ld0RhdGEpIHsKICAgICAgICAvLyByZXBhcnNlIGhlYWRlciBpZiBuZWVkZWQKICAgICAgICBpZiAodGhpcy5pc0hlYWRlckNoYW5nZWQoaGNhKSkgewogICAgICAgICAgICB0aGlzLnBhcnNlSGVhZGVyKGhjYSwgZmFsc2UsIGZhbHNlLCB7fSk7CiAgICAgICAgfQogICAgICAgIC8vIHByZXBhcmUgdG8gbW9kaWZ5IGRhdGEgaW4tcGxhY2UKICAgICAgICBsZXQgbW9kTGlzdCA9IHt9OwogICAgICAgIG1vZExpc3Rbc2lnXSA9IG5ld0RhdGE7CiAgICAgICAgbGV0IGVuY3J5cHQgPSB0aGlzLmNpcGhlciAhPSAwOwogICAgICAgIGlmIChzaWcgPT09ICJjaXBoIikgewogICAgICAgICAgICBlbmNyeXB0ID0KICAgICAgICAgICAgICAgIG5ldyBEYXRhVmlldyhuZXdEYXRhLmJ1ZmZlciwgbmV3RGF0YS5ieXRlT2Zmc2V0LCBuZXdEYXRhLmJ5dGVMZW5ndGgpCiAgICAgICAgICAgICAgICAgICAgLmdldFVpbnQxNigwKSAhPSAwOwogICAgICAgIH0KICAgICAgICAvLyBkbyBhY3R1YWwgbW9kaWZpY2F0aW9uICYgY2hlY2sgdmFsaWRpdHkKICAgICAgICB0aGlzLnJhd0hlYWRlciA9IHRoaXMucGFyc2VIZWFkZXIoaGNhLCB0cnVlLCBlbmNyeXB0LCBtb2RMaXN0KTsKICAgIH0KICAgIHN0YXRpYyBhZGRIZWFkZXIoaGNhLCBzaWcsIG5ld0RhdGEpIHsKICAgICAgICAvLyBzaWcgbXVzdCBjb25zaXN0IG9mIDEtNCBBU0NJSSBjaGFyYWN0ZXJzCiAgICAgICAgaWYgKHNpZy5sZW5ndGggPCAxIHx8IHNpZy5sZW5ndGggPiA0KQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICBsZXQgbmV3U2lnID0gbmV3IFVpbnQ4QXJyYXkoNCk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCA0OyBpKyspIHsKICAgICAgICAgICAgbGV0IGMgPSBzaWcuY2hhckNvZGVBdChpKTsKICAgICAgICAgICAgaWYgKGMgPj0gMHg4MCkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgICAgICBuZXdTaWdbaV0gPSBjOwogICAgICAgIH0KICAgICAgICAvLyBwYXJzZSBoZWFkZXIgJiBjaGVjayB2YWxpZHR5CiAgICAgICAgbGV0IGluZm8gPSBuZXcgSENBSW5mbyhoY2EpOwogICAgICAgIC8vIGNoZWNrIHdoZXRoZXIgc3BlY2lmaWVkIGhlYWRlciBzZWN0aW9uIGFscmVhZHkgZXhpc3RzCiAgICAgICAgaWYgKGluZm8uaGFzSGVhZGVyW3NpZ10pIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBoZWFkZXIgc2VjdGlvbiAke3NpZ30gYWxyZWFkeSBleGlzdHNgKTsKICAgICAgICB9CiAgICAgICAgLy8gcHJlcGFyZSBhIG5ld2x5IGFsbG9jYXRlZCBidWZmZXIKICAgICAgICBsZXQgbmV3SGNhID0gbmV3IFVpbnQ4QXJyYXkoaGNhLmJ5dGVMZW5ndGggKyBuZXdTaWcuYnl0ZUxlbmd0aCArIG5ld0RhdGEuYnl0ZUxlbmd0aCk7CiAgICAgICAgbGV0IGluc2VydE9mZnNldCA9IGluZm8uaGVhZGVyT2Zmc2V0WyJwYWQiXVswXTsKICAgICAgICAvLyBjb3B5IGV4aXN0aW5nIGhlYWRlcnMgKGV4Y2VwdCBwYWRkaW5nKQogICAgICAgIG5ld0hjYS5zZXQoaGNhLnN1YmFycmF5KDAsIGluc2VydE9mZnNldCksIDApOwogICAgICAgIC8vIGNvcHkgaW5zZXJ0ZWQgaGVhZGVyCiAgICAgICAgbmV3SGNhLnNldChuZXdTaWcsIGluc2VydE9mZnNldCk7CiAgICAgICAgbmV3SGNhLnNldChuZXdEYXRhLCBpbnNlcnRPZmZzZXQgKyBuZXdTaWcuYnl0ZUxlbmd0aCk7CiAgICAgICAgLy8gY29weSByZW1haW5pbmcgZGF0YSAocGFkZGluZyBhbmQgYmxvY2tzKQogICAgICAgIG5ld0hjYS5zZXQoaGNhLnN1YmFycmF5KGluc2VydE9mZnNldCwgaGNhLmJ5dGVMZW5ndGgpLCBpbnNlcnRPZmZzZXQgKyBuZXdTaWcuYnl0ZUxlbmd0aCArIG5ld0RhdGEuYnl0ZUxlbmd0aCk7CiAgICAgICAgLy8gdXBkYXRlIGRhdGFPZmZzZXQKICAgICAgICBpbmZvLmRhdGFPZmZzZXQgKz0gbmV3U2lnLmJ5dGVMZW5ndGggKyBuZXdEYXRhLmJ5dGVMZW5ndGg7CiAgICAgICAgbGV0IHAgPSBuZXcgRGF0YVZpZXcobmV3SGNhLmJ1ZmZlciwgbmV3SGNhLmJ5dGVPZmZzZXQsIG5ld0hjYS5ieXRlTGVuZ3RoKTsKICAgICAgICBwLnNldEludDE2KDYsIGluZm8uZGF0YU9mZnNldCk7CiAgICAgICAgLy8gZml4IGNoZWNrc3VtCiAgICAgICAgQ3JjMTYuZml4KG5ld0hjYSwgaW5mby5kYXRhT2Zmc2V0IC0gMik7CiAgICAgICAgLy8gcmVwYXJzZSBoZWFkZXIgJiByZWNoZWNrIHZhbGlkdHkKICAgICAgICBpbmZvID0gbmV3IEhDQUluZm8obmV3SGNhKTsKICAgICAgICByZXR1cm4gbmV3SGNhOwogICAgfQogICAgc3RhdGljIGFkZENpcGhlckhlYWRlcihoY2EsIGNpcGhlclR5cGUpIHsKICAgICAgICBsZXQgbmV3RGF0YSA9IG5ldyBVaW50OEFycmF5KDIpOwogICAgICAgIGlmIChjaXBoZXJUeXBlICE9IG51bGwpIHsKICAgICAgICAgICAgbmV3IERhdGFWaWV3KG5ld0RhdGEuYnVmZmVyKS5zZXRVaW50MTYoMCwgY2lwaGVyVHlwZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLmFkZEhlYWRlcihoY2EsICJjaXBoIiwgbmV3RGF0YSk7CiAgICB9CiAgICBzdGF0aWMgZml4SGVhZGVyQ2hlY2tzdW0oaGNhKSB7CiAgICAgICAgbGV0IHAgPSBuZXcgRGF0YVZpZXcoaGNhLmJ1ZmZlciwgaGNhLmJ5dGVPZmZzZXQsIDgpOwogICAgICAgIGxldCBoZWFkID0gdGhpcy5nZXRTaWduKHAsIDAsIGZhbHNlLCBmYWxzZSk7CiAgICAgICAgaWYgKGhlYWQgIT09ICJIQ0EiKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiTm90IGEgSENBIGZpbGUiKTsKICAgICAgICB9CiAgICAgICAgbGV0IGRhdGFPZmZzZXQgPSBwLmdldFVpbnQxNig2KTsKICAgICAgICBDcmMxNi5maXgoaGNhLCBkYXRhT2Zmc2V0IC0gMik7CiAgICAgICAgcmV0dXJuIGhjYTsKICAgIH0KICAgIGNhbGNJbldhdlNpemUobW9kZSA9IDMyKSB7CiAgICAgICAgc3dpdGNoIChtb2RlKSB7CiAgICAgICAgICAgIGNhc2UgMDogLy8gZmxvYXQKICAgICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICBjYXNlIDE2OgogICAgICAgICAgICBjYXNlIDI0OgogICAgICAgICAgICBjYXNlIDMyOiAvLyBpbnRlZ2VyCiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIG1vZGUgPSAzMjsKICAgICAgICB9CiAgICAgICAgbGV0IGJpdHNQZXJTYW1wbGUgPSBtb2RlID09IDAgPyAzMiA6IG1vZGU7CiAgICAgICAgbGV0IHNhbXBsZVNpemVJbldhdiA9IHRoaXMuZm9ybWF0LmNoYW5uZWxDb3VudCAqIGJpdHNQZXJTYW1wbGUgLyA4OwogICAgICAgIHJldHVybiB0aGlzLmluV2F2U2l6ZSA9IHsKICAgICAgICAgICAgYml0c1BlclNhbXBsZTogYml0c1BlclNhbXBsZSwKICAgICAgICAgICAgc2FtcGxlOiBzYW1wbGVTaXplSW5XYXYsCiAgICAgICAgICAgIGJsb2NrOiBTYW1wbGVzUGVyRnJhbWUgKiBzYW1wbGVTaXplSW5XYXYsCiAgICAgICAgICAgIGRyb3BwZWQ6IHsKICAgICAgICAgICAgICAgIGhlYWRlcjogdGhpcy5mb3JtYXQuZHJvcHBlZEhlYWRlciAqIHNhbXBsZVNpemVJbldhdiwKICAgICAgICAgICAgICAgIGZvb3RlcjogdGhpcy5mb3JtYXQuZHJvcHBlZEZvb3RlciAqIHNhbXBsZVNpemVJbldhdiwKICAgICAgICAgICAgfSwKICAgICAgICAgICAgbG9vcDogdGhpcy5oYXNIZWFkZXJbImxvb3AiXQogICAgICAgICAgICAgICAgPyB7CiAgICAgICAgICAgICAgICAgICAgbG9vcFBhcnQ6ICh0aGlzLmxvb3BFbmRBdFNhbXBsZSAtIHRoaXMubG9vcFN0YXJ0QXRTYW1wbGUpICoKICAgICAgICAgICAgICAgICAgICAgICAgc2FtcGxlU2l6ZUluV2F2LAogICAgICAgICAgICAgICAgICAgIGRyb3BwZWQ6IHsKICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVyOiB0aGlzLmxvb3AuZHJvcHBlZEhlYWRlciAqIHNhbXBsZVNpemVJbldhdiwKICAgICAgICAgICAgICAgICAgICAgICAgZm9vdGVyOiB0aGlzLmxvb3AuZHJvcHBlZEZvb3RlciAqIHNhbXBsZVNpemVJbldhdiwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgOiB1bmRlZmluZWQsCiAgICAgICAgfTsKICAgIH0KfQoKY2xhc3MgSENBV2F2Q29tbWVudENodW5rIHsKICAgIGNvbnN0cnVjdG9yKGluZm8pIHsKICAgICAgICB0aGlzLmNvbW1lbnRCdWYgPSBuZXcgVGV4dEVuY29kZXIoKS5lbmNvZGUoaW5mby5jb21tZW50KTsKICAgICAgICBsZXQgc2l6ZSA9IHRoaXMuY29tbWVudEJ1Zi5ieXRlTGVuZ3RoOwogICAgICAgIHNpemUgKz0gNDsKICAgICAgICBpZiAoc2l6ZSAlIDQpCiAgICAgICAgICAgIHNpemUgKz0gNCAtIHNpemUgJSA0OwogICAgICAgIHRoaXMuc2l6ZSA9IHNpemU7CiAgICB9CiAgICBnZXQoKSB7CiAgICAgICAgbGV0IGJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcig4ICsgdGhpcy5zaXplKTsKICAgICAgICBsZXQgcmV0ID0gbmV3IFVpbnQ4QXJyYXkoYnVmKTsKICAgICAgICBsZXQgcCA9IG5ldyBEYXRhVmlldyhidWYpOwogICAgICAgIGxldCB0ZSA9IG5ldyBUZXh0RW5jb2RlcigpOwogICAgICAgIHJldC5zZXQodGUuZW5jb2RlKCJub3RlIiksIDApOwogICAgICAgIHAuc2V0VWludDMyKDQsIHRoaXMuc2l6ZSwgdHJ1ZSk7CiAgICAgICAgcmV0LnNldCh0aGlzLmNvbW1lbnRCdWYsIDgpOwogICAgICAgIHJldHVybiByZXQ7CiAgICB9Cn0KCmNsYXNzIEhDQVdhdmVTbXBsQ2h1bmsgewogICAgY29uc3RydWN0b3IoaW5mbykgewogICAgICAgIHRoaXMuc2l6ZSA9IDYwOwogICAgICAgIHRoaXMubWFudWZhY3R1cmVyID0gMDsKICAgICAgICB0aGlzLnByb2R1Y3QgPSAwOwogICAgICAgIHRoaXMuTUlESVVuaXR5Tm90ZSA9IDB4M2M7CiAgICAgICAgdGhpcy5NSURJUGl0Y2hGcmFjdGlvbiA9IDA7CiAgICAgICAgdGhpcy5TTVBURUZvcm1hdCA9IDA7CiAgICAgICAgdGhpcy5zYW1wbGVMb29wcyA9IDE7CiAgICAgICAgdGhpcy5zYW1wbGVyRGF0YSA9IDB4MTg7CiAgICAgICAgdGhpcy5sb29wX0lkZW50aWZpZXIgPSAwOwogICAgICAgIHRoaXMubG9vcF9UeXBlID0gMDsKICAgICAgICB0aGlzLmxvb3BfRnJhY3Rpb24gPSAwOwogICAgICAgIHRoaXMubG9vcF9QbGF5Q291bnQgPSAwOwogICAgICAgIGlmICghaW5mby5oYXNIZWFkZXJbImxvb3AiXSkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdtaXNzaW5nICJsb29wIiBoZWFkZXInKTsKICAgICAgICB0aGlzLnNhbXBsZVBlcmlvZCA9IDEgLyBpbmZvLmZvcm1hdC5zYW1wbGluZ1JhdGUgKiAxMDAwMDAwMDAwOwogICAgICAgIHRoaXMubG9vcF9TdGFydCA9IGluZm8ubG9vcFN0YXJ0QXRTYW1wbGUgLSBpbmZvLnN0YXJ0QXRTYW1wbGU7CiAgICAgICAgdGhpcy5sb29wX0VuZCA9IGluZm8ubG9vcEVuZEF0U2FtcGxlIC0gaW5mby5zdGFydEF0U2FtcGxlOwogICAgICAgIHRoaXMuU01QVEVPZmZzZXQgPSAxOwogICAgfQogICAgZ2V0KCkgewogICAgICAgIGxldCBidWYgPSBuZXcgQXJyYXlCdWZmZXIoOCArIHRoaXMuc2l6ZSk7CiAgICAgICAgbGV0IHJldCA9IG5ldyBVaW50OEFycmF5KGJ1Zik7CiAgICAgICAgbGV0IHAgPSBuZXcgRGF0YVZpZXcoYnVmKTsKICAgICAgICBsZXQgdGUgPSBuZXcgVGV4dEVuY29kZXIoKTsKICAgICAgICByZXQuc2V0KHRlLmVuY29kZSgic21wbCIpLCAwKTsKICAgICAgICBwLnNldFVpbnQzMig0LCB0aGlzLnNpemUsIHRydWUpOwogICAgICAgIHAuc2V0VWludDMyKDgsIHRoaXMubWFudWZhY3R1cmVyLCB0cnVlKTsKICAgICAgICBwLnNldFVpbnQzMigxMiwgdGhpcy5wcm9kdWN0LCB0cnVlKTsKICAgICAgICBwLnNldFVpbnQzMigxNiwgdGhpcy5zYW1wbGVQZXJpb2QsIHRydWUpOwogICAgICAgIHAuc2V0VWludDMyKDIwLCB0aGlzLk1JRElVbml0eU5vdGUsIHRydWUpOwogICAgICAgIHAuc2V0VWludDMyKDI0LCB0aGlzLk1JRElQaXRjaEZyYWN0aW9uLCB0cnVlKTsKICAgICAgICBwLnNldFVpbnQzMigyOCwgdGhpcy5TTVBURUZvcm1hdCwgdHJ1ZSk7CiAgICAgICAgcC5zZXRVaW50MzIoMzIsIHRoaXMuU01QVEVPZmZzZXQsIHRydWUpOwogICAgICAgIHAuc2V0VWludDMyKDM2LCB0aGlzLnNhbXBsZUxvb3BzLCB0cnVlKTsKICAgICAgICBwLnNldFVpbnQzMig0MCwgdGhpcy5zYW1wbGVyRGF0YSwgdHJ1ZSk7CiAgICAgICAgcC5zZXRVaW50MzIoNDQsIHRoaXMubG9vcF9JZGVudGlmaWVyLCB0cnVlKTsKICAgICAgICBwLnNldFVpbnQzMig0OCwgdGhpcy5sb29wX1R5cGUsIHRydWUpOwogICAgICAgIHAuc2V0VWludDMyKDUyLCB0aGlzLmxvb3BfU3RhcnQsIHRydWUpOwogICAgICAgIHAuc2V0VWludDMyKDU2LCB0aGlzLmxvb3BfRW5kLCB0cnVlKTsKICAgICAgICBwLnNldFVpbnQzMig2MCwgdGhpcy5sb29wX0ZyYWN0aW9uLCB0cnVlKTsKICAgICAgICBwLnNldFVpbnQzMig2NCwgdGhpcy5sb29wX1BsYXlDb3VudCwgdHJ1ZSk7CiAgICAgICAgcmV0dXJuIHJldDsKICAgIH0KfQoKY2xhc3MgSENBV2F2Rm10Q2h1bmsgewogICAgY29uc3RydWN0b3IoaW5mbywgbW9kZSA9IDMyKSB7CiAgICAgICAgdGhpcy5zaXplID0gMTY7CiAgICAgICAgc3dpdGNoIChtb2RlKSB7CiAgICAgICAgICAgIGNhc2UgMDogLy8gZmxvYXQKICAgICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICBjYXNlIDE2OgogICAgICAgICAgICBjYXNlIDI0OgogICAgICAgICAgICBjYXNlIDMyOiAvLyBpbnRlZ2VyCiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIG1vZGUgPSAzMjsKICAgICAgICB9CiAgICAgICAgbGV0IGluV2F2U2l6ZSA9IGluZm8uY2FsY0luV2F2U2l6ZShtb2RlKTsKICAgICAgICB0aGlzLmZvcm1hdFRhZyA9IG1vZGUgPiAwID8gMSA6IDM7CiAgICAgICAgdGhpcy5jaGFubmVsQ291bnQgPSBpbmZvLmZvcm1hdC5jaGFubmVsQ291bnQ7CiAgICAgICAgdGhpcy5zYW1wbGVzUGVyU2VjID0gaW5mby5mb3JtYXQuc2FtcGxpbmdSYXRlOwogICAgICAgIHRoaXMuYnl0ZXNQZXJTZWMgPSBpbldhdlNpemUuc2FtcGxlICogaW5mby5mb3JtYXQuc2FtcGxpbmdSYXRlOwogICAgICAgIHRoaXMuYmxvY2tBbGlnbiA9IGluV2F2U2l6ZS5zYW1wbGU7CiAgICAgICAgdGhpcy5iaXRzUGVyU2FtcGxlID0gaW5XYXZTaXplLmJpdHNQZXJTYW1wbGU7CiAgICB9CiAgICBnZXQoKSB7CiAgICAgICAgbGV0IGJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcig4ICsgdGhpcy5zaXplKTsKICAgICAgICBsZXQgcmV0ID0gbmV3IFVpbnQ4QXJyYXkoYnVmKTsKICAgICAgICBsZXQgcCA9IG5ldyBEYXRhVmlldyhidWYpOwogICAgICAgIGxldCB0ZSA9IG5ldyBUZXh0RW5jb2RlcigpOwogICAgICAgIHJldC5zZXQodGUuZW5jb2RlKCJmbXQgIiksIDApOwogICAgICAgIHAuc2V0VWludDMyKDQsIHRoaXMuc2l6ZSwgdHJ1ZSk7CiAgICAgICAgcC5zZXRVaW50MTYoOCwgdGhpcy5mb3JtYXRUYWcsIHRydWUpOwogICAgICAgIHAuc2V0VWludDE2KDEwLCB0aGlzLmNoYW5uZWxDb3VudCwgdHJ1ZSk7CiAgICAgICAgcC5zZXRVaW50MzIoMTIsIHRoaXMuc2FtcGxlc1BlclNlYywgdHJ1ZSk7CiAgICAgICAgcC5zZXRVaW50MzIoMTYsIHRoaXMuYnl0ZXNQZXJTZWMsIHRydWUpOwogICAgICAgIHAuc2V0VWludDE2KDIwLCB0aGlzLmJsb2NrQWxpZ24sIHRydWUpOwogICAgICAgIHAuc2V0VWludDE2KDIyLCB0aGlzLmJpdHNQZXJTYW1wbGUsIHRydWUpOwogICAgICAgIHJldHVybiByZXQ7CiAgICB9Cn0KCmNsYXNzIEhDQVdhdldhdmVSaWZmSGVhZGVyIHsKICAgIGNvbnN0cnVjdG9yKHNpemUpIHsKICAgICAgICBpZiAoaXNOYU4oc2l6ZSkpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigic2l6ZSBtdXN0IGJlIG51bWJlciIpOwogICAgICAgIHNpemUgPSBNYXRoLmZsb29yKHNpemUpOwogICAgICAgIGlmIChzaXplIDw9IDApCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgIHRoaXMuc2l6ZSA9IDQgKyBzaXplOyAvLyAiV0FWRSIgKyByZW1haW5pbmcgcGFydAogICAgfQogICAgZ2V0KCkgewogICAgICAgIGxldCBidWYgPSBuZXcgQXJyYXlCdWZmZXIoMTIpOwogICAgICAgIGxldCByZXQgPSBuZXcgVWludDhBcnJheShidWYpOwogICAgICAgIGxldCBwID0gbmV3IERhdGFWaWV3KGJ1Zik7CiAgICAgICAgbGV0IHRlID0gbmV3IFRleHRFbmNvZGVyKCk7CiAgICAgICAgcmV0LnNldCh0ZS5lbmNvZGUoIlJJRkYiKSwgMCk7CiAgICAgICAgcC5zZXRVaW50MzIoNCwgdGhpcy5zaXplLCB0cnVlKTsKICAgICAgICByZXQuc2V0KHRlLmVuY29kZSgiV0FWRSIpLCA4KTsKICAgICAgICByZXR1cm4gcmV0OwogICAgfQp9CgpjbGFzcyBIQ0FXYXYgewogICAgY29uc3RydWN0b3IoaW5mbywgbW9kZSA9IDMyLCBsb29wID0gMCkgewogICAgICAgIHN3aXRjaCAobW9kZSkgewogICAgICAgICAgICBjYXNlIDA6IC8vIGZsb2F0CiAgICAgICAgICAgIGNhc2UgODoKICAgICAgICAgICAgY2FzZSAxNjoKICAgICAgICAgICAgY2FzZSAyNDoKICAgICAgICAgICAgY2FzZSAzMjogLy8gaW50ZWdlcgogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICBtb2RlID0gMzI7CiAgICAgICAgfQogICAgICAgIGlmIChpc05hTihsb29wKSkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJsb29wIGlzIG5vdCBudW1iZXIiKTsKICAgICAgICBsb29wID0gTWF0aC5mbG9vcihsb29wKTsKICAgICAgICBpZiAobG9vcCA8IDApCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgIGxldCBpbldhdlNpemUgPSBpbmZvLmNhbGNJbldhdlNpemUobW9kZSk7CiAgICAgICAgbGV0IGRhdGFTaXplID0gaW5XYXZTaXplLnNhbXBsZSAqIGluZm8uc2FtcGxlQ291bnQ7CiAgICAgICAgaWYgKGxvb3AgPiAwKSB7CiAgICAgICAgICAgIGlmIChpbldhdlNpemUubG9vcCA9PSBudWxsKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgICAgIGRhdGFTaXplICs9IGluV2F2U2l6ZS5sb29wLmxvb3BQYXJ0ICogbG9vcDsKICAgICAgICB9CiAgICAgICAgLy8gcHJlcGFyZSBtZXRhZGF0YSBjaHVua3MgYW5kIGRhdGEgY2h1bmsgaGVhZGVyCiAgICAgICAgdGhpcy5mbXQgPSBuZXcgSENBV2F2Rm10Q2h1bmsoaW5mbywgbW9kZSk7CiAgICAgICAgaWYgKGluZm8uaGFzSGVhZGVyWyJjb21tIl0pCiAgICAgICAgICAgIHRoaXMubm90ZSA9IG5ldyBIQ0FXYXZDb21tZW50Q2h1bmsoaW5mbyk7CiAgICAgICAgaWYgKGluZm8uaGFzSGVhZGVyWyJsb29wIl0pCiAgICAgICAgICAgIHRoaXMuc21wbCA9IG5ldyBIQ0FXYXZlU21wbENodW5rKGluZm8pOwogICAgICAgIHRoaXMud2F2ZVJpZmYgPSBuZXcgSENBV2F2V2F2ZVJpZmZIZWFkZXIoOCArIHRoaXMuZm10LnNpemUgKwogICAgICAgICAgICAodGhpcy5ub3RlID09IG51bGwgPyAwIDogOCArIHRoaXMubm90ZS5zaXplKSArCiAgICAgICAgICAgIDggKyBkYXRhU2l6ZSArCiAgICAgICAgICAgICh0aGlzLnNtcGwgPT0gbnVsbCA/IDAgOiA4ICsgdGhpcy5zbXBsLnNpemUpKTsKICAgICAgICAvLyBnZXQgYnl0ZXMgb2YgcHJlcGFyZWQgY2h1bmtzCiAgICAgICAgbGV0IHdhdmVSaWZmSGVhZGVyID0gdGhpcy53YXZlUmlmZi5nZXQoKTsKICAgICAgICBsZXQgZm10Q2h1bmsgPSB0aGlzLmZtdC5nZXQoKTsKICAgICAgICBsZXQgbm90ZUNodW5rID0gdGhpcy5ub3RlICE9IG51bGwgPyB0aGlzLm5vdGUuZ2V0KCkgOiBuZXcgVWludDhBcnJheSgwKTsKICAgICAgICBsZXQgZGF0YUNodW5rSGVhZGVyID0gbmV3IFVpbnQ4QXJyYXkoOCk7CiAgICAgICAgZGF0YUNodW5rSGVhZGVyLnNldChuZXcgVGV4dEVuY29kZXIoKS5lbmNvZGUoImRhdGEiKSk7CiAgICAgICAgbmV3IERhdGFWaWV3KGRhdGFDaHVua0hlYWRlci5idWZmZXIpLnNldFVpbnQzMig0LCBkYXRhU2l6ZSwgdHJ1ZSk7CiAgICAgICAgbGV0IHNtcGxDaHVuayA9IHRoaXMuc21wbCAhPSBudWxsID8gdGhpcy5zbXBsLmdldCgpIDogbmV3IFVpbnQ4QXJyYXkoMCk7CiAgICAgICAgLy8gY3JlYXRlIHdob2xlLWZpbGUgYnVmZmVyCiAgICAgICAgdGhpcy5maWxlQnVmID0gbmV3IFVpbnQ4QXJyYXkoOCArIHRoaXMud2F2ZVJpZmYuc2l6ZSk7CiAgICAgICAgLy8gY29weSBwcmVwYXJlZCBtZXRhZGF0YSBjaHVua3MgYW5kIGRhdGEgY2h1bmsgaGVhZGVyIHRvIHdob2xlLWZpbGUgYnVmZmVyCiAgICAgICAgbGV0IHdyaXR0ZW5MZW5ndGggPSAwOwogICAgICAgIFt3YXZlUmlmZkhlYWRlciwgZm10Q2h1bmssIG5vdGVDaHVuaywgZGF0YUNodW5rSGVhZGVyXS5mb3JFYWNoKChjaHVuaykgPT4gewogICAgICAgICAgICB0aGlzLmZpbGVCdWYuc2V0KGNodW5rLCB3cml0dGVuTGVuZ3RoKTsKICAgICAgICAgICAgd3JpdHRlbkxlbmd0aCArPSBjaHVuay5ieXRlTGVuZ3RoOwogICAgICAgIH0pOwogICAgICAgIC8vIHNraXAgZGF0YVBhcnQgc2luY2UgaXQncyBlbXB0eQogICAgICAgIHRoaXMuZGF0YVBhcnQgPSB0aGlzLmZpbGVCdWYuc3ViYXJyYXkod3JpdHRlbkxlbmd0aCwgd3JpdHRlbkxlbmd0aCArIGRhdGFTaXplKTsKICAgICAgICB3cml0dGVuTGVuZ3RoICs9IGRhdGFTaXplOwogICAgICAgIC8vIGNvcHkgdGhlIGxhc3QgcHJlcGFyZWQgY2h1bmsgdG8gd2hvbGUtZmlsZSBidWZmZXIKICAgICAgICB0aGlzLmZpbGVCdWYuc2V0KHNtcGxDaHVuaywgd3JpdHRlbkxlbmd0aCk7CiAgICAgICAgd3JpdHRlbkxlbmd0aCArPSBzbXBsQ2h1bmsuYnl0ZUxlbmd0aDsKICAgICAgICBpZiAod3JpdHRlbkxlbmd0aCAhPSB0aGlzLmZpbGVCdWYuYnl0ZUxlbmd0aCkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICB9Cn0KCmNsYXNzIEhDQSB7CiAgICBjb25zdHJ1Y3RvcigpIHsKICAgIH0KICAgIHN0YXRpYyBkZWNyeXB0KGhjYSwga2V5MSwga2V5Miwgc3Via2V5KSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZGVjcnlwdE9yRW5jcnlwdChoY2EsIGZhbHNlLCBrZXkxLCBrZXkyLCBzdWJrZXkpOwogICAgfQogICAgc3RhdGljIGVuY3J5cHQoaGNhLCBrZXkxLCBrZXkyLCBzdWJrZXkpIHsKICAgICAgICByZXR1cm4gdGhpcy5kZWNyeXB0T3JFbmNyeXB0KGhjYSwgdHJ1ZSwga2V5MSwga2V5Miwgc3Via2V5KTsKICAgIH0KICAgIHN0YXRpYyBkZWNyeXB0T3JFbmNyeXB0KGhjYSwgZW5jcnlwdCwga2V5MSwga2V5Miwgc3Via2V5KSB7CiAgICAgICAgLy8gaW4tcGxhY2UgZGVjcnlwdGlvbi9lbmNyeXB0aW9uCiAgICAgICAgLy8gaGFuZGxlIHN1YmtleQogICAgICAgIGxldCBtaXhlZCA9IEhDQUNpcGhlci5taXhXaXRoU3Via2V5KGtleTEsIGtleTIsIHN1YmtleSk7CiAgICAgICAga2V5MSA9IG1peGVkLmtleTE7CiAgICAgICAga2V5MiA9IG1peGVkLmtleTI7CiAgICAgICAgLy8gcGFyc2UgaGVhZGVyCiAgICAgICAgbGV0IGluZm8gPSBuZXcgSENBSW5mbyhoY2EpOyAvLyB0aHJvd3MgIk5vdCBhIEhDQSBmaWxlIiBpZiBtaXNtYXRjaAogICAgICAgIGlmICghZW5jcnlwdCAmJiAhaW5mby5oYXNIZWFkZXJbImNpcGgiXSkgewogICAgICAgICAgICByZXR1cm4gaGNhOyAvLyBub3QgZW5jcnlwdGVkCiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGVuY3J5cHQgJiYgIWluZm8uaGFzSGVhZGVyWyJjaXBoIl0pIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnB1dCBoY2EgbGFja3MgImNpcGgiIGhlYWRlciBzZWN0aW9uLiBQbGVhc2UgY2FsbCBIQ0FJbmZvLmFkZENpcGhlckhlYWRlcihoY2EpIGZpcnN0LicpOwogICAgICAgIH0KICAgICAgICBsZXQgY2lwaGVyOwogICAgICAgIHN3aXRjaCAoaW5mby5jaXBoZXIpIHsKICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgLy8gbm90IGVuY3J5cHRlZAogICAgICAgICAgICAgICAgaWYgKGVuY3J5cHQpCiAgICAgICAgICAgICAgICAgICAgY2lwaGVyID0gbmV3IEhDQUNpcGhlcihrZXkxLCBrZXkyKS5pbnZlcnRUYWJsZSgpOwogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIHJldHVybiBoY2E7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgICAgLy8gZW5jcnlwdGVkIHdpdGggIm5vIGtleSIKICAgICAgICAgICAgICAgIGlmIChlbmNyeXB0KSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdhbHJlYWR5IGVuY3J5cHRlZCB3aXRoICJubyBrZXkiLCBwbGVhc2UgZGVjcnlwdCBmaXJzdCcpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIGNpcGhlciA9IG5ldyBIQ0FDaXBoZXIoIm5vbmUiKTsgLy8gaWdub3JlIGdpdmVuIGtleXMKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIDB4Mzg6CiAgICAgICAgICAgICAgICAvLyBlbmNyeXB0ZWQgd2l0aCBrZXlzIC0gd2lsbCB5aWVsZCBpbmNvcnJlY3Qgd2F2ZWZvcm0gaWYgaW5jb3JyZWN0IGtleXMgYXJlIGdpdmVuIQogICAgICAgICAgICAgICAgaWYgKGVuY3J5cHQpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImFscmVhZHkgZW5jcnlwdGVkIHdpdGggc3BlY2lmaWMga2V5cywgcGxlYXNlIGRlY3J5cHQgd2l0aCBjb3JyZWN0IGtleXMgZmlyc3QiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICBjaXBoZXIgPSBuZXcgSENBQ2lwaGVyKGtleTEsIGtleTIpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInVua25vd24gY2lwaC50eXBlIik7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5mby5mb3JtYXQuYmxvY2tDb3VudDsgKytpKSB7CiAgICAgICAgICAgIGxldCBmdGVsbCA9IGluZm8uZGF0YU9mZnNldCArIGluZm8uYmxvY2tTaXplICogaTsKICAgICAgICAgICAgbGV0IGJsb2NrID0gaGNhLnN1YmFycmF5KGZ0ZWxsLCBmdGVsbCArIGluZm8uYmxvY2tTaXplKTsKICAgICAgICAgICAgLy8gdmVyaWZ5IGJsb2NrIGNoZWNrc3VtCiAgICAgICAgICAgIENyYzE2LnZlcmlmeShibG9jaywgaW5mby5ibG9ja1NpemUgLSAyKTsKICAgICAgICAgICAgLy8gZGVjcnlwdC9lbmNyeXB0IGJsb2NrCiAgICAgICAgICAgIGNpcGhlci5tYXNrKGJsb2NrLCAwLCBpbmZvLmJsb2NrU2l6ZSAtIDIpOwogICAgICAgICAgICAvLyBmaXggY2hlY2tzdW0KICAgICAgICAgICAgQ3JjMTYuZml4KGJsb2NrLCBpbmZvLmJsb2NrU2l6ZSAtIDIpOwogICAgICAgIH0KICAgICAgICAvLyByZS0odW4pbWFzayBoZWFkZXJzLCBhbmQgc2V0IGNpcGggaGVhZGVyIHRvIG5ldyB2YWx1ZQogICAgICAgIGxldCBuZXdDaXBoZXJEYXRhID0gbmV3IFVpbnQ4QXJyYXkoMik7CiAgICAgICAgbGV0IG5ld0NpcGhlclR5cGUgPSBlbmNyeXB0ID8gY2lwaGVyLmdldFR5cGUoKSA6IDA7CiAgICAgICAgbmV3IERhdGFWaWV3KG5ld0NpcGhlckRhdGEuYnVmZmVyKS5zZXRVaW50MTYoMCwgbmV3Q2lwaGVyVHlwZSk7CiAgICAgICAgaW5mby5tb2RpZnkoaGNhLCAiY2lwaCIsIG5ld0NpcGhlckRhdGEpOwogICAgICAgIHJldHVybiBoY2E7CiAgICB9CiAgICBzdGF0aWMgZmluZEtleShoY2EsIGdpdmVuS2V5TGlzdCwgc3Via2V5LCB0aHJlc2hvbGQgPSAwLjUsIGRlcHRoID0gMTAyNCkgewogICAgICAgIGxldCBrZXlMaXN0LCB1bm1peGVkS2V5TGlzdDsKICAgICAgICBpZiAoZ2l2ZW5LZXlMaXN0ID09IG51bGwpIHsKICAgICAgICAgICAga2V5TGlzdCA9IEhDQUtub3duS2V5czsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIGtleUxpc3QgPSBnaXZlbktleUxpc3QubWFwKChrZXlzKSA9PiBbSENBQ2lwaGVyLnBhcnNlS2V5KGtleXNbMF0pLCBIQ0FDaXBoZXIucGFyc2VLZXkoa2V5c1sxXSldKTsKICAgICAgICAgICAgSENBS25vd25LZXlzLmZvckVhY2goKGtleXMpID0+IGtleUxpc3QgPT09IG51bGwgfHwga2V5TGlzdCA9PT0gdm9pZCAwID8gdm9pZCAwIDoga2V5TGlzdC5wdXNoKGtleXMpKTsKICAgICAgICB9CiAgICAgICAgdW5taXhlZEtleUxpc3QgPSBrZXlMaXN0LnNsaWNlKCk7CiAgICAgICAgaWYgKHN1YmtleSAhPSBudWxsKSB7CiAgICAgICAgICAgIC8vIGhhbmRsZSBzdWJrZXkKICAgICAgICAgICAga2V5TGlzdCA9IGtleUxpc3QubWFwKChrZXlzKSA9PiB7CiAgICAgICAgICAgICAgICBsZXQgbWl4ZWQgPSBIQ0FDaXBoZXIubWl4V2l0aFN1YmtleShrZXlzWzBdLCBrZXlzWzFdLCBzdWJrZXkpOwogICAgICAgICAgICAgICAgcmV0dXJuIFttaXhlZC5rZXkxLCBtaXhlZC5rZXkyXTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIC8vIHBhcnNlIGhlYWRlcgogICAgICAgIGNvbnN0IGluZm8gPSBuZXcgSENBSW5mbyhoY2EpOyAvLyB0aHJvd3MgIk5vdCBhIEhDQSBmaWxlIiBpZiBtaXNtYXRjaAogICAgICAgIGlmIChpbmZvLmNpcGhlciA9PSAwKQogICAgICAgICAgICByZXR1cm47IC8vIG5vdCBlbmNyeXB0ZWQKICAgICAgICBjb25zdCBmcmFtZSA9IG5ldyBIQ0FGcmFtZShpbmZvKTsKICAgICAgICBjb25zdCBzY29yZXMgPSBrZXlMaXN0Lm1hcCgoKSA9PiAwKTsKICAgICAgICBsZXQgY2lwaGVyOwogICAgICAgIGNvbnN0IHRlc3RLZXkgPSAoYmxvY2ssIGtleXMpID0+IHsKICAgICAgICAgICAgaWYgKGNpcGhlciA9PSBudWxsKQogICAgICAgICAgICAgICAgY2lwaGVyID0gbmV3IEhDQUNpcGhlcihrZXlzWzBdLCBrZXlzWzFdKTsKICAgICAgICAgICAgLy8gZGVjcnlwdCBibG9jawogICAgICAgICAgICBibG9jayA9IGJsb2NrLnNsaWNlKCk7CiAgICAgICAgICAgIGNpcGhlci5tYXNrKGJsb2NrLCAwLCBpbmZvLmJsb2NrU2l6ZSAtIDIpOwogICAgICAgICAgICAvLyB0ZXN0IGlmIHRoZSBrZXkgaXMgY29ycmVjdAogICAgICAgICAgICBsZXQgcmVhZGVyID0gbmV3IEhDQUJpdFJlYWRlcihibG9jayk7CiAgICAgICAgICAgIGxldCByZXN1bHQgPSBmYWxzZTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJlc3VsdCA9IEhDQVBhY2tpbmcuVW5wYWNrRnJhbWUoZnJhbWUsIHJlYWRlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2F0Y2ggKGUpIHsgfQogICAgICAgICAgICBpZiAoIXJlc3VsdCkgewogICAgICAgICAgICAgICAgY2lwaGVyID0gdW5kZWZpbmVkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfTsKICAgICAgICBsZXQgdGVzdGVkQmxvY2tDb3VudCA9IDA7CiAgICAgICAgZm9yIChsZXQgaSA9IDAsIGxhc3RGb3VuZCA9IC0xOyBpIDwgaW5mby5mb3JtYXQuYmxvY2tDb3VudCAmJiBpIDwgZGVwdGg7IGkrKykgewogICAgICAgICAgICBsZXQgZnRlbGwgPSBpbmZvLmRhdGFPZmZzZXQgKyBpbmZvLmJsb2NrU2l6ZSAqIGk7CiAgICAgICAgICAgIGxldCBibG9jayA9IGhjYS5zdWJhcnJheShmdGVsbCwgZnRlbGwgKyBpbmZvLmJsb2NrU2l6ZSk7CiAgICAgICAgICAgIGxldCBmb3VuZCA9IC0xOwogICAgICAgICAgICBpZiAobGFzdEZvdW5kICE9IC0xKSB7CiAgICAgICAgICAgICAgICAvLyB0ZXN0IGxhc3QgZm91bmQga2V5CiAgICAgICAgICAgICAgICBpZiAodGVzdEtleShibG9jaywga2V5TGlzdFtsYXN0Rm91bmRdKSkKICAgICAgICAgICAgICAgICAgICBmb3VuZCA9IGxhc3RGb3VuZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZm91bmQgPT0gLTEpIHsKICAgICAgICAgICAgICAgIC8vIGxhc3QgZm91bmQga2V5IGRvZXMgbm90IG1hdGNoLCB0ZXN0IG90aGVycwogICAgICAgICAgICAgICAgZm91bmQgPSBrZXlMaXN0LmZpbmRJbmRleCgoa2V5cywgaW5kZXgpID0+IGluZGV4ID09IGxhc3RGb3VuZCA/IGZhbHNlIDogdGVzdEtleShibG9jaywga2V5cykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmb3VuZCAhPSAtMSkgewogICAgICAgICAgICAgICAgbGFzdEZvdW5kID0gZm91bmQ7CiAgICAgICAgICAgICAgICBzY29yZXNbZm91bmRdKys7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGVzdGVkQmxvY2tDb3VudCsrOwogICAgICAgIH0KICAgICAgICBsZXQgYmVzdFNjb3JlID0gMCwgYmVzdEluZGV4ID0gLTE7CiAgICAgICAgc2NvcmVzLmZvckVhY2goKHMsIGkpID0+IHMgPiBiZXN0U2NvcmUgJiYgKGJlc3RTY29yZSA9IHMsIGJlc3RJbmRleCA9IGkpKTsKICAgICAgICBpZiAoYmVzdEluZGV4ID09IC0xIHx8IGJlc3RTY29yZSAvIHRlc3RlZEJsb2NrQ291bnQgPCB0aHJlc2hvbGQpCiAgICAgICAgICAgIHJldHVybjsgLy8gY2Fubm90IGZvdW5kIHZhbGlkIGtleQogICAgICAgIGVsc2UKICAgICAgICAgICAgcmV0dXJuIHVubWl4ZWRLZXlMaXN0W2Jlc3RJbmRleF07CiAgICB9CiAgICBzdGF0aWMgZGVjb2RlKGhjYSwgbW9kZSA9IDMyLCBsb29wID0gMCwgdm9sdW1lID0gMS4wKSB7CiAgICAgICAgc3dpdGNoIChtb2RlKSB7CiAgICAgICAgICAgIGNhc2UgMDogLy8gZmxvYXQKICAgICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICBjYXNlIDE2OgogICAgICAgICAgICBjYXNlIDI0OgogICAgICAgICAgICBjYXNlIDMyOiAvLyBpbnRlZ2VyCiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIG1vZGUgPSAzMjsKICAgICAgICB9CiAgICAgICAgaWYgKHZvbHVtZSA+IDEpCiAgICAgICAgICAgIHZvbHVtZSA9IDE7CiAgICAgICAgZWxzZSBpZiAodm9sdW1lIDwgMCkKICAgICAgICAgICAgdm9sdW1lID0gMDsKICAgICAgICBsZXQgaW5mbyA9IG5ldyBIQ0FJbmZvKGhjYSk7IC8vIHRocm93cyAiTm90IGEgSENBIGZpbGUiIGlmIG1pc21hdGNoCiAgICAgICAgbGV0IGZyYW1lID0gbmV3IEhDQUZyYW1lKGluZm8pOwogICAgICAgIGlmIChpbmZvLmhhc0hlYWRlclsiY2lwaCJdICYmIGluZm8uY2lwaGVyICE9IDApIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJIQ0EgaXMgZW5jcnlwdGVkLCBwbGVhc2UgZGVjcnlwdCBpdCBmaXJzdCBiZWZvcmUgZGVjb2RpbmciKTsKICAgICAgICB9CiAgICAgICAgLy8gcHJlcGFyZSBvdXRwdXQgV0FWIGZpbGUKICAgICAgICBjb25zdCBvdXRwdXRXYXYgPSBuZXcgSENBV2F2KGluZm8sIG1vZGUsIGxvb3ApOwogICAgICAgIGNvbnN0IGZpbGVCdWYgPSBvdXRwdXRXYXYuZmlsZUJ1ZjsKICAgICAgICBjb25zdCBkYXRhUGFydCA9IG91dHB1dFdhdi5kYXRhUGFydDsKICAgICAgICAvLyBjYWxjdWxhdGUgaW4tV0FWIHNpemUKICAgICAgICBsZXQgaW5XYXZTaXplID0gaW5mby5jYWxjSW5XYXZTaXplKG1vZGUpOwogICAgICAgIC8vIGRlY29kZSBibG9ja3MgKGZyYW1lcykKICAgICAgICBsZXQgZmFpbGVkQmxvY2tzID0gW10sIGxhc3RFcnJvciA9IHVuZGVmaW5lZDsKICAgICAgICBmb3IgKGxldCBpID0gMCwgb2Zmc2V0ID0gMDsgaSA8IGluZm8uZm9ybWF0LmJsb2NrQ291bnQ7IGkrKykgewogICAgICAgICAgICBsZXQgbGFzdERlY29kZWRTYW1wbGVzID0gaSAqIFNhbXBsZXNQZXJGcmFtZTsKICAgICAgICAgICAgbGV0IGN1cnJlbnREZWNvZGVkU2FtcGxlcyA9IGxhc3REZWNvZGVkU2FtcGxlcyArIFNhbXBsZXNQZXJGcmFtZTsKICAgICAgICAgICAgaWYgKGN1cnJlbnREZWNvZGVkU2FtcGxlcyA8PSBpbmZvLnN0YXJ0QXRTYW1wbGUgfHwKICAgICAgICAgICAgICAgIGxhc3REZWNvZGVkU2FtcGxlcyA+PSBpbmZvLmVuZEF0U2FtcGxlKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsZXQgc3RhcnRPZmZzZXQgPSBpbmZvLmRhdGFPZmZzZXQgKyBpbmZvLmJsb2NrU2l6ZSAqIGk7CiAgICAgICAgICAgIGxldCBibG9jayA9IGhjYS5zdWJhcnJheShzdGFydE9mZnNldCwgc3RhcnRPZmZzZXQgKyBpbmZvLmJsb2NrU2l6ZSk7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB0aGlzLmRlY29kZUJsb2NrKGZyYW1lLCBibG9jayk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIGZhaWxlZEJsb2Nrcy5wdXNoKGkpOwogICAgICAgICAgICAgICAgbGFzdEVycm9yID0gZTsKICAgICAgICAgICAgICAgIGZyYW1lID0gbmV3IEhDQUZyYW1lKGluZm8pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxldCB3YXZlYnVmZjsKICAgICAgICAgICAgaWYgKGxhc3REZWNvZGVkU2FtcGxlcyA8IGluZm8uc3RhcnRBdFNhbXBsZSB8fAogICAgICAgICAgICAgICAgY3VycmVudERlY29kZWRTYW1wbGVzID4gaW5mby5lbmRBdFNhbXBsZSkgewogICAgICAgICAgICAgICAgLy8gY3Jvc3Npbmcgc3RhcnRBdFNhbXBsZS9lbmRBdFNhbXBsZSwgc2tpcC9kcm9wIHNwZWNpZmllZCBieXRlcwogICAgICAgICAgICAgICAgd2F2ZWJ1ZmYgPSB0aGlzLndyaXRlVG9QQ00oZnJhbWUsIG1vZGUsIHZvbHVtZSk7CiAgICAgICAgICAgICAgICBpZiAobGFzdERlY29kZWRTYW1wbGVzIDwgaW5mby5zdGFydEF0U2FtcGxlKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IHNraXBwZWRTaXplID0gKGluZm8uc3RhcnRBdFNhbXBsZSAtIGxhc3REZWNvZGVkU2FtcGxlcykgKgogICAgICAgICAgICAgICAgICAgICAgICBpbldhdlNpemUuc2FtcGxlOwogICAgICAgICAgICAgICAgICAgIHdhdmVidWZmID0gd2F2ZWJ1ZmYuc3ViYXJyYXkoc2tpcHBlZFNpemUsIGluV2F2U2l6ZS5ibG9jayk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmIChjdXJyZW50RGVjb2RlZFNhbXBsZXMgPiBpbmZvLmVuZEF0U2FtcGxlKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IHdyaXRlU2l6ZSA9IChpbmZvLmVuZEF0U2FtcGxlIC0gbGFzdERlY29kZWRTYW1wbGVzKSAqCiAgICAgICAgICAgICAgICAgICAgICAgIGluV2F2U2l6ZS5zYW1wbGU7CiAgICAgICAgICAgICAgICAgICAgd2F2ZWJ1ZmYgPSB3YXZlYnVmZi5zdWJhcnJheSgwLCB3cml0ZVNpemUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCJzaG91bGQgbmV2ZXIgZ28gaGVyZSIpOwogICAgICAgICAgICAgICAgZGF0YVBhcnQuc2V0KHdhdmVidWZmLCBvZmZzZXQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgd2F2ZWJ1ZmYgPSB0aGlzLndyaXRlVG9QQ00oZnJhbWUsIG1vZGUsIHZvbHVtZSwgZGF0YVBhcnQsIG9mZnNldCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb2Zmc2V0ICs9IHdhdmVidWZmLmJ5dGVMZW5ndGg7CiAgICAgICAgfQogICAgICAgIGlmIChmYWlsZWRCbG9ja3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBlcnJvciBkZWNvZGluZyBmb2xsb3dpbmcgYmxvY2tzLCBmaWxsZWQgemVyb2AsIGZhaWxlZEJsb2NrcywgbGFzdEVycm9yKTsKICAgICAgICB9CiAgICAgICAgLy8gZGVjb2RpbmcgZG9uZSwgdGhlbiBqdXN0IGNvcHkgbG9vcGluZyBwYXJ0CiAgICAgICAgaWYgKGluZm8uaGFzSGVhZGVyWyJsb29wIl0gJiYgbG9vcCkgewogICAgICAgICAgICAvLyAidGFpbCIgYmV5b25kIGxvb3AgZW5kIGlzIGRyb3BwZWQKICAgICAgICAgICAgLy8gY29weSBsb29waW5nIGF1ZGlvIGNsaXBzCiAgICAgICAgICAgIGlmIChpbldhdlNpemUubG9vcCA9PSBudWxsKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgICAgIGxldCBwcmVMb29wU2l6ZUluV2F2ID0gaW5XYXZTaXplLnNhbXBsZSAqCiAgICAgICAgICAgICAgICAoaW5mby5sb29wU3RhcnRBdFNhbXBsZSAtIGluZm8uc3RhcnRBdFNhbXBsZSk7CiAgICAgICAgICAgIGxldCBzcmMgPSBkYXRhUGFydC5zdWJhcnJheShwcmVMb29wU2l6ZUluV2F2LCBwcmVMb29wU2l6ZUluV2F2ICsgaW5XYXZTaXplLmxvb3AubG9vcFBhcnQpOwogICAgICAgICAgICBmb3IgKGxldCBpID0gMCwgc3RhcnQgPSBwcmVMb29wU2l6ZUluV2F2ICsgaW5XYXZTaXplLmxvb3AubG9vcFBhcnQ7IGkgPCBsb29wOyBpKyspIHsKICAgICAgICAgICAgICAgIGxldCBkc3QgPSBkYXRhUGFydC5zdWJhcnJheShzdGFydCwgc3RhcnQgKyBpbldhdlNpemUubG9vcC5sb29wUGFydCk7CiAgICAgICAgICAgICAgICBkc3Quc2V0KHNyYyk7CiAgICAgICAgICAgICAgICBzdGFydCArPSBpbldhdlNpemUubG9vcC5sb29wUGFydDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmlsZUJ1ZjsKICAgIH0KICAgIHN0YXRpYyBkZWNvZGVCbG9jayhmcmFtZSwgYmxvY2spIHsKICAgICAgICBsZXQgaW5mbyA9IGZyYW1lLkhjYTsKICAgICAgICBpZiAoYmxvY2suYnl0ZUxlbmd0aCAhPSBpbmZvLmJsb2NrU2l6ZSkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgLy8gdmVyaWZ5IGNoZWNrc3VtCiAgICAgICAgQ3JjMTYudmVyaWZ5KGJsb2NrLCBpbmZvLmJsb2NrU2l6ZSAtIDIpOwogICAgICAgIC8vIGRlY29kZQogICAgICAgIEhDQURlY29kZXIuRGVjb2RlRnJhbWUoYmxvY2ssIGZyYW1lKTsKICAgIH0KICAgIHN0YXRpYyB3cml0ZVRvUENNKGZyYW1lLCBtb2RlID0gMzIsIHZvbHVtZSA9IDEuMCwgd3JpdGVyLCBmdGVsbCkgewogICAgICAgIHN3aXRjaCAobW9kZSkgewogICAgICAgICAgICBjYXNlIDA6IC8vIGZsb2F0CiAgICAgICAgICAgIGNhc2UgODoKICAgICAgICAgICAgY2FzZSAxNjoKICAgICAgICAgICAgY2FzZSAyNDoKICAgICAgICAgICAgY2FzZSAzMjogLy8gaW50ZWdlcgogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICBtb2RlID0gMzI7CiAgICAgICAgfQogICAgICAgIGlmICh2b2x1bWUgPiAxKQogICAgICAgICAgICB2b2x1bWUgPSAxOwogICAgICAgIGVsc2UgaWYgKHZvbHVtZSA8IDApCiAgICAgICAgICAgIHZvbHVtZSA9IDA7CiAgICAgICAgLy8gY3JlYXRlIG5ldyB3cml0ZXIgaWYgbm90IHNwZWNpZmllZAogICAgICAgIGxldCBpbmZvID0gZnJhbWUuSGNhOwogICAgICAgIGlmICh3cml0ZXIgPT0gbnVsbCkgewogICAgICAgICAgICB3cml0ZXIgPSBuZXcgVWludDhBcnJheShTYW1wbGVzUGVyRnJhbWUgKiBpbmZvLmZvcm1hdC5jaGFubmVsQ291bnQgKgogICAgICAgICAgICAgICAgKG1vZGUgPT0gMCA/IDMyIDogbW9kZSkgLyA4KTsKICAgICAgICAgICAgaWYgKGZ0ZWxsID09IG51bGwpIHsKICAgICAgICAgICAgICAgIGZ0ZWxsID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgaWYgKGZ0ZWxsID09IG51bGwpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICB9CiAgICAgICAgLy8gd3JpdGUgZGVjb2RlZCBkYXRhIGludG8gd3JpdGVyCiAgICAgICAgbGV0IHAgPSBuZXcgRGF0YVZpZXcod3JpdGVyLmJ1ZmZlciwgd3JpdGVyLmJ5dGVPZmZzZXQsIHdyaXRlci5ieXRlTGVuZ3RoKTsKICAgICAgICBsZXQgZnRlbGxCZWdpbiA9IGZ0ZWxsOwogICAgICAgIGZvciAobGV0IHNmID0gMDsgc2YgPCBTdWJmcmFtZXNQZXJGcmFtZTsgc2YrKykgewogICAgICAgICAgICBmb3IgKGxldCBzID0gMDsgcyA8IFNhbXBsZXNQZXJTdWJGcmFtZTsgcysrKSB7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBjID0gMDsgYyA8IGZyYW1lLkNoYW5uZWxzLmxlbmd0aDsgYysrKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IGYgPSBmcmFtZS5DaGFubmVsc1tjXS5QY21GbG9hdFtzZl1bc10gKiB2b2x1bWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKGYgPiAxKQogICAgICAgICAgICAgICAgICAgICAgICBmID0gMTsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChmIDwgLTEpCiAgICAgICAgICAgICAgICAgICAgICAgIGYgPSAtMTsKICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKG1vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbXVzdCBiZSB1bnNpZ25lZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcC5zZXRVaW50OChmdGVsbCwgZiAqIDB4N0YgKyAweDgwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ0ZWxsICs9IDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAxNjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGZvciBhYm92ZSA4LWJpdCBpbnRlZ2VyLCBsaXR0bGUtZW5kaWFuIHNpZ25lZCBpbnRlZ2VyIGlzIHVzZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIChzZXRVaW50MTYvc2V0SW50MTYgYWN0dWFsbHkgZG9lc24ndCBzZWVtIHRvIG1ha2UgYW55IGRpZmZlcmVuY2UgaGVyZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAuc2V0SW50MTYoZnRlbGwsIGYgKiAweDdGRkYsIHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnRlbGwgKz0gMjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDI0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhlcmUncyBubyBzZXRJbnQyNCwgd3JpdGUgMyBieXRlcyB3aXRoIHNldFVpbnQ4IHJlc3BlY3RpdmVseQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZiAqPSAweDdGRkZGRjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAuc2V0VWludDgoZnRlbGwsIGYgJiAweEZGKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAuc2V0VWludDgoZnRlbGwgKyAxLCBmID4+IDggJiAweEZGKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAuc2V0VWludDgoZnRlbGwgKyAyLCBmID4+IDE2ICYgMHhGRik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdGVsbCArPSAzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMzI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLnNldEludDMyKGZ0ZWxsLCBmICogMHg3RkZGRkZGRiwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdGVsbCArPSA0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGZsb2F0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLnNldEZsb2F0MzIoZnRlbGwsIGYsIHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnRlbGwgKz0gNDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJ1bmtub3duIG1vZGUiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHdyaXRlci5zdWJhcnJheShmdGVsbEJlZ2luLCBmdGVsbCk7CiAgICB9CiAgICBzdGF0aWMgZml4Q2hlY2tzdW0oaGNhKSB7CiAgICAgICAgSENBSW5mby5maXhIZWFkZXJDaGVja3N1bShoY2EpOwogICAgICAgIGxldCBpbmZvID0gbmV3IEhDQUluZm8oaGNhKTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGluZm8uZm9ybWF0LmJsb2NrQ291bnQ7IGkrKykgewogICAgICAgICAgICBsZXQgZnRlbGwgPSBpbmZvLmRhdGFPZmZzZXQgKyBpICogaW5mby5ibG9ja1NpemU7CiAgICAgICAgICAgIGxldCBibG9jayA9IGhjYS5zdWJhcnJheShmdGVsbCwgZnRlbGwgKyBpbmZvLmJsb2NrU2l6ZSk7CiAgICAgICAgICAgIENyYzE2LmZpeChibG9jaywgaW5mby5ibG9ja1NpemUgLSAyKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGhjYTsKICAgIH0KfQoKLy8gY29udmVydCBub24tdHJhbnNmZXJhYmxlIHR5cGVkIGFycmF5IHRvIHRyYW5zZmVyYWJsZSBhcnJheSBidWZmZXIKY2xhc3MgSENBVHJhbnNUeXBlZEFycmF5IHsKICAgIGNvbnN0cnVjdG9yKHRhLCB0cmFuc2Zlckxpc3QpIHsKICAgICAgICBjb25zdCB0eXBlID0gSENBVHJhbnNUeXBlZEFycmF5LmdldFR5cGUodGEpOwogICAgICAgIGlmICh0eXBlICE9IG51bGwpCiAgICAgICAgICAgIHRoaXMudHlwZSA9IHR5cGUudHlwZTsKICAgICAgICBlbHNlCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigidW5leHBlY3RlZCB0eXBlIik7CiAgICAgICAgdGhpcy5idWZmZXIgPSB0YS5idWZmZXI7CiAgICAgICAgdGhpcy5ieXRlT2Zmc2V0ID0gdGEuYnl0ZU9mZnNldDsKICAgICAgICB0aGlzLmxlbmd0aCA9IHRhLmxlbmd0aDsKICAgICAgICBpZiAoIXRyYW5zZmVyTGlzdC5maW5kKCh2YWwpID0+IHZhbCA9PT0gdGhpcy5idWZmZXIpKSB7CiAgICAgICAgICAgIHRyYW5zZmVyTGlzdC5wdXNoKHRoaXMuYnVmZmVyKTsKICAgICAgICB9CiAgICB9CiAgICBzdGF0aWMgY29udmVydChhcmcsIHRyYW5zZmVyTGlzdCkgewogICAgICAgIGlmICh0aGlzLmdldFR5cGUoYXJnKSAhPSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgSENBVHJhbnNUeXBlZEFycmF5KGFyZywgdHJhbnNmZXJMaXN0KTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgICAgICByZXR1cm4gYXJnOwogICAgfQogICAgc3RhdGljIHJlc3RvcmUoYXJnKSB7CiAgICAgICAgY29uc3QgdHlwZSA9IHRoaXMuZ2V0VHlwZShhcmcpOwogICAgICAgIGlmICh0eXBlICE9IG51bGwgJiYgdHlwZS5jb252ZXJ0ZWQpIHsKICAgICAgICAgICAgcmV0dXJuIGFyZy5hcnJheTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgICAgICByZXR1cm4gYXJnOwogICAgfQogICAgc3RhdGljIGdldFR5cGUoYXJnKSB7CiAgICAgICAgaWYgKGFyZyA9PSBudWxsIHx8IHR5cGVvZiBhcmcgIT09ICJvYmplY3QiKQogICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgIGVsc2UgaWYgKGFyZyBpbnN0YW5jZW9mIEludDhBcnJheSkgewogICAgICAgICAgICByZXR1cm4geyBjb252ZXJ0ZWQ6IGZhbHNlLCB0eXBlOiAiSW50OCIgfTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoYXJnIGluc3RhbmNlb2YgSW50MTZBcnJheSkgewogICAgICAgICAgICByZXR1cm4geyBjb252ZXJ0ZWQ6IGZhbHNlLCB0eXBlOiAiSW50MTYiIH07CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGFyZyBpbnN0YW5jZW9mIEludDMyQXJyYXkpIHsKICAgICAgICAgICAgcmV0dXJuIHsgY29udmVydGVkOiBmYWxzZSwgdHlwZTogIkludDMyIiB9OwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChhcmcgaW5zdGFuY2VvZiBVaW50OEFycmF5KSB7CiAgICAgICAgICAgIHJldHVybiB7IGNvbnZlcnRlZDogZmFsc2UsIHR5cGU6ICJVaW50OCIgfTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoYXJnIGluc3RhbmNlb2YgVWludDE2QXJyYXkpIHsKICAgICAgICAgICAgcmV0dXJuIHsgY29udmVydGVkOiBmYWxzZSwgdHlwZTogIlVpbnQxNiIgfTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoYXJnIGluc3RhbmNlb2YgVWludDMyQXJyYXkpIHsKICAgICAgICAgICAgcmV0dXJuIHsgY29udmVydGVkOiBmYWxzZSwgdHlwZTogIlVpbnQzMiIgfTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoYXJnIGluc3RhbmNlb2YgRmxvYXQzMkFycmF5KSB7CiAgICAgICAgICAgIHJldHVybiB7IGNvbnZlcnRlZDogZmFsc2UsIHR5cGU6ICJGbG9hdDMyIiB9OwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChhcmcgaW5zdGFuY2VvZiBGbG9hdDY0QXJyYXkpIHsKICAgICAgICAgICAgcmV0dXJuIHsgY29udmVydGVkOiBmYWxzZSwgdHlwZTogIkZsb2F0NjQiIH07CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGFyZy5idWZmZXIgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlciAmJiB0eXBlb2YgYXJnLnR5cGUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHJldHVybiB7IGNvbnZlcnRlZDogdHJ1ZSwgdHlwZTogYXJnLnR5cGUgfTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgfQogICAgZ2V0IGFycmF5KCkgewogICAgICAgIHN3aXRjaCAodGhpcy50eXBlKSB7CiAgICAgICAgICAgIGNhc2UgIkludDgiOgogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBJbnQ4QXJyYXkodGhpcy5idWZmZXIsIHRoaXMuYnl0ZU9mZnNldCwgdGhpcy5sZW5ndGgpOwogICAgICAgICAgICBjYXNlICJJbnQxNiI6CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IEludDE2QXJyYXkodGhpcy5idWZmZXIsIHRoaXMuYnl0ZU9mZnNldCwgdGhpcy5sZW5ndGgpOwogICAgICAgICAgICBjYXNlICJJbnQzMiI6CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IEludDMyQXJyYXkodGhpcy5idWZmZXIsIHRoaXMuYnl0ZU9mZnNldCwgdGhpcy5sZW5ndGgpOwogICAgICAgICAgICBjYXNlICJVaW50OCI6CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkodGhpcy5idWZmZXIsIHRoaXMuYnl0ZU9mZnNldCwgdGhpcy5sZW5ndGgpOwogICAgICAgICAgICBjYXNlICJVaW50MTYiOgogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBVaW50MTZBcnJheSh0aGlzLmJ1ZmZlciwgdGhpcy5ieXRlT2Zmc2V0LCB0aGlzLmxlbmd0aCk7CiAgICAgICAgICAgIGNhc2UgIlVpbnQzMiI6CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFVpbnQzMkFycmF5KHRoaXMuYnVmZmVyLCB0aGlzLmJ5dGVPZmZzZXQsIHRoaXMubGVuZ3RoKTsKICAgICAgICAgICAgY2FzZSAiRmxvYXQzMiI6CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IEZsb2F0MzJBcnJheSh0aGlzLmJ1ZmZlciwgdGhpcy5ieXRlT2Zmc2V0LCB0aGlzLmxlbmd0aCk7CiAgICAgICAgICAgIGNhc2UgIkZsb2F0NjQiOgogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBGbG9hdDY0QXJyYXkodGhpcy5idWZmZXIsIHRoaXMuYnl0ZU9mZnNldCwgdGhpcy5sZW5ndGgpOwogICAgICAgIH0KICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInVuZXhwZWN0ZWQgdHlwZSIpOwogICAgfQp9CgpjbGFzcyBIQ0FUYXNrIHsKICAgIGNvbnN0cnVjdG9yKG9yaWdpbiwgdGFza0lELCBjbWQsIGFyZ3MsIHJlcGx5QXJncywgaXNEdW1teSkgewogICAgICAgIHRoaXMudHJhbnNmZXJMaXN0ID0gW107CiAgICAgICAgdGhpcy5faGFzUmVzdWx0ID0gZmFsc2U7CiAgICAgICAgdGhpcy5vcmlnaW4gPSBvcmlnaW47CiAgICAgICAgdGhpcy50YXNrSUQgPSB0YXNrSUQ7CiAgICAgICAgdGhpcy5jbWQgPSBjbWQ7CiAgICAgICAgdGhpcy5fYXJncyA9IGFyZ3MgPT09IG51bGwgfHwgYXJncyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYXJncy5tYXAoKGFyZykgPT4gSENBVHJhbnNUeXBlZEFycmF5LmNvbnZlcnQoYXJnLCB0aGlzLnRyYW5zZmVyTGlzdCkpOwogICAgICAgIHRoaXMuX3JlcGx5QXJncyA9IHJlcGx5QXJnczsKICAgICAgICBpZiAoaXNEdW1teSAhPSBudWxsICYmIGlzRHVtbXkpCiAgICAgICAgICAgIHRoaXMuaXNEdW1teSA9IHRydWU7CiAgICB9CiAgICBnZXQgYXJncygpIHsKICAgICAgICB2YXIgX2E7CiAgICAgICAgcmV0dXJuIChfYSA9IHRoaXMuX2FyZ3MpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5tYXAoKGFyZykgPT4gSENBVHJhbnNUeXBlZEFycmF5LnJlc3RvcmUoYXJnKSk7CiAgICB9CiAgICBnZXQgaGFzUmVzdWx0KCkgewogICAgICAgIHJldHVybiB0aGlzLl9oYXNSZXN1bHQ7CiAgICB9CiAgICBnZXQgcmVzdWx0KCkgewogICAgICAgIGlmICghdGhpcy5faGFzUmVzdWx0KQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIm5vIHJlc3VsdCIpOwogICAgICAgIHJldHVybiBIQ0FUcmFuc1R5cGVkQXJyYXkucmVzdG9yZSh0aGlzLl9yZXN1bHQpOwogICAgfQogICAgc2V0IHJlc3VsdChyZXN1bHQpIHsKICAgICAgICBpZiAodGhpcy5oYXNFcnIpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiYWxyZWFkeSBoYXMgZXJyb3IsIGNhbm5vdCBzZXQgcmVzdWx0Iik7CiAgICAgICAgaWYgKHRoaXMuX2hhc1Jlc3VsdCkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJjYW5ub3Qgc2V0IHJlc3VsdCBhZ2FpbiIpOwogICAgICAgIHRoaXMuX3Jlc3VsdCA9IEhDQVRyYW5zVHlwZWRBcnJheS5jb252ZXJ0KHJlc3VsdCwgdGhpcy50cmFuc2Zlckxpc3QpOwogICAgICAgIHRoaXMuX2hhc1Jlc3VsdCA9IHRydWU7CiAgICAgICAgaWYgKCF0aGlzLl9yZXBseUFyZ3MpCiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9hcmdzOwogICAgfQogICAgZ2V0IGhhc0VycigpIHsKICAgICAgICByZXR1cm4gdGhpcy5fZXJyTXNnICE9IG51bGw7CiAgICB9CiAgICBnZXQgZXJyTXNnKCkgewogICAgICAgIHJldHVybiB0aGlzLl9lcnJNc2c7CiAgICB9CiAgICBzZXQgZXJyTXNnKG1zZykgewogICAgICAgIC8vIGNoYW5naW5nIGVyck1zZyBpcyBhbGxvd2VkLCBidXQgY2xlYXJpbmcgZXJyTXNnIGlzIGRpc2FsbG93ZWQKICAgICAgICBpZiAodHlwZW9mIG1zZyAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJlcnJvciBtZXNzYWdlIG11c3QgYmUgYSBzdHJpbmciKTsKICAgICAgICB9CiAgICAgICAgZGVsZXRlIHRoaXMuX2FyZ3M7CiAgICAgICAgaWYgKHRoaXMuX2hhc1Jlc3VsdCkgewogICAgICAgICAgICAvLyBjbGVhciByZXN1bHQgb24gZXJyb3IKICAgICAgICAgICAgZGVsZXRlIHRoaXMuX3Jlc3VsdDsKICAgICAgICAgICAgdGhpcy5faGFzUmVzdWx0ID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMudHJhbnNmZXJMaXN0ID0gW107CiAgICAgICAgICAgIHRoaXMuYXJncy5mb3JFYWNoKChhcmcpID0+IEhDQVRyYW5zVHlwZWRBcnJheS5jb252ZXJ0KGFyZywgdGhpcy50cmFuc2Zlckxpc3QpKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5fZXJyTXNnID0gbXNnOwogICAgfQogICAgc3RhdGljIHJlY3JlYXRlKHRhc2spIHsKICAgICAgICBjb25zdCByZWNyZWF0ZWQgPSBuZXcgSENBVGFzayh0YXNrLm9yaWdpbiwgdGFzay50YXNrSUQsIHRhc2suY21kLCB0YXNrLl9hcmdzLCB0YXNrLl9yZXBseUFyZ3MpOwogICAgICAgIGlmICh0YXNrLl9lcnJNc2cgIT0gbnVsbCkKICAgICAgICAgICAgcmVjcmVhdGVkLmVyck1zZyA9IHRhc2suX2Vyck1zZzsKICAgICAgICBlbHNlIGlmICh0YXNrLl9oYXNSZXN1bHQpCiAgICAgICAgICAgIHJlY3JlYXRlZC5yZXN1bHQgPSB0YXNrLl9yZXN1bHQ7CiAgICAgICAgcmV0dXJuIHJlY3JlYXRlZDsKICAgIH0KfQoKY2xhc3MgSENBVGFza1F1ZXVlIHsKICAgIGNvbnN0cnVjdG9yKG9yaWdpbiwgcG9zdE1lc3NhZ2UsIHRhc2tIYW5kbGVyLCBkZXN0cm95KSB7CiAgICAgICAgdGhpcy5faXNBbGl2ZSA9IHRydWU7CiAgICAgICAgdGhpcy5pc0lkbGUgPSB0cnVlOwogICAgICAgIC8vIGNvbXBhcmluZyB0byBzdHJ1Y3R1cmVkIGNvcHkgKGJ5IGRlZmF1bHQpLCBpZiBkYXRhIHNpemUgaXMgYmlnIChiZWNhdXNlIG9mIHplcm8tY29weSksCiAgICAgICAgLy8gdHJhbnNmZXJyaW5nIGlzIGdlbmVyYWxseSBtdWNoIGZhc3Rlci4gaG93ZXZlciBpdCBvYnZpb3VzbHkgaGFzIGEgZHJhd2JhY2ssCiAgICAgICAgLy8gdGhhdCB0cmFuc2ZlcnJlZCBhcmd1bWVudHMgYXJlIG5vIGxvbmdlciBhY2Nlc3NpYmxlIGluIHRoZSBzZW5kZXIgdGhyZWFkCiAgICAgICAgdGhpcy50cmFuc2ZlckFyZ3MgPSBmYWxzZTsKICAgICAgICAvLyB0aGUgcmVjZWl2ZXIvY2FsbGVlIHdpbGwgYWx3YXlzIHVzZSB0cmFuc2ZlcnJpbmcgdG8gc2VuZCBiYWNrIGFyZ3VtZW50cywKICAgICAgICAvLyBub3Qgc2VuZGluZyB0aGUgYXJndW1lbnRzIGJhY2sgaXMgc3VwcG9zZWQgdG8gc2F2ZSBhIGxpdHRsZSB0aW1lL292ZXJoZWFkCiAgICAgICAgdGhpcy5yZXBseUFyZ3MgPSBmYWxzZTsKICAgICAgICB0aGlzLnF1ZXVlID0gW107CiAgICAgICAgdGhpcy5fbGFzdFRhc2tJRCA9IDA7CiAgICAgICAgdGhpcy5jYWxsYmFja3MgPSB7fTsKICAgICAgICB0aGlzLm9yaWdpbiA9IG9yaWdpbjsKICAgICAgICB0aGlzLnBvc3RNZXNzYWdlID0gcG9zdE1lc3NhZ2U7CiAgICAgICAgdGhpcy50YXNrSGFuZGxlciA9IHRhc2tIYW5kbGVyOwogICAgICAgIHRoaXMuZGVzdHJveSA9IGRlc3Ryb3k7CiAgICB9CiAgICBnZXROZXh0VGFza0lEKCkgewogICAgICAgIGNvbnN0IG1heCA9IEhDQVRhc2tRdWV1ZS5tYXhUYXNrSUQgLSAxOwogICAgICAgIGlmICh0aGlzLl9sYXN0VGFza0lEIDwgMCB8fCB0aGlzLl9sYXN0VGFza0lEID4gbWF4KSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigibGFzdFRhc2tJRCBvdXQgb2YgcmFuZ2UiKTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgc3RhcnQgPSB0aGlzLl9sYXN0VGFza0lEICsgMTsKICAgICAgICBmb3IgKGxldCBpID0gc3RhcnQ7IGkgPD0gc3RhcnQgKyBtYXg7IGkrKykgewogICAgICAgICAgICBjb25zdCB0YXNrSUQgPSBpICUgKG1heCArIDEpOwogICAgICAgICAgICBpZiAodGhpcy5jYWxsYmFja3NbdGFza0lEXSA9PSBudWxsKQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2xhc3RUYXNrSUQgPSB0YXNrSUQ7CiAgICAgICAgfQogICAgICAgIHRocm93IG5ldyBFcnJvcigiY2Fubm90IGZpbmQgbmV4dCB0YXNrSUQiKTsKICAgIH0KICAgIHNlbmRUYXNrKHRhc2spIHsKICAgICAgICBpZiAodGFzay5vcmlnaW4gIT09IHRoaXMub3JpZ2luKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigidGhlIHRhc2sgdG8gYmUgc2VudCBtdXN0IGhhdmUgdGhlIHNhbWUgb3JpZ2luIGFzIHRoZSB0YXNrIHF1ZXVlIik7CiAgICAgICAgfQogICAgICAgIHRoaXMucG9zdE1lc3NhZ2UodGFzaywgdGhpcy50cmFuc2ZlckFyZ3MgPyB0YXNrLnRyYW5zZmVyTGlzdCA6IFtdKTsKICAgIH0KICAgIHNlbmRSZXBseSh0YXNrKSB7CiAgICAgICAgaWYgKHRhc2sub3JpZ2luID09PSB0aGlzLm9yaWdpbikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInRoZSByZXBseSB0byBiZSBzZW50IG11c3Qgbm90IGhhdmUgdGhlIHNhbWUgb3JpZ2luIGFzIHRoZSB0YXNrIHF1ZXVlIik7CiAgICAgICAgfQogICAgICAgIHRoaXMucG9zdE1lc3NhZ2UodGFzaywgdGFzay50cmFuc2Zlckxpc3QpOyAvLyBhbHdheXMgdXNlIHRyYW5zZmVycmluZyB0byBzZW5kIGJhY2sgYXJndW1lbnRzCiAgICB9CiAgICBhc3luYyBzZW5kTmV4dFRhc2soKSB7CiAgICAgICAgbGV0IHRhc2sgPSB0aGlzLnF1ZXVlLnNoaWZ0KCk7CiAgICAgICAgaWYgKHRhc2sgPT0gbnVsbCkgewogICAgICAgICAgICB0aGlzLmlzSWRsZSA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICB0aGlzLmlzSWRsZSA9IGZhbHNlOwogICAgICAgICAgICAvLyBhcHBseSBob29rIGZpcnN0CiAgICAgICAgICAgIGNvbnN0IHJlZ2lzdGVyZWQgPSB0aGlzLmNhbGxiYWNrc1t0YXNrLnRhc2tJRF07CiAgICAgICAgICAgIGNvbnN0IHRhc2tIb29rID0gcmVnaXN0ZXJlZCAhPSBudWxsICYmIHJlZ2lzdGVyZWQuaG9vayAhPSBudWxsICYmCiAgICAgICAgICAgICAgICByZWdpc3RlcmVkLmhvb2sudGFzayAhPSBudWxsCiAgICAgICAgICAgICAgICA/IHJlZ2lzdGVyZWQuaG9vay50YXNrCiAgICAgICAgICAgICAgICA6IHVuZGVmaW5lZDsKICAgICAgICAgICAgaWYgKHRhc2tIb29rICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgdGFzayA9IGF3YWl0IHRhc2tIb29rKHRhc2spOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICB0YXNrLmVyck1zZyA9IGBbJHt0aGlzLm9yaWdpbn1dIGVycm9yIHdoZW4gYXBwbHlpbmcgaG9vayBgICsKICAgICAgICAgICAgICAgICAgICAgICAgYGJlZm9yZSBleGVjdXRpbmcgY21kICR7dGFzay5jbWR9IGZyb20gJHt0YXNrLm9yaWdpbn1gOwogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZSA9PT0gInN0cmluZyIgfHwgZSBpbnN0YW5jZW9mIEVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhc2suZXJyTXNnICs9ICJcbiIgKyBlLnRvU3RyaW5nKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRhc2suaXNEdW1teSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gc2VuZCB0YXNrCiAgICAgICAgICAgIGlmICh0YXNrLmlzRHVtbXkpIHsKICAgICAgICAgICAgICAgIGlmICghdGFzay5oYXNFcnIgJiYgIXRhc2suaGFzUmVzdWx0KQogICAgICAgICAgICAgICAgICAgIHRhc2sucmVzdWx0ID0gbnVsbDsKICAgICAgICAgICAgICAgIGNvbnN0IGV2ID0gbmV3IE1lc3NhZ2VFdmVudCgibWVzc2FnZSIsIHsgZGF0YTogdGFzayB9KTsgLy8gbm90IGFjdHVhbGx5IHNlbmRpbmcsIHVzZSBhIGZha2UgcmVwbHkKICAgICAgICAgICAgICAgIHRoaXMubXNnSGFuZGxlcihldik7IC8vIHdvbid0IGF3YWl0CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNlbmRUYXNrKHRhc2spOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgZ2V0IGlzQWxpdmUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2lzQWxpdmU7CiAgICB9CiAgICAvLyB0aGVzZSBmb2xsb3dpbmcgdHdvIG1ldGhvZHMvZnVuY3Rpb25zIGFyZSBzdXBwb3NlZCB0byBiZSBjYWxsYmFja3MKICAgIGFzeW5jIG1zZ0hhbmRsZXIoZXYpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBjb25zdCB0YXNrID0gSENBVGFzay5yZWNyZWF0ZShldi5kYXRhKTsKICAgICAgICAgICAgaWYgKHRhc2sub3JpZ2luICE9PSB0aGlzLm9yaWdpbikgewogICAgICAgICAgICAgICAgLy8gaW5jb21pbmcgY21kIHRvIGV4ZWN1dGUKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgdGFzay5yZXN1bHQgPSBhd2FpdCB0aGlzLnRhc2tIYW5kbGVyKHRhc2spOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAvLyBpdCdzIG9ic2VydmVkIHRoYXQgRmlyZWZveCByZWZ1c2VzIHRvIHBvc3RNZXNzYWdlIGFuIEVycm9yIG9iamVjdDoKICAgICAgICAgICAgICAgICAgICAvLyAiRGF0YUNsb25lRXJyb3I6IFRoZSBvYmplY3QgY291bGQgbm90IGJlIGNsb25lZC4iCiAgICAgICAgICAgICAgICAgICAgLy8gKG9ic2VydmVkIGluIEZpcmVmb3ggOTcsIG5vdCBjbGVhciBhYm91dCBvdGhlciB2ZXJzaW9ucykKICAgICAgICAgICAgICAgICAgICAvLyBDaHJvbWUgZG9lc24ndCBzZWVtIHRvIGhhdmUgdGhpcyBwcm9ibGVtLAogICAgICAgICAgICAgICAgICAgIC8vIGhvd2V2ZXIsIGluIG9yZGVyIHRvIGtlZXAgY29tcGF0aWJsZSB3aXRoIEZpcmVmb3gsCiAgICAgICAgICAgICAgICAgICAgLy8gd2Ugc3RpbGwgaGF2ZSB0byBhdm9pZCBwb3N0aW5nIGFuIEVycm9yIG9iamVjdAogICAgICAgICAgICAgICAgICAgIHRhc2suZXJyTXNnID0KICAgICAgICAgICAgICAgICAgICAgICAgYFske3RoaXMub3JpZ2lufV0gZXJyb3Igd2hlbiBleGVjdXRpbmcgY21kICR7dGFzay5jbWR9IGZyb20gJHt0YXNrLm9yaWdpbn1gOwogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZSA9PT0gInN0cmluZyIgfHwgZSBpbnN0YW5jZW9mIEVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhc2suZXJyTXNnICs9ICJcbiIgKyBlLnRvU3RyaW5nKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHRhc2sudGFza0lEICE9IEhDQVRhc2tRdWV1ZS5kaXNjYXJkUmVwbHlUYXNrSUQpIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbmRSZXBseSh0YXNrKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGhpcy5vcmlnaW59XSBzZW5kUmVwbHkgZmFpbGVkLmAsIGUpOwogICAgICAgICAgICAgICAgICAgICAgICB0YXNrLmVyck1zZyA9ICh0YXNrLmVyck1zZyA9PSBudWxsID8gIiIgOiB0YXNrLmVyck1zZyArICJcblxuIikgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgInBvc3RNZXNzYWdlIGZyb20gV29ya2VyIGZhaWxlZCI7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZSA9PT0gInN0cmluZyIgfHwgZSBpbnN0YW5jZW9mIEVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXNrLmVyck1zZyArPSAiXG4iICsgZS50b1N0cmluZygpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRyeSBhZ2FpbgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbmRSZXBseSh0YXNrKTsgLy8gaWYgaXQgdGhyb3dzLCBqdXN0IGxldCBpdCB0aHJvdwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIHJlY2VpdmluZyBjbWQgcmVzdWx0CiAgICAgICAgICAgICAgICAvLyBmaW5kICYgdW5yZWdpc3RlciBjYWxsYmFjawogICAgICAgICAgICAgICAgY29uc3QgcmVnaXN0ZXJlZCA9IHRoaXMuY2FsbGJhY2tzW3Rhc2sudGFza0lEXTsKICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmNhbGxiYWNrc1t0YXNrLnRhc2tJRF07CiAgICAgICAgICAgICAgICAvLyBhcHBseSBob29rCiAgICAgICAgICAgICAgICBsZXQgcmVzdWx0ID0gdGFzay5oYXNSZXN1bHQgPyB0YXNrLnJlc3VsdCA6IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIGNvbnN0IGhvb2sgPSByZWdpc3RlcmVkLmhvb2s7CiAgICAgICAgICAgICAgICBpZiAoaG9vayAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRhc2suaGFzRXJyICYmIGhvb2suZXJyb3IgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgaG9vay5lcnJvcih0YXNrLmVyck1zZyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodGFzay5oYXNSZXN1bHQgJiYgaG9vay5yZXN1bHQgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gYXdhaXQgaG9vay5yZXN1bHQodGFzay5yZXN1bHQpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGFzay5oYXNFcnIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXNrLmVyck1zZyA9ICIiOwogICAgICAgICAgICAgICAgICAgICAgICB0YXNrLmVyck1zZyArPSBgWyR7dGhpcy5vcmlnaW59XSBlcnJvciB3aGVuIGFwcGx5aW5nIGhvb2sgYCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBgYWZ0ZXIgZXhlY3V0aW5nIGNtZCAke3Rhc2suY21kfSBmcm9tICR7dGFzay5vcmlnaW59YDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBlID09PSAic3RyaW5nIiB8fCBlIGluc3RhbmNlb2YgRXJyb3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhc2suZXJyTXNnICs9ICJcbiIgKyBlLnRvU3RyaW5nKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBzZXR0bGUgcHJvbWlzZQogICAgICAgICAgICAgICAgaWYgKHRhc2suaGFzRXJyKSB7CiAgICAgICAgICAgICAgICAgICAgcmVnaXN0ZXJlZC5yZWplY3QodGFzay5lcnJNc2cpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAodGFzay5oYXNSZXN1bHQpIHsKICAgICAgICAgICAgICAgICAgICByZWdpc3RlcmVkLnJlc29sdmUocmVzdWx0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgdGFzayAob3JpZ2luPSR7dGFzay5vcmlnaW59IHRhc2tJRD0ke3Rhc2sudGFza0lEfSBjbWQ9JHt0YXNrLmNtZH0pIGAgKwogICAgICAgICAgICAgICAgICAgICAgICBgaGFzIG5laXRoZXIgZXJyb3Igbm9yIHJlc3VsdGApOyAvLyBzaG91bGQgbmV2ZXIgaGFwcGVuCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBzdGFydCBuZXh0IHRhc2sKICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuc2VuZE5leHRUYXNrKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY2F0Y2ggKGUpIHsKICAgICAgICAgICAgLy8gaXJyZWNvdmVyYWJsZSBlcnJvcgogICAgICAgICAgICBhd2FpdCB0aGlzLmVyckhhbmRsZXIoZSk7CiAgICAgICAgfQogICAgfQogICAgYXN5bmMgZXJySGFuZGxlcihkYXRhKSB7CiAgICAgICAgLy8gaXJyZWNvdmVyYWJsZSBlcnJvcgogICAgICAgIGlmICh0aGlzLl9pc0FsaXZlKSB7CiAgICAgICAgICAgIC8vIHByaW50IGVycm9yIG1lc3NhZ2UKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGhpcy5vcmlnaW59XSBkZXN0cm95aW5nIGJhY2tncm91bmQgd29ya2VyIG9uIGlycmVjb3ZlcmFibGUgZXJyb3JgLCBkYXRhKTsKICAgICAgICAgICAgLy8gZGVzdHJveSBiYWNrZ3JvdW5kIHdvcmtlcgogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5kZXN0cm95KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RoaXMub3JpZ2lufV0gZXJyb3Igd2hlbiB0cnlpbmcgdG8gZGVzdHJveSgpYCwgZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gYWZ0ZXIgZGVzdHJveSwgbWFyayBpc0FsaXZlIGFzIGZhbHNlIChvdGhlcndpc2Ugc2VuZENtZCB3aWxsIGZhaWwpCiAgICAgICAgICAgIHRoaXMuX2lzQWxpdmUgPSBmYWxzZTsKICAgICAgICAgICAgLy8gcmVqZWN0IGFsbCBwZW5kaW5nIHByb21pc2VzCiAgICAgICAgICAgIGZvciAobGV0IHRhc2tJRCBpbiB0aGlzLmNhbGxiYWNrcykgewogICAgICAgICAgICAgICAgY29uc3QgcmVqZWN0ID0gdGhpcy5jYWxsYmFja3NbdGFza0lEXS5yZWplY3Q7CiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5jYWxsYmFja3NbdGFza0lEXTsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RoaXMub3JpZ2lufV0gZXJyb3IgcmVqZWN0aW5nIHRhc2tJRD0ke3Rhc2tJRH1gLCBlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIGFzeW5jIGdldFRyYW5zZmVyQ29uZmlnKCkgewogICAgICAgIGlmICghdGhpcy5faXNBbGl2ZSkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJkZWFkIik7CiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZXhlY0NtZCgibm9wIiwgW10sIHsKICAgICAgICAgICAgcmVzdWx0OiAoKSA9PiAoewogICAgICAgICAgICAgICAgdHJhbnNmZXJBcmdzOiB0aGlzLnRyYW5zZmVyQXJncywKICAgICAgICAgICAgICAgIHJlcGx5QXJnczogdGhpcy5yZXBseUFyZ3MsCiAgICAgICAgICAgIH0pLAogICAgICAgIH0pOwogICAgfQogICAgYXN5bmMgY29uZmlnVHJhbnNmZXIodHJhbnNmZXJBcmdzLCByZXBseUFyZ3MpIHsKICAgICAgICBpZiAoIXRoaXMuX2lzQWxpdmUpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiZGVhZCIpOwogICAgICAgIHJldHVybiBhd2FpdCB0aGlzLmV4ZWNDbWQoIm5vcCIsIFtdLCB7CiAgICAgICAgICAgIHJlc3VsdDogKCkgPT4gewogICAgICAgICAgICAgICAgdGhpcy50cmFuc2ZlckFyZ3MgPSB0cmFuc2ZlckFyZ3MgPyB0cnVlIDogZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLnJlcGx5QXJncyA9IHJlcGx5QXJncyA/IHRydWUgOiBmYWxzZTsKICAgICAgICAgICAgfSwKICAgICAgICB9KTsKICAgIH0KICAgIGFzeW5jIGV4ZWNDbWQoY21kLCBhcmdzLCBob29rKSB7CiAgICAgICAgLy8gY2FuIGJlIG1vZGlmaWVkIHRvIHNpbXBseSB3cmFwIGV4ZWNNdWx0aUNtZCBidXQgSSBqdXN0IHdhbnQgdG8gbGV0IGl0IGFsb25lIGZvciBubyBzcGVjaWFsIHJlYXNvbgogICAgICAgIGlmICghdGhpcy5faXNBbGl2ZSkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJkZWFkIik7CiAgICAgICAgLy8gYXNzaWduIG5ldyB0YXNrSUQKICAgICAgICBjb25zdCB0YXNrSUQgPSB0aGlzLmdldE5leHRUYXNrSUQoKTsKICAgICAgICBjb25zdCB0YXNrID0gbmV3IEhDQVRhc2sodGhpcy5vcmlnaW4sIHRhc2tJRCwgY21kLCBhcmdzLCB0aGlzLnJlcGx5QXJncyk7CiAgICAgICAgLy8gcmVnaXN0ZXIgY2FsbGJhY2sKICAgICAgICBpZiAodGhpcy5jYWxsYmFja3NbdGFza0lEXSAhPSBudWxsKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgdGFza0lEPSR7dGFza0lEfSBpcyBhbHJlYWR5IG9jY3VwaWVkYCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHJlc3VsdFByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB0aGlzLmNhbGxiYWNrc1t0YXNrSURdID0geyByZXNvbHZlOiByZXNvbHZlLCByZWplY3Q6IHJlamVjdCwgaG9vazogaG9vayB9KTsKICAgICAgICAvLyBhcHBlbmQgdG8gY29tbWFuZCBxdWV1ZQogICAgICAgIHRoaXMucXVldWUucHVzaCh0YXNrKTsKICAgICAgICAvLyBzdGFydCBleGVjdXRpbmcgdGFza3MKICAgICAgICBpZiAodGhpcy5pc0lkbGUpCiAgICAgICAgICAgIGF3YWl0IHRoaXMuc2VuZE5leHRUYXNrKCk7CiAgICAgICAgLy8gcmV0dXJuIHJlc3VsdAogICAgICAgIHJldHVybiBhd2FpdCByZXN1bHRQcm9taXNlOwogICAgfQogICAgYXN5bmMgZXhlY011bHRpQ21kKGNtZExpc3QpIHsKICAgICAgICAvLyB0aGUgcG9pbnQgaXMgdG8gZW5zdXJlICJhdG9taWNpdHkiIGJldHdlZW4gY21kcwogICAgICAgIGlmICghdGhpcy5faXNBbGl2ZSkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJkZWFkIik7CiAgICAgICAgbGV0IHJlc3VsdFByb21pc2VzID0gW107CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjbWRMaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIC8vIGFzc2lnbiBuZXcgdGFza0lECiAgICAgICAgICAgIGNvbnN0IHRhc2tJRCA9IHRoaXMuZ2V0TmV4dFRhc2tJRCgpOwogICAgICAgICAgICBjb25zdCBsaXN0SXRlbSA9IGNtZExpc3RbaV07CiAgICAgICAgICAgIGNvbnN0IHRhc2sgPSBuZXcgSENBVGFzayh0aGlzLm9yaWdpbiwgdGFza0lELCBsaXN0SXRlbS5jbWQsIGxpc3RJdGVtLmFyZ3MsIHRoaXMucmVwbHlBcmdzKTsKICAgICAgICAgICAgLy8gcmVnaXN0ZXIgY2FsbGJhY2sKICAgICAgICAgICAgaWYgKHRoaXMuY2FsbGJhY2tzW3Rhc2tJRF0gIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGB0YXNrSUQ9JHt0YXNrSUR9IGlzIGFscmVhZHkgb2NjdXBpZWRgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXN1bHRQcm9taXNlcy5wdXNoKG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHRoaXMuY2FsbGJhY2tzW3Rhc2tJRF0gPSB7CiAgICAgICAgICAgICAgICByZXNvbHZlOiByZXNvbHZlLAogICAgICAgICAgICAgICAgcmVqZWN0OiByZWplY3QsCiAgICAgICAgICAgICAgICBob29rOiBsaXN0SXRlbS5ob29rLAogICAgICAgICAgICB9KSk7CiAgICAgICAgICAgIC8vIGFwcGVuZCB0byBjb21tYW5kIHF1ZXVlCiAgICAgICAgICAgIHRoaXMucXVldWUucHVzaCh0YXNrKTsKICAgICAgICB9CiAgICAgICAgLy8gc3RhcnQgZXhlY3V0aW5nIHRhc2tzCiAgICAgICAgaWYgKHRoaXMuaXNJZGxlKQogICAgICAgICAgICBhd2FpdCB0aGlzLnNlbmROZXh0VGFzaygpOwogICAgICAgIC8vIHJldHVybiByZXN1bHRzCiAgICAgICAgcmV0dXJuIGF3YWl0IFByb21pc2UuYWxsKHJlc3VsdFByb21pc2VzKTsKICAgIH0KICAgIHNlbmRDbWQoY21kLCBhcmdzKSB7CiAgICAgICAgLy8gc2VuZCBjbWQgd2l0aG91dCByZWdpc3RlcmluZyBjYWxsYmFjawogICAgICAgIC8vIGdlbmVyYWxseSBub3QgcmVjb21tZW5kZWQKICAgICAgICBpZiAoIXRoaXMuX2lzQWxpdmUpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiZGVhZCIpOwogICAgICAgIGNvbnN0IHRhc2sgPSBuZXcgSENBVGFzayh0aGlzLm9yaWdpbiwgSENBVGFza1F1ZXVlLmRpc2NhcmRSZXBseVRhc2tJRCwgY21kLCBhcmdzLCBmYWxzZSk7CiAgICAgICAgdGhpcy5zZW5kVGFzayh0YXNrKTsKICAgIH0KICAgIGFzeW5jIHNodXRkb3duKGZvcmNpYmx5ID0gZmFsc2UpIHsKICAgICAgICBpZiAodGhpcy5faXNBbGl2ZSkgewogICAgICAgICAgICBpZiAoZm9yY2libHkpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5kZXN0cm95KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RoaXMub3JpZ2lufV0gZXJyb3Igd2hlbiB0cnlpbmcgdG8gZm9yY2libHkgc2h1dGRvd24uYCwgZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLl9pc0FsaXZlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmV4ZWNDbWQoIm5vcCIsIFtdLCB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0OiBhc3luYyAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuZGVzdHJveSgpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9pc0FsaXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CkhDQVRhc2tRdWV1ZS5tYXhUYXNrSUQgPSAyNTY7IC8vIHRoZXJlJ3MgcmVjdXJzaW9uIGluIHNlbmROZXh0VGFzayB3aGVuIG1ha2luZyBmYWtlIHJlcGx5CkhDQVRhc2tRdWV1ZS5kaXNjYXJkUmVwbHlUYXNrSUQgPSAtMTsKCi8vIFdlYiBXb3JrZXIgLyBBdWRpb1dvcmtsZXQgc3VwcG9ydAppZiAodHlwZW9mIGRvY3VtZW50ID09PSAidW5kZWZpbmVkIikgewogICAgaWYgKHR5cGVvZiBvbm1lc3NhZ2UgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgY2xhc3MgSENBRnJhbWVQbGF5ZXJDb250ZXh0IHsKICAgICAgICAgICAgY29uc3RydWN0b3IocHJvY09wdHMpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNQbGF5aW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmRlZmF1bHRQdWxsQmxvY2tDb3VudCA9IDEyODsKICAgICAgICAgICAgICAgIHRoaXMuZmFpbGVkQmxvY2tzID0gW107CiAgICAgICAgICAgICAgICB0aGlzLnByaW50RXJyb3JDb3VudERvd25Gcm9tID0gMjU2OwogICAgICAgICAgICAgICAgdGhpcy5wcmludEVycm9yQ291bnREb3duID0gdGhpcy5wcmludEVycm9yQ291bnREb3duRnJvbTsKICAgICAgICAgICAgICAgIHRoaXMudG90YWxQdWxsZWRCbG9ja0NvdW50ID0gMDsKICAgICAgICAgICAgICAgIHRoaXMuaXNQdWxsaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLl9pc1N0YWxsaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLm9uY2VTdGFsbGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLnNhbXBsZU9mZnNldCA9IDA7CiAgICAgICAgICAgICAgICB0aGlzLmxhc3REZWNvZGVkQmxvY2tJbmRleCA9IC0xOwogICAgICAgICAgICAgICAgdGhpcy5mcmFtZSA9IG5ldyBIQ0FGcmFtZShuZXcgSENBSW5mbyhwcm9jT3B0cy5yYXdIZWFkZXIpKTsKICAgICAgICAgICAgICAgIGNvbnN0IGluZm8gPSB0aGlzLmZyYW1lLkhjYTsKICAgICAgICAgICAgICAgIGNvbnN0IGhhc0xvb3AgPSBpbmZvLmhhc0hlYWRlclsibG9vcCJdID8gdHJ1ZSA6IGZhbHNlOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwcm9jT3B0cy5wdWxsQmxvY2tDb3VudCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNOYU4ocHJvY09wdHMucHVsbEJsb2NrQ291bnQpKQogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICAgICAgICAgICAgICBsZXQgcHVsbEJsb2NrQ291bnQgPSBNYXRoLmZsb29yKHByb2NPcHRzLnB1bGxCbG9ja0NvdW50KTsKICAgICAgICAgICAgICAgICAgICBpZiAocHVsbEJsb2NrQ291bnQgPCAyKQogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnB1bGxCbG9ja0NvdW50ID0gcHVsbEJsb2NrQ291bnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgdGhpcy5wdWxsQmxvY2tDb3VudCA9IHRoaXMuZGVmYXVsdFB1bGxCbG9ja0NvdW50OwogICAgICAgICAgICAgICAgY29uc3QgYnVmZmVyZWRCbG9ja0NvdW50ID0gaGFzTG9vcCA/IChpbmZvLmxvb3AuZW5kICsgMSkgOiB0aGlzLnB1bGxCbG9ja0NvdW50ICogMjsKICAgICAgICAgICAgICAgIHRoaXMuZW5jb2RlZCA9IG5ldyBVaW50OEFycmF5KGluZm8uYmxvY2tTaXplICogYnVmZmVyZWRCbG9ja0NvdW50KTsKICAgICAgICAgICAgICAgIHRoaXMuZGVjb2RlZCA9IEFycmF5LmZyb20oeyBsZW5ndGg6IGluZm8uZm9ybWF0LmNoYW5uZWxDb3VudCB9LCAoKSA9PiBuZXcgRmxvYXQzMkFycmF5KEhDQUZyYW1lLlNhbXBsZXNQZXJGcmFtZSAqIDIpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBnZXQgaXNTdGFsbGluZygpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9pc1N0YWxsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNldCBpc1N0YWxsaW5nKHZhbCkgewogICAgICAgICAgICAgICAgdGhpcy5faXNTdGFsbGluZyA9IHZhbDsKICAgICAgICAgICAgICAgIGlmICh2YWwpCiAgICAgICAgICAgICAgICAgICAgdGhpcy5vbmNlU3RhbGxlZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY2xhc3MgSENBRnJhbWVQbGF5ZXIgZXh0ZW5kcyBBdWRpb1dvcmtsZXRQcm9jZXNzb3IgewogICAgICAgICAgICBjb25zdHJ1Y3RvcihvcHRpb25zKSB7CiAgICAgICAgICAgICAgICBzdXBlcigpOwogICAgICAgICAgICAgICAgdGhpcy51bnNldHRsZWQgPSBbXTsKICAgICAgICAgICAgICAgIHRoaXMud2FpdENvdW50RG93bkZyb20gPSAzMjsKICAgICAgICAgICAgICAgIGlmIChvcHRpb25zID09IG51bGwgfHwgb3B0aW9ucy5wcm9jZXNzb3JPcHRpb25zID09IG51bGwpCiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgICAgICAgICB0aGlzLmN0eCA9IG5ldyBIQ0FGcmFtZVBsYXllckNvbnRleHQob3B0aW9ucy5wcm9jZXNzb3JPcHRpb25zKTsKICAgICAgICAgICAgICAgIHRoaXMudGFza1F1ZXVlID0gbmV3IEhDQVRhc2tRdWV1ZSgiQmFja2dyb3VuZC1IQ0FGcmFtZVBsYXllciIsIChtc2csIHRyYW5zKSA9PiB0aGlzLnBvcnQucG9zdE1lc3NhZ2UobXNnLCB0cmFucyksIGFzeW5jICh0YXNrKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgc3dpdGNoICh0YXNrLmNtZCkgewogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJub3AiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJpbml0aWFsaXplIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY3R4ID0gbmV3IEhDQUZyYW1lUGxheWVyQ29udGV4dCh0YXNrLmFyZ3NbMF0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInJlc2V0IjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuY3R4OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudW5zZXR0bGVkLnB1c2goeyByZXNvbHZlOiByZXNvbHZlLCBjb3VudGVyOiB0aGlzLndhaXRDb3VudERvd25Gcm9tIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAicGF1c2UiOgogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJyZXN1bWUiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY3R4ID09IG51bGwpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBub3QgaW5pdGlhbGl6ZWRgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY3R4LmlzUGxheWluZyA9IHRhc2suY21kID09PSAicmVzdW1lIjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5jdHguaXNQbGF5aW5nKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudW5zZXR0bGVkLnB1c2goeyByZXNvbHZlOiByZXNvbHZlLCBjb3VudGVyOiB0aGlzLndhaXRDb3VudERvd25Gcm9tIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYHVua25vd24gY21kICR7dGFzay5jbWR9YCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgKCkgPT4geyB0aGlzLnRhc2tRdWV1ZS5zZW5kQ21kKCJzZWxmLWRlc3RydWN0IiwgW10pOyB9KTsKICAgICAgICAgICAgICAgIHRoaXMudGFza1F1ZXVlLmNvbmZpZ1RyYW5zZmVyKHRydWUsIGZhbHNlKTsKICAgICAgICAgICAgICAgIHRoaXMucG9ydC5vbm1lc3NhZ2UgPSAoZXYpID0+IHRoaXMudGFza1F1ZXVlLm1zZ0hhbmRsZXIoZXYpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGhhbmRsZU5ld0Jsb2NrcyhjdHgsIG5ld0Jsb2NrcykgewogICAgICAgICAgICAgICAgY29uc3QgaW5mbyA9IGN0eC5mcmFtZS5IY2E7CiAgICAgICAgICAgICAgICBjb25zdCBoYXNMb29wID0gaW5mby5oYXNIZWFkZXJbImxvb3AiXSA/IHRydWUgOiBmYWxzZTsKICAgICAgICAgICAgICAgIGNvbnN0IHB1bGxCbG9ja0NvdW50ID0gY3R4LnB1bGxCbG9ja0NvdW50OwogICAgICAgICAgICAgICAgY29uc3QgZW5jb2RlZCA9IGN0eC5lbmNvZGVkOwogICAgICAgICAgICAgICAgaWYgKG5ld0Jsb2Nrcy5sZW5ndGggJSBpbmZvLmJsb2NrU2l6ZSAhPSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBuZXdCbG9ja3MubGVuZ3RoPSR7bmV3QmxvY2tzLmxlbmd0aH0gc2hvdWxkIGJlIG11bHRpcGxlIG9mIGJsb2NrU2l6ZWApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29uc3QgbmV3QmxvY2tDb3VudCA9IG5ld0Jsb2Nrcy5sZW5ndGggLyBpbmZvLmJsb2NrU2l6ZTsKICAgICAgICAgICAgICAgIGNvbnN0IGV4cGVjdGVkID0gaW5mby5ibG9ja1NpemUgKiBwdWxsQmxvY2tDb3VudDsKICAgICAgICAgICAgICAgIGlmIChoYXNMb29wKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IGVuY29kZWRPZmZzZXQgPSBpbmZvLmJsb2NrU2l6ZSAqIGN0eC50b3RhbFB1bGxlZEJsb2NrQ291bnQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKGVuY29kZWRPZmZzZXQgKyBuZXdCbG9ja3MubGVuZ3RoID4gZW5jb2RlZC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBoYXMgbG9vcCBoZWFkZXIsIGJ1ZmZlciB3aWxsIG92ZXJmbG93YCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVuY29kZWQuc2V0KG5ld0Jsb2NrcywgZW5jb2RlZE9mZnNldCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAobmV3QmxvY2tzLmxlbmd0aCAhPSBleHBlY3RlZCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYG5vIGxvb3AgaGVhZGVyLCBuZXdCbG9ja3MubGVuZ3RoICgke25ld0Jsb2Nrcy5sZW5ndGh9KSAhPSBleHBlY3RlZCAoJHtleHBlY3RlZH0pYCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoY3R4LnRvdGFsUHVsbGVkQmxvY2tDb3VudCAlIChwdWxsQmxvY2tDb3VudCAqIDIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuY29kZWQuc2V0KG5ld0Jsb2Nrcyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBwdWxsQmxvY2tDb3VudDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuY29kZWQuc2V0KG5ld0Jsb2NrcywgZXhwZWN0ZWQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjdHgudG90YWxQdWxsZWRCbG9ja0NvdW50ICs9IG5ld0Jsb2NrQ291bnQ7CiAgICAgICAgICAgICAgICBjdHguaXNQdWxsaW5nID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcHVsbE5ld0Jsb2NrcyhjdHgpIHsKICAgICAgICAgICAgICAgIC8vIGlmIGN0eCBwYXNzZWQgaW4gaGFkIGJlZW4gYWN0dWFsbHkgZGVsZXRlZCwgaXQgd29uJ3QgYWZmZWN0IHRoZSBjdXJyZW50IHVzaW5nIGN0eAogICAgICAgICAgICAgICAgaWYgKGN0eC5pc1B1bGxpbmcpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOyAvLyBhbHJlYWR5IHB1bGxpbmcuIHdpbGwgYmUgY2FsbGVkIGFnYWluIGlmIHN0aWxsIG5vdCBlbm91Z2gKICAgICAgICAgICAgICAgIGN0eC5pc1B1bGxpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgLy8gcmVxdWVzdCB0byBwdWxsICYgY29udGludWUgZGVjb2RpbmcKICAgICAgICAgICAgICAgIHRoaXMudGFza1F1ZXVlLmV4ZWNDbWQoInB1bGwiLCBbXSwgewogICAgICAgICAgICAgICAgICAgIHJlc3VsdDogKG5ld0Jsb2NrcykgPT4gdGhpcy5oYW5kbGVOZXdCbG9ja3MoY3R4LCBuZXdCbG9ja3MpLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiAoKSA9PiB7IGN0eC5pc1B1bGxpbmcgPSBmYWxzZTsgfSwKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLmNhdGNoKChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKGBwdWxsTmV3QmxvY2tzIGZhaWxlZC5gLCBlKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdyaXRlVG9EZWNvZGVkQnVmZmVyKGZyYW1lLCBkZWNvZGVkKSB7CiAgICAgICAgICAgICAgICBjb25zdCBoYWxmU2l6ZSA9IEhDQUZyYW1lLlNhbXBsZXNQZXJGcmFtZTsKICAgICAgICAgICAgICAgIGZvciAobGV0IGMgPSAwOyBjIDwgZnJhbWUuQ2hhbm5lbHMubGVuZ3RoOyBjKyspIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBmaXJzdEhhbGYgPSBkZWNvZGVkW2NdLnN1YmFycmF5KDAsIGhhbGZTaXplKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBsYXN0SGFsZiA9IGRlY29kZWRbY10uc3ViYXJyYXkoaGFsZlNpemUsIGhhbGZTaXplICogMik7CiAgICAgICAgICAgICAgICAgICAgZmlyc3RIYWxmLnNldChsYXN0SGFsZik7CiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgc2YgPSAwLCBvZmZzZXQgPSAwOyBzZiA8IEhDQUZyYW1lLlN1YmZyYW1lc1BlckZyYW1lOyBzZisrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RIYWxmLnNldChmcmFtZS5DaGFubmVsc1tjXS5QY21GbG9hdFtzZl0sIG9mZnNldCk7CiAgICAgICAgICAgICAgICAgICAgICAgIG9mZnNldCArPSBIQ0FGcmFtZS5TYW1wbGVzUGVyU3ViRnJhbWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGFzdEhhbGYubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxhc3RIYWxmW2ldID4gMSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RIYWxmW2ldID0gMTsKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAobGFzdEhhbGZbaV0gPCAtMSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RIYWxmW2ldID0gLTE7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIG1hcFRvVW5Mb29wZWQoaW5mbywgc2FtcGxlT2Zmc2V0KSB7CiAgICAgICAgICAgICAgICBjb25zdCBoYXNMb29wID0gaW5mby5oYXNIZWFkZXJbImxvb3AiXSA/IHRydWUgOiBmYWxzZTsKICAgICAgICAgICAgICAgIGlmIChzYW1wbGVPZmZzZXQgPD0gaW5mby5lbmRBdFNhbXBsZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBzYW1wbGVPZmZzZXQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaGFzTG9vcCkgewogICAgICAgICAgICAgICAgICAgICAgICBsZXQgb2Zmc2V0ID0gKHNhbXBsZU9mZnNldCAtIGluZm8ubG9vcFN0YXJ0QXRTYW1wbGUpICUgaW5mby5sb29wU2FtcGxlQ291bnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpbmZvLmxvb3BTdGFydEF0U2FtcGxlICsgb2Zmc2V0OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGluZm8uZW5kQXRTYW1wbGU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHByb2Nlc3MoaW5wdXRzLCBvdXRwdXRzLCBwYXJhbWV0ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5jdHggPT0gbnVsbCB8fCAhdGhpcy5jdHguaXNQbGF5aW5nKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gd29ya2Fyb3VuZCB0aGUgInJlc2lkdWUiIGJ1cnN0IG5vaXNlIGlzc3VlIGluIENocm9tZQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHVuc2V0dGxlZCA9IHRoaXMudW5zZXR0bGVkLnNoaWZ0KCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHVuc2V0dGxlZCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgtLXVuc2V0dGxlZC5jb3VudGVyID4gMCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudW5zZXR0bGVkLnVuc2hpZnQodW5zZXR0bGVkKTsKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1bnNldHRsZWQucmVzb2x2ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBlcnJvciB3aGVuIHNldHRsaW5nIHByb21pc2Ugb2YgInJlc2V0IiBvciAic2V0UGxheWluZyIgY21kYCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOyAvLyB3YWl0IGZvciBuZXcgc291cmNlIG9yIHJlc3VtZQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHRoaXMuY3R4LmZhaWxlZEJsb2Nrcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY3R4LmZhaWxlZEJsb2Nrcy5sZW5ndGggPj0gNjQgfHwgLS10aGlzLmN0eC5wcmludEVycm9yQ291bnREb3duIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgZXJyb3IgZGVjb2RpbmcgZm9sbG93aW5nIGJsb2Nrc2AsIHRoaXMuY3R4LmZhaWxlZEJsb2NrcywgdGhpcy5jdHgubGFzdEVycm9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jdHguZmFpbGVkQmxvY2tzID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY3R4Lmxhc3RFcnJvciA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jdHgucHJpbnRFcnJvckNvdW50RG93biA9IHRoaXMuY3R4LnByaW50RXJyb3JDb3VudERvd25Gcm9tOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnN0IG91dHB1dCA9IG91dHB1dHNbMF07CiAgICAgICAgICAgICAgICBjb25zdCByZW5kZXJRdWFudHVtU2l6ZSA9IG91dHB1dFswXS5sZW5ndGg7CiAgICAgICAgICAgICAgICBjb25zdCBzYW1wbGVzUGVyQmxvY2sgPSBIQ0FGcmFtZS5TYW1wbGVzUGVyRnJhbWU7CiAgICAgICAgICAgICAgICAvLyBubyBtb3JlIHRoYW4gb25lIGJsb2NrIHdpbGwgYmUgZGVjb2RlZCBlYWNoIHRpbWUgdGhpcyBmdW5jdGlvbiBiZWluZyBjYWxsZWQsCiAgICAgICAgICAgICAgICAvLyB0aGVyZWZvcmUgb25lIGJsb2NrIG11c3QgY292ZXIgdGhlIHdob2xlIHJlbmRlclF1YW50dW1TaXplCiAgICAgICAgICAgICAgICBpZiAoc2FtcGxlc1BlckJsb2NrIDwgcmVuZGVyUXVhbnR1bVNpemUpCiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJyZW5kZXIgcXVhbnR1bSByZXF1aXJlcyBtb3JlIHNhbXBsZSB0aGFuIGEgZnVsbCBibG9jayIpOwogICAgICAgICAgICAgICAgY29uc3QgaW5mbyA9IHRoaXMuY3R4LmZyYW1lLkhjYTsKICAgICAgICAgICAgICAgIGNvbnN0IGhhc0xvb3AgPSBpbmZvLmhhc0hlYWRlclsibG9vcCJdID8gdHJ1ZSA6IGZhbHNlOwogICAgICAgICAgICAgICAgY29uc3QgZW5jb2RlZCA9IHRoaXMuY3R4LmVuY29kZWQ7CiAgICAgICAgICAgICAgICBjb25zdCBkZWNvZGVkID0gdGhpcy5jdHguZGVjb2RlZDsKICAgICAgICAgICAgICAgIC8vIHNraXAgZHJvcHBlZEhlYWRlcgogICAgICAgICAgICAgICAgaWYgKHRoaXMuY3R4LnNhbXBsZU9mZnNldCA8IGluZm8uZm9ybWF0LmRyb3BwZWRIZWFkZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmN0eC5zYW1wbGVPZmZzZXQgPSBpbmZvLmZvcm1hdC5kcm9wcGVkSGVhZGVyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHRoaXMuY3R4LnNhbXBsZU9mZnNldCA+PSBpbmZvLmVuZEF0U2FtcGxlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGhhc0xvb3ApIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmV3aW5kIGJhY2sgaWYgYmV5b25kIGxvb3AgZW5kCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY3R4LnNhbXBsZU9mZnNldCA9IHRoaXMubWFwVG9Vbkxvb3BlZChpbmZvLCB0aGlzLmN0eC5zYW1wbGVPZmZzZXQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gbm90aGluZyBtb3JlIHRvIHBsYXkKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50YXNrUXVldWUuc2VuZENtZCgiZW5kIiwgW10pOyAvLyBub3Qgd2FpdGluZyBmb3IgcmVzdWx0CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmN0eDsgLy8gYXZvaWQgc2VuZGluZyAiZW5kIiBjbWQgZm9yIG1vcmUgdGhhbiBvbmUgdGltZQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBkZWNvZGUgYmxvY2sgJiBwdWxsIG5ldyBibG9jayAoaWYgbmVlZGVkKQogICAgICAgICAgICAgICAgY29uc3QgbWFwcGVkU3RhcnRPZmZzZXQgPSB0aGlzLm1hcFRvVW5Mb29wZWQoaW5mbywgdGhpcy5jdHguc2FtcGxlT2Zmc2V0KTsKICAgICAgICAgICAgICAgIGNvbnN0IG1hcHBlZEVuZE9mZnNldCA9IHRoaXMubWFwVG9Vbkxvb3BlZChpbmZvLCB0aGlzLmN0eC5zYW1wbGVPZmZzZXQgKyByZW5kZXJRdWFudHVtU2l6ZSk7CiAgICAgICAgICAgICAgICBjb25zdCBpbkJsb2NrU3RhcnRPZmZzZXQgPSBtYXBwZWRTdGFydE9mZnNldCAlIHNhbXBsZXNQZXJCbG9jazsKICAgICAgICAgICAgICAgIGNvbnN0IGluQmxvY2tFbmRPZmZzZXQgPSBtYXBwZWRFbmRPZmZzZXQgJSBzYW1wbGVzUGVyQmxvY2s7CiAgICAgICAgICAgICAgICBjb25zdCBzdGFydEJsb2NrSW5kZXggPSAobWFwcGVkU3RhcnRPZmZzZXQgLSBpbkJsb2NrU3RhcnRPZmZzZXQpIC8gc2FtcGxlc1BlckJsb2NrOwogICAgICAgICAgICAgICAgY29uc3QgZW5kQmxvY2tJbmRleCA9IChtYXBwZWRFbmRPZmZzZXQgLSBpbkJsb2NrRW5kT2Zmc2V0KSAvIHNhbXBsZXNQZXJCbG9jazsKICAgICAgICAgICAgICAgIGlmIChlbmRCbG9ja0luZGV4ICE9IHRoaXMuY3R4Lmxhc3REZWNvZGVkQmxvY2tJbmRleCkgewogICAgICAgICAgICAgICAgICAgIGlmIChlbmRCbG9ja0luZGV4IDwgdGhpcy5jdHgudG90YWxQdWxsZWRCbG9ja0NvdW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGJsb2NrIGlzIGF2YWlsYWJsZSBmb3IgZGVjb2RpbmcKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jdHguaXNTdGFsbGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgc3RhcnQgPSBpbmZvLmJsb2NrU2l6ZSAqIChoYXNMb29wCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IGVuZEJsb2NrSW5kZXgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogZW5kQmxvY2tJbmRleCAlICh0aGlzLmN0eC5wdWxsQmxvY2tDb3VudCAqIDIpKTsKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGVuZCA9IHN0YXJ0ICsgaW5mby5ibG9ja1NpemU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbmQgPiBlbmNvZGVkLmxlbmd0aCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiYmxvY2sgZW5kIG9mZnNldCBleGNlZWRzIGJ1ZmZlciBzaXplIik7CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBIQ0EuZGVjb2RlQmxvY2sodGhpcy5jdHguZnJhbWUsIGVuY29kZWQuc3ViYXJyYXkoc3RhcnQsIGVuZCkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmN0eC5mYWlsZWRCbG9ja3MucHVzaChlbmRCbG9ja0luZGV4KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY3R4Lmxhc3RFcnJvciA9IGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmN0eC5mcmFtZS5DaGFubmVscy5mb3JFYWNoKChjKSA9PiB7IGMuUGNtRmxvYXQuZm9yRWFjaCgoc2YpID0+IHNmLmZpbGwoMCkpOyB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLndyaXRlVG9EZWNvZGVkQnVmZmVyKHRoaXMuY3R4LmZyYW1lLCB0aGlzLmN0eC5kZWNvZGVkKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jdHgubGFzdERlY29kZWRCbG9ja0luZGV4ID0gZW5kQmxvY2tJbmRleDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY3R4LnRvdGFsUHVsbGVkQmxvY2tDb3VudCA8IChoYXNMb29wID8gaW5mby5sb29wLmVuZCA6IGluZm8uZm9ybWF0LmJsb2NrQ291bnQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBwdWxsIGJsb2NrcyBpbiBhZHZhbmNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgYXZhaWxhYmxlQmxvY2tDb3VudCA9IGhhc0xvb3AgJiYgdGhpcy5jdHgudG90YWxQdWxsZWRCbG9ja0NvdW50ID49IGluZm8ubG9vcC5lbmQgKyAxCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyAiYWxsX3B1bGxlZCIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IHRoaXMuY3R4LnRvdGFsUHVsbGVkQmxvY2tDb3VudCAtICh0aGlzLmN0eC5sYXN0RGVjb2RlZEJsb2NrSW5kZXggKyAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgYXZhaWxhYmxlQmxvY2tDb3VudCA9PT0gJ251bWJlcicgJiYgYXZhaWxhYmxlQmxvY2tDb3VudCA8IHRoaXMuY3R4LnB1bGxCbG9ja0NvdW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wdWxsTmV3QmxvY2tzKHRoaXMuY3R4KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gYmxvY2sgaXMgdW5hdmFpbGFibGUKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmN0eC5pc1N0YWxsaW5nICYmIHRoaXMuY3R4Lm9uY2VTdGFsbGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBwcmludCBlcnJvciBhYm91dCBzdGFsbGluZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKGBbSENBRnJhbWVQbGF5ZXJdIHdhaXRpbmcgdW50aWwgYmxvY2sgJHtlbmRCbG9ja0luZGV4fSBiZWNvbWUgYXZhaWxhYmxlLi4uYCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jdHguaXNTdGFsbGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHVsbE5ld0Jsb2Nrcyh0aGlzLmN0eCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIGNvcHkgZGVjb2RlZCBkYXRhCiAgICAgICAgICAgICAgICBpZiAob3V0cHV0Lmxlbmd0aCAhPSBpbmZvLmZvcm1hdC5jaGFubmVsQ291bnQpCiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJjaGFubmVsIGNvdW50IG1pc21hdGNoIik7CiAgICAgICAgICAgICAgICBjb25zdCBpbkJ1ZmZlclN0YXJ0T2Zmc2V0ID0gKGVuZEJsb2NrSW5kZXggIT0gc3RhcnRCbG9ja0luZGV4ID8gMCA6IHNhbXBsZXNQZXJCbG9jaykgKyBpbkJsb2NrU3RhcnRPZmZzZXQ7CiAgICAgICAgICAgICAgICBjb25zdCBpbkJ1ZmZlckVuZE9mZnNldCA9IHNhbXBsZXNQZXJCbG9jayArIGluQmxvY2tFbmRPZmZzZXQ7CiAgICAgICAgICAgICAgICBjb25zdCBpbkJ1ZmZlclNyY1NpemUgPSBpbkJ1ZmZlckVuZE9mZnNldCAtIGluQnVmZmVyU3RhcnRPZmZzZXQ7CiAgICAgICAgICAgICAgICBpZiAoaW5CdWZmZXJTcmNTaXplIDw9IDApCiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJzaXplIGluIGRlY29kZWQgYnVmZmVyIHNob3VsZCBiZSBwb3NpdGl2ZSIpOwogICAgICAgICAgICAgICAgY29uc3QgY29weVNpemUgPSBNYXRoLm1pbihpbkJ1ZmZlclNyY1NpemUsIHJlbmRlclF1YW50dW1TaXplKTsKICAgICAgICAgICAgICAgIGZvciAobGV0IGNoYW5uZWwgPSAwOyBjaGFubmVsIDwgb3V0cHV0Lmxlbmd0aDsgY2hhbm5lbCsrKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IHNyYyA9IGRlY29kZWRbY2hhbm5lbF0uc3ViYXJyYXkoaW5CdWZmZXJTdGFydE9mZnNldCwgaW5CdWZmZXJTdGFydE9mZnNldCArIGNvcHlTaXplKTsKICAgICAgICAgICAgICAgICAgICBvdXRwdXRbY2hhbm5lbF0uc2V0KHNyYyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLmN0eC5zYW1wbGVPZmZzZXQgKz0gY29weVNpemU7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZWdpc3RlclByb2Nlc3NvcigiaGNhLWZyYW1lLXBsYXllciIsIEhDQUZyYW1lUGxheWVyKTsKICAgIH0KICAgIGVsc2UgewogICAgICAgIC8vIFdlYiBXb3JrZXIKICAgICAgICBjb25zdCB0YXNrUXVldWUgPSBuZXcgSENBVGFza1F1ZXVlKCJCYWNrZ3JvdW5kLUhDQVdvcmtlciIsIChtc2csIHRyYW5zKSA9PiBwb3N0TWVzc2FnZShtc2csIHRyYW5zKSwgKHRhc2spID0+IHsKICAgICAgICAgICAgc3dpdGNoICh0YXNrLmNtZCkgewogICAgICAgICAgICAgICAgY2FzZSAibm9wIjoKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICBjYXNlICJmaXhIZWFkZXJDaGVja3N1bSI6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEhDQUluZm8uZml4SGVhZGVyQ2hlY2tzdW0uYXBwbHkoSENBSW5mbywgdGFzay5hcmdzKTsKICAgICAgICAgICAgICAgIGNhc2UgImZpeENoZWNrc3VtIjoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gSENBLmZpeENoZWNrc3VtLmFwcGx5KEhDQSwgdGFzay5hcmdzKTsKICAgICAgICAgICAgICAgIGNhc2UgImZpbmRLZXkiOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBIQ0EuZmluZEtleS5hcHBseShIQ0EsIHRhc2suYXJncyk7CiAgICAgICAgICAgICAgICBjYXNlICJkZWNyeXB0IjoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gSENBLmRlY3J5cHQuYXBwbHkoSENBLCB0YXNrLmFyZ3MpOwogICAgICAgICAgICAgICAgY2FzZSAiZW5jcnlwdCI6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEhDQS5lbmNyeXB0LmFwcGx5KEhDQSwgdGFzay5hcmdzKTsKICAgICAgICAgICAgICAgIGNhc2UgImFkZENpcGhlckhlYWRlciI6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEhDQUluZm8uYWRkQ2lwaGVySGVhZGVyLmFwcGx5KEhDQUluZm8sIHRhc2suYXJncyk7CiAgICAgICAgICAgICAgICBjYXNlICJkZWNvZGUiOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBIQ0EuZGVjb2RlLmFwcGx5KEhDQSwgdGFzay5hcmdzKTsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGB1bmtub3duIGNtZCAke3Rhc2suY21kfWApOwogICAgICAgICAgICB9CiAgICAgICAgfSwgKCkgPT4gewogICAgICAgICAgICB0YXNrUXVldWUuc2VuZENtZCgic2VsZi1kZXN0cnVjdCIsIFtdKTsKICAgICAgICB9KTsKICAgICAgICBvbm1lc3NhZ2UgPSAoZXYpID0+IHRhc2tRdWV1ZS5tc2dIYW5kbGVyKGV2KTsKICAgIH0KfQoKLy8gY3JlYXRlICYgY29udHJvbCBhdWRpbyB3b3JrbGV0CmNsYXNzIEhDQUF1ZGlvV29ya2xldEhDQVBsYXllciB7CiAgICBjb25zdHJ1Y3RvcihzZWxmVXJsLCBhdWRpb0N0eCwgdW5sb2NrZWQsIGhjYVBsYXllck5vZGUsIGdhaW5Ob2RlLCBmZWVkQmxvY2tDb3VudCwgaW5mbywgc291cmNlLCBzcmNCdWYsIGNpcGhlcikgewogICAgICAgIHRoaXMuX2luaXRpYWxpemVkID0gdHJ1ZTsgLy8gaW5pdGlhbGx5IHRoZXJlIG11c3QgYmUgc29tZXRoaW5nIHRvIHBsYXkKICAgICAgICB0aGlzLmlzUGxheWluZyA9IGZhbHNlOwogICAgICAgIHRoaXMucGxheUluQmFja2dyb3VuZCA9IGZhbHNlOyAvLyBGSVhNRQogICAgICAgIHRoaXMucmVxdWVzdGVkVG9QbGF5ID0gZmFsc2U7CiAgICAgICAgdGhpcy52ZXJpZnlDc3VtID0gZmFsc2U7CiAgICAgICAgdGhpcy50b3RhbEZlZEJsb2NrQ291bnQgPSAwOwogICAgICAgIHRoaXMudmlzaWJpbGl0eUNoYW5nZUxpc3RlbmVyID0gKCkgPT4gewogICAgICAgICAgICBzd2l0Y2ggKGRvY3VtZW50LnZpc2liaWxpdHlTdGF0ZSkgewogICAgICAgICAgICAgICAgY2FzZSAndmlzaWJsZSc6CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucmVxdWVzdGVkVG9QbGF5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3BsYXkoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdoaWRkZW4nOgogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMucGxheUluQmFja2dyb3VuZCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9wYXVzZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgdGhpcy5zdG9wQ21kSXRlbSA9IHsKICAgICAgICAgICAgLy8gZXhlYyAicmVzZXQiIGNtZCBmaXJzdCwgaW4gb3JkZXIgdG8gYXZvaWQgInJlc2lkdWUiIGJ1cnN0IG5vaXNlIHRvIGJlIHBsYXllZCBpbiB0aGUgZnV0dXJlIChvYnNlcnZlZCBpbiBDaHJvbWUpCiAgICAgICAgICAgIGNtZDogInJlc2V0IiwgYXJnczogW10sIGhvb2s6IHsKICAgICAgICAgICAgICAgIHRhc2s6IGFzeW5jICh0YXNrKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlzQWxpdmUpCiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiZGVhZCIpOwogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc1BsYXlpbmcpCiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuX3Jlc3VtZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB0YXNrOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHJlc3VsdDogYXN5bmMgKCkgPT4gewogICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuX3N1c3BlbmQoKTsgLy8gY2FuIG5vdyBzdXNwZW5kCiAgICAgICAgICAgICAgICAgICAgdGhpcy5faW5pdGlhbGl6ZWQgPSBmYWxzZTsgLy8gbm93IHdlIGhhdmUgbm90aGluZyB0byBwbGF5IHVudGlsIG5leHQgc2V0U291cmNlCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc291cmNlICE9IG51bGwgJiYgISh0aGlzLnNvdXJjZSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuc291cmNlLmNhbmNlbCgpOwogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5zb3VyY2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgdGhpcy5zZWxmVXJsID0gc2VsZlVybDsKICAgICAgICB0aGlzLmF1ZGlvQ3R4ID0gYXVkaW9DdHg7CiAgICAgICAgdGhpcy5fdW5sb2NrZWQgPSB1bmxvY2tlZDsKICAgICAgICB0aGlzLnRhc2tRdWV1ZSA9IG5ldyBIQ0FUYXNrUXVldWUoIk1haW4tSENBQXVkaW9Xb3JrbGV0SENBUGxheWVyIiwgKG1zZywgdHJhbnMpID0+IGhjYVBsYXllck5vZGUucG9ydC5wb3N0TWVzc2FnZShtc2csIHRyYW5zKSwgKHRhc2spID0+IHRoaXMudGFza0hhbmRsZXIodGFzayksIGFzeW5jICgpID0+IGF3YWl0IHRoaXMuX3Rlcm1pbmF0ZSgpKTsKICAgICAgICBoY2FQbGF5ZXJOb2RlLnBvcnQub25tZXNzYWdlID0gKGV2KSA9PiB0aGlzLnRhc2tRdWV1ZS5tc2dIYW5kbGVyKGV2KTsKICAgICAgICBoY2FQbGF5ZXJOb2RlLnBvcnQub25tZXNzYWdlZXJyb3IgPSAoZXYpID0+IHRoaXMudGFza1F1ZXVlLmVyckhhbmRsZXIoZXYpOwogICAgICAgIGhjYVBsYXllck5vZGUub25wcm9jZXNzb3JlcnJvciA9IChldikgPT4gdGhpcy50YXNrUXVldWUuZXJySGFuZGxlcihldik7CiAgICAgICAgdGhpcy5oY2FQbGF5ZXJOb2RlID0gaGNhUGxheWVyTm9kZTsKICAgICAgICB0aGlzLmdhaW5Ob2RlID0gZ2Fpbk5vZGU7CiAgICAgICAgdGhpcy5mZWVkQmxvY2tDb3VudCA9IGZlZWRCbG9ja0NvdW50OwogICAgICAgIHRoaXMuaW5mbyA9IGluZm87CiAgICAgICAgdGhpcy5zb3VyY2UgPSBzb3VyY2U7CiAgICAgICAgdGhpcy5jaXBoZXIgPSBjaXBoZXI7CiAgICAgICAgdGhpcy5zcmNCdWYgPSBzcmNCdWY7CiAgICAgICAgdGhpcy5zYW1wbGVSYXRlID0gaW5mby5mb3JtYXQuc2FtcGxpbmdSYXRlOwogICAgICAgIHRoaXMuY2hhbm5lbENvdW50ID0gaW5mby5mb3JtYXQuY2hhbm5lbENvdW50OwogICAgICAgIHRoaXMuaGFzTG9vcCA9IGluZm8uaGFzSGVhZGVyWyJsb29wIl0gPyB0cnVlIDogZmFsc2U7CiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndmlzaWJpbGl0eWNoYW5nZScsIHRoaXMudmlzaWJpbGl0eUNoYW5nZUxpc3RlbmVyKTsKICAgIH0KICAgIGdldCBpc0FsaXZlKCkgewogICAgICAgIHJldHVybiB0aGlzLnRhc2tRdWV1ZS5pc0FsaXZlOwogICAgfQogICAgZ2V0IGluaXRpYWxpemVkKCkgewogICAgICAgIHJldHVybiB0aGlzLl9pbml0aWFsaXplZDsKICAgIH0KICAgIGdldCB1bmxvY2tlZCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fdW5sb2NrZWQ7CiAgICB9CiAgICBnZXQgYmxvY2tDaGVja3N1bVZlcmlmaWNhdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy52ZXJpZnlDc3VtOwogICAgfQogICAgc2V0IGJsb2NrQ2hlY2tzdW1WZXJpZmljYXRpb24odmFsKSB7CiAgICAgICAgaWYgKHR5cGVvZiB2YWwgIT09ICJib29sZWFuIikKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgdGhpcy52ZXJpZnlDc3VtID0gdmFsOwogICAgfQogICAgZ2V0IGZlZWRTaXplKCkgewogICAgICAgIHJldHVybiB0aGlzLmluZm8uYmxvY2tTaXplICogdGhpcy5mZWVkQmxvY2tDb3VudDsKICAgIH0KICAgIGdldCByZW1haW5pbmdCbG9ja0NvdW50KCkgewogICAgICAgIGxldCB0b3RhbCA9IHRoaXMuaGFzTG9vcCA/IHRoaXMuaW5mby5sb29wLmVuZCArIDEgOiB0aGlzLmluZm8uZm9ybWF0LmJsb2NrQ291bnQ7CiAgICAgICAgbGV0IHJlbWFpbmluZyA9IHRvdGFsIC0gdGhpcy50b3RhbEZlZEJsb2NrQ291bnQ7CiAgICAgICAgaWYgKHJlbWFpbmluZyA8PSAwKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICByZXR1cm4gcmVtYWluaW5nOwogICAgfQogICAgZ2V0IGRvd25sb2FkQnVmZmVyU2l6ZSgpIHsKICAgICAgICBjb25zdCBieXRlc1BlclNlYyA9IHRoaXMuaW5mby5rYnBzICogMTAwMCAvIDg7CiAgICAgICAgcmV0dXJuIGJ5dGVzUGVyU2VjICogNDsKICAgIH0KICAgIGdldCB2b2x1bWUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2Fpbk5vZGUuZ2Fpbi52YWx1ZTsKICAgIH0KICAgIHNldCB2b2x1bWUodmFsKSB7CiAgICAgICAgaWYgKGlzTmFOKHZhbCkpCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICBpZiAodmFsID4gMS4wKQogICAgICAgICAgICB2YWwgPSAxLjA7CiAgICAgICAgaWYgKHZhbCA8IDApCiAgICAgICAgICAgIHZhbCA9IDA7CiAgICAgICAgdGhpcy5nYWluTm9kZS5nYWluLnZhbHVlID0gdmFsOwogICAgfQogICAgYXN5bmMgdGFza0hhbmRsZXIodGFzaykgewogICAgICAgIHN3aXRjaCAodGFzay5jbWQpIHsKICAgICAgICAgICAgY2FzZSAibm9wIjoKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgY2FzZSAic2VsZi1kZXN0cnVjdCI6IC8vIGRvZXNuJ3Qgc2VlbSB0byBoYXZlIGEgY2hhbmNlIHRvIGJlIGNhbGxlZAogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgSENBRnJhbWVQbGF5ZXIgcmVxdWVzdGVkIHRvIHNlbGYtZGVzdHJ1Y3RgKTsKICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMudGFza1F1ZXVlLnNodXRkb3duKHRydWUpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5zdG9wKCk7CiAgICAgICAgICAgICAgICByZXR1cm47IC8vIGFjdHVhbGx5IG5vdCBzZW5kaW5nIGJhY2sgcmVwbHkKICAgICAgICAgICAgY2FzZSAicHVsbCI6CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zb3VyY2UgPT0gbnVsbCkKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYG5vdGhpbmcgdG8gZmVlZGApOyAvLyBzaG91bGQgbmV2ZXIgaGFwcGVuCiAgICAgICAgICAgICAgICBsZXQgYmxvY2tDb3VudCA9IE1hdGgubWluKHRoaXMuZmVlZEJsb2NrQ291bnQsIHRoaXMucmVtYWluaW5nQmxvY2tDb3VudCk7CiAgICAgICAgICAgICAgICBsZXQgc2l6ZSA9IHRoaXMuaW5mby5ibG9ja1NpemUgKiBibG9ja0NvdW50OwogICAgICAgICAgICAgICAgbGV0IG5ld0Jsb2NrczsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnNvdXJjZSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkpIHsKICAgICAgICAgICAgICAgICAgICAvLyB3aG9sZSBIQ0EgbW9kZQogICAgICAgICAgICAgICAgICAgIGxldCBzdGFydCA9IHRoaXMuaW5mby5kYXRhT2Zmc2V0ICsgdGhpcy5pbmZvLmJsb2NrU2l6ZSAqIHRoaXMudG90YWxGZWRCbG9ja0NvdW50OwogICAgICAgICAgICAgICAgICAgIGxldCBlbmQgPSBzdGFydCArIHNpemU7CiAgICAgICAgICAgICAgICAgICAgbmV3QmxvY2tzID0gdGhpcy5zb3VyY2Uuc3ViYXJyYXkoc3RhcnQsIGVuZCk7CiAgICAgICAgICAgICAgICAgICAgLy99IGVsc2UgaWYgKHRoaXMuc291cmNlIGluc3RhbmNlb2YgUmVhZGFibGVTdHJlYW1EZWZhdWx0UmVhZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gY29tbWVudGVkIG91dCBiZWNhdXNlIEZpcmVmb3ggdGhyb3dzICJSZWZlcmVuY2VFcnJvcjogUmVhZGFibGVTdHJlYW1EZWZhdWx0UmVhZGVyIGlzIG5vdCBkZWZpbmVkIgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVVJMIG1vZGUKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zcmNCdWYgPT0gbnVsbCkKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJzcmNCdWYgaXMgdW5kZWZpbmVkIik7CiAgICAgICAgICAgICAgICAgICAgbGV0IG1heERvd25sYW9kU2l6ZSA9IHRoaXMuaW5mby5ibG9ja1NpemUgKiB0aGlzLnJlbWFpbmluZ0Jsb2NrQ291bnQ7CiAgICAgICAgICAgICAgICAgICAgbGV0IGRvd25sb2FkU2l6ZSA9IE1hdGgubWF4KHRoaXMuZG93bmxvYWRCdWZmZXJTaXplLCBzaXplKTsKICAgICAgICAgICAgICAgICAgICBkb3dubG9hZFNpemUgPSBNYXRoLm1pbihkb3dubG9hZFNpemUsIG1heERvd25sYW9kU2l6ZSk7CiAgICAgICAgICAgICAgICAgICAgbGV0IHJlbWFpbmluZyA9IGRvd25sb2FkU2l6ZSAtIHRoaXMuc3JjQnVmLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICBpZiAocmVtYWluaW5nID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBGSVhNRSBjb25uZWN0aW9uIGxvc3MgaXMgbm90IGhhbmRsZWQvcmVjb3ZlcmVkCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3JjQnVmID0gYXdhaXQgSENBQXVkaW9Xb3JrbGV0SENBUGxheWVyLnJlYWRBbmRBcHBlbmQodGhpcy5zb3VyY2UsIHRoaXMuc3JjQnVmLCByZW1haW5pbmcpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zcmNCdWYubGVuZ3RoIDwgc2l6ZSkKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJzcmNCdWYgc3RpbGwgc21hbGxlciB0aGFuIGV4cGVjdGVkIik7CiAgICAgICAgICAgICAgICAgICAgbmV3QmxvY2tzID0gdGhpcy5zcmNCdWYuc3ViYXJyYXkoMCwgc2l6ZSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zcmNCdWYgPSB0aGlzLnNyY0J1Zi5zbGljZShzaXplKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwLCBzdGFydCA9IDA7IGkgPCBibG9ja0NvdW50OyBpKyssIHN0YXJ0ICs9IHRoaXMuaW5mby5ibG9ja1NpemUpIHsKICAgICAgICAgICAgICAgICAgICBsZXQgYmxvY2sgPSBuZXdCbG9ja3Muc3ViYXJyYXkoc3RhcnQsIHN0YXJ0ICsgdGhpcy5pbmZvLmJsb2NrU2l6ZSk7CiAgICAgICAgICAgICAgICAgICAgLy8gdmVyaWZ5IGNoZWNrc3VtIChpZiBlbmFibGVkKQogICAgICAgICAgICAgICAgICAgIC8vIHdpbGwgdGhyb3cgJiBzdG9wIHBsYXlpbmcgb24gbWlzbWF0Y2ghCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMudmVyaWZ5Q3N1bSkKICAgICAgICAgICAgICAgICAgICAgICAgQ3JjMTYudmVyaWZ5KGJsb2NrLCB0aGlzLmluZm8uYmxvY2tTaXplIC0gMik7CiAgICAgICAgICAgICAgICAgICAgLy8gZGVjcnlwdCAoaWYgZW5jcnlwdGVkKQogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNpcGhlciAhPSBudWxsKQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNpcGhlci5tYXNrKGJsb2NrLCAwLCB0aGlzLmluZm8uYmxvY2tTaXplIC0gMik7CiAgICAgICAgICAgICAgICAgICAgLy8gZml4IGNoZWNrc3VtCiAgICAgICAgICAgICAgICAgICAgQ3JjMTYuZml4KGJsb2NrLCB0aGlzLmluZm8uYmxvY2tTaXplIC0gMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXNMb29wKSB7CiAgICAgICAgICAgICAgICAgICAgLy8ganVzdCBjb3B5LCBubyBuZWVkIHRvIGVubGFyZ2UKICAgICAgICAgICAgICAgICAgICBuZXdCbG9ja3MgPSBuZXdCbG9ja3Muc2xpY2UoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIGVubGFyZ2UgJiBjb3B5CiAgICAgICAgICAgICAgICAgICAgbGV0IGRhdGEgPSBuZXdCbG9ja3M7CiAgICAgICAgICAgICAgICAgICAgbmV3QmxvY2tzID0gbmV3IFVpbnQ4QXJyYXkodGhpcy5mZWVkU2l6ZSk7CiAgICAgICAgICAgICAgICAgICAgbmV3QmxvY2tzLnNldChkYXRhKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMudG90YWxGZWRCbG9ja0NvdW50ICs9IGJsb2NrQ291bnQ7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3QmxvY2tzOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGB1bmtub3duIGNtZCAiJHt0YXNrLmNtZH0iYCk7CiAgICAgICAgfQogICAgfQogICAgc3RhdGljIGFzeW5jIGNyZWF0ZShzZWxmVXJsLCBzb3VyY2UsIGtleTEsIGtleTIsIHN1YmtleSkgewogICAgICAgIGlmICghKHNlbGZVcmwgaW5zdGFuY2VvZiBVUkwpKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICBpZiAoIShzb3VyY2UgaW5zdGFuY2VvZiBVaW50OEFycmF5IHx8IHNvdXJjZSBpbnN0YW5jZW9mIFVSTCkpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgIGxldCBhY3R1YWxTb3VyY2U7CiAgICAgICAgbGV0IGluZm87CiAgICAgICAgbGV0IHNyY0J1ZiA9IHVuZGVmaW5lZDsKICAgICAgICBpZiAoc291cmNlIGluc3RhbmNlb2YgVWludDhBcnJheSkgewogICAgICAgICAgICBhY3R1YWxTb3VyY2UgPSBzb3VyY2Uuc2xpY2UoMCk7CiAgICAgICAgICAgIGluZm8gPSBuZXcgSENBSW5mbyhhY3R1YWxTb3VyY2UpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChzb3VyY2UgaW5zdGFuY2VvZiBVUkwpIHsKICAgICAgICAgICAgY29uc3QgZmV0Y2hlZCA9IGF3YWl0IHRoaXMuZ2V0SENBSW5mb0Zyb21VUkwoc291cmNlKTsKICAgICAgICAgICAgYWN0dWFsU291cmNlID0gZmV0Y2hlZC5yZWFkZXI7CiAgICAgICAgICAgIGluZm8gPSBmZXRjaGVkLmluZm87CiAgICAgICAgICAgIHNyY0J1ZiA9IGZldGNoZWQuYnVmZmVyOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgbGV0IGZlZWRCeXRlTWF4ID0gTWF0aC5mbG9vcih0aGlzLmZlZWRCeXRlTWF4KTsKICAgICAgICBpZiAoZmVlZEJ5dGVNYXggPCBpbmZvLmJsb2NrU2l6ZSkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgZmVlZEJ5dGVNYXggLT0gZmVlZEJ5dGVNYXggJSBpbmZvLmJsb2NrU2l6ZTsKICAgICAgICBjb25zdCBmZWVkQmxvY2tDb3VudCA9IGZlZWRCeXRlTWF4IC8gaW5mby5ibG9ja1NpemU7CiAgICAgICAgLy8gaW5pdGlhbGl6ZSBjaXBoZXIKICAgICAgICBjb25zdCBjaXBoZXIgPSB0aGlzLmdldENpcGhlcihpbmZvLCBrZXkxLCBrZXkyLCBzdWJrZXkpOwogICAgICAgIC8vIGNyZWF0ZSBhdWRpbyBjb250ZXh0CiAgICAgICAgY29uc3QgYXVkaW9DdHggPSBuZXcgQXVkaW9Db250ZXh0KHsKICAgICAgICAgICAgLy9sYXRlbmN5SGludDogInBsYXliYWNrIiwgLy8gRklYTUUgInBsYXliYWNrIiBzZWVtcyB0byBnbGl0Y2ggaWYgc3dpdGNoZWQgdG8gYmFja2dyb3VuZCBpbiBBbmRyb2lkCiAgICAgICAgICAgIHNhbXBsZVJhdGU6IGluZm8uZm9ybWF0LnNhbXBsaW5nUmF0ZSwKICAgICAgICB9KTsKICAgICAgICAvLyBjcmVhdGUgYXVkaW8gd29ya2xldCBub2RlIChub3QgeWV0IGNvbm5lY3RlZCkKICAgICAgICBhd2FpdCBhdWRpb0N0eC5hdWRpb1dvcmtsZXQuYWRkTW9kdWxlKHNlbGZVcmwpOwogICAgICAgIGNvbnN0IG9wdGlvbnMgPSB7CiAgICAgICAgICAgIG51bWJlck9mSW5wdXRzOiAwLAogICAgICAgICAgICBudW1iZXJPZk91dHB1dHM6IDEsCiAgICAgICAgICAgIG91dHB1dENoYW5uZWxDb3VudDogW2luZm8uZm9ybWF0LmNoYW5uZWxDb3VudF0sCiAgICAgICAgICAgIHByb2Nlc3Nvck9wdGlvbnM6IHsKICAgICAgICAgICAgICAgIHJhd0hlYWRlcjogaW5mby5nZXRSYXdIZWFkZXIoKSwKICAgICAgICAgICAgICAgIHB1bGxCbG9ja0NvdW50OiBmZWVkQmxvY2tDb3VudCwKICAgICAgICAgICAgfSwKICAgICAgICB9OwogICAgICAgIGNvbnN0IGhjYVBsYXllck5vZGUgPSBuZXcgQXVkaW9Xb3JrbGV0Tm9kZShhdWRpb0N0eCwgImhjYS1mcmFtZS1wbGF5ZXIiLCBvcHRpb25zKTsKICAgICAgICAvLyBjcmVhdGUgZ2FpbiBub2RlCiAgICAgICAgY29uc3QgZ2Fpbk5vZGUgPSBhdWRpb0N0eC5jcmVhdGVHYWluKCk7CiAgICAgICAgY29uc3QgdW5sb2NrZWQgPSBhd2FpdCBzdXNwZW5kQXVkaW9DdHhJZlVubG9ja2VkKGF1ZGlvQ3R4KTsKICAgICAgICAvLyBjcmVhdGUgY29udHJvbGxlciBvYmplY3QKICAgICAgICByZXR1cm4gbmV3IEhDQUF1ZGlvV29ya2xldEhDQVBsYXllcihzZWxmVXJsLCBhdWRpb0N0eCwgdW5sb2NrZWQsIGhjYVBsYXllck5vZGUsIGdhaW5Ob2RlLCBmZWVkQmxvY2tDb3VudCwgaW5mbywgYWN0dWFsU291cmNlLCBzcmNCdWYsIGNpcGhlcik7CiAgICB9CiAgICBhc3luYyBfdGVybWluYXRlKCkgewogICAgICAgIC8vIEkgZGlkbid0IGZpbmQgdGVybWluYXRlKCkgZm9yIEF1ZGlvV29ya2xldCBzbyBJIG1hZGUgb25lCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdGhpcy5oY2FQbGF5ZXJOb2RlLnBvcnQuY2xvc2UoKTsKICAgICAgICB9CiAgICAgICAgY2F0Y2ggKGUpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgZXJyb3IgdHJ5aW5nIHRvIGNsb3NlIG1lc3NhZ2UgcG9ydGAsIGUpOwogICAgICAgIH0KICAgICAgICB0cnkgewogICAgICAgICAgICB0aGlzLmhjYVBsYXllck5vZGUuZGlzY29ubmVjdCgpOwogICAgICAgIH0KICAgICAgICBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBlcnJvciB0cnlpbmcgdG8gZGlzY29ubmVjdCBoY2FQbGF5ZXJOb2RlYCwgZSk7CiAgICAgICAgfQogICAgICAgIHRyeSB7CiAgICAgICAgICAgIHRoaXMuZ2Fpbk5vZGUuZGlzY29ubmVjdCgpOwogICAgICAgIH0KICAgICAgICBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBlcnJvciB0cnlpbmcgdG8gZGlzY29ubmVjdCBnYWluTm9kZWAsIGUpOwogICAgICAgIH0KICAgICAgICB0cnkgewogICAgICAgICAgICBhd2FpdCB0aGlzLmF1ZGlvQ3R4LmNsb3NlKCk7CiAgICAgICAgfQogICAgICAgIGNhdGNoIChlKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYGVycm9yIHRyeWluZyB0byBjbG9zZSBhdWRpbyBjb250ZXh0YCwgZSk7CiAgICAgICAgfQogICAgfQogICAgc3RhdGljIGdldENpcGhlcihpbmZvLCBrZXkxLCBrZXkyLCBzdWJrZXkpIHsKICAgICAgICAvLyBoYW5kbGUgc3Via2V5CiAgICAgICAgbGV0IG1peGVkID0gSENBQ2lwaGVyLm1peFdpdGhTdWJrZXkoa2V5MSwga2V5Miwgc3Via2V5KTsKICAgICAgICBrZXkxID0gbWl4ZWQua2V5MTsKICAgICAgICBrZXkyID0gbWl4ZWQua2V5MjsKICAgICAgICBzd2l0Y2ggKGluZm8uY2lwaGVyKSB7CiAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIC8vIG5vdCBlbmNyeXB0ZWQKICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgICAgIC8vIGVuY3J5cHRlZCB3aXRoICJubyBrZXkiCiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IEhDQUNpcGhlcigibm9uZSIpOyAvLyBpZ25vcmUgZ2l2ZW4ga2V5cwogICAgICAgICAgICBjYXNlIDB4Mzg6CiAgICAgICAgICAgICAgICAvLyBlbmNyeXB0ZWQgd2l0aCBrZXlzIC0gd2lsbCB5aWVsZCBpbmNvcnJlY3Qgd2F2ZWZvcm0gaWYgaW5jb3JyZWN0IGtleXMgYXJlIGdpdmVuIQogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBIQ0FDaXBoZXIoa2V5MSwga2V5Mik7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInVua25vd24gY2lwaC50eXBlIik7CiAgICAgICAgfQogICAgfQogICAgc3RhdGljIGFzeW5jIHJlYWRBbmRBcHBlbmQocmVhZGVyLCBkYXRhLCBtaW5Db3VudCkgewogICAgICAgIGlmIChtaW5Db3VudCA8IDApCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgIGNvbnN0IGRlc2lyZWQgPSBkYXRhLmxlbmd0aCArIG1pbkNvdW50OwogICAgICAgIGxldCBuZXdEYXRhID0gbmV3IFVpbnQ4QXJyYXkoZGVzaXJlZCk7CiAgICAgICAgbmV3RGF0YS5zZXQoZGF0YSk7CiAgICAgICAgZm9yIChsZXQgb2Zmc2V0ID0gZGF0YS5sZW5ndGg7IG9mZnNldCA8IGRlc2lyZWQ7KSB7CiAgICAgICAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IHJlYWRlci5yZWFkKCk7CiAgICAgICAgICAgIGlmIChyZXMuZG9uZSkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgdW5leHBlY3RlZCBzdHJlYW0gZW5kLiBgCiAgICAgICAgICAgICAgICAgICAgKyBgaXQgaXMgcG9zc2libGUgdGhhdCB0aGUgZG93bmxvYWQgaGFzIGJlZW4gY2FuY2VsZWQgKGJ5IGxhdGVyIHNldFNvdXJjZSksIG9yIHRoZSBmaWxlIGRhdGEgaXMgaW5jb21wbGV0ZWApOwogICAgICAgICAgICBjb25zdCBieXRlcyA9IHJlcy52YWx1ZTsKICAgICAgICAgICAgaWYgKGJ5dGVzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IHJlcXVpcmVkID0gb2Zmc2V0ICsgYnl0ZXMubGVuZ3RoOwogICAgICAgICAgICAgICAgaWYgKHJlcXVpcmVkID4gbmV3RGF0YS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBleGlzdGluZyA9IG5ld0RhdGE7CiAgICAgICAgICAgICAgICAgICAgbmV3RGF0YSA9IG5ldyBVaW50OEFycmF5KHJlcXVpcmVkKTsKICAgICAgICAgICAgICAgICAgICBuZXdEYXRhLnNldChleGlzdGluZyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBuZXdEYXRhLnNldChieXRlcywgb2Zmc2V0KTsKICAgICAgICAgICAgICAgIG9mZnNldCArPSBieXRlcy5sZW5ndGg7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ld0RhdGE7CiAgICB9CiAgICBzdGF0aWMgYXN5bmMgZ2V0SENBSW5mb0Zyb21VUkwodXJsKSB7CiAgICAgICAgLy8gRklYTUUgc2VuZCBIVFRQIFJhbmdlIHJlcXVlc3QgdG8gYXZvaWQgYmxvY2tpbmcgbGF0ZXIgcmVxdWVzdHMgKGVzcGVjaWFsbHkgaW4gRmlyZWZveCkKICAgICAgICBjb25zdCByZXNwID0gYXdhaXQgZmV0Y2godXJsLmhyZWYpOwogICAgICAgIGlmIChyZXNwLnN0YXR1cyAhPSAyMDApCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgc3RhdHVzICR7cmVzcC5zdGF0dXN9YCk7CiAgICAgICAgaWYgKHJlc3AuYm9keSA9PSBudWxsKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInJlc3BvbnNlIGhhcyBubyBib2R5Iik7CiAgICAgICAgY29uc3QgcmVhZGVyID0gcmVzcC5ib2R5LmdldFJlYWRlcigpOwogICAgICAgIGxldCBidWZmZXIgPSBhd2FpdCB0aGlzLnJlYWRBbmRBcHBlbmQocmVhZGVyLCBuZXcgVWludDhBcnJheSgwKSwgOCk7CiAgICAgICAgY29uc3QgZGF0YU9mZnNldCA9IG5ldyBEYXRhVmlldyhidWZmZXIuYnVmZmVyLCBidWZmZXIuYnl0ZU9mZnNldCwgYnVmZmVyLmJ5dGVMZW5ndGgpLmdldFVpbnQxNig2KTsKICAgICAgICBjb25zdCByZW1haW5pbmcgPSBkYXRhT2Zmc2V0IC0gYnVmZmVyLmxlbmd0aDsKICAgICAgICBpZiAocmVtYWluaW5nID4gMCkgewogICAgICAgICAgICBidWZmZXIgPSBhd2FpdCB0aGlzLnJlYWRBbmRBcHBlbmQocmVhZGVyLCBidWZmZXIsIHJlbWFpbmluZyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHJlYWRlcjogcmVhZGVyLAogICAgICAgICAgICBpbmZvOiBuZXcgSENBSW5mbyhidWZmZXIpLAogICAgICAgICAgICBidWZmZXI6IGJ1ZmZlci5zbGljZShkYXRhT2Zmc2V0KSwKICAgICAgICB9OwogICAgfQogICAgYXN5bmMgc2V0U291cmNlKHNvdXJjZSwga2V5MSwga2V5Miwgc3Via2V5KSB7CiAgICAgICAgbGV0IG5ld0luZm87CiAgICAgICAgbGV0IG5ld1NvdXJjZTsKICAgICAgICBsZXQgbmV3QnVmZmVyID0gdW5kZWZpbmVkOwogICAgICAgIGNvbnN0IGluaXRpYWxpemVDbWRJdGVtID0gewogICAgICAgICAgICBjbWQ6ICJpbml0aWFsaXplIiwgYXJnczogW251bGxdLCBob29rOiB7CiAgICAgICAgICAgICAgICB0YXNrOiBhc3luYyAodGFzaykgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc0FsaXZlKQogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImRlYWQiKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBvbGRTb3VyY2UgPSB0aGlzLnNvdXJjZTsKICAgICAgICAgICAgICAgICAgICAvL2lmIChvbGRTb3VyY2UgaW5zdGFuY2VvZiBSZWFkYWJsZVN0cmVhbURlZmF1bHRSZWFkZXIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAob2xkU291cmNlICE9IG51bGwgJiYgIShvbGRTb3VyY2UgaW5zdGFuY2VvZiBVaW50OEFycmF5KSkgewogICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgb2xkU291cmNlLmNhbmNlbCgpOyAvLyBzdG9wIGRvd25sb2FkaW5nIGZyb20gcHJldmlvdXMgVVJMCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBGSVhNRSBGaXJlZm94IGRvZXNuJ3Qgc2VlbSB0byBhYm9ydCBwcmV2aW91cyBkb3dubG9hZAogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBlcnJvciB3aGVuIGNhbmNlbGxpbmcgcHJldmlvdXMgZG93bmxvYWQuYCwgZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHNvdXJjZSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbmV3U291cmNlID0gc291cmNlLnNsaWNlKDApOwogICAgICAgICAgICAgICAgICAgICAgICBuZXdJbmZvID0gbmV3IEhDQUluZm8obmV3U291cmNlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoc291cmNlIGluc3RhbmNlb2YgVVJMKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IEhDQUF1ZGlvV29ya2xldEhDQVBsYXllci5nZXRIQ0FJbmZvRnJvbVVSTChzb3VyY2UpOwogICAgICAgICAgICAgICAgICAgICAgICBuZXdTb3VyY2UgPSByZXN1bHQucmVhZGVyOwogICAgICAgICAgICAgICAgICAgICAgICBuZXdJbmZvID0gcmVzdWx0LmluZm87CiAgICAgICAgICAgICAgICAgICAgICAgIG5ld0J1ZmZlciA9IHJlc3VsdC5idWZmZXI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJpbnZhbGlkIHNvdXJjZSIpOwogICAgICAgICAgICAgICAgICAgIC8vIHNhbXBsZSByYXRlIGFuZCBjaGFubmVsIGNvdW50IGlzIGltbXV0YWJsZSwKICAgICAgICAgICAgICAgICAgICAvLyB0aGVyZWZvcmUsIHRoZSBvbmx5IHdheSB0byBjaGFuZ2UgdGhlbSBpcyB0byByZWNyZWF0ZSBhIG5ldyBpbnN0YW5jZS4KICAgICAgICAgICAgICAgICAgICAvLyBob3dldmVyLCB0aGVyZSBpcyBhIG1lbWxlYWsgYnVnIGluIENocm9taXVtLCB0aGF0OgogICAgICAgICAgICAgICAgICAgIC8vIChuby1sb25nZXItdXNlZCkgYXVkaW8gd29ya2xldCBub2RlKHMpIHdvbid0IGJlIHJlY3ljbGVkOgogICAgICAgICAgICAgICAgICAgIC8vIGh0dHBzOi8vYnVncy5jaHJvbWl1bS5vcmcvcC9jaHJvbWl1bS9pc3N1ZXMvZGV0YWlsP2lkPTEyOTg5NTUKICAgICAgICAgICAgICAgICAgICBpZiAobmV3SW5mby5mb3JtYXQuc2FtcGxpbmdSYXRlICE9IHRoaXMuc2FtcGxlUmF0ZSkKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJzYW1wbGUgcmF0ZSBtaXNtYXRjaCIpOwogICAgICAgICAgICAgICAgICAgIGlmIChuZXdJbmZvLmZvcm1hdC5jaGFubmVsQ291bnQgIT0gdGhpcy5jaGFubmVsQ291bnQpCiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiY2hhbm5lbCBjb3VudCBtaXNtYXRjaCIpOwogICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuX3Jlc3VtZSgpOyAvLyByZXN1bWUgaXQsIHNvIHRoYXQgY21kIGNhbiB0aGVuIGJlIGV4ZWN1dGVkCiAgICAgICAgICAgICAgICAgICAgY29uc3QgbmV3UHJvY09wdHMgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJhd0hlYWRlcjogbmV3SW5mby5nZXRSYXdIZWFkZXIoKSwKICAgICAgICAgICAgICAgICAgICAgICAgcHVsbEJsb2NrQ291bnQ6IHRoaXMuZmVlZEJsb2NrQ291bnQsCiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IEhDQVRhc2sodGFzay5vcmlnaW4sIHRhc2sudGFza0lELCB0YXNrLmNtZCwgW25ld1Byb2NPcHRzXSwgZmFsc2UpOwogICAgICAgICAgICAgICAgfSwgcmVzdWx0OiBhc3luYyAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5fc3VzcGVuZCgpOyAvLyBpbml0aWFsaXplZCwgYnV0IGl0J3MgcGF1c2VkLCB1bnRpbCBiZWluZyByZXF1ZXN0ZWQgdG8gc3RhcnQvcGxheSAocmVzdW1lKQogICAgICAgICAgICAgICAgICAgIHRoaXMudG90YWxGZWRCbG9ja0NvdW50ID0gMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNpcGhlciA9IEhDQUF1ZGlvV29ya2xldEhDQVBsYXllci5nZXRDaXBoZXIobmV3SW5mbywga2V5MSwga2V5Miwgc3Via2V5KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmluZm8gPSBuZXdJbmZvOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc291cmNlID0gbmV3U291cmNlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc3JjQnVmID0gbmV3QnVmZmVyOwogICAgICAgICAgICAgICAgICAgIHRoaXMuaGFzTG9vcCA9IG5ld0luZm8uaGFzSGVhZGVyWyJsb29wIl0gPyB0cnVlIDogZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faW5pdGlhbGl6ZWQgPSB0cnVlOyAvLyBhZ2FpbiB3ZSBub3cgaGF2ZSBzb21ldGhpbmcgdG8gcGxheQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBhd2FpdCB0aGlzLnRhc2tRdWV1ZS5leGVjTXVsdGlDbWQoW3RoaXMuc3RvcENtZEl0ZW0sIGluaXRpYWxpemVDbWRJdGVtXSk7IC8vIGVuc3VyZSBhdG9taWNpdHkKICAgIH0KICAgIC8vIG5vdCBzdXBwb3NlZCB0byBiZSB1c2VkIGRpcmVjdGx5CiAgICBhc3luYyBfcmVzdW1lKCkgewogICAgICAgIGlmICghdGhpcy5pc0FsaXZlKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImRlYWQiKTsKICAgICAgICBpZiAodGhpcy5pc1BsYXlpbmcpCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICBhd2FpdCB0aGlzLmF1ZGlvQ3R4LnJlc3VtZSgpOwogICAgICAgIHRoaXMuaGNhUGxheWVyTm9kZS5jb25uZWN0KHRoaXMuZ2Fpbk5vZGUpOwogICAgICAgIHRoaXMuZ2Fpbk5vZGUuY29ubmVjdCh0aGlzLmF1ZGlvQ3R4LmRlc3RpbmF0aW9uKTsKICAgICAgICB0aGlzLmlzUGxheWluZyA9IHRydWU7CiAgICAgICAgLy8gbWFyayBhcyB1bmxvY2tlZAogICAgICAgIGlmICghdGhpcy5fdW5sb2NrZWQpIHsKICAgICAgICAgICAgdGhpcy5fdW5sb2NrZWQgPSB0cnVlOwogICAgICAgICAgICBjb25zb2xlLndhcm4oYGF1ZGlvIGNvbnRleHQgZm9yIHNhbXBsZVJhdGU9JHt0aGlzLmF1ZGlvQ3R4LnNhbXBsZVJhdGV9IGlzIG5vdyByZXN1bWVkL3VubG9ja2VkYCk7CiAgICAgICAgfQogICAgfQogICAgYXN5bmMgX3N1c3BlbmQoKSB7CiAgICAgICAgaWYgKCF0aGlzLmlzQWxpdmUpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiZGVhZCIpOwogICAgICAgIGlmICghdGhpcy5pc1BsYXlpbmcpCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB0aGlzLmhjYVBsYXllck5vZGUuZGlzY29ubmVjdCgpOwogICAgICAgIHRoaXMuZ2Fpbk5vZGUuZGlzY29ubmVjdCgpOwogICAgICAgIGF3YWl0IHRoaXMuYXVkaW9DdHguc3VzcGVuZCgpOwogICAgICAgIHRoaXMuaXNQbGF5aW5nID0gZmFsc2U7CiAgICB9CiAgICBhc3luYyBfcGF1c2UoKSB7CiAgICAgICAgYXdhaXQgdGhpcy5zZXRQbGF5aW5nKGZhbHNlKTsKICAgIH0KICAgIGFzeW5jIF9wbGF5KCkgewogICAgICAgIC8vIGluIGFwcGxlIHdlYmtpdCwgYXVkaW8gY29udGV4dCBpcyBzdXNwZW5kZWQvbG9ja2VkIGluaXRpYWxseSwKICAgICAgICAvLyAob3RoZXIgYnJvd3NlcnMgbGlrZSBGaXJlZm94IG1heSBoYXZlIHNpbWlsYXIgYnV0IGxlc3Mgc3RyaWN0IHJlc3RyaWN0aW9ucykKICAgICAgICAvLyB0byByZXN1bWUvdW5sb2NrIGl0LCBmaXJzdCByZXN1bWUoKSBjYWxsIG11c3QgYmUgdHJpZ2dlcmVkIGJ5IGZyb20gVUkgZXZlbnQsCiAgICAgICAgLy8gd2hpY2ggbXVzdCBub3QgYmUgYWZ0ZXIgYXdhaXQKICAgICAgICBhd2FpdCB0aGlzLnNldFBsYXlpbmcodHJ1ZSk7CiAgICB9CiAgICAvLyB3cmFwZWQgdG8gZW5zdXJlIGF0b21pY2l0eQogICAgYXN5bmMgc2V0UGxheWluZyh0b1BsYXkpIHsKICAgICAgICAvLyBzaW1saWxhciB0byBzdG9wQ21kSXRlbSBhYm92ZSwgc2VuZCAicGF1c2UiIGNtZCB0byBhdm9pZCAicmVzaWR1ZSIgYnVyc3Qgbm9pc2UKICAgICAgICBhd2FpdCB0aGlzLnRhc2tRdWV1ZS5leGVjQ21kKHRvUGxheSA/ICJyZXN1bWUiIDogInBhdXNlIiwgW10sIHsKICAgICAgICAgICAgdGFzazogYXN5bmMgKHRhc2spID0+IHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc0FsaXZlKQogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiZGVhZCIpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNQbGF5aW5nKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRvUGxheSkKICAgICAgICAgICAgICAgICAgICAgICAgdGFzay5pc0R1bW15ID0gdHJ1ZTsgLy8gYWxyZWFkeSByZXN1bWVkLCBub3Qgc2VuZGluZyBjbWQKICAgICAgICAgICAgICAgICAgICAvLyBlbHNlIHNob3VsZCBzdGlsbCBrZWVwIHBsYXlpbmcgdW50aWwgInBhdXNlIiBjbWQgcmV0dXJucwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRvUGxheSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX2luaXRpYWxpemVkKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBub3QgaW5pdGlhbGl6ZWQgYnV0IHN0aWxsIGF0dGVtcHQgdG8gcmVzdW1lYCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuX3Jlc3VtZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIHRhc2suaXNEdW1teSA9IHRydWU7IC8vIGFscmVhZHkgcGF1c2VkLCBub3Qgc2VuZGluZyBjbWQKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0YXNrOwogICAgICAgICAgICB9LAogICAgICAgICAgICByZXN1bHQ6IGFzeW5jICgpID0+IHsKICAgICAgICAgICAgICAgIGlmICh0b1BsYXkpCiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5fcmVzdW1lKCk7CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5fc3VzcGVuZCgpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9CiAgICBhc3luYyBwYXVzZSgpIHsKICAgICAgICB0aGlzLnJlcXVlc3RlZFRvUGxheSA9IGZhbHNlOwogICAgICAgIGF3YWl0IHRoaXMuX3BhdXNlKCk7CiAgICB9CiAgICBhc3luYyBwbGF5KCkgewogICAgICAgIHRoaXMucmVxdWVzdGVkVG9QbGF5ID0gdHJ1ZTsKICAgICAgICBhd2FpdCB0aGlzLl9wbGF5KCk7CiAgICB9CiAgICBhc3luYyBzdG9wKCkgewogICAgICAgIC8vIGNhbiB1bmxvY2sgdGhlIGxvY2tlZCBhdWRpbyBjb250ZXh0IGFzIHdlbGwgYmVjYXVzZSBpdCdzIHJlc3VtZWQgZmlyc3RseSBiZWZvcmUgZmluYWxseSBzdXNwZW5kZWQKICAgICAgICB0aGlzLnJlcXVlc3RlZFRvUGxheSA9IGZhbHNlOwogICAgICAgIGNvbnN0IGl0ZW0gPSB0aGlzLnN0b3BDbWRJdGVtOwogICAgICAgIGF3YWl0IHRoaXMudGFza1F1ZXVlLmV4ZWNDbWQoaXRlbS5jbWQsIGl0ZW0uYXJncywgaXRlbS5ob29rKTsKICAgIH0KICAgIGFzeW5jIHNodXRkb3duKGZvcmNpYmx5ID0gZmFsc2UpIHsKICAgICAgICBpZiAoIXRoaXMuaXNBbGl2ZSkgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBhbHJlYWR5IHNodXRkb3duYCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigndmlzaWJpbGl0eWNoYW5nZScsIHRoaXMudmlzaWJpbGl0eUNoYW5nZUxpc3RlbmVyKTsKICAgICAgICB9CiAgICAgICAgY2F0Y2ggKGUpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihlKTsKICAgICAgICB9CiAgICAgICAgYXdhaXQgdGhpcy50YXNrUXVldWUuc2h1dGRvd24oZm9yY2libHkpOwogICAgfQp9CkhDQUF1ZGlvV29ya2xldEhDQVBsYXllci5mZWVkQnl0ZU1heCA9IDMyNzY4OwovLyBjcmVhdGUgJiBjb250cm9sIHdvcmtlcgpjbGFzcyBIQ0FXb3JrZXIgewogICAgY29uc3RydWN0b3Ioc2VsZlVybCwgc2VsZkJsb2IpIHsKICAgICAgICB0aGlzLmxhc3RUaWNrID0gMDsKICAgICAgICB0aGlzLmhjYVdvcmtlciA9IG5ldyBXb3JrZXIoc2VsZlVybCwgeyB0eXBlOiAibW9kdWxlIiB9KTsgLy8gc2V0dGluZyB0eXBlIHRvICJtb2R1bGUiIGlzIGN1cnJlbnRseSBib2d1cyBpbiBGaXJlZm94CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdGhpcy5oY2FXb3JrZXIgPSBuZXcgV29ya2VyKHNlbGZVcmwsIHsgdHlwZTogIm1vZHVsZSIgfSk7IC8vIHNldHRpbmcgdHlwZSB0byAibW9kdWxlIiBpcyBjdXJyZW50bHkgYm9ndXMgaW4gRmlyZWZveAogICAgICAgIH0KICAgICAgICBjYXRjaCAoZSkgewogICAgICAgICAgICAvLyB3b3JrYXJvdW5kIGZvciBsZWdhY3kgaU9TIFNhZmFyaQogICAgICAgICAgICBpZiAoc2VsZkJsb2IgPT0gbnVsbCB8fCAhKHNlbGZCbG9iIGluc3RhbmNlb2YgQmxvYikpCiAgICAgICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgICBjb25zdCBvYmpVcmwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKHNlbGZCbG9iKTsKICAgICAgICAgICAgdGhpcy5oY2FXb3JrZXIgPSBuZXcgV29ya2VyKG9ialVybCwgeyB0eXBlOiAibW9kdWxlIiB9KTsKICAgICAgICAgICAgVVJMLnJldm9rZU9iamVjdFVSTChvYmpVcmwpOwogICAgICAgIH0KICAgICAgICB0aGlzLnNlbGZVcmwgPSBzZWxmVXJsOwogICAgICAgIHRoaXMudGFza1F1ZXVlID0gbmV3IEhDQVRhc2tRdWV1ZSgiTWFpbi1IQ0FXb3JrZXIiLCAobXNnLCB0cmFucykgPT4gdGhpcy5oY2FXb3JrZXIucG9zdE1lc3NhZ2UobXNnLCB0cmFucyksIGFzeW5jICh0YXNrKSA9PiB7CiAgICAgICAgICAgIHN3aXRjaCAodGFzay5jbWQpIHsKICAgICAgICAgICAgICAgIGNhc2UgInNlbGYtZGVzdHJ1Y3QiOiAvLyBkb2Vzbid0IHNlZW0gdG8gaGF2ZSBhIGNoYW5jZSB0byBiZSBjYWxsZWQKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBoY2FXb3JrZXIgcmVxdWVzdGVkIHRvIHNlbGYtZGVzdHJ1Y3RgKTsKICAgICAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLnRhc2tRdWV1ZS5zaHV0ZG93bih0cnVlKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0sICgpID0+IHRoaXMuaGNhV29ya2VyLnRlcm1pbmF0ZSgpKTsKICAgICAgICB0aGlzLmhjYVdvcmtlci5vbm1lc3NhZ2UgPSAobXNnKSA9PiB0aGlzLnRhc2tRdWV1ZS5tc2dIYW5kbGVyKG1zZyk7CiAgICAgICAgdGhpcy5oY2FXb3JrZXIub25lcnJvciA9IChtc2cpID0+IHRoaXMudGFza1F1ZXVlLmVyckhhbmRsZXIobXNnKTsKICAgICAgICB0aGlzLmhjYVdvcmtlci5vbm1lc3NhZ2VlcnJvciA9IChtc2cpID0+IHRoaXMudGFza1F1ZXVlLmVyckhhbmRsZXIobXNnKTsKICAgIH0KICAgIGdldCBpc0FsaXZlKCkgewogICAgICAgIHJldHVybiB0aGlzLnRhc2tRdWV1ZS5pc0FsaXZlOwogICAgfQogICAgYXN5bmMgc2h1dGRvd24oZm9yY2libHkgPSBmYWxzZSkgewogICAgICAgIGlmICh0aGlzLnRhc2tRdWV1ZS5pc0FsaXZlKQogICAgICAgICAgICBhd2FpdCB0aGlzLnRhc2tRdWV1ZS5zaHV0ZG93bihmb3JjaWJseSk7CiAgICAgICAgaWYgKHRoaXMuYXdIY2FQbGF5ZXIgIT0gbnVsbCAmJiB0aGlzLmF3SGNhUGxheWVyLmlzQWxpdmUpCiAgICAgICAgICAgIGF3YWl0IHRoaXMuYXdIY2FQbGF5ZXIuc2h1dGRvd24oZm9yY2libHkpOwogICAgfQogICAgYXN5bmMgdGljaygpIHsKICAgICAgICBhd2FpdCB0aGlzLnRhc2tRdWV1ZS5leGVjQ21kKCJub3AiLCBbXSk7CiAgICAgICAgdGhpcy5sYXN0VGljayA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgfQogICAgYXN5bmMgdG9jayh0ZXh0ID0gIiIpIHsKICAgICAgICBhd2FpdCB0aGlzLnRhc2tRdWV1ZS5leGVjQ21kKCJub3AiLCBbXSk7CiAgICAgICAgY29uc3QgZHVyYXRpb24gPSBuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHRoaXMubGFzdFRpY2s7CiAgICAgICAgY29uc29sZS5sb2coYCR7dGV4dH0gdG9vayAke2R1cmF0aW9ufSBtc2ApOwogICAgICAgIHJldHVybiBkdXJhdGlvbjsKICAgIH0KICAgIHN0YXRpYyBhc3luYyBjcmVhdGUoc2VsZlVybCkgewogICAgICAgIGlmICh0eXBlb2Ygc2VsZlVybCA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgc2VsZlVybCA9IG5ldyBVUkwoc2VsZlVybCwgZG9jdW1lbnQuYmFzZVVSSSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKCEoc2VsZlVybCBpbnN0YW5jZW9mIFVSTCkpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJzZWxmVXJsIG11c3QgYmUgZWl0aGVyIHN0cmluZyBvciBVUkwiKTsKICAgICAgICB9CiAgICAgICAgLy8gZmV0Y2ggJiBzYXZlIGhjYS5qcyBhcyBibG9iIGluIGFkdmFuY2UsIHRvIGF2b2lkIGNyZWF0aW5nIHdvcmtlciBiZWluZyBibG9ja2VkIGxhdGVyLCBsaWtlOgogICAgICAgIC8vIChJIG9ic2VydmVkIHRoaXMgcHJvYmxlbSBpbiBGaXJlZm94KQogICAgICAgIC8vIGNyZWF0aW5nIEhDQUF1ZGlvV29ya2xldEhDQVBsYXllciByZXF1aXJlcyBpbmZvcm1hdGlvbiBmcm9tIEhDQSwgd2hpY2ggaXMgc2FtcGxlIHJhdGUgYW5kIGNoYW5uZWwgY291bnQ7CiAgICAgICAgLy8gaG93ZXZlciwgZmV0Y2hpbmcgSENBIChvcmlnaW5hbGx5IHN1cHBvc2VkIHRvIGJlIHByb2dyZXNzaXZlL3N0cmVhbWVkKSBibG9ja3MgbGF0ZXIgcmVxdWVzdCB0byBmZXRjaCBoY2EuanMsCiAgICAgICAgLy8gc28gdGhhdCBIQ0FBdWRpb1dvcmtsZXRIQ0FQbGF5ZXIgY2FuIG9ubHkgYmUgY3JlYXRlZCBhZnRlciBmaW5pc2hpbmcgZG93bmxvYWRpbmcgdGhlIHdob2xlIEhDQSwKICAgICAgICAvLyB3aGljaCBvYnZpb3VzbHkgZGVmZWF0cyB0aGUgcHVycG9zZSBvZiBzdHJlYW1pbmcgSENBCiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaChzZWxmVXJsLmhyZWYpOwogICAgICAgIC8vIEZpcmVmb3ggY3VycmVudGx5IGRvZXMgbm90IHN1cHBvcnQgRUNNQVNjcmlwdCBtb2R1bGVzIGluIFdvcmtlciwKICAgICAgICAvLyB0aGVyZWZvcmUgd2UgbXVzdCBzdHJpcCBhbGwgZXhwb3J0IGRlY2xhcmF0aW9ucwogICAgICAgIGNvbnN0IG9yaWdUZXh0ID0gYXdhaXQgcmVzcG9uc2UudGV4dCgpOwogICAgICAgIGNvbnN0IGNvbnZlcnRlZFRleHQgPSAoIlxuIiArIG9yaWdUZXh0KS5yZXBsYWNlKC9cYmV4cG9ydFxzK3suKj99Oz8vLCAiIikuc2xpY2UoMSk7CiAgICAgICAgY29uc3QgYmxvYiA9IG5ldyBCbG9iKFtjb252ZXJ0ZWRUZXh0XSwgeyB0eXBlOiAidGV4dC9qYXZhc2NyaXB0IiB9KTsKICAgICAgICBjb25zdCByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpOwogICAgICAgIHJlYWRlci5yZWFkQXNEYXRhVVJMKGJsb2IpOwogICAgICAgIGNvbnN0IGRhdGFVUkkgPSBhd2FpdCBuZXcgUHJvbWlzZSgocmVzKSA9PiB7CiAgICAgICAgICAgIHJlYWRlci5vbmxvYWRlbmQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXMocmVhZGVyLnJlc3VsdCk7CiAgICAgICAgICAgIH07CiAgICAgICAgfSk7CiAgICAgICAgc2VsZlVybCA9IG5ldyBVUkwoZGF0YVVSSSwgZG9jdW1lbnQuYmFzZVVSSSk7CiAgICAgICAgcmV0dXJuIG5ldyBIQ0FXb3JrZXIoc2VsZlVybCk7CiAgICB9CiAgICAvLyBjb21tYW5kcwogICAgYXN5bmMgZ2V0VHJhbnNmZXJDb25maWcoKSB7CiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMudGFza1F1ZXVlLmdldFRyYW5zZmVyQ29uZmlnKCk7CiAgICB9CiAgICBhc3luYyBjb25maWdUcmFuc2Zlcih0cmFuc2ZlckFyZ3MsIHJlcGx5QXJncykgewogICAgICAgIHJldHVybiBhd2FpdCB0aGlzLnRhc2tRdWV1ZS5jb25maWdUcmFuc2Zlcih0cmFuc2ZlckFyZ3MsIHJlcGx5QXJncyk7CiAgICB9CiAgICBhc3luYyBmaXhIZWFkZXJDaGVja3N1bShoY2EpIHsKICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy50YXNrUXVldWUuZXhlY0NtZCgiZml4SGVhZGVyQ2hlY2tzdW0iLCBbaGNhXSk7CiAgICB9CiAgICBhc3luYyBmaXhDaGVja3N1bShoY2EpIHsKICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy50YXNrUXVldWUuZXhlY0NtZCgiZml4Q2hlY2tzdW0iLCBbaGNhXSk7CiAgICB9CiAgICBhc3luYyBmaW5kS2V5KGhjYSwgZ2l2ZW5LZXlMaXN0LCBzdWJrZXksIHRocmVzaG9sZCA9IDAuNSwgZGVwdGggPSAxMDI0KSB7CiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMudGFza1F1ZXVlLmV4ZWNDbWQoImZpbmRLZXkiLCBbaGNhLCBnaXZlbktleUxpc3QsIHN1YmtleSwgdGhyZXNob2xkLCBkZXB0aF0pOwogICAgfQogICAgYXN5bmMgZGVjcnlwdChoY2EsIGtleTEsIGtleTIsIHN1YmtleSkgewogICAgICAgIHJldHVybiBhd2FpdCB0aGlzLnRhc2tRdWV1ZS5leGVjQ21kKCJkZWNyeXB0IiwgW2hjYSwga2V5MSwga2V5Miwgc3Via2V5XSk7CiAgICB9CiAgICBhc3luYyBlbmNyeXB0KGhjYSwga2V5MSwga2V5Miwgc3Via2V5KSB7CiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMudGFza1F1ZXVlLmV4ZWNDbWQoImVuY3J5cHQiLCBbaGNhLCBrZXkxLCBrZXkyLCBzdWJrZXldKTsKICAgIH0KICAgIGFzeW5jIGFkZEhlYWRlcihoY2EsIHNpZywgbmV3RGF0YSkgewogICAgICAgIHJldHVybiBhd2FpdCB0aGlzLnRhc2tRdWV1ZS5leGVjQ21kKCJhZGRIZWFkZXIiLCBbaGNhLCBzaWcsIG5ld0RhdGFdKTsKICAgIH0KICAgIGFzeW5jIGFkZENpcGhlckhlYWRlcihoY2EsIGNpcGhlclR5cGUpIHsKICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy50YXNrUXVldWUuZXhlY0NtZCgiYWRkQ2lwaGVySGVhZGVyIiwgW2hjYSwgY2lwaGVyVHlwZV0pOwogICAgfQogICAgYXN5bmMgZGVjb2RlKGhjYSwgbW9kZSA9IDMyLCBsb29wID0gMCwgdm9sdW1lID0gMS4wKSB7CiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMudGFza1F1ZXVlLmV4ZWNDbWQoImRlY29kZSIsIFtoY2EsIG1vZGUsIGxvb3AsIHZvbHVtZV0pOwogICAgfQogICAgYXN5bmMgbG9hZEhDQUZvclBsYXlpbmcoaGNhLCBrZXkxLCBrZXkyLCBzdWJrZXkpIHsKICAgICAgICBpZiAodHlwZW9mIGhjYSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgaWYgKGhjYSA9PT0gIiIpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImVtcHR5IFVSTCIpOwogICAgICAgICAgICBoY2EgPSBuZXcgVVJMKGhjYSwgZG9jdW1lbnQuYmFzZVVSSSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKCEoaGNhIGluc3RhbmNlb2YgVVJMKSAmJiAhKGhjYSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkpKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImhjYSBtdXN0IGJlIGVpdGhlciBVUkwgb3IgVWludDhBcnJheSIpOwogICAgICAgIGlmICh0aGlzLmF3SGNhUGxheWVyID09IG51bGwpIHsKICAgICAgICAgICAgdGhpcy5hd0hjYVBsYXllciA9IGF3YWl0IEhDQUF1ZGlvV29ya2xldEhDQVBsYXllci5jcmVhdGUodGhpcy5zZWxmVXJsLCBoY2EsIGtleTEsIGtleTIsIHN1YmtleSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5hd0hjYVBsYXllci5zZXRTb3VyY2UoaGNhLCBrZXkxLCBrZXkyLCBzdWJrZXkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBhd0hjYVBsYXllci5zZXRTb3VyY2UgZmFpbGVkLCBhdHRlbXB0IHJlY3JlYXRlIHBsYXllciBpbnN0YW5jZWAsIGUpOwogICAgICAgICAgICAgICAgLy8gRklYTUUgbWVtbGVhawogICAgICAgICAgICAgICAgdGhpcy5hd0hjYVBsYXllciA9IGF3YWl0IEhDQUF1ZGlvV29ya2xldEhDQVBsYXllci5jcmVhdGUodGhpcy5zZWxmVXJsLCBoY2EsIGtleTEsIGtleTIsIHN1YmtleSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBhc3luYyBwYXVzZVBsYXlpbmcoKSB7CiAgICAgICAgaWYgKHRoaXMuYXdIY2FQbGF5ZXIgPT0gbnVsbCkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgYXdhaXQgdGhpcy5hd0hjYVBsYXllci5wYXVzZSgpOwogICAgfQogICAgYXN5bmMgcmVzdW1lUGxheWluZygpIHsKICAgICAgICBpZiAodGhpcy5hd0hjYVBsYXllciA9PSBudWxsKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICBhd2FpdCB0aGlzLmF3SGNhUGxheWVyLnBsYXkoKTsKICAgIH0KICAgIGFzeW5jIHN0b3BQbGF5aW5nKCkgewogICAgICAgIGlmICh0aGlzLmF3SGNhUGxheWVyID09IG51bGwpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgIGF3YWl0IHRoaXMuYXdIY2FQbGF5ZXIuc3RvcCgpOwogICAgfQp9CgovLyBodHRwczovL2dpdGh1Yi5jb20vdmdtc3RyZWFtL3ZnbXN0cmVhbS9ibG9iLzRlZWNkYWRhOWEwM2E3M2FmMGM3YzE3ZjVjZDZlMDg1MThmZDdlM2Yvc3JjL21ldGEvYXdiLmMjTDEzCmNsYXNzIEFXQkFyY2hpdmUgewogICAgY29uc3RydWN0b3IoYXdiKSB7CiAgICAgICAgaWYgKCFBV0JBcmNoaXZlLmlzQVdCKGF3YikpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgbm90IEFXQiBhcmNoaXZlYCk7CiAgICAgICAgY29uc3QgZHYgPSBuZXcgRGF0YVZpZXcoYXdiLmJ1ZmZlciwgYXdiLmJ5dGVPZmZzZXQsIGF3Yi5ieXRlTGVuZ3RoKTsKICAgICAgICB0aGlzLnZlcnNpb24gPSBkdi5nZXRVaW50OCgweDA0KTsKICAgICAgICB0aGlzLm9mZnNldFNpemUgPSBkdi5nZXRVaW50OCgweDA1KTsKICAgICAgICB0aGlzLndhdmVJZEFsaWdubWVudCA9IGR2LmdldFVpbnQxNigweDA2LCB0cnVlKTsKICAgICAgICB0aGlzLnRvdGFsU3Vic29uZ3MgPSBkdi5nZXRJbnQzMigweDA4LCB0cnVlKTsKICAgICAgICB0aGlzLm9mZnNldEFsaWdubWVudCA9IGR2LmdldFVpbnQxNigweDBjLCB0cnVlKTsKICAgICAgICB0aGlzLnN1YmtleSA9IGR2LmdldFVpbnQxNigweDBlLCB0cnVlKTsKICAgICAgICBsZXQgZnRlbGwgPSAweDEwOwogICAgICAgIHRoaXMuaGNhRmlsZXMgPSBBcnJheS5mcm9tKHsgbGVuZ3RoOiB0aGlzLnRvdGFsU3Vic29uZ3MgfSwgKCkgPT4gewogICAgICAgICAgICBjb25zdCBvZmZzZXQgPSBmdGVsbDsKICAgICAgICAgICAgZnRlbGwgKz0gdGhpcy53YXZlSWRBbGlnbm1lbnQ7CiAgICAgICAgICAgIHJldHVybiB7IHdhdmVJRDogZHYuZ2V0VWludDE2KG9mZnNldCwgdHJ1ZSkgfTsKICAgICAgICB9KS5tYXAoKG8pID0+IHsKICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZnRlbGw7CiAgICAgICAgICAgIGZ0ZWxsICs9IHRoaXMub2Zmc2V0U2l6ZSAqIDI7CiAgICAgICAgICAgIHN3aXRjaCAodGhpcy5vZmZzZXRTaXplKSB7CiAgICAgICAgICAgICAgICBjYXNlIDB4MDQ6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2F2ZUlEOiBvLndhdmVJRCwKICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2V0OiBkdi5nZXRVaW50MzIob2Zmc2V0LCB0cnVlKSwKICAgICAgICAgICAgICAgICAgICAgICAgbmV4dDogZHYuZ2V0VWludDMyKG9mZnNldCArIHRoaXMub2Zmc2V0U2l6ZSwgdHJ1ZSksCiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGNhc2UgMHgwMjoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICAgICB3YXZlSUQ6IG8ud2F2ZUlELAogICAgICAgICAgICAgICAgICAgICAgICBvZmZzZXQ6IGR2LmdldFVpbnQxNihvZmZzZXQsIHRydWUpLAogICAgICAgICAgICAgICAgICAgICAgICBuZXh0OiBkdi5nZXRVaW50MTYob2Zmc2V0ICsgdGhpcy5vZmZzZXRTaXplLCB0cnVlKSwKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEFXQjogdW5rbm93biBvZmZzZXQgc2l6ZWApOwogICAgICAgICAgICB9CiAgICAgICAgfSkubWFwKChvKSA9PiB7CiAgICAgICAgICAgIC8vIG9mZnNldCBhcmUgYWJzb2x1dGUgYnV0IHNvbWV0aW1lcyBtaXNhbGlnbmVkIChzcGVjaWFsbHkgZmlyc3QgdGhhdCBqdXN0IHBvaW50cyB0byBvZmZzZXQgdGFibGUgZW5kKQogICAgICAgICAgICBvLm9mZnNldCArPSAoby5vZmZzZXQgJSB0aGlzLm9mZnNldEFsaWdubWVudCkgPwogICAgICAgICAgICAgICAgdGhpcy5vZmZzZXRBbGlnbm1lbnQgLSAoby5vZmZzZXQgJSB0aGlzLm9mZnNldEFsaWdubWVudCkgOiAwOwogICAgICAgICAgICBvLm5leHQgKz0gKG8ubmV4dCAlIHRoaXMub2Zmc2V0QWxpZ25tZW50KSAmJiBvLm5leHQgPCBhd2IuYnl0ZUxlbmd0aCA/CiAgICAgICAgICAgICAgICB0aGlzLm9mZnNldEFsaWdubWVudCAtIChvLm5leHQgJSB0aGlzLm9mZnNldEFsaWdubWVudCkgOiAwOwogICAgICAgICAgICByZXR1cm4geyB3YXZlSUQ6IG8ud2F2ZUlELCBmaWxlOiBhd2Iuc3ViYXJyYXkoby5vZmZzZXQsIG8ubmV4dCkgfTsKICAgICAgICB9KTsKICAgIH0KICAgIHN0YXRpYyBpc0FXQihmaWxlKSB7CiAgICAgICAgY29uc3QgZHYgPSBuZXcgRGF0YVZpZXcoZmlsZS5idWZmZXIsIGZpbGUuYnl0ZU9mZnNldCwgZmlsZS5ieXRlTGVuZ3RoKTsKICAgICAgICBjb25zdCBtYWdpYyA9IDB4NDE0NjUzMzI7IC8vICJBRlMyIiBpbiBVaW50MzJCRQogICAgICAgIHJldHVybiBkdi5nZXRVaW50MzIoMCwgZmFsc2UpID09IG1hZ2ljOwogICAgfQp9CgovLyBXZWJBdWRpby1iYXNlZCBsb29wIHBsYXllcgpjbGFzcyBIQ0FXZWJBdWRpb0xvb3BQbGF5ZXIgewogICAgY29uc3RydWN0b3IoaW5mbywgYnVmU3JjLCBhdWRpb0N0eCwgdW5sb2NrZWQsIGdhaW5Ob2RlLCB2b2x1bWUpIHsKICAgICAgICB0aGlzLmJ1ZlNyY1N0YXJ0ZWQgPSBmYWxzZTsKICAgICAgICB0aGlzLmNsb3NlZCA9IGZhbHNlOwogICAgICAgIHRoaXMucGxheUluQmFja2dyb3VuZCA9IGZhbHNlOyAvLyBGSVhNRQogICAgICAgIHRoaXMucmVxdWVzdGVkVG9QbGF5ID0gZmFsc2U7CiAgICAgICAgdGhpcy52aXNpYmlsaXR5Q2hhbmdlTGlzdGVuZXIgPSAoKSA9PiB7CiAgICAgICAgICAgIHN3aXRjaCAoZG9jdW1lbnQudmlzaWJpbGl0eVN0YXRlKSB7CiAgICAgICAgICAgICAgICBjYXNlICd2aXNpYmxlJzoKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5yZXF1ZXN0ZWRUb1BsYXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGxheSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ2hpZGRlbic6CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5wbGF5SW5CYWNrZ3JvdW5kKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3BhdXNlKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICB0aGlzLmluZm8gPSBpbmZvOwogICAgICAgIHRoaXMuYnVmU3JjID0gYnVmU3JjOwogICAgICAgIHRoaXMuYXVkaW9DdHggPSBhdWRpb0N0eDsKICAgICAgICB0aGlzLl91bmxvY2tlZCA9IHVubG9ja2VkOwogICAgICAgIHRoaXMuZ2Fpbk5vZGUgPSBnYWluTm9kZTsKICAgICAgICB0aGlzLnZvbHVtZSA9IHZvbHVtZTsKICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCd2aXNpYmlsaXR5Y2hhbmdlJywgdGhpcy52aXNpYmlsaXR5Q2hhbmdlTGlzdGVuZXIpOwogICAgfQogICAgZ2V0IHVubG9ja2VkKCkgewogICAgICAgIHJldHVybiB0aGlzLl91bmxvY2tlZDsKICAgIH0KICAgIGdldCB2b2x1bWUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2Fpbk5vZGUuZ2Fpbi52YWx1ZTsKICAgIH0KICAgIHNldCB2b2x1bWUodmFsKSB7CiAgICAgICAgaWYgKGlzTmFOKHZhbCkpCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICBpZiAodmFsID4gMS4wKQogICAgICAgICAgICB2YWwgPSAxLjA7CiAgICAgICAgaWYgKHZhbCA8IDApCiAgICAgICAgICAgIHZhbCA9IDA7CiAgICAgICAgdGhpcy5nYWluTm9kZS5nYWluLnZhbHVlID0gdmFsOwogICAgfQogICAgc3RhdGljIGFzeW5jIGNyZWF0ZShkZWNyeXB0ZWQsIHdvcmtlciwgdm9sdW1lID0gMTAwKSB7CiAgICAgICAgY29uc3QgaW5mbyA9IG5ldyBIQ0FJbmZvKGRlY3J5cHRlZCk7CiAgICAgICAgaWYgKGluZm8uY2lwaGVyICE9IDApCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigib25seSBkZWNyeXB0ZWQgaGNhIGlzIGFjY2VwdGVkIik7CiAgICAgICAgY29uc3QgYXVkaW9DdHggPSBuZXcgQXVkaW9Db250ZXh0KHsKICAgICAgICAgICAgc2FtcGxlUmF0ZTogaW5mby5mb3JtYXQuc2FtcGxpbmdSYXRlLAogICAgICAgIH0pOwogICAgICAgIGNvbnN0IHdhdiA9IGF3YWl0IHdvcmtlci5kZWNvZGUoZGVjcnlwdGVkLCAxNik7IC8vIGZpcnN0CiAgICAgICAgY29uc3QgdW5sb2NrZWQgPSBhd2FpdCBzdXNwZW5kQXVkaW9DdHhJZlVubG9ja2VkKGF1ZGlvQ3R4KTsKICAgICAgICBjb25zdCBidWZmZXIgPSBhd2FpdCBhdWRpb0N0eC5kZWNvZGVBdWRpb0RhdGEod2F2LmJ1ZmZlcik7CiAgICAgICAgY29uc3QgYnVmU3JjID0gYXVkaW9DdHguY3JlYXRlQnVmZmVyU291cmNlKCk7CiAgICAgICAgYnVmU3JjLmJ1ZmZlciA9IGJ1ZmZlcjsKICAgICAgICBpZiAoaW5mby5sb29wICE9IG51bGwgJiYgaW5mby5sb29wLmVuZCA+IGluZm8ubG9vcC5zdGFydCkgewogICAgICAgICAgICBidWZTcmMubG9vcFN0YXJ0ID0gaW5mby5sb29wU3RhcnRUaW1lOwogICAgICAgICAgICBidWZTcmMubG9vcEVuZCA9IGluZm8ubG9vcEVuZFRpbWU7CiAgICAgICAgICAgIGJ1ZlNyYy5sb29wID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZ2Fpbk5vZGUgPSBhdWRpb0N0eC5jcmVhdGVHYWluKCk7CiAgICAgICAgYnVmU3JjLmNvbm5lY3QoZ2Fpbk5vZGUpOwogICAgICAgIGdhaW5Ob2RlLmNvbm5lY3QoYXVkaW9DdHguZGVzdGluYXRpb24pOwogICAgICAgIHJldHVybiBuZXcgSENBV2ViQXVkaW9Mb29wUGxheWVyKGluZm8sIGJ1ZlNyYywgYXVkaW9DdHgsIHVubG9ja2VkLCBnYWluTm9kZSwgdm9sdW1lKTsKICAgIH0KICAgIC8vIG5vdCBzdXBwb3NlZCB0byBiZSB1c2VkIGRpcmVjdGx5CiAgICBfcGxheSgpIHsKICAgICAgICBpZiAodGhpcy5hdWRpb0N0eC5zdGF0ZSAhPT0gInJ1bm5pbmciKQogICAgICAgICAgICB0aGlzLmF1ZGlvQ3R4LnJlc3VtZSgpOwogICAgICAgIGlmICghdGhpcy5idWZTcmNTdGFydGVkKSB7CiAgICAgICAgICAgIHRoaXMuYnVmU3JjLnN0YXJ0KCk7CiAgICAgICAgICAgIHRoaXMuYnVmU3JjU3RhcnRlZCA9IHRydWU7CiAgICAgICAgfQogICAgICAgIC8vIG1hcmsgYXMgdW5sb2NrZWQKICAgICAgICBpZiAoIXRoaXMuX3VubG9ja2VkKSB7CiAgICAgICAgICAgIHRoaXMuX3VubG9ja2VkID0gdHJ1ZTsKICAgICAgICAgICAgY29uc29sZS53YXJuKGBhdWRpbyBjb250ZXh0IGZvciBzYW1wbGVSYXRlPSR7dGhpcy5hdWRpb0N0eC5zYW1wbGVSYXRlfSBpcyBub3cgcmVzdW1lZC91bmxvY2tlZGApOwogICAgICAgIH0KICAgIH0KICAgIF9wYXVzZSgpIHsKICAgICAgICBpZiAodGhpcy5hdWRpb0N0eC5zdGF0ZSAhPT0gInJ1bm5pbmciKQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgdGhpcy5hdWRpb0N0eC5zdXNwZW5kKCk7CiAgICB9CiAgICBwbGF5KCkgewogICAgICAgIHRoaXMucmVxdWVzdGVkVG9QbGF5ID0gdHJ1ZTsKICAgICAgICB0aGlzLl9wbGF5KCk7CiAgICB9CiAgICBwYXVzZSgpIHsKICAgICAgICB0aGlzLnJlcXVlc3RlZFRvUGxheSA9IGZhbHNlOwogICAgICAgIHRoaXMuX3BhdXNlKCk7CiAgICB9CiAgICBhc3luYyBzdG9wKCkgewogICAgICAgIGlmICghdGhpcy5fdW5sb2NrZWQpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiYXVkaW8gY29udGV4dCBpcyBub3QgdW5sb2NrZWQsIGNhbm5vdCBzdG9wIGFuZCBkZXN0cm95Iik7CiAgICAgICAgaWYgKHRoaXMuY2xvc2VkKQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigndmlzaWJpbGl0eWNoYW5nZScsIHRoaXMudmlzaWJpbGl0eUNoYW5nZUxpc3RlbmVyKTsKICAgICAgICB9CiAgICAgICAgY2F0Y2ggKGUpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihlKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5yZXF1ZXN0ZWRUb1BsYXkgPSBmYWxzZTsKICAgICAgICB0aGlzLmJ1ZlNyYy5kaXNjb25uZWN0KCk7CiAgICAgICAgYXdhaXQgdGhpcy5hdWRpb0N0eC5jbG9zZSgpOwogICAgICAgIHRoaXMuY2xvc2VkID0gdHJ1ZTsKICAgIH0KfQoKZXhwb3J0IHsgQVdCQXJjaGl2ZSwgSENBLCBIQ0FJbmZvLCBIQ0FXZWJBdWRpb0xvb3BQbGF5ZXIsIEhDQVdvcmtlciB9Owo=", document.baseURI);
        var hcaJsModule, hcaJsObjUrl, AWBArchive, HCAInfo, HCAWorker, HCAWebAudioLoopPlayer;

        // mime types
        const defMimeType = "application/octet-stream";
        const mimeTypeMap = {
            wav: "audio/x-wav",
            hca: defMimeType,
        }

        // HCAWorker instance
        var worker = null;

        // HCAWebAudioLoopPlayer instance
        var webAudioLoopPlayer = null;

        // dragged file
        var draggedFile = null;

        // parsed AWB
        var parsedAWB = null;

        // local file picker
        const localfile = document.getElementById("localfile");
        const localfileform = document.getElementById("localfileform");
        // onchange does not work on iOS Safari
        localfile.addEventListener("change", function (ev) { buttons.loadfilebtn = this.files.length > 0; });
        // reset state on refresh
        // https://bugzilla.mozilla.org/show_bug.cgi?id=685657
        localfileform.reset();
        // workaround for iOS Safari file picker
        document.getElementById("hcaonly").addEventListener("change", function (ev) {
            localfile.accept = ev.target.checked ? ".hca,application/octet-stream" : "";
        });
        // AWB subsong switcher
        const awbsubsongswitcher = document.getElementById("awbsubsongswitcher");
        AWBSubsongSelect = function (selected, doNotPlay) {
            let index = selected.id.replace(/^awb_subsong_index_/, "");
            fileName = `${AWBFileName}_${index}.hca`;
            hcaFileData.original.data = parsedAWB.hcaFiles[index].file;
            if (!doNotPlay && document.getElementById("awautoplayondrop").checked) {
                // doNotPlay=true, will play in "drop" event
                buttons.awloadwholehcabtn = "click";
                buttons.awresumebtn = "click";
            }
        }
        function setAWBSubSongSwitcher(enable) {
            if (!enable) {
                awbsubsongswitcher.innerHTML = "";
                keys.subkey = "0x0";
                return;
            }

            const subkey = `0x${parsedAWB.subkey.toString(16).toUpperCase()}`;

            console.log(`AWB archive version=[${parsedAWB.version}]`
                + `, subsong count=[${parsedAWB.hcaFiles.length}], subkey=[${subkey}]`);

            const listEntries = parsedAWB.hcaFiles.map((entry, index) => {
                // filter out non-HCA entries
                if (entry.file.byteLength == 0) return;
                try {
                    new HCAInfo(entry.file);
                } catch (e) {
                    return;
                }
                // convert to HTML
                return `<div><input type=\"radio\" name=\"awb_subsong_id\" id=\"awb_subsong_index_${index}\"`
                    + ` onclick=\"AWBSubsongSelect(this);\">`
                    + `<label for=\"awb_subsong_index_${index}\">waveID=${entry.waveID}</label>`
                    + `</div>`;
            }).filter((str) => str != null).join("\n");

            keys.subkey = subkey;
            awbsubsongswitcher.innerHTML = `<fieldset><legend>AWB archive subsongs</legend>\n`
                + `${listEntries}\n`
                + `</fieldset>`;
        }

        // input HCA URL
        const urlinput = document.getElementById("urlinput");

        // file name
        var AWBFileName = null;
        var fileName = null;

        // HCA info table
        const hcaInfoTable = {
            el: document.getElementById("hcaInfoTable"),
            body: {
                el: document.getElementById("hcaInfoTable")
                    .getElementsByTagName('tbody')[0],
                defText: document.getElementById("hcaInfoTable")
                    .getElementsByTagName('tbody')[0]
                    .getElementsByTagName("td")[0]
                    .textContent,
                data: {},
            },
        }
        Object.defineProperty(hcaInfoTable.body, "data", {
            get: function () { return this.value },
            set: function (val) {
                // clear existing content
                for (let i = hcaInfoTable.body.el.getElementsByTagName("tr").length - 1; i >= 0; i--) {
                    hcaInfoTable.body.el.deleteRow(i);
                }
                function appendRow(cells, rowspan) {
                    let newRow = hcaInfoTable.body.el.insertRow(-1);
                    cells.forEach((val, idx) => {
                        let newCell = newRow.insertCell(idx);
                        if (rowspan != null && idx == 0)
                            newCell.setAttribute("rowspan", rowspan);
                        if (cells.length < 3 && idx == cells.length - 1)
                            newCell.setAttribute("colspan", cells.length - idx + 1);
                        let newText = val != null
                            ? document.createTextNode("" + val)
                            : (() => {
                                let italic = document.createElement("i");
                                italic.innerHTML = "(not defined)";
                                return italic;
                            })();
                        newCell.appendChild(newText);
                    });
                }
                function toHex(num) {
                    const padding = "0000";
                    let hex = padding + num.toString(padding.length * 4).toUpperCase();
                    return "0x" + hex.substring(hex.length - padding.length, hex.length)
                }
                if (val == null || !val instanceof HCAInfo) {
                    appendRow([hcaInfoTable.body.defText]);
                    return; // nothing to add
                }
                // add given content
                let info = val;
                const hcaInfoTextArray = [
                    ["Version", info.version],
                    ["Header size", info.dataOffset],
                    ["Format", !info.hasHeader["fmt"] ? null : [
                        ["Channels", info.format.channelCount],
                        ["Sampling Rate", info.format.samplingRate],
                        ["Blocks", info.format.blockCount],
                        ["Dropped smpl. (head)", info.format.droppedHeader],
                        ["Dropped smpl. (tail)", info.format.droppedFooter],
                        ["Duration (calc)", `${info.duration.toFixed(3)}s`],
                    ]],
                    ["Block size", !info.hasHeader["comp"] && !info.hasHeader["dec"] ? null : info.blockSize],
                    ["Bitrate (kbps)", !info.hasHeader["comp"] && !info.hasHeader["dec"] ? null : info.kbps],
                    ["VBR", info.hasHeader["vbr"] ? "yes" : "no"],
                    ["ATH", !info.hasHeader["ath"] ? null : toHex(info.ath)],
                    ["Loop", !info.hasHeader["loop"] ? null : [
                        ["Start", info.loop.start],
                        ["End", info.loop.end],
                        ["Dropped smpl. (head)", info.loop.droppedHeader],
                        ["Dropped smpl. (tail)", info.loop.droppedFooter],
                        ["StartTime (calc)", `${info.loopStartTime.toFixed(3)}s`],
                        ["EndTime (calc)", `${info.loopEndTime.toFixed(3)}s`],
                        ["Duration (calc)", `${info.loopDuration.toFixed(3)}s`],
                    ]],
                    ["Cipher", !info.hasHeader["ciph"] ? null : toHex(info.cipher)],
                    ["RVA (volume)", !info.hasHeader["rva"] ? null : info.rva],
                    ["Comment", !info.hasHeader["comm"] ? null : info.comment],
                ];
                for (let item of hcaInfoTextArray) {
                    let key = item[0];
                    let val = item[1];
                    if (Array.isArray(val)) {
                        let textList = val[0].slice(0);
                        textList.unshift(key);
                        appendRow(textList, val.length);
                        val.shift();
                        val.forEach((item) => appendRow(item))
                    } else {
                        appendRow([key, val]);
                    }
                }
                // update value
                this.value = val;
            },
        });

        // keys
        const keys = { key1: undefined, key2: undefined, subkey: undefined };
        for (let key in keys) {
            Object.defineProperty(keys, key, {
                get: function () { return document.getElementById(key + "input").value },
                set: function (val) { document.getElementById(key + "input").value = val },
            });
        }
        async function testAndFindValidKeyAsync() {
            worker.tick();
            let resultPromise = worker.findKey(hcaFileData.original.data, [[keys.key1, keys.key2]], keys.subkey);
            worker.tock(`findKey`);
            let result = await resultPromise;
            if (result != null) {
                result = result.map((k) => `0x${k.toString(16).toUpperCase()}`);
                console.log(`found valid key`, result);
                keys.key1 = result[0];
                keys.key2 = result[1];
            } else {
                console.warn(`not encrypted, or no valid key found!`);
            }
        }

        // mode/loop/volume
        const decodingParam = {
            mode: {
                el: document.getElementById("decodingmodeinput"),
                defVal: 16,
            },
            loop: {
                el: document.getElementById("loopcountinput"),
                defVal: 0,
            },
            volumePerCent: {
                el: document.getElementById("volumeinput"),
                defVal: 100,
            },
        }

        function setVolume(val) {
            val = Number(val) / 100;
            if (worker != null && worker.awHcaPlayer != null) {
                worker.awHcaPlayer.volume = val;
            }
            if (webAudioLoopPlayer != null) {
                webAudioLoopPlayer.volume = val;
            }
        }
        document.getElementById("volumeslider").addEventListener("input", (ev) => {
            const val = ev.target.value;
            document.getElementById("volumeinput").value = val;
            setVolume(val);
        });
        document.getElementById("volumeinput").addEventListener("input", (ev) => {
            const val = ev.target.value;
            const slider = document.getElementById("volumeslider");
            if (slider.value != val) {
                slider.value = val;
            }
            setVolume(val);
        });

        // play in background checkbox
        const awplayinbackground = document.getElementById("awplayinbackground");
        awplayinbackground.addEventListener("change", (ev) => {
            if (worker == null || worker.awHcaPlayer == null) return;
            worker.awHcaPlayer.playInBackground = ev.target.checked;
        }, false);
        const webaudioplayinbackground = document.getElementById("webaudioplayinbackground");
        webaudioplayinbackground.addEventListener("change", (ev) => {
            if (webAudioLoopPlayer == null) return;
            webAudioLoopPlayer.playInBackground = ev.target.checked;
        }, false);

        for (let paramName in decodingParam) {
            let el = decodingParam[paramName].el;
            let defVal = decodingParam[paramName].defVal;
            let attr = {};
            ["min", "max", "step"].forEach((attrName) => attr[attrName] = el.getAttribute(attrName));
            let clampVal = function (val) {
                if (val == null || val === "")
                    return defVal;
                val = parseInt(val);
                if (isNaN(val))
                    return defVal;
                if (val % attr.step != 0)
                    val = Math.floor(val / attr.step);
                else if (val < attr.min)
                    val = attr.min;
                else if (val > attr.max)
                    val = attr.max;
                return val;
            }
            Object.defineProperty(decodingParam, paramName, {
                get: function () {
                    let clamped = clampVal(el.value);
                    el.value = "" + clamped;
                    return clamped;
                },
                set: function (val) {
                    el.value = "" + clampVal(val);
                }
            });
        }

        // HCA file data
        const hcaFileData = {
            // original HCA file content
            original: {
                btnID: "downloadbtn",
                data: {},
            },
            // after fixing checksum
            fixed_checksum: {
                btnID: "fixcsumbtn",
                data: {},
            },
            // after decryption
            decrypted: {
                btnID: "decryptbtn",
                data: {},
            },
            // after encryption
            encrypted: {
                btnID: "encryptbtn",
                data: {},
            },
            // after decoding
            decoded: {
                btnID: "decodetoh5btn",
                data: {},
            },
        }
        for (let suffix in hcaFileData) {
            Object.defineProperty(hcaFileData[suffix], "data", {
                get: function () { return this.value },
                set: function (val) {
                    this.value = null; // clear existing data
                    const fileExtRegEx = /\.([^\.]+)$/;
                    let newFileName = fileName.replace(fileExtRegEx, "_" + suffix + ".$1");
                    if (suffix === "decoded")
                        newFileName = newFileName.replace(fileExtRegEx, ".wav");
                    let id = suffix + "-download-link";
                    let el = document.getElementById(id);
                    if (el != null) {
                        // remove existing download link
                        URL.revokeObjectURL(el.getAttribute("href"));
                        el.nextSibling.remove();
                        el.remove();
                    }
                    if (val == null) {
                        console.log(`hcaFileData ${suffix} cleared`);
                        return; // nothing to create
                    }
                    console.log(`hcaFileData ${suffix} byteLength=${val.byteLength}`);
                    // create new download link
                    el = document.createElement("a");
                    el.setAttribute("id", id);
                    el.setAttribute("download", newFileName);
                    let extName = newFileName.match(fileExtRegEx)[0];
                    let mimeType = mimeTypeMap[extName];
                    if (mimeType == null) mimeType = defMimeType;
                    el.setAttribute("href", URL.createObjectURL(new Blob([val], { type: mimeType })));
                    el.innerHTML = newFileName;
                    let refNode = document.getElementById(hcaFileData[suffix].btnID).nextSibling;
                    refNode.parentElement.insertBefore(document.createElement("br"), refNode);
                    refNode.parentElement.insertBefore(el, refNode);
                    // update value
                    this.value = val;
                },
            });
        }
        function clearAllData() {
            localfileform.reset();
            for (let suffix in hcaFileData) {
                hcaFileData[suffix].data = null;
            }
            setAWBSubSongSwitcher(null);
            hcaInfoTable.body.data = null;
            audioElement.src = null;
            console.log(`cleared all data`);
        }

        // Audio element
        const audioElement = {
            el: document.getElementById("audioElement"),
            src: ""
        };
        Object.defineProperty(audioElement, "src", {
            get: function () { return this.value },
            set: function (val) {
                if (this.value != null && this.value != "")
                    URL.revokeObjectURL(this.value);
                if (val == null || val === "") {
                    this.value = audioElement.el.src = "";
                    return;
                }
                let newUrl;
                if (val instanceof ArrayBuffer || val.buffer instanceof ArrayBuffer) {
                    newUrl = URL.createObjectURL(new Blob([val], { type: mimeTypeMap.wav }));
                } else {
                    newUrl = val;
                }
                this.value = audioElement.el.src = newUrl;
            }
        });

        // buttons
        const hcaWorkerLoadedEvent = new CustomEvent("hcaworkerloaded");
        const audioCtxUnlockedEvent = new CustomEvent("audioctxunlocked");
        const buttons = {
            startworkerbtn: async (self) => {
                if (worker == null) {
                    if (hcaJsObjUrl == null) {
                        const response = await fetch(hcaJsUrl.href);
                        const blob = new Blob([await response.arrayBuffer()], { type: "text/javascript" });
                        hcaJsObjUrl = URL.createObjectURL(blob);
                    }
                    if (hcaJsModule == null) {
                        hcaJsModule = await import(hcaJsObjUrl);
                    }
                    if (AWBArchive == null) AWBArchive = hcaJsModule.AWBArchive;
                    if (HCAInfo == null) HCAInfo = hcaJsModule.HCAInfo;
                    if (HCAWorker == null) HCAWorker = hcaJsModule.HCAWorker;
                    if (HCAWebAudioLoopPlayer == null) HCAWebAudioLoopPlayer = hcaJsModule.HCAWebAudioLoopPlayer;
                    worker = await HCAWorker.create(hcaJsObjUrl);
                    console.log("started background worker");
                    window.dispatchEvent(hcaWorkerLoadedEvent);
                }
                self.disabled = true; // added because button won't grey out if there's any await above
                buttons.shutdownbtn = true;
            },
            shutdownbtn: async (self) => {
                if (worker != null) {
                    await worker.shutdown();
                    worker = null;
                    console.log("background worker is now shut down");
                }
                self.disabled = true; // added together with above startworkerbtn
                buttons.startworkerbtn = true;
            },
            loadfilebtn: async (self) => {
                let file = null;
                if (draggedFile != null) {
                    self.textContent = "loading dragged file...";
                    file = draggedFile;
                    draggedFile = null;
                } else {
                    self.textContent = "loading picked file...";
                    file = localfile.files[0];
                }
                let newFileName = file.name;
                // update fileName
                fileName = newFileName;
                // clear all existing data
                clearAllData();
                resetButtonsExcept(self.id);
                // update data
                let ab;
                if (file.arrayBuffer == null) {
                    let objUrl = URL.createObjectURL(file);
                    let resp = await fetch(objUrl);
                    URL.revokeObjectURL(objUrl);
                    ab = await resp.arrayBuffer();
                } else {
                    ab = await file.arrayBuffer();
                }
                // parse AWB
                AWBFileName = null;
                parsedAWB = null;
                if (AWBArchive.isAWB(new Uint8Array(ab))) {
                    try {
                        parsedAWB = new AWBArchive(new Uint8Array(ab));
                    } catch (e) {
                        console.error(`error parsing AWB archive`, e);
                    }
                }
                if (parsedAWB != null && parsedAWB.hcaFiles.length > 0) {
                    AWBFileName = fileName;
                    setAWBSubSongSwitcher(true);
                    AWBSubsongSelect({ id: "awb_subsong_index_0" }, true); // doNotPlay=true, will play in "drop" event
                } else {
                    setAWBSubSongSwitcher(null);
                    hcaFileData.original.data = new Uint8Array(ab);
                }
                // find valid key
                await testAndFindValidKeyAsync();
                self.textContent = "load picked file (successful)";
                // no need to let the button bounce
                // next step
                buttons.awloadwholehcabtn = true;
                buttons.infobtn = true;
                buttons.fixcsumbtn = true;
            },
            downloadbtn: async (self) => {
                self.textContent = "downloading...";
                let requestUrl = urlinput.value;
                if (requestUrl === "") {
                    self.textContent = "download (empty URL)";
                    self.disabled = false;
                    return;
                }
                let response = null;
                try {
                    response = await fetch(requestUrl);
                } catch (e) {
                    console.error(e);
                    self.textContent = "download (network error)";
                    self.disabled = false;
                    return;
                }
                if (response.status != 200) {
                    console.error("download failed,", response);
                    self.textContent = `download (failed, ${response.status} ${response.statusText})`;
                    self.disabled = false;
                    return;
                }
                // get filename from Content-Disposition
                let cd = response.headers.get("Content-Disposition");
                let newFileName = null;
                if (cd != null) {
                    let splitted = cd.split(";");
                    let cdFileName = splitted.find((substr) => substr.startsWith("filename="));
                    if (cdFileName != null) {
                        newFileName = cdFileName.substring("filename=".length)
                            .replaceAll(" ", "")
                            .replaceAll("\"", "");
                    }
                }
                // failed to get filename from Content-Disposition, try URL
                const fileNameRegEx = /[^\/^\\]+$/;
                if (newFileName == null || newFileName === "") {
                    let urlFilename = [response.url, requestUrl].find((url) => url != null && url.match(fileNameRegEx));
                    if (urlFilename != null)
                        newFileName = urlFilename.match(fileNameRegEx)[0];
                }
                // failed to get filename, use default filename
                if (newFileName == null || newFileName === "") {
                    newFileName = "downloaded.hca";
                }
                // strip query string
                let stripped = newFileName.match(/^[^\?]+/);
                if (stripped != null)
                    newFileName = stripped[0];
                // update fileName
                fileName = newFileName;
                // clear all existing data
                clearAllData();
                resetButtonsExcept(self.id);
                // update data
                let ab = await response.arrayBuffer();
                // parse AWB
                AWBFileName = null;
                parsedAWB = null;
                if (AWBArchive.isAWB(new Uint8Array(ab))) {
                    try {
                        parsedAWB = new AWBArchive(new Uint8Array(ab));
                    } catch (e) {
                        console.error(`error parsing AWB archive`, e);
                    }
                }
                if (parsedAWB != null && parsedAWB.hcaFiles.length > 0) {
                    AWBFileName = fileName;
                    setAWBSubSongSwitcher(true);
                    AWBSubsongSelect({ id: "awb_subsong_index_0" }, true); // doNotPlay=true, will play in "drop" event
                } else {
                    setAWBSubSongSwitcher(null);
                    hcaFileData.original.data = new Uint8Array(ab);
                }
                self.textContent = "download (successful)";
                // find valid key
                await testAndFindValidKeyAsync();
                // let the button bounce
                self.disabled = false;
                // next step
                buttons.awloadwholehcabtn = true;
                buttons.infobtn = true;
                buttons.fixcsumbtn = true;
            },
            awloadwholehcabtn: async (self) => {
                try {
                    await worker.loadHCAForPlaying(hcaFileData.original.data, keys.key1, keys.key2, keys.subkey);
                    worker.awHcaPlayer.playInBackground = awplayinbackground.checked;
                    self.textContent = "Load (successful)";
                } catch (e) {
                    self.textContent = "Load (failed)";
                    console.error(e);
                }
                // let the button bounce
                self.disabled = false;
                // next step
                buttons.awpausebtn = false;
                buttons.awresumebtn = true;
                buttons.awstopbtn = true;
                // TODO pause/rewind/fast-forward etc
            },
            awloadfromurlbtn: async (self) => {
                try {
                    await worker.loadHCAForPlaying(urlinput.value, keys.key1, keys.key2, keys.subkey);
                    worker.awHcaPlayer.playInBackground = awplayinbackground.checked;
                    self.textContent = "Load (successful)";
                } catch (e) {
                    self.textContent = "Load (failed)";
                    console.error(e);
                }
                // let the button bounce
                self.disabled = false;
                // next step
                buttons.awpausebtn = false;
                buttons.awresumebtn = true;
                buttons.awstopbtn = true;
                // TODO rewind/fast-forward etc
            },
            awpausebtn: async (self) => {
                try {
                    await worker.pausePlaying();
                    self.textContent = "Paused";
                } catch (e) {
                    self.textContent = "Pause (Error)";
                    console.log(e);
                    // let the button bounce
                    self.disabled = false;
                }
                // next step
                buttons.awresumebtn = true;
            },
            awresumebtn: async (self) => {
                try {
                    await worker.resumePlaying();
                    self.textContent = "Playing/Resumed";
                } catch (e) {
                    self.textContent = "Play/Resume (Error)";
                    console.log(e);
                    // let the button bounce
                    self.disabled = false;
                }
                // next step
                buttons.awpausebtn = true;
            },
            awstopbtn: async (self) => {
                try {
                    await worker.stopPlaying();
                    self.textContent = "Stopped";
                } catch (e) {
                    self.textContent = "Stop (Error)";
                    console.log(e);
                    // let the button bounce
                    self.disabled = false;
                }
                // next step
                buttons.awpausebtn = false;
                buttons.awresumebtn = false;
            },
            infobtn: async (self) => {
                let hca = hcaFileData[
                    ["fixed_checksum", "original"].find((suffix) => {
                        if (hcaFileData[suffix].data != null) {
                            console.log(`get HCA info from ${suffix} file data`);
                            return true;
                        }
                    })
                ].data;
                try {
                    let info = new HCAInfo(hca);
                    self.textContent = "get HCA info (successful)";
                    // update table content
                    hcaInfoTable.body.data = info;
                    // next step
                    let isEncrypted = info.hasHeader["ciph"] && info.cipher != 0;
                    buttons.encryptbtn = !isEncrypted;
                    buttons.decryptbtn = isEncrypted;
                    buttons.decodetoh5btn = !isEncrypted;
                    buttons.decodetowabtn = !isEncrypted;
                } catch (e) {
                    console.error(e);
                    self.textContent = "get HCA info (failed)";
                }
                // let the button bounce
                self.disabled = false;
            },
            fixcsumbtn: async (self) => {
                try {
                    worker.tick();
                    let newHcaPromise = worker.fixChecksum(hcaFileData.original.data);
                    worker.tock("fix checksum");
                    let newHca = await newHcaPromise;
                    // update data
                    hcaFileData.fixed_checksum.data = newHca;
                    self.textContent = "fix checksum (successful)";
                } catch (e) {
                    console.error(e);
                    self.textContent = "fix checksum (failed)";
                }
                // let the button bounce
                self.disabled = false;
            },
            encryptbtn: async (self) => {
                await encryptOrDecrypt(self, true);
                // let the button bounce
                self.disabled = false;
            },
            decryptbtn: async (self) => {
                await encryptOrDecrypt(self, false);
                // let the button bounce
                self.disabled = false;
            },
            decodetoh5btn: async (self) => {
                // prepare data
                let hca = hcaFileData[
                    ["decrypted", "fixed_checksum", "original"].find((suffix) => {
                        if (hcaFileData[suffix].data != null) {
                            console.log(`decoding ${suffix} data...`);
                            return true;
                        }
                    })
                ].data;
                // start decoding
                try {
                    worker.tick();
                    let decodedPromise = worker.decode(hca,
                        decodingParam.mode, decodingParam.loop, decodingParam.volumePerCent / 100);
                    worker.tock("decoding");
                    let decoded = await decodedPromise;
                    // update data
                    hcaFileData.decoded.data = decoded;
                    self.textContent = "decode (done)";
                    // next step (play)
                    audioElement.src = decoded;
                } catch (e) {
                    console.error(e);
                    self.textContent = "decode (failed)";
                }
                // let the button bounce
                self.disabled = false;
            },
            decodetowabtn: async (self) => {
                // prepare data
                let hca = hcaFileData[
                    ["decrypted", "fixed_checksum", "original"].find((suffix) => {
                        if (hcaFileData[suffix].data != null) {
                            console.log(`decoding ${suffix} data...`);
                            return true;
                        }
                    })
                ].data;
                // start decoding
                try {
                    worker.tick();
                    let decodedPromise = HCAWebAudioLoopPlayer.create(hca, worker, decodingParam.volumePerCent / 100);
                    worker.tock("decoding");
                    let newPlayer = await decodedPromise;
                    // update player instance
                    if (webAudioLoopPlayer != null) await webAudioLoopPlayer.stop();
                    webAudioLoopPlayer = newPlayer;
                    webAudioLoopPlayer.playInBackground = webaudioplayinbackground.checked;
                    self.textContent = "decode (done)";
                    // next step (play)
                    buttons.webaudioplaybtn = true;
                } catch (e) {
                    console.error(e);
                    self.textContent = "decode (failed)";
                }
                // let the button bounce
                self.disabled = false;
            },
            webaudioplaybtn: async (self) => {
                try {
                    webAudioLoopPlayer.play();
                    self.textContent = "Playing/Resumed";
                } catch (e) {
                    self.textContent = "Play/Resume (Error)";
                    console.log(e);
                    // let the button bounce
                    self.disabled = false;
                }
                // next step
                buttons.webaudiopausebtn = true;
                buttons.webaudiostopbtn = true;
            },
            webaudiopausebtn: async (self) => {
                try {
                    webAudioLoopPlayer.pause();
                    self.textContent = "Paused";
                } catch (e) {
                    self.textContent = "Pause (Error)";
                    console.log(e);
                    // let the button bounce
                    self.disabled = false;
                }
                // next step
                buttons.webaudioplaybtn = true;
            },
            webaudiostopbtn: async (self) => {
                try {
                    await webAudioLoopPlayer.stop();
                    self.textContent = "Stopped";
                } catch (e) {
                    self.textContent = "Stop (Error)";
                    console.log(e);
                    // let the button bounce
                    self.disabled = false;
                }
                // next step
                buttons.webaudiopausebtn = false;
                buttons.webaudioplaybtn = false;
            },
        };
        const _buttons = {};
        for (let id in buttons) {
            let el = document.getElementById(id);
            let onclick = buttons[id];
            el.onclick = (ev) => {
                let self = ev.srcElement;
                self.disabled = true;
                onclick(self);
            }
            const initialText = el.textContent;
            Object.defineProperty(buttons, id, {
                get: function () { return !el.disabled },
                set: function (val) {
                    if (val === "click") {
                        el.disabled = true;
                        onclick(el);
                        return;
                    }
                    el.textContent = initialText;
                    el.disabled = !val;
                },
            });
            Object.defineProperty(_buttons, id, {
                get: function () { return onclick; },
            });
        }
        function resetButtonsExcept(exceptBtnID) {
            for (let btnID in buttons) {
                if (btnID !== exceptBtnID) switch (btnID) {
                    case "startworkerbtn":
                        buttons[btnID] = worker == null || !worker.isAlive;
                        break;
                    case "shutdownbtn":
                        buttons[btnID] = worker != null && worker.isAlive;
                        break;
                    case "loadfilebtn":
                        buttons[btnID] = false;
                        break;
                    case "downloadbtn":
                        buttons[btnID] = true;
                        break;
                    case "awloadwholehcabtn":
                        buttons[btnID] = false;
                        break;
                    case "awloadfromurlbtn":
                        buttons[btnID] = true;
                        break;
                    case "awresumebtn":
                    case "awpausebtn":
                    case "awstopbtn":
                        // do not reset except on refresh
                        if (exceptBtnID == null) buttons[btnID] = false;
                        break;
                    default:
                        buttons[btnID] = false;
                }
            }
        }
        resetButtonsExcept(); // same to above, reset state on refresh
        async function encryptOrDecrypt(self, isEncrypting) {
            const action = isEncrypting ? "encrypt" : "decrypt";
            const opposite = isEncrypting ? "decrypt" : "encrypt";
            // disable both buttons
            self.disabled = true;
            buttons[opposite + "btn"] = false;
            self.textContent = action + "ing...";
            // disable decodetoh5btn and decodetowabtn if necessary
            if (!isEncrypting) {
                buttons.decodetoh5btn = false;
                buttons.decodetowabtn = false;
            }
            // prepare data
            let hca = hcaFileData[
                [opposite + "ed", "fixed_checksum", "original"].find((suffix) => {
                    if (hcaFileData[suffix].data != null) {
                        console.log(`${action}ing ${suffix} data...`);
                        return true;
                    }
                })
            ].data;
            if (isEncrypting && !hcaInfoTable.body.data.hasHeader["ciph"]) {
                // check for ciph header section
                console.log("input HCA lacks ciph header section, adding it");
                hca = await worker.addCipherHeader(hca);
            } else {
                hca = hca.slice(0); // just copy to new buffer
            }
            // start to encrypt/decrypt
            try {
                worker.tick();
                // although decryption/encryption is done in-place,
                // however since we are not using SharedArrayBuffer,
                // the background worker is still actually overwritting a newly allocated buffer
                let resultPromise = worker[action](hca, keys.key1, keys.key2, keys.subkey);
                worker.tock(isEncrypting ? "encryption" : "decryption");
                let result = await resultPromise;
                self.textContent = action + " (done)";
                // update data
                hcaFileData[action + "ed"].data = result;
                // next steps
                buttons[opposite + "btn"] = true;
                if (!isEncrypting) {
                    buttons.decodetoh5btn = true;
                    buttons.decodetowabtn = true;
                }
            } catch (e) {
                console.error(e);
                self.textContent = "Error during " + (isEncrypting ? "encryption" : "decryption");
            }
        }
        window.addEventListener("dragover", function (ev) {
            // https://stackoverflow.com/questions/46668079/addeventlistener-drop-not-firing
            ev.preventDefault();
        });

        const audioCtxUnlocker = document.getElementById("audioctx_unlocker");
        function setShowAudioCtxUnlocker(show) {
            if (show) {
                audioCtxUnlocker.classList.add("overlay");
                audioCtxUnlocker.classList.remove("hidden");
            } else {
                audioCtxUnlocker.classList.add("hidden");
            }
        }

        var tryingUnlock = false;
        function tryUnlock() {
            if (worker.awHcaPlayer && !worker.awHcaPlayer.unlocked) {
                // FIXME temporary workaround
                if (!tryingUnlock) {
                    tryingUnlock = true;
                    const id = "awresumebtn";
                    const el = document.getElementById(id);
                    el.disabled = true;
                    _buttons[id](el).then(() => {
                        tryingUnlock = false;
                        setShowAudioCtxUnlocker(false);
                        window.dispatchEvent(audioCtxUnlockedEvent);
                    });
                }
            }
        }
        window.addEventListener("click", function (ev) {
            tryUnlock();
        });
        window.addEventListener("drop", function (ev) {
            ev.preventDefault();
            let file = null;
            const dtItems = ev.dataTransfer.items;
            const dtFiles = ev.dataTransfer.files;
            if (dtItems != null && dtItems.length == 1) {
                // Use DataTransferItemList interface to access the file(s)
                const item = dtItems[0];
                if (item.kind === "file") {
                    file = item.getAsFile();
                }
            } else if (dtFiles != null && dtFiles.length == 1) {
                // Use DataTransfer interface to access the file(s)
                file = dtFiles[0];
            }
            if (file != null) {
                draggedFile = file;
                let btnToClick = ["loadfilebtn", "infobtn"];
                const autoPlay = document.getElementById("awautoplayondrop").checked;
                if (autoPlay) {
                    btnToClick.push("awloadwholehcabtn", "awresumebtn");
                    //tryUnlock(); // did not seem to work
                }
                const iter = btnToClick.values();
                const clickNextBtn = function () {
                    let id = iter.next();
                    if (id.done) return;
                    id = id.value;
                    if (typeof id !== "string") throw new Error();
                    if (id === "awloadwholehcabtn" || id === "awresumebtn") {
                        if (worker.awHcaPlayer && !worker.awHcaPlayer.unlocked) {
                            // FIXME temporary workaround
                            console.warn("awHcaPlayer is still locked, give up before clicking " + id);
                            setShowAudioCtxUnlocker(true);
                            return;
                        }
                    }
                    const el = document.getElementById(id);
                    el.disabled = true;
                    _buttons[id](el).then(() => { clickNextBtn(); });
                }
                clickNextBtn();
            }
        });

        const handleHashChange = async (ev) => {
            const hash = window.location.hash;
            if (hash == null || hash === "" || hash === "#") return;
            if (document.getElementById(hash.replace(/^#/, "")) != null) return;

            urlinput.value = window.location.hash.replace(/^#/, "");

            const id = "awloadfromurlbtn";
            const el = document.getElementById(id);
            el.disabled = true;
            await new Promise((resolve) => {
                _buttons[id](el).then(() => {
                    if (worker.awHcaPlayer.unlocked) {
                        resolve();
                        return;
                    }
                    setShowAudioCtxUnlocker(true);
                    const listener = () => {
                        window.removeEventListener(audioCtxUnlockedEvent.type, listener);
                        resolve();
                    }
                    window.addEventListener(audioCtxUnlockedEvent.type, listener);
                });
            });

            buttons.awresumebtn = "click";
        }

        window.addEventListener("load", () => {
            window.addEventListener(hcaWorkerLoadedEvent.type, () => {
                handleHashChange();
                window.addEventListener("hashchange", handleHashChange);
            });
            buttons.startworkerbtn = "click"; // start background worker
        });
    </script>
</body>

</html>